<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Card√°pio Real ‚Äì Sistema com Autentica√ß√£o e FIREBASE</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let salesChartInstance = null; // Vari√°vel global para a inst√¢ncia do Chart.js

// Solicita permiss√£o de notifica√ß√£o ao carregar a p√°gina
document.addEventListener("DOMContentLoaded", () => {
    if (typeof Notification !== 'undefined' && Notification.permission !== "granted" && Notification.permission !== "denied") {
        Notification.requestPermission();
    }
});

// ==== Fun√ß√µes Auxiliares ====
function formatCPFCNPJ(value) {
    // Placeholder: Retorna o valor sem formata√ß√£o se a fun√ß√£o real n√£o estiver definida.
    // O usu√°rio deve implementar a formata√ß√£o real se necess√°rio.
    return value || 'N/A';
}

// ==== Bot√£o Sair do Perfil ====
document.addEventListener("DOMContentLoaded", () => {
  const logoutBtn = document.getElementById("btnLogout");
  if (logoutBtn) {
    logoutBtn.addEventListener("click", () => {
      if (confirm("Deseja realmente sair da conta?")) {
        if (typeof logoutUser === "function") logoutUser();
        else console.warn("Fun√ß√£o logoutUser() n√£o encontrada.");
      }
    });
  }
});



window.printOrder = function(orderId) {
  const order = orders.find(o => o.id === orderId);
  if (!order) return alert('Pedido n√£o encontrado.');

  // Fun√ß√µes auxiliares (assumindo que j√° existem no escopo global do HTML)
  // formatBRL(value)
  // formatCPFCNPJ(value) - Precisa ser criada ou assumida

  // Dados fict√≠cios ou extra√≠dos do objeto 'order'
  const orderDate = new Date(order.createdAt).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
  const orderTime = new Date(order.createdAt).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
  const deliveryTime = order.deliveryTime || '30min a 1h'; // Assumindo que o tempo de entrega est√° em 'order.deliveryTime' ou um valor padr√£o
  const storeName = order.storeName || 'Acaiteria Creamy Purple'; // Assumindo que o nome da loja est√° em 'order.storeName' ou um valor padr√£o
  const orderNumber = order.orderNumber || order.id.substring(0, 7); // N√∫mero do pedido

  // Informa√ß√µes do Cliente
  const clientName = order.userName || 'N/A';
  const clientCpfCnpj = order.userCpfCnpj ? formatCPFCNPJ(order.userCpfCnpj) : 'N/A'; // Assumindo formatCPFCNPJ existe
  const clientPhone = order.userPhone || 'N/A';
  const clientOrderCount = order.userOrderCount || 'N/A'; // Assumindo que a contagem de pedidos est√° em 'order.userOrderCount'
  const clientAddress = order.address || 'N/A';
  const clientNeighborhood = order.neighborhood || 'N/A'; // Assumindo que o bairro est√° em 'order.neighborhood'

  // Informa√ß√µes de Pagamento
  let paymentMethod = 'N/A';
  if (order.paymentMethod === 'cash') {
    paymentMethod = 'Dinheiro' + (order.changeNeeded > 0 ? ` (Troco: ${formatBRL(order.changeNeeded)})` : '');
  } else if (order.paymentMethod === 'credit') {
    paymentMethod = 'Cart√£o de Cr√©dito';
  } else if (order.paymentMethod === 'debit') {
    paymentMethod = 'Cart√£o de D√©bito';
  } else if (order.paymentMethod === 'pix') {
    paymentMethod = 'PIX';
  }

  // Valores
  const subtotal = order.subtotal || order.total - (order.deliveryFee || 0); // Assumindo que subtotal existe ou pode ser calculado
  const deliveryFee = order.deliveryFee || 0;
  const total = order.total || 0;

  // Gera√ß√£o da lista de itens
  const itemsList = (order.items || []).map(item => {
    let itemHtml = `<div class="footer-line"><span>${item.qty}x ${item.name}</span><span>${formatBRL(item.price)}</span></div>`;
    if (item.addons && item.addons.length > 0) {
      item.addons.forEach(a => {
        itemHtml += `<div class="item-addon"> &nbsp; &nbsp; + ${a.qty}x ${a.name}</div>`;
      });
    }
    return itemHtml;
  }).join('');

  const printContent = `
    <html>
      <head>
        <title>Comanda - Pedido #${orderNumber}</title>
        <style>
          @page { size: 58mm auto; margin: 5mm; }
          body { font-family: monospace; font-size: 10px; line-height: 1.2; white-space: pre; }
          .center { text-align: center; }
          .right { text-align: right; }
          .line { border-top: 1px dashed #000; margin: 5px 0; }
          .bold { font-weight: bold; }
          .item-line { margin-left: 5px; }
          .footer-line { display: flex; justify-content: space-between; }
          .item-addon { margin-left: 10px; }
        </style>
      </head>
      <body>
===============================================
               COMANDA - PEDIDO
===============================================
<div class="center">${orderDate} ${orderTime}</div>
<div class="center">Entrega prevista: ${deliveryTime}</div>
<div class="center">${storeName}</div>
<div class="center bold">===============================================</div>
<div class="center bold">                Pedido:</div>
<div class="line"></div>
<div class="bold">Itens:</div>
<div class="items-list">${itemsList}</div>
<div class="line"></div>
<div class="bold">Cliente</div>

Nome: ${clientName}
CPF/CNPJ: ${clientCpfCnpj}
Telefone: ${clientPhone}
Quantidade de pedidos: ${clientOrderCount}
Endere√ßo: ${clientAddress}
Bairro: ${clientNeighborhood}
<div class="line"></div>
<div class="bold">Pagamento</div>

Forma de Pagamento: ${paymentMethod}
<div class="line"></div>
<div class="footer-line"><span>Subtotal:</span><span>${formatBRL(subtotal)}</span></div>
<div class="footer-line"><span>Taxa de entrega:</span><span>${formatBRL(deliveryFee)}</span></div>
<div class="footer-line"><span>Total:</span><span>${formatBRL(total)}</span></div>
<div class="line"></div>
      </body>
    </html>
  `;

  const win = window.open('', 'PRINT', 'height=600,width=400');
  win.document.write(printContent);
  win.document.close();
  win.focus();
  win.print();
}

</script>
<style>
  :root{
    --primary:#800080;
    --muted:#7d8590;
    --bg:#f5f6f7;
    --card:#ffffff;
    --radius:12px;
    font-family:Inter, "Helvetica Neue", Arial, sans-serif;
    color:#222;
  }
  *{box-sizing:border-box}
  /* Ajuste de padding padr√£o */
  body{margin:0;background:var(--bg);padding:18px;display:flex;justify-content:center}
  .app{width:100%;max-width:1200px}
  header.banner{
    background:linear-gradient(90deg,var(--primary),#ff6b6b);
    color:#fff;border-radius:12px;padding:18px;display:flex;align-items:center;gap:16px;margin-bottom:14px;
  }
  header.banner img.logo{width:72px;height:72px;border-radius:50%;object-fit:cover;background:#fff;}
  header .meta h1{margin:0;font-size:20px}
  header .meta p{margin:6px 0 0;color:rgba(255,255,255,0.95);font-size:13px}
  .controls{display:flex;gap:12px;align-items:center;margin-bottom:10px;flex-wrap:wrap}
  .search{flex:1;display:flex;align-items:center;background:#fff;padding:8px;border-radius:10px}
  .search input{border:0;outline:0;width:100%;font-size:15px}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:14px}
  
  /* --- IN√çCIO: AJUSTES DE RESPONSIVIDADE (MOBILE) --- */
  
  /* Esconde o user-badge que est√° no footer em telas grandes (desktop) */
  .user-badge.only-mobile {
      display: none;
  }

  /* Ajuste para telas menores que 1024px (tablets e celular) */
  @media (max-width:1024px){ 
    .grid{grid-template-columns:1fr; } 
    
    /* Torna o painel do carrinho responsivo e centralizado */
    .cart-panel{
      position:fixed;
      bottom:90px; /* 90px de dist√¢ncia do rodap√© fixo */
      width:min(90%, 320px); 
      left: 50%; 
      transform: translateX(-50%);
      right: auto; 
      z-index:60;
    }

    /* Esconde o status do rodap√© para dar espa√ßo aos bot√µes */
    #footerStatus {
        display: none; 
    }

    /* Mostra o user-badge do footer em mobile, ao lado do bot√£o do carrinho */
    .user-badge.only-mobile {
        display: flex; /* Agora vis√≠vel em mobile */
        margin-right: 10px; /* Adiciona um pequeno espa√ßamento do bot√£o ao lado */
    }

    /* Reduz o tamanho do bot√£o no footer para caber melhor */
    .footer-content-wrapper .btn {
      padding: 8px 10px;
      font-size: 14px;
    }
  }

  /* Ajuste para telas muito pequenas (celulares estreitos) */
  @media (max-width:600px){
    body{padding: 10px;} 
    header.banner{padding: 12px;} 
    header.banner img.logo{width: 60px; height: 60px;} 
    .controls{gap: 8px;} 
  }

  /* Ajuste para o rodap√© fixo */
  .footer-fixed{
      position:fixed;
      left:0;
      right:0;
      bottom:0;
      background:#fff;
      border-top:1px solid #eee;
      padding:10px; 
      display:flex;
      justify-content:center;
      z-index:90;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.05); 
  }
  
  /* Novo wrapper para alinhar o conte√∫do do rodap√© com o max-width do app */
  .footer-content-wrapper {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      max-width: 1200px;
      padding: 0 8px; 
  }
  /* --- FIM: AJUSTES DE RESPONSIVIDADE (MOBILE) --- */

  .side{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.06)}
  main {
      overflow-y: auto;
      min-height: 0; 
  }
  .items{
      display:flex;
      flex-direction:column;
      gap:6px;
      padding-bottom: 30px; 
  }
  .categories{display:flex;gap:8px;overflow-x:auto;padding-bottom:10px; /* Espa√ßo para a barra de rolagem */}.categories::-webkit-scrollbar{height:4px;}.categories::-webkit-scrollbar-thumb{background:var(--primary);border-radius:2px;}.categories button{flex-shrink:0;display:inline-block;text-align:center;padding:6px 12px;border-radius:20px;border:1px solid #ddd;background:#f5f5f5;margin-bottom:0;cursor:pointer;font-size:14px;transition:background 0.2s, border-color 0.2s;}
  
  .categories button.active{background:var(--primary);color:#fff;border-color:var(--primary);font-weight:700}.item{display:flex;gap:12px;align-items:flex-start;background:var(--card);padding:12px;border-radius:12px;box-shadow:0 6px 14px rgba(0,0,0,0.04)}
  .item img{width:110px;height:90px;object-fit:cover;border-radius:10px}
  .item .info h3{margin:0;display:flex;justify-content:space-between;align-items:center;gap:12px}
  .item .info p{margin:6px 0 10px;color:var(--muted)}
  .actions{display:flex;flex-direction:column;gap:8px;align-items:flex-end}
  .btn{background:var(--primary);color:#fff;padding:8px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
  .pill{background:#fff;padding:6px 10px;border-radius:10px;border:1px solid #eee;cursor:pointer}
  .qty{display:flex;gap:6px;align-items:center;background:#fff;padding:6px;border-radius:8px}
  .qty button{border:0;background:transparent;font-size:18px;cursor:pointer}
  .modal{position:fixed;left:0;top:0;right:0;bottom:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:80;padding:12px}
  .modal.open{display:flex}
  .modal .card{background:#fff;border-radius:12px;padding:16px;width:100%;max-width:1000px;max-height:85vh;overflow:auto}
  .addon-group{border:1px solid #f1f1f1;padding:12px;border-radius:8px;margin-bottom:12px}
  .addon-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .addon-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-top:1px solid #fbfbfb}
  .addon-controls{display:flex;gap:8px;align-items:center}
  .addon-controls button{background:#fff;border:1px solid #eee;border-radius:6px;padding:6px 10px;cursor:pointer}
  .addon-controls .count{min-width:28px;text-align:center;display:inline-block}
  .cart-panel{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.08)}
  .admin-bar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
  .meta-addon-info{font-size:12px;color:var(--muted);margin-top:4px}
  .hidden{display:none}
  .auth-tabs{display:flex;gap:8px;margin-bottom:16px}
  .auth-tabs button{flex:1;padding:10px;border:0;background:#f5f5f5;border-radius:8px;cursor:pointer;font-weight:600}
  .auth-tabs button.active{background:var(--primary);color:#fff}
  .admin-tabs{display:flex;gap:8px;margin-bottom:16px;border-bottom:1px solid #eee;padding-bottom:8px;overflow-x:auto;}
  .admin-tabs button{flex-shrink:0;padding:10px 15px;border:0;background:#f5f5f5;border-radius:8px;cursor:pointer;font-weight:600;}
  .admin-tabs button.active{background:var(--primary);color:#fff;}
  .admin-panel{padding-top:10px;}
  
  /* CORRE√á√ÉO DO GR√ÅFICO: Define altura para o cont√™iner */
  #salesPanel { 
      height: 400px; 
      padding-bottom: 20px; 
  } 
  #salesChart { 
      width: 100%; 
      height: 100%; 
  }

  .form-group{margin-bottom:14px}
  .form-group label{display:block;margin-bottom:6px;font-weight:600;font-size:14px}
  .form-group input, .form-group select, .form-group textarea{width:100%;padding:10px;border:1px solid #e1e1e1;border-radius:8px;font-size:14px}
  .user-badge{background:#fff;padding:6px 12px;border-radius:20px;display:flex;align-items:center;gap:8px;cursor:pointer}
  .user-badge:hover{background:#f9f9f9}
  .item-management-note { background: #fff7e6; padding: 10px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid #ff9800; }
  .addon-group-settings { margin-bottom: 15px; padding: 10px; border: 1px solid #e9ecef; border-radius: 6px; background: #f8f9fa; }
  .addon-item-row { display: flex; gap: 8px; align-items: center; margin-bottom: 6px; }
  .addon-item-row input { flex: 1; }
  .delivery-area-row { display: flex; gap: 10px; align-items: center; margin-bottom: 8px; padding: 8px; border: 1px solid #eee; border-radius: 6px; }
  .delivery-area-row input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
  .delivery-area-row .area-name-input { flex: 2; }
  .delivery-area-row .area-fee-input { flex: 1; max-width: 100px; }

  /* --- CORRE√á√ÉO DE Z-INDEX PARA MODAL DE ADICIONAIS --- */
  #modal { z-index: 200 !important; }


/* === NOVO LAYOUT DE CARDS PARA CLIENTE === */
.menu-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 14px;
  width: 100%;
}

.menu-card {
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  overflow: hidden;
  text-align: center;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.menu-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 20px rgba(0,0,0,0.1);
}
.menu-card-img {
  width: 100%;
  height: 140px;
  object-fit: cover;
}
.menu-card-body {
  padding: 10px;
}
.menu-card-title {
  font-size: 15px;
  margin: 6px 0 4px;
  color: #333;
}
.menu-card-price {
  font-weight: 700;
  color: var(--primary);
  margin-bottom: 8px;
}
.menu-card-btn {
  width: 100%;
  background: var(--primary);
  color: #fff;
  border: none;
  border-radius: 10px;
  padding: 8px 12px;
  font-weight: 600;
  cursor: pointer;
}
.menu-card-btn:hover {
  opacity: 0.9;
}


/* === Drawer de Pedidos === */
.drawer {
  position: fixed;
  left: 0;
  right: 0;
  bottom: -100%;
  background: var(--card);
  border-top-left-radius: 16px;
  border-top-right-radius: 16px;
  box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
  padding: 18px;
  transition: bottom 0.35s ease;
  z-index: 250;
  max-height: 80vh;
  overflow-y: auto;
}
.drawer.open { bottom: 0; }

.drawer h4 {
  color: var(--primary);
  margin-top: 0;
  margin-bottom: 12px;
}






/* === Bot√£o Pedidos igual ao Entrar === */
#btnViewOrders {
  background-color: inherit !important; /* cor do rodap√© */
  color: #000 !important;               /* texto preto */
  border: none !important;
  border-radius: 8px;
  padding: 8px 12px;
  font-weight: 600;
}
#btnViewOrders:hover {
  opacity: 0.9;
}


/* === CORRE√á√ÉO DE LAYOUT ADMIN (CATEGORIAS E ITENS) === */

/* For√ßa o conte√∫do principal a respeitar o limite da tela */
.app {
  max-width: 100%;
  overflow-x: hidden;
}

/* Mant√©m o grid alinhado no mobile */
@media (max-width: 1024px) {
  .grid {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  main, .side {
    width: 100% !important;
    max-width: 100%;
  }

  /* Corrige as categorias para n√£o estourarem a largura */
  .categories {
    display: flex;
    flex-wrap: nowrap;
    overflow-x: auto;
    padding: 8px 0;
    margin: 0;
  }
  .categories > div,
  .categories > button {
    flex-shrink: 0;
    max-width: 90%;
  }

  /* Corrige os bot√µes de categoria do admin */
  .categories div {
    flex: 0 0 auto;
    display: flex;
    align-items: center;
    gap: 6px;
    margin-right: 6px;
  }

  /* Ajusta itens do card√°pio */
  .item {
    flex-direction: column;
    align-items: flex-start;
    width: 100%;
  }
  .item img {
    width: 100%;
    height: auto;
    border-radius: 10px;
  }
  .item .info {
    width: 100%;
  }

  /* Ajusta modais para caber na tela */
  .modal .card {
    width: 95% !important;
    max-width: 95% !important;
  }
}

/* Corrige o grid em telas grandes */
@media (min-width: 1025px) {
  .categories {
    flex-wrap: wrap;
    justify-content: flex-start;
  }
  .categories div {
    display: flex;
    align-items: center;
    gap: 6px;
    margin: 4px;
  }
}

</style>
</head>
<body>
  <div class="app" id="app">
    <header class="banner">
      <img class="logo" id="logo" src="" alt="Logo">
      <div class="meta">
        <h1 id="name">Creamy Purple</h1>
        <p id="addr">R ALCIDES RODRIGUES PONTES ‚Ä¢ <span id="status">Aberto at√© as 23:00</span></p>
      </div>
      <div style="margin-left:auto;text-align:right">
      </div>
      </header>

    <div class="controls">
      <div class="search"><input id="q" placeholder="Buscar no card√°pio ‚Äî ex: calabresa, bacon..." /></div>
      <div id="adminControls" class="hidden">
        <button class="pill" id="btnAdminPanel">Painel Admin</button>
        <button class="pill" id="btnExport">Exportar JSON</button>
        <button class="pill" id="btnImport">Importar JSON</button>
        <button class="pill" id="logoutBtn">Sair</button>
        <input id="fileImport" type="file" accept=".json" style="display:none" />
      </div>
      <div style="margin-left:auto" class="admin-bar" id="adminBar">
        <button class="pill" id="btnReset" style="background:#dc3545; color:white;">Reset demo (Firebase)</button>
      </div>
    </div>

    <div class="grid">
      <main>
        <div class="categories" id="cats">
  <button class="active">Todas</button>
  <button>Pizzas Salgadas</button>
  <button>Pizzas Doces</button>
  <button>Esfihas</button>
  <button>Bebidas</button>
  <button>Sobremesas</button>
  <button>Combos Especiais</button>
  <button>Promo√ß√µes do Dia</button>
  <button>Lanches</button>
  <button>Sucos Naturais</button>
</div>
        <div id="items" class="items"></div>

        <div class="modal" id="adminModal">
          <div class="card" role="dialog" aria-modal="true" style="max-width:1000px">
            <h3>Painel de Administra√ß√£o</h3>
            <div class="admin-tabs">
              <button id="tabOrders" class="active">Pedidos em Tempo Real</button>
              <button id="tabSales">Relat√≥rio de Vendas</button>
              <button id="tabCustomers">Controle de Clientes</button>
              <button id="tabSettings">Configura√ß√µes da Loja</button>
              <button id="tabPDV">PDV (Mesas)</button>
              <button id="btnComandaAvulsa" class="pill" style="background:#ffe6b3; color:#663300; font-weight:700; margin-left:6px;">Comanda Avulsa</button>
              <button id="closeAdminModal" style="text-align:right;margin-top:16px">Fechar</button>
            </div>

            <div id="adminContent">
              <div id="ordersPanel" class="admin-panel">
                <h4>Pedidos Atuais</h4>
                <div id="currentOrdersList"></div>
              </div>
              
<div id="salesPanel" class="admin-panel hidden">
  <h4>Relat√≥rio de Vendas</h4>

  <!-- Filtro de Per√≠odo -->
  <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px;">
    <div style="font-weight:700;">Per√≠odo:</div>
    <div id="periodFilters" style="display:flex;gap:8px;margin-left:6px">
      <button class="pill period-btn active" data-period="day">Dia</button>
      <button class="pill period-btn" data-period="week">Semana</button>
      <button class="pill period-btn" data-period="month">M√™s</button>
    </div>
    <div style="margin-left:auto;font-size:13px;color:var(--muted)">Apenas pedidos com status <strong>entregue</strong> s√£o considerados.</div>
  </div>

  <!-- Cards Resumo -->
  <div id="salesSummaryCards" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:14px">
    <div class="side" style="padding:12px;text-align:left">
      <div style="font-size:13px;color:var(--muted)">Faturamento Total</div>
      <div id="cardRevenue" style="font-weight:800;font-size:20px;margin-top:6px">R$ 0,00</div>
    </div>
    <div class="side" style="padding:12px;text-align:left">
      <div style="font-size:13px;color:var(--muted)">Quantidade de Vendas</div>
      <div id="cardCount" style="font-weight:800;font-size:20px;margin-top:6px">0</div>
    </div>
    <div class="side" style="padding:12px;text-align:left">
      <div style="font-size:13px;color:var(--muted)">Ticket M√©dio</div>
      <div id="cardAvg" style="font-weight:800;font-size:20px;margin-top:6px">R$ 0,00</div>
    </div>
    <div class="side" style="padding:12px;text-align:left">
      <div style="font-size:13px;color:var(--muted)">√Årea com Mais Pedidos</div>
      <div id="cardTopArea" style="font-weight:800;font-size:16px;margin-top:6px">N/A</div>
    </div>
  </div>

  <!-- Tabelas -->
  <div style="display:grid;grid-template-columns:1fr;gap:12px">
    <div class="side" style="padding:12px">
      <h5 style="margin:0 0 8px">Top 10 Produtos Mais Vendidos</h5>
      <div style="overflow:auto">
        <table id="tableTopProducts" style="width:100%;border-collapse:collapse">
          <thead>
            <tr style="text-align:left;color:var(--muted);font-size:13px">
              <th style="padding:8px;border-bottom:1px solid #eee">Posi√ß√£o</th>
              <th style="padding:8px;border-bottom:1px solid #eee">Produto</th>
              <th style="padding:8px;border-bottom:1px solid #eee">Quantidade</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="side" style="padding:12px">
      <h5 style="margin:0 0 8px">Formas de Pagamento</h5>
      <div style="overflow:auto">
        <table id="tablePayments" style="width:100%;border-collapse:collapse">
          <thead>
            <tr style="text-align:left;color:var(--muted);font-size:13px">
              <th style="padding:8px;border-bottom:1px solid #eee">M√©todo</th>
              <th style="padding:8px;border-bottom:1px solid #eee">Quantidade</th>
              <th style="padding:8px;border-bottom:1px solid #eee">%</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="side" style="padding:12px">
      <h5 style="margin:0 0 8px">Performance por √Årea de Entrega</h5>
      <div style="overflow:auto">
        <table id="tableAreas" style="width:100%;border-collapse:collapse">
          <thead>
            <tr style="text-align:left;color:var(--muted);font-size:13px">
              <th style="padding:8px;border-bottom:1px solid #eee">√Årea</th>
              <th style="padding:8px;border-bottom:1px solid #eee">Pedidos</th>
              <th style="padding:8px;border-bottom:1px solid #eee">Total (R$)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>
<div id="customersPanel" class="admin-panel hidden">
                <h4>Controle de Clientes</h4>
                <div id="customersList"></div>
              </div>
              <div id="settingsPanel" class="admin-panel hidden">
                <h4>Configura√ß√µes da Loja</h4>
                <form id="storeSettingsForm">
                  <div class="form-group">
                    <label for="restaurantName">Nome da Loja</label>
                    <input type="text" id="restaurantName" required>
                  </div>
                  <div class="form-group">
                    <label for="restaurantAddress">Endere√ßo</label>
                    <input type="text" id="restaurantAddress" required>
                  </div>
                  <div class="form-group" id="savedAddressesGroup" style="display:none;">
                    <label for="savedAddresses">Endere√ßos Salvos</label>
                    <select id="savedAddresses" class="form-control">
                      <option value="">Selecionar um endere√ßo salvo...</option>
                      <option value="Casa">Casa (Rua Exemplo, 123, Cidade)</option>
                      <option value="Trabalho">Trabalho (Av. Principal, 456, Cidade)</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label for="restaurantStatus">Status (Hor√°rio de Funcionamento)</label>
                    <input type="text" id="restaurantStatus" placeholder="Ex: Aberto at√© as 23:00" required>
                  </div>
                  
                  <div class="form-group">
                    <label for="restaurantLogoFile">Logo da Loja (Escolha Arquivo)</label>
                    <input type="file" id="restaurantLogoFile" accept="image/*">
                    <div style="margin-top:10px;"><img id="currentLogoPreview" src="" alt="Pr√©via do Logo" style="max-width:100px; height:auto; border-radius:8px;"></div>
                    <input type="hidden" id="restaurantLogoUrl"> </div>
                  <h5 style="margin-top:20px;">Taxas de Entrega por √Årea</h5>
                  <div id="deliveryAreasList">
                    </div>
                  <button type="button" class="pill" id="btnAddDeliveryArea" style="background:#e6ffe6; color:#28a745; margin-bottom:10px;">+ Adicionar √Årea de Entrega</button>
                  <div style="text-align:right;margin-top:16px">
                    <button type="submit" class="btn">Salvar Configura√ß√µes</button>
                  </div>
                </form>
              </div>
              <div id="pdvPanel" class="admin-panel hidden">
                <h4>PDV ‚Äî Gest√£o de Mesas</h4>
                <div id="pdvTablesGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px;"></div>
              </div>
            </div>
          </div>
        </div>

      </main>

      <aside class="side cart-panel" id="cartPanel">
        <h4>Carrinho</h4>
        <div id="cartList"></div>
        <div style="margin-top:10px;display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="small">Subtotal</div>
            <div id="subtotal" style="font-weight:800">R$ 0,00</div>
          </div>
          <div>
            <button id="btnCheckout" class="btn">Finalizar</button>
          </div>
        </div>
      </aside>
    </div>

    <div class="modal" id="itemDetailsModal">
      <div class="card" role="dialog" aria-modal="true" style="max-width:500px">
        <h3 id="itemDetailsModalTitle">Adicionar Novo Item</h3>
        <form id="itemDetailsForm">
          <input type="hidden" id="itemIdDetails" />
          <div class="form-group">
            <label for="itemName">Nome do Item</label>
            <input type="text" id="itemName" required>
          </div>
          <div class="form-group">
            <label for="itemDesc">Descri√ß√£o</label>
            <textarea id="itemDesc" rows="3" required></textarea>
          </div>
          <div class="form-group">
            <label for="itemPrice">Pre√ßo (R$)</label>
            <input type="number" id="itemPrice" step="0.01" required>
          </div>
          <div class="form-group">
            <label for="itemCategory">Categoria</label>
            <select id="itemCategory" required></select>
          </div>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px">
            <button type="button" id="itemDetailsCancel" class="pill">Cancelar</button>
            <button type="submit" class="btn" id="itemDetailsSubmit">Salvar Detalhes</button>
          </div>
        </form>
      </div>
    </div>

    <div class="modal" id="addonManagementModal">
      <div class="card" role="dialog" aria-modal="true" style="max-width:800px">
        <h3 id="addonManagementTitle">Gerenciar Adicionais para <span id="addonItemName" style="color:var(--primary);"></span></h3>
        
        <div id="addonGroupsList"></div>
        
        <div style="margin-top:16px; display:flex; justify-content:space-between; align-items:center;">
          <button type="button" class="btn" id="btnAddAddonGroup" style="background:#28a745;">+ Adicionar Grupo</button>
          <div>
            <button type="button" id="addonManagementCancel" class="pill">Cancelar</button>
            <button type="button" class="btn" id="addonManagementSubmit">Salvar Adicionais</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal" id="imageEditModal">
      <div class="card" role="dialog" aria-modal="true" style="max-width:500px">
        <h3 id="imageEditModalTitle">Editar Imagem para <span id="imageItemName" style="color:var(--primary);"></span></h3>
        <form id="imageEditForm">
          <input type="hidden" id="itemIdImage" />
          
          <div class="form-group">
            <label for="itemImgFile">Escolher Imagem do Item</label>
            <input type="file" id="itemImgFile" accept="image/*">
            <input type="hidden" id="itemImgUrl"> </div>
          <div style="text-align:center; margin-bottom:16px;">
             <img id="currentImagePreview" src="" alt="Pr√©via" style="max-width:100%; height:auto; border-radius:8px; margin-top:10px;">
          </div>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px">
            <button type="button" id="imageEditCancel" class="pill">Cancelar</button>
            <button type="submit" class="btn" id="imageEditSubmit">Salvar Imagem</button>
          </div>
        </form>
      </div>
    </div>


    <div class="modal" id="modal">
      <div class="card" role="dialog" aria-modal="true">
        <h3 id="modalTitle">Adicionais</h3>
        <div style="display:flex;gap:12px;align-items:center;margin-bottom:8px">
          <div><strong id="modalItemName"></strong></div>
          <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
            <div class="small">Quantidade do item:</div>
            <div class="qty" id="itemQtyControls">
              <button data-action="decrement-qty">-</button>
              <span id="modalItemQty">1</span>
              <button data-action="increment-qty">+</button>
            </div>
          </div>
        </div>
        <div id="modalAddons"></div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
          <div class="small">Total do item: <strong id="modalTotal">R$ 0,00</strong></div>
          <div>
            <button id="modalCancel" class="pill">Cancelar</button>
            <button id="modalConfirm" class="btn">Adicionar ao carrinho</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal" id="authModal">
      <div class="card" role="dialog" aria-modal="true" style="max-width:420px">
        <h3 id="authTitle">Entrar / Cadastrar</h3>
        <div class="auth-tabs">
          <button id="tabLogin" class="active">Entrar</button>
          <button id="tabRegister">Cadastrar</button>
        </div>
        
        <div id="loginForm">
          <div class="form-group">
            <label>Email ou usu√°rio</label>
            <input type="text" id="loginUser" placeholder="seu@email.com">
          </div>
          <div class="form-group">
            <label>Senha</label>
            <input type="password" id="loginPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
          </div>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px">
            <button id="loginCancel" class="pill">Cancelar</button>
            <button id="loginSubmit" class="btn">Entrar</button>
          </div>
        </div>

        <div id="registerForm" class="hidden">
          <div class="form-group">
            <label>Nome completo</label>
            <input type="text" id="regName" placeholder="Jo√£o Silva">
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="regEmail" placeholder="seu@email.com">
          </div>
          <div class="form-group">
            <label>Telefone</label>
            <input type="tel" id="regPhone" placeholder="(11) 99999-9999">
          </div>
          <div class="form-group">
            <label>Senha</label>
            <input type="password" id="regPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
          </div>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px">
            <button id="registerCancel" class="pill">Cancelar</button>
            <button id="registerSubmit" class="btn">Cadastrar</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal" id="profileModal">
      <div class="card" role="dialog" aria-modal="true" style="max-width:600px">
        <h3>Meu Perfil</h3>
        <div style="background:#f9f9f9;padding:12px;border-radius:8px;margin-bottom:16px">
          <div style="display:flex;justify-content:space-between;margin-bottom:8px">
            <strong id="profileName"></strong>
            <button class="pill" id="logoutBtn">Sair</button>
          </div>
          <div class="small" id="profileEmail"></div>
          <div class="small" id="profilePhone"></div>

          <h4 style="margin-top:20px;">Meus Endere√ßos Salvos</h4>
          <div id="savedUserAddressesList">
            </div>
          <div class="form-group" style="margin-top:15px;">
            <label for="newAddressInput">Adicionar Novo Endere√ßo</label>
            <input type="text" id="newAddressInput" placeholder="Ex: Rua Exemplo, 123 - Bairro - Cidade" />
          </div>
          <button type="button" class="btn" id="btnAddUserAddress" style="background:#28a745; margin-bottom:15px;">Salvar Endere√ßo</button>

          <hr/>
        </div>
        
        <h4>Meus Pedidos</h4>
        <div id="profileOrders"></div>
        
        <div style="text-align:right;margin-top:16px">
          <button id="closeProfile" class="btn">Fechar</button>
        </div>
      </div>
    </div>

    
    <div class="modal" id="pdvOrderModal">
      <div class="card" role="dialog" aria-modal="true" style="max-width:900px">
        <button id="closePdvOrderModal" class="pill" style="position:absolute; top:10px; right:10px; background:#eee; border:none; border-radius:8px; padding:8px 10px; cursor:pointer;">‚ùå</button>
<h3 id="pdvOrderTitle">Pedido ‚Äî Mesa</h3>
        <div style="display:flex;gap:12px;align-items:flex-start">
          <div style="flex:1; max-width:480px;">
            <h4>Itens do Card√°pio</h4>
            <div id="pdvItemsList" style="max-height:420px; overflow:auto;"></div>
          </div>
          <div style="width:360px;background:#fafafa;padding:12px;border-radius:8px;">
            <h4>Pedido da Mesa</h4>
            <div id="pdvCartList" style="max-height:360px; overflow:auto;"></div>
            <div style="margin-top:10px;display:flex;justify-content:space-between;align-items:center">
              <div>
                <div class="small">Subtotal</div>
                <div id="pdvSubtotal" style="font-weight:800">R$ 0,00</div>
              </div>
              <div>
                <button id="pdvFinalizeBtn" class="btn" style="background:#28a745">Enviar para Cozinha e Fechar Mesa</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    
    
    <div class="modal" id="comandaModal">
      <div class="card" role="dialog" aria-modal="true" style="max-width:520px; position:relative;">
        <h3 style="margin:0 0 10px;">Criar Comanda Avulsa</h3>
        <form id="comandaForm" style="display:flex;flex-direction:column;gap:10px;">
          <div class="form-group">
            <label for="comandaName">Nome do Cliente</label>
            <input type="text" id="comandaName" required placeholder="Ex: Jo√£o Silva">
          </div>
          <div class="form-group">
            <label for="comandaValue">Valor a ser cobrado (R$)</label>
            <input type="number" id="comandaValue" step="0.01" required placeholder="Ex: 25.00">
          </div>
          <div class="form-group">
            <label for="comandaPayment">Forma de Pagamento</label>
            <select id="comandaPayment" required>
              <option value="pix">Pix</option>
              <option value="credit">Cart√£o de Cr√©dito</option>
              <option value="debit">Cart√£o de D√©bito</option>
              <option value="cash">Dinheiro</option>
            </select>
          </div>
          <div class="form-group">
            <label for="comandaCPF">CPF na nota (opcional)</label>
            <input type="text" id="comandaCPF" placeholder="000.000.000-00">
          </div>
          <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:6px;">
            <button type="button" id="comandaCancel" class="pill">Cancelar</button>
            <button type="submit" id="comandaSave" class="btn">Salvar Comanda</button>
          </div>
        </form>
      </div>
    </div>
    
<div class="modal" id="checkoutModal">
      <div class="card" role="dialog" aria-modal="true" style="max-width:600px">
        <h3>Finalizar Pedido</h3>
        
        <form id="checkoutForm"> 
            <div id="checkoutContent">
              <h4>Seus Dados</h4>
              <div class="form-group">
                <label for="checkoutName">Nome Completo</label>
                <input type="text" id="checkoutName" placeholder="Seu nome" required>
              </div>
              <div class="form-group">
                <label for="checkoutAddress">Endere√ßo de Entrega</label>
                <input type="text" id="checkoutAddress" placeholder="Rua, n√∫mero, bairro, complemento" required>
    <div class="form-group" id="checkoutSavedAddressesGroup" style="display:none; margin-top: 10px;">
      <label for="checkoutSavedAddresses">Ou selecione um endere√ßo salvo:</label>
      <select id="checkoutSavedAddresses" class="form-control">
        <option value="" disabled selected>Selecione um endere√ßo salvo...</option>
      </select>
    </div>
              <div class="form-group">
                <label for="checkoutCPF">CPF na nota (opcional)</label>
                <input type="text" id="checkoutCPF" placeholder="000.000.000-00">
              </div>

              </div>
              <div class="form-group">
                <label for="checkoutPhone">Telefone</label>
                <input type="tel" id="checkoutPhone" placeholder="(XX) XXXXX-XXXX" required>
              </div>
              
              <div class="form-group">
                  <label for="deliveryAreaSelect">√Årea de Entrega (Para c√°lculo da taxa)</label>
                  <select id="deliveryAreaSelect" required>
                      <option value="" disabled selected>Selecione sua √°rea...</option>
                      </select>
              </div>
              <h4>Forma de Pagamento</h4>
              <div class="form-group">
                <label>Escolha uma op√ß√£o:</label>
                <div>
                  <input type="radio" id="paymentCredit" name="paymentMethod" value="credit" checked>
                  <label for="paymentCredit">Cart√£o de Cr√©dito</label>
                </div>
                <div>
                  <input type="radio" id="paymentDebit" name="paymentMethod" value="debit">
                  <label for="paymentDebit">Cart√£o de D√©bito</label>
                </div>
                <div>
                  <input type="radio" id="paymentCash" name="paymentMethod" value="cash">
                  <label for="paymentCash">Dinheiro</label>
                </div>
              </div>
              <div class="form-group" id="cashChangeGroup" style="display:none;">
                <label for="cashChange">Precisa de troco para quanto?</label>
                <input type="number" id="cashChange" placeholder="Ex: 50.00">
              </div>

              <h4>Resumo do Pedido</h4>
              <div id="checkoutCartSummary"></div>
              <div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:4px;border-top:1px solid #eee;padding-top:8px;margin-top:8px;">
                <span>Subtotal:</span>
                <span id="checkoutSubtotal">R$ 0,00</span>
              </div>
              <div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:8px;">
                <span>Taxa de Entrega (<span id="checkoutAreaName">N/A</span>):</span>
                <span id="checkoutDeliveryFee">R$ 0,00</span>
              </div>
              <div style="margin-top:10px;display:flex;justify-content:space-between;align-items:center">
                <div>
                  <div class="small">Total Geral</div>
                  <div id="checkoutTotal" style="font-weight:800; color:var(--primary);">R$ 0,00</div>
                </div>
              </div>

            </div>
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px">
              <button type="button" id="checkoutCancel" class="pill">Cancelar</button>
              <button type="submit" id="checkoutSubmit" class="btn" disabled>Confirmar Pedido</button>
            </div>
        </form>
        </div>
    </div>

    <div class="modal" id="confirmationModal">
      <div class="card" role="dialog" aria-modal="true" style="max-width:500px; text-align:center;">
        <h3 style="color:#28a745; margin-bottom: 0;">üéâ Pedido Confirmado!</h3>
        <h1 id="orderNumberDisplay" style="color:var(--primary); margin: 10px 0 20px; font-size: 32px;">#XXXXXXX</h1>

        <h4>Resumo do Pedido</h4>
        <div id="confirmationSummaryContent" style="text-align:left; border:1px solid #eee; padding: 12px; border-radius:8px;">
          </div>
        
        <p style="margin-top:20px; color:var(--muted); font-size:14px;">
            Acompanhe o status do pedido no Painel do Administrador (se for admin) ou no seu Perfil.
        </p>

        <div style="text-align:right;margin-top:16px">
          <button id="closeConfirmationModal" class="btn">Voltar ao Card√°pio</button>
        </div>
      </div>
    </div>

    <div class="footer-fixed">
      <div class="footer-content-wrapper" style="justify-content: space-around;">
        <div class="user-badge only-mobile" id="userBadge">
          <span id="userIcon">üë§</span>
          <span id="userName">Entrar</span>
        </div>

        <span id="footerStatus">Fa√ßa login para fazer pedidos</span>
        <button class="btn" id="btnViewOrders">üßæ Pedidos</button>    <button class="btn" id="btnViewCart">Ver Carrinho (<span id="cartCount">0</span>)</button>
      </div>
    </div>

  </div>

<script type="module">

// === FUN√á√ÉO PARA LISTAR CLIENTES COM PEDIDOS (FIREBASE) ===

async function renderCustomers() {
  const container = document.getElementById("customersList");
  container.innerHTML = `<p style="color:#888;">Carregando clientes...</p>`;

  try {
    const snapshot = await getDocs(ordersCollectionRef);
    const orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

    if (orders.length === 0) {
      container.innerHTML = `<p style="color:#777;">Nenhum cliente com pedidos encontrados.</p>`;
      return;
    }

    const clientsMap = {};
    for (const o of orders) {
      if (!o.userId || !o.userPhone) continue;
      const nome = (o.userName || "").toLowerCase();
      if (nome.includes("mesa") || nome.includes("comanda")) continue;

      if (!clientsMap[o.userId]) {
        clientsMap[o.userId] = {
          id: o.userId,
          name: o.userName || "Cliente sem nome",
          email: o.userEmail || "",
          phone: o.userPhone || "",
          address: o.address || "Endere√ßo n√£o informado",
          totalOrders: 1,
        };
      } else {
        clientsMap[o.userId].totalOrders++;
      }
    }

    const clients = Object.values(clientsMap);

    if (clients.length === 0) {
      container.innerHTML = `<p style="color:#777;">Nenhum cliente cadastrado encontrado.</p>`;
      return;
    }

    container.innerHTML = clients.map(u => `
      <div style="
        background:#fff;
        padding:14px 16px;
        border-radius:12px;
        margin-bottom:10px;
        box-shadow:0 3px 10px rgba(0,0,0,0.05);
        display:flex;
        justify-content:space-between;
        align-items:center;
        flex-wrap:wrap;
      ">
        <div style="flex:1;min-width:250px;">
          <strong style="font-size:16px;color:#333;">${u.name}</strong><br>
          <small style="color:#555;">üìû ${u.phone}</small><br>
          <small style="color:#555;">üè† ${u.address}</small><br>
          ${u.email ? `<small style="color:#555;">üìß ${u.email}</small><br>` : ""}
          <small style="color:#777;">üßæ Pedidos: ${u.totalOrders}</small>
        </div>
        ${u.phone ? `
        <a href="https://wa.me/${u.phone.replace(/\D/g,'')}" target="_blank"
           style="background:#25D366;color:white;padding:8px 12px;border-radius:10px;
                  text-decoration:none;font-weight:600;display:flex;align-items:center;gap:6px;">
           üí¨ WhatsApp
        </a>` : ''}
      </div>
    `).join("");

  } catch (err) {
    console.error("Erro ao carregar clientes:", err);
    container.innerHTML = `<p style="color:red;">Erro ao carregar clientes do Firebase.</p>`;
  }
}
window.renderCustomers = renderCustomers;



// =========================================================================
// === CONFIGURA√á√ÉO DO FIREBASE (CHAVES INSERIDAS PELO G√äMINI) ===
// =========================================================================
const firebaseConfig = {
    apiKey: "AIzaSyBYxYq65hf2zwBTKrwuFAg5AmS5iM88aLU", 
    authDomain: "luk123-b1986.firebaseapp.com", 
    projectId: "luk123-b1986", 
    storageBucket: "luk123-b1986.firebasestorage.app", 
    messagingSenderId: "55447377903", 
    appId: "1:55447377903:web:e9cbbcdba3a4ed5dc4081a"
};
// =========================================================================

// === INICIALIZA√á√ÉO DO FIREBASE E SDKs NECESS√ÅRIOS ===
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-app.js";
import { 
    getFirestore, collection, doc, getDoc, setDoc, updateDoc, 
    addDoc, query, orderBy, onSnapshot 
} from "https://www.gstatic.com/firebasejs/9.1.0/firebase-firestore.js";
import { getDocs } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-firestore.js";

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
// Documento √∫nico para o card√°pio e configura√ß√µes da loja
const menuDocRef = doc(db, "config", "cardapioData"); 
// Cole√ß√£o para pedidos, permitindo queries e tempo real
const ordersCollectionRef = collection(db, "orders"); 
// Cole√ß√£o para usu√°rios (opcional, mantendo o local storage para a demo)
const usersCollectionRef = collection(db, "users");

// Vari√°veis globais
let DATA = null; 
let orders = []; 
let users = []; 

const CART_KEY = "cardapio_cart_v1";
const ORDERS_KEY = "cardapio_orders_v1";

const ORDER_STATUSES = {
  pending: { label: 'Pendente', color: '#ffc107' },
  preparing: { label: 'Em Preparo', color: '#17a2b8' },
  ready: { label: 'Pronto para Entrega', color: '#28a745' },
  delivered: { label: 'Entregue', color: '#6c757d' },
  cancelled: { label: 'Cancelado', color: '#dc3545' }
};

const ADMIN_CREDENTIALS = {
  user: "admin",
  pass: "admin123"
};

let activeCat = null;
let cart = loadCart();
let modalState = null;
let pdvCartState = { tableId: null, items: [] }; // PDV temporary cart (admin use)

let itemState = null;
let addonManagerState = null;
let currentUser = null;
let isAdmin = false;
let salesChartInstance = null;
let lastPendingCount = 0; // Para notifica√ß√£o


const $ = sel => document.querySelector(sel);
const formatBRL = v => "R$ " + (v || 0).toFixed(2).replace(".",",");

// Fun√ß√µes de Storage (Mantidas para Carrinho e Login SIMPLIFICADO de Cliente)
function loadCart(){ try{ return JSON.parse(localStorage.getItem(CART_KEY)) || []; }catch(e){ return []; } }
function saveCart(){ localStorage.setItem(CART_KEY, JSON.stringify(cart)); }
function loadUsers(){ try{ return JSON.parse(localStorage.getItem("cardapio_users_v1")) || []; }catch(e){ return []; } }
function saveUsers(){ localStorage.setItem("cardapio_users_v1", JSON.stringify(users)); }

// =========================================================================
// === FUN√á√ïES DE PERSIST√äNCIA (FIREBASE) ===
// =========================================================================

/**
 * Carrega o card√°pio do Firestore (config/cardapioData).
 */
async function fetchMenuData() {
    try {
        // 1. Carrega o Card√°pio
        const menuSnap = await getDoc(menuDocRef);
        if (menuSnap.exists()) {
            DATA = menuSnap.data();
            console.log("Card√°pio carregado do Firebase.");
        } else {
            console.warn("Nenhum dado de card√°pio encontrado no Firebase. Usando Demo e salvando.");
            DATA = loadDemoData();
            // Salva a demo no Firebase para come√ßar a persist√™ncia
            await setDoc(menuDocRef, DATA);
        }

        // Inicializa a primeira categoria ativa
        if (DATA.categories.length > 0) {
            activeCat = DATA.categories[0].id;
        }

        renderAll();
        // Come√ßa a monitorar pedidos em tempo real imediatamente (ou ap√≥s login)
        setupRealtimeOrdersListener(); 

        return true;
    } catch (e) {
        console.error("Erro ao carregar card√°pio do Firebase:", e);
        alert("Erro ao conectar com o banco de dados. Carregando dados de demonstra√ß√£o local.");
        DATA = loadDemoData();
        renderAll();
        return false;
    }
}


/**
 * Salva o card√°pio (DATA) de volta para o Firestore.
 */
async function saveMenuData() {
    if (!isAdmin) {
        alert("Acesso negado. Apenas administradores podem salvar.");
        return false;
    }
    try {
        await setDoc(menuDocRef, DATA);
        console.log("Dados do card√°pio salvos no Firebase com sucesso!");
        return true;
    } catch (e) {
        console.error("Erro ao salvar card√°pio no Firebase:", e);
        alert("Falha ao salvar. Verifique as regras de seguran√ßa do seu Firebase.");
        return false;
    }
}

/**
 * Mant√©m o array 'orders' atualizado em tempo real e notifica o admin.
 */
function setupRealtimeOrdersListener() {
    // Busca todos os pedidos, ordenados pelo mais recente
    const q = query(ordersCollectionRef, orderBy("createdAt", "desc"));

    // onSnapshot: mant√©m a conex√£o aberta para updates em tempo real
    onSnapshot(q, (snapshot) => {
        const newOrders = ((snapshot.docs || [])).map(doc => ({ id: doc.id, ...doc.data() }));
        
        // Verifica se h√° novos pedidos pendentes APENAS se for Admin
        if (isAdmin) {
            const currentPending = ((newOrders || [])).filter(o => o.status === "pending").length;
            if (currentPending > lastPendingCount) {
                // Novo pedido detectado
                const newPendingOrders = ((newOrders || [])).filter(o => o.status === "pending");
                const latestNewOrder = newPendingOrders[0]; // O primeiro √© o mais recente, pois a query √© decrescente

                // 1. Notifica√ß√£o Sonora
                const audio = new Audio('https://www.soundjay.com/misc/bell-ringing-05.mp3'); // Som de sino de mesa 
                audio.play().catch(e => console.error("Erro ao tocar √°udio:", e));
                // 2. Janela visual dentro da p√°gina
                const popup = document.createElement("div");
                popup.innerHTML = `
                  <div style="
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    background: #fff;
                    border-radius: 12px;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.25);
                    padding: 16px 20px;
                    z-index: 9999;
                    display: flex;
                    align-items: center;
                    gap: 12px;
                    font-family: Arial, sans-serif;
                    border-left: 6px solid #28a745;
                    animation: fadeIn 0.4s ease;
                  ">
                    <img src="https://cdn-icons-png.flaticon.com/512/2331/2331970.png" 
                         style="width:42px;height:42px;border-radius:50%;object-fit:cover;">
                    <div>
                      <div style="font-weight:700;font-size:15px;color:#222;">üõí Novo Pedido Recebido!</div>
                      <div style="font-size:13px;color:#555;">
                        Pedido #${latestNewOrder.id.substring(0,7)} ‚Äî Total ${formatBRL(latestNewOrder.total)}
                      </div>
                    </div>
                  </div>
                `;
                document.body.appendChild(popup);
                setTimeout(() => popup.remove(), 8000);


                // 2. Notifica√ß√£o Visual (API de Notifica√ß√£o do Navegador)
                if (Notification.permission === "granted") {
                    new Notification("Novo Pedido Recebido!", {
                        body: `Pedido #${latestNewOrder.id.substring(0, 7)} - Total: ${formatBRL(latestNewOrder.total)}`,
                        icon: 'https://i.imgur.com/2Jt9r0X.png'
                    });
                }
            }
            lastPendingCount = currentPending;
        }

        orders = newOrders;
        
        // Atualiza as visualiza√ß√µes se estiverem abertas
        if (document.querySelector("#adminModal").classList.contains('open')) {
            renderAdminOrders();
            renderAdminDashboard();
        }
        if (document.querySelector("#profileModal").classList.contains('open')) {
            renderProfileOrders();
        }
    }, (error) => {
        console.error("Erro no listener de pedidos:", error);
    });
}


/**
 * Atualiza o status de um pedido no Firestore.
 * AGORA EXPOSTA GLOBALMENTE para uso no onchange do HTML
 */
async function updateOrderStatus(orderId, newStatus) {
  if (!isAdmin) return;
  
  try {
    const orderDocRef = doc(db, "orders", orderId);
    await updateDoc(orderDocRef, { status: newStatus });
    // O onSnapshot se encarregar√° de re-renderizar a lista automaticamente
  } catch (e) {
      console.error("Erro ao atualizar status no Firebase:", e);
      alert("Falha ao atualizar o status do pedido.");
  }
}

// =========================================================================
// === FUN√á√ïES DE AUTENTICA√á√ÉO E ADMIN (SIMPLIFICADAS E ADAPTADAS) ===
// =========================================================================

function doLogin(){
    const user = document.querySelector("#loginUser").value.trim();
    const pass = document.querySelector("#loginPass").value;
    
    if(!user || !pass){ alert("Preencha todos os campos"); return; }
    
    // Simula√ß√£o de Login de Admin
    if(user === ADMIN_CREDENTIALS.user && pass === ADMIN_CREDENTIALS.pass){ 
        currentUser = { id: "admin", name: "Administrador", email: "admin@sistema.com", isAdmin: true, savedAddresses: [] };
        isAdmin = true;
        closeAuthModal();
        updateUserBadge();
        toggleAdminUI();
        renderCategories();
        renderItems();
        // setupRealtimeOrdersListener j√° est√° ativo e come√ßa a notificar
        alert("Bem-vindo, Admin! Painel em Tempo Real (via Firebase) ativado. üéâ");
        return;
    }

    // SIMULA√á√ÉO DE LOGIN DE CLIENTE (usa array local 'users')
    const foundUser = users.find(u => (u.email === user || u.email === user) && u.password === pass);
    if(foundUser){
        currentUser = { id: foundUser.id, name: foundUser.name, email: foundUser.email, phone: foundUser.phone, isAdmin: false, savedAddresses: foundUser.savedAddresses || [] };
        isAdmin = false;
        closeAuthModal();
        updateUserBadge();
        toggleAdminUI();
        renderCategories();
        renderItems();
        alert(`Bem-vindo de volta, ${foundUser.name.split(" ")[0]}! (Conta Simples) üòä`);
        return;
    }
    
    alert("Credenciais inv√°lidas. Para Admin use: admin/admin123");
}

function doRegister(){
    const name = document.querySelector("#regName").value.trim();
    const email = document.querySelector("#regEmail").value.trim();
    const phone = document.querySelector("#regPhone").value.trim();
    const pass = document.querySelector("#regPass").value;
    
    if(!name || !email || !pass){ alert("Preencha nome, email e senha"); return; }
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if(!emailRegex.test(email)){ alert("Email inv√°lido"); return; }
    if(pass.length < 4){ alert("Senha deve ter pelo menos 4 caracteres"); return; }
    if(users.find(u => u.email === email)){ alert("Email j√° cadastrado"); return; }
    
    const newUser = { id: Date.now().toString(), name, email, phone, password: pass, createdAt: new Date().toISOString(), savedAddresses: [] };
    
    users.push(newUser);
    saveUsers(); // Salva no localStorage (para a demo)
    
    currentUser = { id: newUser.id, name: newUser.name, email: newUser.email, phone: newUser.phone, isAdmin: false, savedAddresses: [] };
    closeAuthModal();
    updateUserBadge();
    alert(`Cadastro realizado! Bem-vindo, ${name.split(" ")[0]}! üéâ`);
}


// =========================================================================
// === FUN√á√ÉO DE PEDIDO (AGORA PERSISTENTE FIREBASE) ===
// =========================================================================


async function finalizeOrder(e) {
  e.preventDefault();
  
  if (!currentUser) {
      alert("Voc√™ precisa estar logado para fazer o pedido.");
      return;
  }
  
  const selectedOption = document.querySelector("#deliveryAreaSelect").options[document.querySelector("#deliveryAreaSelect").selectedIndex];
  if (!selectedOption || selectedOption.value === "") {
      alert("Por favor, selecione sua √Årea de Entrega para calcular a taxa.");
      return;
  }

  const deliveryFee = parseFloat(selectedOption.dataset.fee);
  const subtotal = cart.reduce((sum, item) => sum + item.totalPrice, 0);
  const total = subtotal + deliveryFee;
  
  const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
  let changeNeeded = 0;

  if (paymentMethod === 'cash') {
    changeNeeded = parseFloat(document.querySelector("#cashChange").value) || 0;
    if (changeNeeded > 0 && changeNeeded < total) {
      alert("O valor do troco deve ser maior ou igual ao total do pedido.");
      return;
    }
  }

  const newOrder = {
    userId: currentUser.id,
    userName: document.querySelector("#checkoutName").value.trim(),
    userPhone: document.querySelector("#checkoutPhone").value.trim(),
    address: document.querySelector("#checkoutAddress").value.trim(),
    deliveryAreaId: document.querySelector("#deliveryAreaSelect").value,
    deliveryAreaName: selectedOption.textContent.split('(')[0].trim(),
    deliveryFee: deliveryFee,
    items: ((cart || [])).map(item => ({
        itemId: item.itemId,
        name: item.name,
        qty: item.qty,
        totalPrice: item.totalPrice,
        addons: item.addons.flatMap(group => {
            const originalItem = getItem(item.itemId);
            if (!originalItem || !originalItem.addonGroups) return [];

            const originalGroup = originalItem.addonGroups.find(g => g.id === group.groupId);
            if (!originalGroup) return [];

            return group.selected
                .filter(a => a.qty > 0)
                .map(a => {
                    const addonDef = originalGroup.addons.find(x => x.id === a.addonId);
                    return {
                        groupName: originalGroup.name,
                        name: addonDef ? addonDef.name : 'Adicional',
                        qty: a.qty,
                        price: addonDef ? addonDef.price : 0
                    };
                });
        })
    })),
    subtotal: subtotal,
    total: total,
    paymentMethod: paymentMethod,
    changeNeeded: changeNeeded,
    status: 'pending',
    createdAt: new Date().toISOString()
  };
  
  try {
      const docRef = await addDoc(ordersCollectionRef, newOrder);
      cart = [];
      saveCart();
      closeCheckoutModal();
      renderCart();
      showConfirmationModal({ ...newOrder, id: docRef.id });
  } catch (e) {
      console.error("Falha ao salvar pedido no Firebase:", e);
      alert("Falha ao finalizar pedido. Verifique sua conex√£o ou as regras do Firebase.");
  }
}


// =========================================================================
// === FUN√á√ïES DE DEMONSTRA√á√ÉO E MANUTEN√á√ÉO (Adaptadas para Firebase) ===
// =========================================================================
function loadDemoData(){
    return {
        restaurant:{
            name:"Creamy Purple (FIREBASE TEST)",
            tables: [],
            address:"Rua Fict√≠cia, 61",
            status:"Aberto at√© as 23:00",
            logo:blankSVG(),
            deliveryAreas: [
                { id: 'area1', name: 'Centro da Cidade', fee: 5.00 },
                { id: 'area2', name: 'Regi√£o Oeste', fee: 8.00 }
            ]
        },
        categories:[
            {id:"lanc", title:"LAN√áAMENTOS"},
            {id:"trad", title:"Lanches Tradicionais"}
        ],
        items:[
            { 
                id:"cmb1", 
                category:"lanc", 
                name:"Combo Real-Time", 
                desc:"Este item est√° salvo no Firebase!", 
                price:57.00, 
                img:blankSVG(), 
                addonGroups:[
                    { 
                        id: 'g1', 
                        name: 'Escolha o P√£o', 
                        max: 1, 
                        free: 0, 
                        required: true, 
                        addons: [
                            { id: 'a1', name: 'P√£o Brioche', price: 0.00 },
                            { id: 'a2', name: 'P√£o Australiano', price: 2.50 }
                        ]
                    },
                    { 
                        id: 'g2', 
                        name: 'Adicionar Molho', 
                        max: 3, 
                        free: 1, 
                        required: false, 
                        addons: [
                            { id: 'a3', name: 'Maionese da Casa', price: 1.00 },
                            { id: 'a4', name: 'Molho Barbecue', price: 1.00 },
                            { id: 'a5', name: 'Molho Picante', price: 1.50 }
                        ]
                    }
                ] 
            },
            { 
                id:"xcal", 
                category:"trad", 
                name:"X-Salada Firestore", 
                desc:"Este card√°pio √© persistente.", 
                price:24.00, 
                img:blankSVG(), 
                addonGroups:[] 
            }
        ]
    };
}

// Altera a fun√ß√£o resetDemo para salvar a demo no Firebase
async function resetDemo(){
    if(confirm("Restaurar demo? Perder√° altera√ß√µes salvas no Firebase e reescrever√° o card√°pio no banco.")){
        DATA = loadDemoData();
        cart=[];
        saveCart();
        await saveMenuData(); // Salva a demo no Firebase
        renderAll();
    }
}



function notifyNewOrder() {
    if (Notification.permission === "granted") {
        new Notification("üõçÔ∏è Novo Pedido Recebido!", { 
            body: "Um novo pedido pendente chegou ao painel.",
            icon: "https://cdn-icons-png.flaticon.com/512/2331/2331970.png"
        });
    }
}

// =========================================================================
// === FUN√á√ïES AUXILIARES (L√ìGICA INALTERADA) ===
// =========================================================================
function blankSVG(){
    return "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(`<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'400\' height=\'400\'><rect fill=\'#fff\' width=\'100%\' height=\'100%\'/><text x=\'50%\' y=\'50%\' dominant-baseline=\'middle\' text-anchor=\'middle\' font-size=\'28\' fill=\'#ff3b3b\' font-family=\'Arial\'>Logo</text></svg>`);
}

function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file);
    });
}

function renderAll(){
    document.querySelector("#name").textContent = DATA.restaurant.name;
    document.querySelector("#addr").textContent = DATA.restaurant.address + " ‚Ä¢ " + DATA.restaurant.status;
    document.querySelector("#logo").src = DATA.restaurant.logo || blankSVG();
    renderCategories();
    renderItems();
    renderCart();
    updateUserBadge();
    renderPDVTables();
    toggleAdminUI();
}

function updateUserBadge(){
    if(currentUser){
        // userBadge agora est√° apenas no footer e √© sempre o mesmo elemento
        document.querySelector("#userIcon").textContent = currentUser.isAdmin ? "‚öôÔ∏è" : "üë§";
        document.querySelector("#userName").textContent = currentUser.name.split(" ")[0];
        document.querySelector("#footerStatus").textContent = currentUser.isAdmin ? "Modo Administrador ativo" : `Logado como ${currentUser.name.split(" ")[0]}`;
    } else {
        document.querySelector("#userIcon").textContent = "üë§";
        document.querySelector("#userName").textContent = "Entrar";
        document.querySelector("#footerStatus").textContent = "Fa√ßa login para fazer pedidos";
    }
}

function toggleAdminUI() {
    const adminControls = document.querySelector("#adminControls");
    const adminBar = document.querySelector("#adminBar");
    if (isAdmin) {
        adminControls.classList.remove("hidden");
        document.querySelector("#btnReset").classList.remove("hidden"); // Mostrar o bot√£o reset que salva no Firebase
    } else {
        adminControls.classList.add("hidden");
        document.querySelector("#btnReset").classList.add("hidden");
    }
}

function openAuthModal(){
    document.querySelector("#authModal").classList.add("open");
    showLoginForm();
}

function closeAuthModal(){
    document.querySelector("#authModal").classList.remove("open");
    clearAuthForms();
}

function showLoginForm(){
    document.querySelector("#tabLogin").classList.add("active");
    document.querySelector("#tabRegister").classList.remove("active");
    document.querySelector("#loginForm").classList.remove("hidden");
    document.querySelector("#registerForm").classList.add("hidden");
}

function showRegisterForm(){
    document.querySelector("#tabRegister").classList.add("active");
    document.querySelector("#tabLogin").classList.remove("active");
    document.querySelector("#registerForm").classList.remove("hidden");
    document.querySelector("#loginForm").classList.add("hidden");
}

function clearAuthForms(){
    document.querySelector("#loginUser").value = "";
    document.querySelector("#loginPass").value = "";
    document.querySelector("#regName").value = "";
    document.querySelector("#regEmail").value = "";
    document.querySelector("#regPhone").value = "";
    document.querySelector("#regPass").value = "";
}

function openProfileModal(){
    if(!currentUser || currentUser.isAdmin){ 
        // Admin usa o Painel Admin
        openAdminModal('settings');
        return;
    }
    document.querySelector("#profileName").textContent = currentUser.name;
    document.querySelector("#profileEmail").textContent = currentUser.email;
    document.querySelector("#profilePhone").textContent = currentUser.phone;
    renderProfileAddresses();
    renderProfileOrders();
    document.querySelector("#profileModal").classList.add("open");
}

function closeProfileModal(){
    document.querySelector("#profileModal").classList.remove("open");
}

function renderProfileAddresses() {
  const list = document.querySelector("#savedUserAddressesList");
  list.innerHTML = '';
  if (!currentUser || !currentUser.savedAddresses || currentUser.savedAddresses.length === 0) {
    list.innerHTML = '<div class="small" style="color:var(--muted)">Nenhum endere√ßo salvo.</div>';
    return;
  }
  
  ((currentUser.savedAddresses || [])).forEach((address, index) => {
    const div = document.createElement('div');
    div.classList.add('delivery-area-row');
    div.style.padding = '6px';
    div.innerHTML = `
      <div style="flex:1;">${address}</div>
      <button type="button" class="pill" style="background:#dc3545; color:white; padding:4px 8px;" onclick="removeUserAddress(${index})">Remover</button>
    `;
    list.appendChild(div);
  });
}

function removeUserAddress(index) {
  if (currentUser && currentUser.savedAddresses) {
    currentUser.savedAddresses.splice(index, 1);
    const userToUpdate = users.find(u => u.id === currentUser.id);
    if (userToUpdate) {
        userToUpdate.savedAddresses = currentUser.savedAddresses;
        saveUsers();
        renderProfileAddresses();
        alert("Endere√ßo removido.");
    }
  }
}

function renderProfileOrders() {
  const list = document.querySelector("#profileOrders");
  list.innerHTML = '';
  
  const userOrders = ((orders || [])).filter(o => o.userId === currentUser.id);

  if (userOrders.length === 0) {
    list.innerHTML = '<div class="small" style="color:var(--muted)">Nenhum pedido realizado.</div>';
    return;
  }
  
  ((userOrders || [])).forEach(order => {
    const statusInfo = ORDER_STATUSES[order.status] || ORDER_STATUSES.pending;
    
    const div = document.createElement('div');
    div.style.cssText = 'border: 1px solid #eee; border-radius: 8px; padding: 12px; margin-bottom: 10px;';
    div.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <strong style="font-size:16px;">Pedido #${order.id.substring(0, 7)}</strong>
            <span style="font-weight:600; color:${statusInfo.color};">${statusInfo.label}</span>
        </div>
        <div class="small" style="color:var(--muted); margin: 4px 0;">Total: ${formatBRL(order.total)} ‚Ä¢ Em: ${new Date(order.createdAt).toLocaleDateString()}</div>
        <div style="font-size:12px; margin-top: 8px;">
            ${((order.items || [])).map(item => `${item.qty}x ${item.name}`).join('<br>')}
        </div>
    `;
    list.appendChild(div);
  });
}

function getItem(id){
    return DATA.items.find(i => i.id === id);
}

function getCategory(id){
    return DATA.categories.find(c => c.id === id);
}

function editCategory(id) {
    const cat = DATA.categories.find(c => c.id === id);
    if (!cat) return;
    const newTitle = prompt(`Novo nome para \"${cat.title}\":`, cat.title);
    if (newTitle && newTitle !== cat.title) {
        cat.title = newTitle;
        saveMenuData();
        renderCategories();
    }
}

async function removeCategory(id) {
    if (confirm("Ao remover a categoria, todos os itens associados a ela ser√£o perdidos. Tem certeza?")) {
        DATA.categories = ((DATA.categories || [])).filter(c => c.id !== id);
        DATA.items = ((DATA.items || [])).filter(i => i.category !== id);
        activeCat = DATA.categories.length > 0 ? DATA.categories[0].id : null;
        await saveMenuData();
        renderCategories();
        renderItems();
    }
}

function renderCategories(){
    const catsEl = document.querySelector("#cats");
    catsEl.innerHTML = '';
    
    ((DATA.categories || [])).forEach(cat => {
        const btn = document.createElement('button');
        btn.textContent = cat.title;
        btn.dataset.id = cat.id;
        if(cat.id === activeCat) btn.classList.add('active');
        btn.addEventListener("click", () => { activeCat = cat.id; renderCategories(); renderItems(); });

        if (isAdmin) {
          // Se for admin, envolve o bot√£o da categoria e os bot√µes de edi√ß√£o/exclus√£o em um container flex√≠vel
          const container = document.createElement("div");
          container.style.display = 'flex'; container.style.alignItems = 'center'; container.style.gap = '4px'; 
          // O bot√£o da categoria precisa ser estilizado como p√≠lula e ter margem zero
          btn.style.margin = '0'; 
          container.appendChild(btn);
          
          // Bot√£o de Edi√ß√£o
          const editBtn = document.createElement("button");
          editBtn.textContent = '‚úèÔ∏è'; editBtn.classList.add('pill'); 
          editBtn.style.cssText = 'padding: 6px 8px; font-size: 14px; margin: 0;';
          editBtn.addEventListener('click', (e) => { e.stopPropagation(); editCategory(cat.id); }); 
          container.appendChild(editBtn);
          
          // Bot√£o de Exclus√£o
          const removeBtn = document.createElement("button");
          removeBtn.textContent = '‚ùå'; removeBtn.classList.add('pill'); 
          removeBtn.style.cssText = 'padding: 6px 8px; font-size: 14px; margin: 0;';
          removeBtn.addEventListener('click', (e) => { e.stopPropagation(); removeCategory(cat.id); }); 
          container.appendChild(removeBtn);
          
          // Adiciona o container (que tem a categoria e os bot√µes de admin)
          catsEl.appendChild(container);
        } else {
          // Se n√£o for admin, apenas adiciona o bot√£o da categoria (que j√° est√° estilizado como p√≠lula pelo CSS)
          catsEl.appendChild(btn);
        }
    });
    
    if (isAdmin) {
        // Bot√£o para adicionar nova categoria (Admin) - Implementa√ß√£o simplificada
        const btnAdd = document.createElement('button');
        btnAdd.textContent = '+ Adicionar Categoria';
        btnAdd.style.cssText = 'background:#e6ffe6; color:#28a745; font-weight:700; border: 1px dashed #28a745; margin-top: 10px;';
        btnAdd.addEventListener('click', () => {
            const title = prompt("Qual o nome da nova categoria?");
            if(title){
                const newCat = { id: title.toLowerCase().replace(/\s/g, '_'), title };
                if(DATA.categories.find(c => c.id === newCat.id)){ 
                    alert("Uma categoria com nome similar j√° existe. Tente outro nome."); 
                    return;
                } 
                DATA.categories.push(newCat);
                saveMenuData();
                activeCat = newCat.id;
                renderCategories();
                renderItems();
            }
        });
        catsEl.appendChild(btnAdd);
    }
}


function renderItems(){
    const itemsEl = document.querySelector("#items");
    itemsEl.innerHTML = '';
    
    const items = ((DATA.items || [])).filter(i => i.category === activeCat);
    
    // === ADMIN: layout antigo ===
    if (isAdmin) {
      const btnNew = document.createElement('button');
      btnNew.classList.add('btn');
      btnNew.style.cssText = 'background:#28a745; margin-bottom: 12px;';
      btnNew.textContent = '+ Adicionar Novo Item';
      btnNew.addEventListener('click', () => openItemDetailsModal());
      itemsEl.appendChild(btnNew);

      if(items.length === 0){
          itemsEl.innerHTML += '<div class="small" style="color:var(--muted); text-align:center;">Nenhum item nesta categoria.</div>';
          return;
      }

      ((items || [])).forEach(item => {
          const itemEl = document.createElement('div');
          itemEl.classList.add('item');
          itemEl.innerHTML = `
              <img src="${item.img || blankSVG()}" alt="${item.name}">
              <div class="info" style="flex:1;">
                  <h3>
                      <span>${item.name}</span>
                      <span style="color:var(--primary); font-weight:800">${formatBRL(item.price)}</span>
                  </h3>
                  <p>${item.desc}</p>
                  <div class="actions">
                      <div style="display:flex;gap:8px;">
                          <button class="pill" data-id="${item.id}" data-action="manage-addons">Adicionais</button>
                          <button class="pill" data-id="${item.id}" data-action="edit-image">Imagem</button>
                          <button class="pill" data-id="${item.id}" data-action="edit-item">Editar</button>
                          <button class="pill" data-id="${item.id}" data-action="delete-item" style="background:#dc3545; color:white;">Deletar</button>
                      </div>
                      <button class=\"btn\" data-id=\"${item.id}\" data-action=\"add-to-cart\">${item.addonGroups.length > 0 ? 'Ver Op√ß√µes' : 'Adicionar'}</button>
                  </div>
              </div>
          `;
          itemsEl.appendChild(itemEl);
      });

      itemsEl.querySelectorAll('[data-action]').forEach(btn => {
          btn.addEventListener('click', (e) => handleItemAction(e.target.dataset.action, e.target.dataset.id));
      });
      return;
    }

    // === CLIENTE: layout tipo iFood ===
    if (items.length === 0) {
        itemsEl.innerHTML = '<div class="small" style="color:var(--muted); text-align:center;">Nenhum item nesta categoria.</div>';
        return;
    }

    const grid = document.createElement('div');
    grid.classList.add('menu-grid');
    items.forEach(item => {
        const card = document.createElement('div');
        card.classList.add('menu-card');
        card.innerHTML = `
            <img src="${item.img || blankSVG()}" alt="${item.name}" class="menu-card-img">
            <div class="menu-card-body">
                <h3 class="menu-card-title">${item.name}</h3>
                <p class="menu-card-price">${formatBRL(item.price)}</p>
                <button class="btn menu-card-btn" data-id="${item.id}" data-action="add-to-cart">Comprar</button>
            </div>
        `;
        grid.appendChild(card);
    });
    itemsEl.appendChild(grid);

    itemsEl.querySelectorAll('[data-action=\"add-to-cart\"]').forEach(btn => {
        btn.addEventListener('click', (e) => handleItemAction('add-to-cart', e.target.dataset.id));
    });
}

function handleItemAction(action, itemId){
    const item = getItem(itemId);
    if (!item) return;
    
    switch(action){
        case 'add-to-cart':
            if (item.addonGroups.length > 0) {
                openModal(item);
            } else {
                addItemToCart(item, 1, []);
            }
            break;
        case 'edit-item':
            openItemDetailsModal(item);
            break;
        case 'edit-image':
            openImageEditModal(item);
            break;
        case 'manage-addons':
            openAddonManagementModal(item);
            break;
        case 'delete-item':
            if(confirm(`Tem certeza que deseja deletar o item "${item.name}"?`)){
                DATA.items = ((DATA.items || [])).filter(i => i.id !== itemId);
                saveMenuData();
                renderItems();
            }
            break;
    }
}


function addItemToCart(item, qty, addons){
    // Se estiver no modo PDV, adiciona ao carrinho PDV
    if(isPdvMode && pdvCartState && pdvCartState.tableId){
        const cartItem = {
            itemId: item.id,
            name: item.name,
            price: item.price,
            qty: qty,
            addons: addons,
            totalPrice: 0
        };
        let totalAddons = 0;
        ((addons || [])).forEach(group => { ((group.selected || [])).forEach(addon => { const originalGroup = item.addonGroups.find(g => g.id === group.groupId); const originalAddon = originalGroup ? originalGroup.addons.find(a => a.id === addon.addonId) : null; totalAddons += (originalAddon ? originalAddon.price : 0) * addon.qty; }); });
        cartItem.totalPrice = (item.price + totalAddons) * qty;
        pdvCartState.items.push(cartItem);
        renderPDVCart();
        closeModal();
        return;
    }

    const cartItem = {
        itemId: item.id,
        name: item.name,
        price: item.price,
        qty: qty,
        addons: addons,
        totalPrice: 0 // Ser√° calculado abaixo
    };
    
    let totalAddons = 0;
    
    ((addons || [])).forEach(group => {
        ((group.selected || [])).forEach(addon => {
            const originalGroup = item.addonGroups.find(g => g.id === group.groupId);
            const originalAddon = originalGroup ? originalGroup.addons.find(a => a.id === addon.addonId) : null;
            totalAddons += (originalAddon ? originalAddon.price : 0) * addon.qty;
        });
    });
    
    cartItem.totalPrice = (item.price + totalAddons) * qty;
    
    cart.push(cartItem);
    saveCart();
    renderCart();
    closeModal();
    
    // Se estiver em mobile (<1024px), mostra o carrinho
    if(window.innerWidth <= 1024){
        document.querySelector("#cartPanel").style.display = 'block'; 
        // Em um app real, aqui o JS faria a transi√ß√£o do carrinho
    }
}

function renderCart(){
    const list = document.querySelector("#cartList");
    list.innerHTML = '';
    
    let subtotal = 0;
    
    if(cart.length === 0){
        list.innerHTML = '<div class="small" style="color:var(--muted); text-align:center;">Seu carrinho est√° vazio.</div>';
        document.querySelector("#btnCheckout").setAttribute('disabled', 'true');
        document.querySelector("#btnViewCart").classList.remove('active');
        document.querySelector("#btnViewCart").textContent = `Ver Carrinho (0)`;
    } else {
        document.querySelector("#btnCheckout").removeAttribute('disabled');
        document.querySelector("#btnViewCart").classList.add('active');
    }
    
    ((cart || [])).forEach((item, index) => {
        subtotal += item.totalPrice;
        
        const itemEl = document.createElement('div');
        itemEl.style.cssText = 'border-bottom: 1px solid #eee; padding: 8px 0;';
        
        const mainLine = document.createElement('div');
        mainLine.style.cssText = 'display:flex; justify-content:space-between; align-items:center;';
        mainLine.innerHTML = `
            <div>
                <strong style="font-size:14px;">${item.name}</strong> 
                <span class="small" style="color:var(--muted)">(${formatBRL(item.price)} cada)</span>
            </div>
            <div style="font-weight:700;">${formatBRL(item.totalPrice)}</div>
        `;
        itemEl.appendChild(mainLine);
        
        // Quantidade e A√ß√µes
        const qtyActions = document.createElement('div');
        qtyActions.style.cssText = 'display:flex; justify-content:space-between; align-items:center; margin-top:4px;';
        qtyActions.innerHTML = `
            <div class="small" style="color:var(--muted);">Qtd: ${item.qty}</div>
            <button class="pill" data-index="${index}" data-action="remove-item" style="padding: 4px 8px; background:#fbe6e6; color:#dc3545;">Remover</button>
        `;
        itemEl.appendChild(qtyActions);
        
        // Adicionais
        if(item.addons && item.addons.length > 0){
            ((item.addons || [])).forEach(group => {
                ((group.selected || [])).forEach(addon => {
                    // Obt√©m os dados originais do item para o nome
                    const originalItem = getItem(item.itemId);
                    const originalGroup = originalItem.addonGroups.find(g => g.id === group.groupId);
                    const originalAddon = originalGroup ? originalGroup.addons.find(a => a.id === addon.addonId) : null;
                    
                    if (originalAddon && addon.qty > 0) {
                        const addonLine = document.createElement('div');
                        addonLine.classList.add('small');
                        addonLine.style.cssText = 'color:var(--muted); margin-left: 10px; border-top: 1px dotted #f5f5f5; padding-top: 2px;';
                        addonLine.textContent = `+ ${addon.qty}x ${originalAddon.name} ${originalAddon.price > 0 ? '(' + formatBRL(originalAddon.price) + ')' : ''}`;
                        itemEl.appendChild(addonLine);
                    }
                });
            });
        }
        
        list.appendChild(itemEl);
    });
    
    document.querySelector("#subtotal").textContent = formatBRL(subtotal);
    document.querySelector("#btnViewCart").textContent = `Ver Carrinho (${cart.length})`;

    list.querySelectorAll('[data-action="remove-item"]').forEach(btn => {
        btn.addEventListener('click', (e) => removeItemFromCart(e.target.dataset.index));
    });
}

function removeItemFromCart(index){
    cart.splice(index, 1);
    saveCart();
    renderCart();
    
    // Se o carrinho estiver vazio em mobile, esconde o painel do carrinho
    if(cart.length === 0 && window.innerWidth <= 1024){
        document.querySelector("#cartPanel").style.display = 'none';
    }
}


let isPdvMode = false; // Vari√°vel global para rastrear o modo PDV

function openModal(item, isPdv = false){
    isPdvMode = isPdv;
    modalState = { item: item, qty: 1, addons: generateAddonState(item.addonGroups) };
    
    document.querySelector("#modalTitle").textContent = "Personalizar " + item.name;
    document.querySelector("#modalItemName").textContent = item.name;
    document.querySelector("#modalItemQty").textContent = modalState.qty;
    
    renderModalAddons();
    calculateModalTotal();
    
    document.querySelector("#modal").classList.add('open');
}

function closeModal(){
    document.querySelector("#modal").classList.remove('open');
    modalState = null;
}

function generateAddonState(groups){
    return ((groups || [])).map(group => ({
        groupId: group.id,
        selected: ((group.addons || [])).map(addon => ({ addonId: addon.id, qty: 0 }))
    }));
}

function renderModalAddons(){
    const addonsEl = document.querySelector("#modalAddons");
    addonsEl.innerHTML = '';
    
    ((modalState.item.addonGroups || [])).forEach(group => {
        const groupState = modalState.addons.find(g => g.groupId === group.id);
        const currentCount = groupState.selected.reduce((sum, addon) => sum + addon.qty, 0);
        
        const groupEl = document.createElement('div');
        groupEl.classList.add('addon-group');
        groupEl.innerHTML = `
            <div class="addon-header">
                <strong style="font-size:15px;">${group.name}</strong>
                <div class="small" style="color:var(--muted);">${group.required ? '(Obrigat√≥rio)' : `(Max ${group.max}, ${group.free > 0 ? group.free + ' gr√°tis' : 'todos pagos'})`}</div>
            </div>
        `;
        
        ((group.addons || [])).forEach(addon => {
            const addonState = groupState.selected.find(a => a.addonId === addon.id);
            const addonEl = document.createElement('div');
            addonEl.classList.add('addon-row');
            
            addonEl.innerHTML = `
                <div>
                    ${addon.name} 
                    ${addon.price > 0 ? `<span style="font-weight:600; color:var(--primary);"> (+${formatBRL(addon.price)})</span>` : ''}
                </div>
                <div class="addon-controls">
                    <button data-group="${group.id}" data-addon="${addon.id}" data-action="decrement" ${addonState.qty === 0 ? 'disabled' : ''}>-</button>
                    <span class="count">${addonState.qty}</span>
                    <button data-group="${group.id}" data-addon="${addon.id}" data-action="increment" ${currentCount >= group.max && addonState.qty === 0 ? 'disabled' : ''}>+</button>
                </div>
            `;
            groupEl.appendChild(addonEl);
        });
        
        addonsEl.appendChild(groupEl);
    });
    
    addonsEl.querySelectorAll('.addon-controls button').forEach(btn => {
        btn.addEventListener('click', (e) => handleAddonChange(
            e.target.dataset.group, 
            e.target.dataset.addon, 
            e.target.dataset.action
        ));
    });
}

function handleAddonChange(groupId, addonId, action){
    const group = modalState.item.addonGroups.find(g => g.id === groupId);
    const groupState = modalState.addons.find(g => g.groupId === groupId);
    const addonState = groupState.selected.find(a => a.addonId === addonId);
    
    let currentCount = groupState.selected.reduce((sum, addon) => sum + addon.qty, 0);
    
    if(action === 'increment'){
        if(currentCount < group.max){
            addonState.qty += 1;
        }
    } else if(action === 'decrement'){
        if(addonState.qty > 0){
            addonState.qty -= 1;
        }
    }
    
    renderModalAddons();
    calculateModalTotal();
}

function calculateModalTotal(){
    let basePrice = modalState.item.price;
    let totalAddonsPrice = 0;
    
    ((modalState.addons || [])).forEach(groupState => {
        const originalGroup = modalState.item.addonGroups.find(g => g.id === groupState.groupId);
        let currentCount = 0;
        
        ((groupState.selected || [])).forEach(addonState => {
            currentCount += addonState.qty;
            const originalAddon = originalGroup.addons.find(a => a.id === addonState.addonId);
            
            // L√≥gica de gr√°tis
            let paidQty = addonState.qty;
            if(originalGroup.free > 0){
                const groupTotal = groupState.selected.reduce((sum, a) => sum + a.qty, 0);
                const freeToApply = Math.min(groupTotal, originalGroup.free);
                
                // Distribui o "gr√°tis" de forma simples (pode ser ajustado)
                // A forma mais simples √© aplicar o free at√© o limite e depois cobrar.
                // Aqui, vou manter a l√≥gica de que o pre√ßo do adicional √© cobrado *sempre* se for > 0, 
                // e o "gr√°tis" √© apenas um indicador de limite/info para o usu√°rio.
                // Para uma l√≥gica de desconto real, o JS seria mais complexo. 
                // Mantenho a implementa√ß√£o mais simples (todos os adicionais pagos contam para o total)
                
                // Assumindo que o `free` √© apenas um limite visual ou simplificado:
                totalAddonsPrice += (originalAddon.price * addonState.qty);
            } else {
                 totalAddonsPrice += (originalAddon.price * addonState.qty);
            }
        });
    });
    
    let itemTotal = (basePrice + totalAddonsPrice) * modalState.qty;
    document.querySelector("#modalTotal").textContent = formatBRL(itemTotal);
    
    // Valida√ß√£o de grupos obrigat√≥rios
    let canConfirm = true;
    ((modalState.item.addonGroups || [])).forEach(group => {
        if(group.required){
            const groupState = modalState.addons.find(g => g.groupId === group.id);
            const currentCount = groupState.selected.reduce((sum, addon) => sum + addon.qty, 0);
            if(currentCount === 0){
                canConfirm = false;
            }
        }
    });
    
    if(canConfirm){
        document.querySelector("#modalConfirm").removeAttribute('disabled');
        document.querySelector("#modalConfirm").textContent = `Adicionar ${formatBRL(itemTotal)}`;
    } else {
        document.querySelector("#modalConfirm").setAttribute('disabled', 'true');
        document.querySelector("#modalConfirm").textContent = `Faltam op√ß√µes obrigat√≥rias`;
    }
}

function handleQtyChange(action){
    if(action === 'increment-qty'){
        modalState.qty += 1;
    } else if(action === 'decrement-qty'){
        if(modalState.qty > 1) modalState.qty -= 1;
    }
    document.querySelector("#modalItemQty").textContent = modalState.qty;
    calculateModalTotal();
}



// ---------------- PDV (Ponto de Venda) ----------------


function openPDVForTable(tableId){
    // initialize pdvCartState from existing order if present
    pdvCartState.tableId = tableId;
    pdvCartState.items = [];
    const table = DATA.tables.find(t => t.id === tableId);
    document.querySelector("#pdvOrderTitle").textContent = `Pedido ‚Äî ${table ? table.name : tableId}`;
    renderPDVItems();
    renderPDVCart();
    document.querySelector("#pdvOrderModal").classList.add('open');
}

function renderPDVItems(){
    const list = document.querySelector("#pdvItemsList");
    list.innerHTML = '';
    // reuse DATA.items rendering (simple list of buttons to add)
    ((DATA.items || [])).forEach(item => {
        const row = document.createElement('div');
        row.style.cssText = 'display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid #f5f5f5;';
        row.innerHTML = `<div><strong>${item.name}</strong><div class="small" style="color:var(--muted)">${formatBRL(item.price)}</div></div>`;
        const btns = document.createElement('div');
        btns.style.display = 'flex'; btns.style.gap = '6px'; 
        const addBtn = document.createElement('button');
        addBtn.className = 'btn';
        addBtn.textContent = item.addonGroups.length > 0 ? 'Ver Op√ß√µes' : 'Adicionar';
        addBtn.addEventListener('click', () => {
            if(item.addonGroups.length > 0){
                // open modal but when confirmed it should add to PDV (pdvCartState). We'll open modal and on confirm it will call addItemToCart (which respects pdvCartState)
                openModal(item);
            } else {
                addItemToCart(item, 1, []);
            }
        });
        btns.appendChild(addBtn);
        row.appendChild(btns);
        list.appendChild(row);
    });
}



// finalize PDV order: save to Firestore and update DATA.tables
async function finalizePDVOrder(clientName = "") {
  const isAddingItems = !!pdvCartState.existingOrderId;
  const existingOrderId = pdvCartState.existingOrderId;
  try {
    if (!isAdmin) {
      alert("Apenas administradores podem finalizar pedidos de mesa.");
      return;
    }

    if (!pdvCartState || !pdvCartState.tableId || (pdvCartState.items || []).length === 0) {
      if(!isAddingItems){
        alert("Nenhum item no pedido da mesa.");
        return;
      }
    }

    const newItemsSubtotal = (pdvCartState.items || []).reduce((sum, item) => sum + item.totalPrice, 0);

    let orderToSave = {};
    let docRef;

    if(isAddingItems){
      const existingOrder = orders.find(o => o.id === existingOrderId);
      if(!existingOrder){
        alert("Erro: Pedido existente n√£o encontrado para adicionar itens.");
        return;
      }

      // 1. Merge dos itens: Novos itens + Itens existentes
      const newItems = (pdvCartState.items || []).map(item => {
        const originalItem = getItem(item.itemId);
        return {
          itemId: item.itemId,
          name: item.name,
          qty: item.qty,
          totalPrice: item.totalPrice,
          addons: (item.addons || []).flatMap(group => {
            if (!originalItem || !originalItem.addonGroups) return [];
            const originalGroup = originalItem.addonGroups.find(g => g.id === group.groupId);
            if (!originalGroup) return [];

            return group.selected
              .filter(a => a.qty > 0)
              .map(a => {
                const addonDef = originalGroup.addons.find(x => x.id === a.addonId);
                return {
                  groupName: originalGroup.name,
                  name: addonDef ? addonDef.name : "Adicional",
                  qty: a.qty,
                  price: addonDef ? addonDef.price : 0
                };
              });
          })
        };
      });
      
      const allItems = [...existingOrder.items, ...newItems];
      const newSubtotal = allItems.reduce((sum, item) => sum + item.totalPrice, 0);

      orderToSave = {
        items: allItems,
        subtotal: newSubtotal,
        total: newSubtotal, // No PDV, total = subtotal
        updatedAt: new Date().toISOString(),
        // Mant√©m o status como 'pending'
      };

      // 2. Atualiza o pedido existente no Firestore
      const orderDocRef = doc(ordersCollectionRef, existingOrderId);
      await updateDoc(orderDocRef, orderToSave);
      docRef = orderDocRef; // Para a mensagem de sucesso
      
    } else {
      // Cria√ß√£o de um NOVO pedido (Comportamento original)
      const subtotal = newItemsSubtotal;
      orderToSave = {
        userId: "pdv_" + pdvCartState.tableId,
        userName: clientName || "Mesa " + pdvCartState.tableId,
        address: "Atendimento no local (PDV)",
        deliveryAreaId: null,
        deliveryAreaName: "PDV",
        deliveryFee: 0,
        items: (pdvCartState.items || []).map(item => {
          const originalItem = getItem(item.itemId);

          return {
            itemId: item.itemId,
            name: item.name,
            qty: item.qty,
            totalPrice: item.totalPrice,
            addons: (item.addons || []).flatMap(group => {
              if (!originalItem || !originalItem.addonGroups) return [];
              const originalGroup = originalItem.addonGroups.find(g => g.id === group.groupId);
              if (!originalGroup) return [];

              return group.selected
                .filter(a => a.qty > 0)
                .map(a => {
                  const addonDef = originalGroup.addons.find(x => x.id === a.addonId);
                  return {
                    groupName: originalGroup.name,
                    name: addonDef ? addonDef.name : "Adicional",
                    qty: a.qty,
                    price: addonDef ? addonDef.price : 0
                  };
                });
            })
          };
        }),
        subtotal: subtotal,
        total: subtotal,
        paymentMethod: "pdv",
        changeNeeded: 0,
        status: "pending",
        createdAt: new Date().toISOString(),
        pdvTable: pdvCartState.tableId
      };

      docRef = await addDoc(ordersCollectionRef, orderToSave);

      // 3. Atualiza o status da mesa para 'ocupada' e associa o orderId
      const table = (DATA.restaurant.tables || []).find(t => t.id === pdvCartState.tableId);
      if(table){
        table.orderId = docRef.id;
        await saveMenuData();
        renderPDVTables(); // Renderiza novamente para mudar a cor da mesa
      }
    }

    pdvCartState.items = [];
    pdvCartState.existingOrderId = null; // Limpa o estado
    renderPDVCart();
    closePDVOrderModal();

    alert(`Pedido da Mesa ${pdvCartState.tableId} ${isAddingItems ? 'atualizado' : 'enviado'} para a cozinha com sucesso!`);

    pdvCartState.items = [];
    renderPDVCart();
    closePDVOrderModal();

    alert(`Pedido da Mesa ${pdvCartState.tableId} enviado para a cozinha com sucesso!`);

  } catch (e) {
    console.error("Erro ao finalizar pedido PDV:", e);
    alert("Falha ao enviar pedido da mesa. Verifique o console ou sua conex√£o com o Firebase.");
  }
}

async function closeTableAccount(tableId){
    const table = (DATA.restaurant.tables || []).find(t => t.id === tableId);
    if(!table || !table.orderId){ alert('Mesa n√£o possui pedido associado.'); return; }
    
    // Encontra o pedido no array global 'orders'
    const order = orders.find(o => o.id === table.orderId);
    if(!order){
        alert('Pedido n√£o encontrado nos pedidos (pode levar um momento para sincronizar).');
        return;
    }
    
    // 1. Confirma√ß√£o e Fechamento
    if(confirm(`Resumo do pedido (#${order.id.substring(0,7)})\\nTotal: ${formatBRL(order.total)}\\nConfirma pagamento e fechamento da mesa?`)){
        
        // 2. Marca o pedido como "delivered" (entregue/finalizado) no Firestore
        try {
            const orderDocRef = doc(ordersCollectionRef, order.id);
            await updateDoc(orderDocRef, { status: 'delivered', closedAt: new Date().toISOString() });
        } catch(e){
            console.error("Erro ao atualizar status do pedido no Firestore:", e);
            alert("Erro ao finalizar pedido no sistema. Verifique o console.");
            return;
        }
        
        // 3. Libera a mesa (limpa orderId e status)
        table.orderId = null;
        // table.status = 'livre'; // O status agora √© determinado pela presen√ßa de orderId
        await saveMenuData();
        
        // 4. Feedback e Renderiza√ß√£o
        alert('Conta fechada. Mesa liberada.');
        renderPDVTables();
        closeTableDetailsModal();
    }
}

// ------------------------------------------------------

// === Table Details Modal (Gerenciamento de Mesa Ocupada) ===

let currentTableId = null;

function openTableDetailsModal(tableId){
    const table = (DATA.restaurant.tables || []).find(t => t.id === tableId);
    if(!table || !table.orderId) return;
    
    currentTableId = tableId;
    const order = orders.find(o => o.id === table.orderId);
    if(!order) return alert('Pedido da mesa n√£o encontrado. Tente novamente.');

    document.querySelector("#tableDetailsTableName").textContent = table.name || 'Mesa ' + table.id.substring(0,4);
    document.querySelector("#tableDetailsClientName").textContent = order.userName || 'N/A';
    document.querySelector("#tableDetailsPaymentMethod").value = order.paymentMethod || 'cash';
    document.querySelector("#tableDetailsTotal").textContent = formatBRL(order.total);
    
    const itemsList = document.querySelector("#tableDetailsOrderItems");
    itemsList.innerHTML = '';
    
    (order.items || []).forEach(item => {
        const div = document.createElement('div');
        div.style.cssText = 'font-size:14px; margin-bottom: 8px; padding-bottom: 4px; border-bottom: 1px dashed #eee;';
        div.innerHTML = `
            <div style="display:flex; justify-content:space-between;">
                <span style="font-weight:600;">${item.qty}x ${item.name}</span>
                <span>${formatBRL(item.totalPrice)}</span>
            </div>
            ${item.addons && item.addons.length > 0 ? `
                <div class="small" style="color:var(--muted); margin-left: 10px; font-size:12px;">
                    + ${((item.addons || [])).map(a => `${a.qty}x ${a.name}`).join(', ')}
                </div>
            ` : ''}
        `;
        itemsList.appendChild(div);
    });

    document.querySelector("#tableDetailsModal").classList.add('open');
}

function closeTableDetailsModal(){
    const paymentMethod = document.querySelector("#tableDetailsPaymentMethod").value;
    if(currentTableId){
        const table = (DATA.restaurant.tables || []).find(t => t.id === currentTableId);
        if(table && table.orderId){
            const order = orders.find(o => o.id === table.orderId);
            if(order && order.paymentMethod !== paymentMethod){
                order.paymentMethod = paymentMethod;
                // Atualiza o pedido no Firebase (assumindo que existe uma fun√ß√£o para isso)
                // updateOrderInFirebase(order); 
                // Como n√£o tenho acesso ao Firebase, vou apenas atualizar o objeto localmente.
                // Em um ambiente real, a linha acima seria descomentada.
                console.log('Forma de pagamento da mesa ' + currentTableId + ' atualizada para: ' + paymentMethod);
            }
        }
    }
    document.querySelector("#tableDetailsModal").classList.remove('open');
    currentTableId = null;
}

// Listeners para o novo modal
document.addEventListener("DOMContentLoaded", () => {
    const modal = document.querySelector("#tableDetailsModal");
    if(!modal) return;

    document.querySelector("#tableDetailsCancel").addEventListener("click", closeTableDetailsModal);
    
    document.querySelector("#tableDetailsAddItems").addEventListener("click", () => {
        if(!currentTableId) return;
        const table = (DATA.restaurant.tables || []).find(t => t.id === currentTableId);
        if(!table || !table.orderId) {
            alert("Erro: N√£o foi poss√≠vel encontrar o pedido associado a esta mesa.");
            return;
        }
        
        const tableIdToOpen = currentTableId;
        const orderIdToOpen = table.orderId;

        closeTableDetailsModal();
        
        // Abre o modal PDV no modo de adi√ß√£o de itens
        openPDVOrderModal(tableIdToOpen, orderIdToOpen);
    });
    
    document.querySelector("#tableDetailsCloseTable").addEventListener("click", () => {
        if(!currentTableId) return;
        closeTableAccount(currentTableId);
    });
});

// ------------------------------------------------------


// === ADMIN MODALS ===

// --- Item Details Modal (CRUD item) ---

function openItemDetailsModal(item = null){
    itemState = item ? { ...item } : { id: Date.now().toString(), category: activeCat || DATA.categories[0].id, name: '', desc: '', price: 0.00, img: blankSVG(), addonGroups: [] };
    
    document.querySelector("#itemDetailsModalTitle").textContent = item ? "Editar Item: " + item.name : "Adicionar Novo Item";
    document.querySelector("#itemIdDetails").value = itemState.id;
    document.querySelector("#itemName").value = itemState.name;
    document.querySelector("#itemDesc").value = itemState.desc;
    document.querySelector("#itemPrice").value = itemState.price;
    
    // Preencher categorias
    const catSelect = document.querySelector("#itemCategory");
    catSelect.innerHTML = '';
    ((DATA.categories || [])).forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat.id;
        opt.textContent = cat.title;
        if(cat.id === itemState.category) opt.selected = true;
        catSelect.appendChild(opt);
    });
    
    document.querySelector("#itemDetailsModal").classList.add('open');
}

function closeItemDetailsModal(){
    document.querySelector("#itemDetailsModal").classList.remove('open');
    itemState = null;
    document.querySelector("#itemDetailsForm").reset();
}

function saveItemDetails(e){
    e.preventDefault();
    if (!isAdmin) return;
    
    const isNew = !DATA.items.find(i => i.id === itemState.id);
    
    itemState.name = document.querySelector("#itemName").value;
    itemState.desc = document.querySelector("#itemDesc").value;
    itemState.price = parseFloat(document.querySelector("#itemPrice").value);
    itemState.category = document.querySelector("#itemCategory").value;
    
    if(isNew){
        DATA.items.push(itemState);
    } else {
        // Encontra o √≠ndice e substitui
        const index = DATA.items.findIndex(i => i.id === itemState.id);
        if(index !== -1){
            // Mant√©m os grupos de adicionais e imagem existentes se n√£o estiverem sendo editados em outra modal
            DATA.items[index] = { ...DATA.items[index], ...itemState };
        }
    }
    
    saveMenuData();
    renderItems();
    closeItemDetailsModal();
}

// --- Image Edit Modal ---

function openImageEditModal(item){
  itemState = item;
  document.querySelector("#imageEditModalTitle").textContent = "Editar Imagem para: ";
  document.querySelector("#imageItemName").textContent = item.name;
  document.querySelector("#itemIdImage").value = item.id;
  document.querySelector("#currentImagePreview").src = item.img || blankSVG();
  document.querySelector("#itemImgUrl").value = item.img || "";
  
  document.querySelector("#imageEditModal").classList.add('open');
}

function closeImageEditModal(){
  document.querySelector("#imageEditModal").classList.remove('open');
  itemState = null;
  document.querySelector("#imageEditForm").reset();
}

async function saveImageEdit(e){
  e.preventDefault();
  if (!isAdmin) return;
  
  const fileInput = document.querySelector("#itemImgFile");
  let newImgUrl = itemState.img || blankSVG();

  if (fileInput.files.length > 0) {
      try {
          // Converte a imagem para Base64 para salvar no banco de dados
          newImgUrl = await fileToBase64(fileInput.files[0]);
      } catch (error) {
          alert("Erro ao ler o arquivo de imagem.");
          return;
      }
  }
  
  const index = DATA.items.findIndex(i => i.id === itemState.id);
  if(index !== -1){
      DATA.items[index].img = newImgUrl;
      saveMenuData();
      renderItems();
      // Atualiza a pr√©via da imagem se o modal for reaberto
  }
  
  closeImageEditModal();
}

// --- Addon Management Modal ---

function openAddonManagementModal(item){
    addonManagerState = item;
    document.querySelector("#addonManagementTitle").textContent = "Gerenciar Adicionais para ";
    document.querySelector("#addonItemName").textContent = item.name;
    
    renderAddonGroups();
    
    document.querySelector("#addonManagementModal").classList.add('open');
}

function closeAddonManagementModal(){
    document.querySelector("#addonManagementModal").classList.remove('open');
    addonManagerState = null;
}

function renderAddonGroups(){
    const list = document.querySelector("#addonGroupsList");
    list.innerHTML = '';
    
    if (!addonManagerState || addonManagerState.addonGroups.length === 0) {
        list.innerHTML = '<div class="item-management-note">Este item ainda n√£o possui grupos de adicionais. Clique em "+ Adicionar Grupo".</div>';
    }
    
    ((addonManagerState.addonGroups || [])).forEach((group, groupIndex) => {
        const groupEl = document.createElement('div');
        groupEl.classList.add('addon-group-settings');
        groupEl.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 8px;">
                <input type="text" value="${group.name}" placeholder="Nome do Grupo (ex: Escolha o Molho)" 
                       onchange="updateAddonGroupProp('${group.id}', 'name', this.value)" style="flex:1; margin-right: 10px; font-weight: 600;">
                <button type="button" class="pill" style="background:#dc3545; color:white; padding:4px 8px;" onclick="removeAddonGroup('${group.id}')">Remover Grupo</button>
            </div>
            
            <div class="meta-addon-info">
                <strong>Configura√ß√µes:</strong>
                <label style="margin-right:15px;">Max: <input type="number" value="${group.max}" min="1" style="width:50px; padding:4px; display:inline;" 
                       onchange="updateAddonGroupProp('${group.id}', 'max', parseInt(this.value))"></label>
                <label style="margin-right:15px;">Gr√°tis: <input type="number" value="${group.free}" min="0" style="width:50px; padding:4px; display:inline;" 
                       onchange="updateAddonGroupProp('${group.id}', 'free', parseInt(this.value))"></label>
                <label>Obrigat√≥rio: <input type="checkbox" ${group.required ? 'checked' : ''} 
                       onchange="updateAddonGroupProp('${group.id}', 'required', this.checked)"></label>
            </div>
            
            <h5 style="margin-top:15px; margin-bottom: 8px;">Itens do Grupo:</h5>
            <div id="addonItemsList-${group.id}">
                ${((group.addons || [])).map(addon => `
                    <div class="addon-item-row">
                        <input type="text" value="${addon.name}" placeholder="Nome do Adicional" onchange="updateAddonItemProp('${group.id}', '${addon.id}', 'name', this.value)">
                        <input type="number" value="${addon.price}" step="0.01" placeholder="Pre√ßo" style="max-width:80px;" onchange="updateAddonItemProp('${group.id}', '${addon.id}', 'price', parseFloat(this.value))">
                        <button type="button" class="pill" style="background:#dc3545; color:white; padding:4px 8px;" onclick="removeAddonItem('${group.id}', '${addon.id}')">X</button>
                    </div>
                `).join('')}
            </div>
            <button type="button" class="pill" style="background:#e6ffe6; color:#28a745; margin-top:10px; border: 1px dashed #28a745;" onclick="addAddonItem('${group.id}')">+ Adicionar Op√ß√£o</button>
        `;
        list.appendChild(groupEl);
    });
}

function addAddonGroup() {
    if (!addonManagerState) return;
    const newGroup = {
        id: Date.now().toString(),
        name: "Novo Grupo de Adicionais",
        max: 1,
        free: 0,
        required: false,
        addons: [
            { id: Date.now().toString() + 'a', name: 'Op√ß√£o Padr√£o', price: 0.00 }
        ]
    };
    addonManagerState.addonGroups.push(newGroup);
    renderAddonGroups();
}

function removeAddonGroup(groupId) {
    if (!addonManagerState || !confirm("Tem certeza que deseja remover este grupo de adicionais?")) return;
    addonManagerState.addonGroups = ((addonManagerState.addonGroups || [])).filter(g => g.id !== groupId);
    renderAddonGroups();
}

function updateAddonGroupProp(groupId, prop, value) {
    const group = addonManagerState.addonGroups.find(g => g.id === groupId);
    if (group) {
        group[prop] = value;
        // N√£o precisa re-renderizar, mas √© bom para garantir o estado
        // renderAddonGroups(); 
    }
}

function addAddonItem(groupId) {
    const group = addonManagerState.addonGroups.find(g => g.id === groupId);
    if (group) {
        group.addons.push({ id: Date.now().toString(), name: 'Nova Op√ß√£o', price: 0.00 });
        renderAddonGroups();
    }
}

function removeAddonItem(groupId, addonId) {
    const group = addonManagerState.addonGroups.find(g => g.id === groupId);
    if (group && confirm("Tem certeza que deseja remover este adicional?")) {
        group.addons = ((group.addons || [])).filter(a => a.id !== addonId);
        renderAddonGroups();
    }
}

function updateAddonItemProp(groupId, addonId, prop, value) {
    const group = addonManagerState.addonGroups.find(g => g.id === groupId);
    const addon = group ? group.addons.find(a => a.id === addonId) : null;
    if (addon) {
        addon[prop] = value;
        // renderAddonGroups(); // N√£o precisa re-renderizar
    }
}

function saveAddonManagement(){
    if (!isAdmin || !addonManagerState) return;
    
    // Encontra o item no array principal e atualiza os grupos de adicionais
    const index = DATA.items.findIndex(i => i.id === addonManagerState.id);
    if(index !== -1){
        DATA.items[index].addonGroups = addonManagerState.addonGroups;
        saveMenuData();
        renderItems();
    }
    closeAddonManagementModal();
}

// --- Admin Panel Modal ---

function openAdminModal(tabId = 'orders'){
    if (!isAdmin) return;
    
    // Renderiza a tab correta
    showAdminTab(tabId);
    
    // Se for settings, carrega os dados atuais
    if (tabId === 'settings') {
        loadStoreSettings();
        renderDeliveryAreas();
    }
    
    document.querySelector("#adminModal").classList.add('open');
}

function closeAdminModal(){
    document.querySelector("#adminModal").classList.remove('open');
}

function showAdminTab(tabId) {
  // Oculta todos os pain√©is
  document.querySelectorAll('.admin-panel').forEach(p => p.classList.add('hidden'));
  
  // Mostra o painel correspondente
  const panel = document.getElementById(tabId + 'Panel');
  if (panel) {
    panel.classList.remove('hidden');
  } else {
    console.warn('Painel n√£o encontrado:', tabId);
    return;
  }

  // Atualiza bot√£o ativo
  document.querySelectorAll('.admin-tabs button').forEach(btn => btn.classList.remove('active'));
  const tabButton = document.getElementById('tab' + tabId.charAt(0).toUpperCase() + tabId.slice(1));
  if (tabButton) tabButton.classList.add('active');

  // L√≥gica de renderiza√ß√£o
  if (tabId === 'menu') {
    renderAdminMenu();
  } else if (tabId === 'orders') {
    renderAdminOrders();
  } else if (tabId === 'sales') {
    renderAdminDashboard();
  } else if (tabId === 'customers') {
    renderAdminCustomers();
  } else if (tabId === 'settings') {
    renderAdminSettings();
  } else if (tabId === 'pdv') {
    // üî• Aqui garantimos renderiza√ß√£o segura
    if (typeof renderPDVTables === 'function') {
      renderPDVTables();
    }
  }
}



function renderAdminOrders() {
  const list = document.getElementById("currentOrdersList");
  list.innerHTML = '';
  if (!orders || orders.length === 0) {
    list.innerHTML = '<div class="small" style="color:var(--muted);">Nenhum pedido recebido ainda.</div>';
    return;
  }

  orders.forEach(order => {
    let bgColor = '#fff';
    if (order.status === 'pending') bgColor = '#fff7e6';
    else if (order.status === 'preparing') bgColor = '#e6ffed';
    else if (order.status === 'ready') bgColor = '#e6f0ff';
    else if (order.status === 'delivered') bgColor = '#f2f2f2';
    else if (order.status === 'cancelled') bgColor = '#ffe6e6';

    const div = document.createElement('div');
    div.style.cssText = `border:1px solid #ddd; border-radius:8px; padding:12px; margin-bottom:10px; background:${bgColor}; transition:background 0.3s;`;

    // Conte√∫do principal (sem o bot√£o de impress√£o inline)
    div.innerHTML = `
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <strong style="font-size:16px;">Pedido #${order.id.substring(0, 7)}</strong>
        <div class="print-button-placeholder"></div>
      </div>
      <div class="small" style="color:var(--muted); margin:4px 0;">
        Cliente: ${order.userName} (${order.userPhone || 'sem telefone'})<br>
        Endere√ßo: ${order.address || 'N/A'}<br>
        √Årea de Entrega: ${order.deliveryAreaName || 'N/A'} (${formatBRL(order.deliveryFee)})
      </div>
      <div style="margin:8px 0;">
        <strong style="color:var(--primary); font-size:18px;">Total: ${formatBRL(order.total)}</strong>
        <span class="small" style="color:var(--muted); margin-left:10px;">(${order.paymentMethod === 'cash' ? 'Dinheiro' + (order.changeNeeded > 0 ? ' c/ Troco para ' + formatBRL(order.changeNeeded) : '') : order.paymentMethod === 'credit' ? 'Cr√©dito' : 'D√©bito'})</span>
      </div>
      <div style="font-size:14px; margin-bottom:10px;">
        ${(order.items || []).map(item => `
          <div style="margin-left:10px; margin-top:4px; border-left:2px solid #eee; padding-left:6px;">
            ${item.qty}x ${item.name} (${formatBRL(item.totalPrice / item.qty)} cada)
            ${item.addons && item.addons.length > 0 ? `<div class="small" style="color:var(--muted); margin-left:5px;">+ ${(item.addons || []).map(a => `${a.qty}x ${a.name}`).join(', ')}</div>` : ''}
          </div>
        `).join('')}
      </div>
      <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
        <div>
          <label style="font-size:13px; color:var(--muted);">Status:</label>
          <select class="pill" style="padding:4px 10px;" onchange="updateOrderStatus('${order.id}', this.value)">
            ${Object.entries(ORDER_STATUSES).map(([key, val]) => `
              <option value="${key}" ${order.status === key ? 'selected' : ''}>${val.label}</option>
            `).join('')}
          </select>
        </div>
      </div>
    `;

    // Criar bot√£o de impress√£o via DOM e adicionar listener (sem depender do escopo global imediato)
    const btn = document.createElement('button');
    btn.className = 'pill';
    btn.style.cssText = 'background:#17a2b8; color:white; padding:4px 10px; font-size:13px;';
    btn.textContent = 'üñ®Ô∏è Imprimir';
    btn.addEventListener('click', () => {
      if (typeof window.printOrder === 'function') {
        window.printOrder(order.id);
      } else if (typeof printOrder === 'function') {
        printOrder(order.id);
      } else {
        alert('Fun√ß√£o de impress√£o n√£o encontrada.');
      }
    });

    // Insere o bot√£o no placeholder
    // Usamos querySelector na div rec√©m criada (n√£o no DOM global ainda)
    const temp = document.createElement('div');
    temp.appendChild(div);
    const placeholder = temp.querySelector('.print-button-placeholder');
    if (placeholder) placeholder.replaceWith(btn);

    // Agora anexa √† lista
    list.appendChild(temp.firstChild);
  });
}


function calculateDailySales() {
  const salesByDay = {}; // { 'YYYY-MM-DD': total }
  
  // Filtra apenas pedidos entregues
  const deliveredOrders = ((orders || [])).filter(o => o.status === 'delivered');
  
  ((deliveredOrders || [])).forEach(order => {
    // O createdAt √© um timestamp do Firebase, convertemos para objeto Date
    const date = new Date(order.createdAt);
    // Formata a data para o formato 'YYYY-MM-DD'
    const dateKey = date.toISOString().split('T')[0];
    
    // O total do pedido j√° inclui subtotal e taxa de entrega
    const total = order.total || 0; 
    
    salesByDay[dateKey] = (salesByDay[dateKey] || 0) + total;
  });
  
  // Prepara os dados para o Chart.js (√∫ltimos 7 dias)
  const chartData = { labels: [], data: [] };
  const today = new Date();
  
  for (let i = 6; i >= 0; i--) {
    const date = new Date(today);
    date.setDate(today.getDate() - i);
    const dateKey = date.toISOString().split('T')[0];
    
    // R√≥tulo: Dia da Semana (DD/MM)
    const dayOfWeek = date.toLocaleDateString('pt-BR', { weekday: 'short' });
    const dayMonth = date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
    const label = `${dayOfWeek} (${dayMonth})`;
    
    const sales = salesByDay[dateKey] || 0;
    
    chartData.labels.push(label);
    chartData.data.push(sales);
  }
  
  return chartData;
}

function renderSalesMetrics() {
  // 1. Filtra pedidos entregues e calcula m√©tricas
  const deliveredOrders = ((orders || [])).filter(o => o.status === 'delivered');
  const totalSales = deliveredOrders.reduce((sum, order) => sum + (order.total || 0), 0);
  const totalCount = deliveredOrders.length;
  const avgTicket = totalCount > 0 ? totalSales / totalCount : 0;

  // 2. Calcula Top Produtos
  const productSales = {};
  deliveredOrders.forEach(order => {
    (order.items || []).forEach(item => {
      const name = item.name;
      productSales[name] = (productSales[name] || 0) + item.qty;
    });
  });
  const topProducts = Object.entries(productSales)
    .sort(([, a], [, b]) => b - a)
    .slice(0, 10);

  // 3. Calcula Formas de Pagamento
  const paymentCounts = {};
  deliveredOrders.forEach(order => {
    const method = order.paymentMethod || 'Outro';
    paymentCounts[method] = (paymentCounts[method] || 0) + 1;
  });
  const totalPayments = Object.values(paymentCounts).reduce((sum, count) => sum + count, 0);
  const paymentStats = Object.entries(paymentCounts).map(([method, count]) => ({
    method,
    count,
    percentage: totalPayments > 0 ? (count / totalPayments) * 100 : 0
  }));

  // 4. Calcula Performance por √Årea de Entrega
  const areaStats = {};
  deliveredOrders.forEach(order => {
    const area = order.deliveryAreaName || 'Retirada/Local';
    areaStats[area] = areaStats[area] || { count: 0, total: 0 };
    areaStats[area].count += 1;
    areaStats[area].total += (order.total || 0);
  });
  const topArea = Object.entries(areaStats).sort(([, a], [, b]) => b.count - a.count)[0];

  // 5. Renderiza Cards
  const cardCount = document.getElementById('cardCount');
  if (cardCount) cardCount.textContent = totalCount;
  const cardAvg = document.getElementById('cardAvg');
  if (cardAvg) cardAvg.textContent = formatBRL(avgTicket);
  const cardRevenue = document.getElementById('cardRevenue');
  if (cardRevenue) cardRevenue.textContent = formatBRL(totalSales); // Total de Vendas (Corrigido o ID)
  const cardTopArea = document.getElementById('cardTopArea');
  if (cardTopArea) cardTopArea.textContent = topArea ? topArea[0] : 'N/A';

  // 6. Renderiza Tabela Top Produtos
  const tableTopProductsBody = document.querySelector('#tableTopProducts tbody');
  if (!tableTopProductsBody) return;
  tableTopProductsBody.innerHTML = '';
  topProducts.forEach(([name, qty], index) => {
    tableTopProductsBody.innerHTML += `
      <tr>
        <td style="padding:8px;border-bottom:1px solid #eee">${index + 1}</td>
        <td style="padding:8px;border-bottom:1px solid #eee">${name}</td>
        <td style="padding:8px;border-bottom:1px solid #eee">${qty}</td>
      </tr>
    `;
  });

  // 7. Renderiza Tabela Formas de Pagamento
  const tablePaymentsBody = document.querySelector('#tablePayments tbody');
  if (!tablePaymentsBody) return;
  tablePaymentsBody.innerHTML = '';
  paymentStats.forEach(stat => {
    tablePaymentsBody.innerHTML += `
      <tr>
        <td style="padding:8px;border-bottom:1px solid #eee">${stat.method}</td>
        <td style="padding:8px;border-bottom:1px solid #eee">${stat.count}</td>
        <td style="padding:8px;border-bottom:1px solid #eee">${stat.percentage.toFixed(1)}%</td>
      </tr>
    `;
  });

  // 8. Renderiza Tabela Performance por √Årea
  const tableAreasBody = document.querySelector('#tableAreas tbody');
  if (!tableAreasBody) return;
  tableAreasBody.innerHTML = '';
  Object.entries(areaStats).forEach(([area, stats]) => {
    tableAreasBody.innerHTML += `
      <tr>
        <td style="padding:8px;border-bottom:1px solid #eee">${area}</td>
        <td style="padding:8px;border-bottom:1px solid #eee">${stats.count}</td>
        <td style="padding:8px;border-bottom:1px solid #eee">${formatBRL(stats.total)}</td>
      </tr>
    `;
  });
}

function renderAdminDashboard() {
  const { labels, data } = calculateDailySales();
  
  renderSalesMetrics(); // Adicionado: Renderiza as m√©tricas e tabelas

  if (!salesChartInstance) {
    const chartCanvas = document.getElementById('salesChart');
    if(chartCanvas){
      const ctx = chartCanvas.getContext('2d');
      if (!ctx) return; // Adiciona verifica√ß√£o de seguran√ßa para o contexto
    salesChartInstance = new Chart(ctx, {
      type: 'bar', // Pode ser 'line', 'bar', 'pie', etc.
      data: {
        labels: labels,
        datasets: [{
          label: 'Vendas Di√°rias (R$)',
          data: data,
          backgroundColor: 'rgba(128, 0, 128, 0.6)',
          borderColor: 'rgba(128, 0, 128, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false, // Permite que o gr√°fico preencha o cont√™iner
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
    }
  } else {
    // Atualiza os dados do gr√°fico existente
    salesChartInstance.data.labels = labels;
    salesChartInstance.data.datasets[0].data = data;
    salesChartInstance.update();
  }
}

function renderAdminCustomers() {
  const list = document.querySelector("#customersList");
  list.innerHTML = '';
  
  if (users.length === 0) {
    list.innerHTML = '<div class="item-management-note" style="border-left: 4px solid #17a2b8;">Nenhum cliente encontrado no Firebase.</div>';
    return;
  }
  
  // Cria uma lista simples de clientes (dados locais para a demo)
  ((users || [])).forEach(user => {
    const div = document.createElement('div');
    div.style.cssText = 'border: 1px solid #eee; border-radius: 6px; padding: 10px; margin-bottom: 8px;';
    div.innerHTML = `
      <div style="font-weight: 600;">${user.name}</div>
      <div class="small" style="color:var(--muted);">Email: ${user.email} ‚Ä¢ Tel: ${user.phone || 'N/A'}</div>
    `;
    list.appendChild(div);
  });
}

// --- Fun√ß√µes de Renderiza√ß√£o da Aba de Configura√ß√µes ---
function renderAdminSettings() {
    loadStoreSettings();
    renderDeliveryAreas();
}

// --- Store Settings ---

function loadStoreSettings() {
    document.querySelector("#restaurantName").value = DATA.restaurant.name;
    document.querySelector("#restaurantAddress").value = DATA.restaurant.address;
    document.querySelector("#restaurantStatus").value = DATA.restaurant.status;
    document.querySelector("#currentLogoPreview").src = DATA.restaurant.logo || blankSVG();
    document.querySelector("#restaurantLogoUrl").value = DATA.restaurant.logo || "";
}

async function saveStoreSettings(e) {
    e.preventDefault();
    if (!isAdmin) return;

    const fileInput = document.querySelector("#restaurantLogoFile");
    let newLogoUrl = DATA.restaurant.logo || blankSVG();

    if (fileInput.files.length > 0) {
        try {
            newLogoUrl = await fileToBase64(fileInput.files[0]);
        } catch (error) {
            alert("Erro ao ler o arquivo de logo.");
            return;
        }
    }

    DATA.restaurant.name = document.querySelector("#restaurantName").value;
    DATA.restaurant.address = document.querySelector("#restaurantAddress").value;
    DATA.restaurant.status = document.querySelector("#restaurantStatus").value;
    DATA.restaurant.logo = newLogoUrl;
    
    // O deliveryAreas j√° foi atualizado via onchange/onclick

    await saveMenuData();
    renderAll(); // Atualiza a header
    alert("Configura√ß√µes da loja salvas com sucesso!");
    // N√£o fecha o modal para permitir mais edi√ß√µes
}

function renderDeliveryAreas() {
  const list = document.querySelector("#deliveryAreasList");
  list.innerHTML = '';
  
  if (DATA.restaurant.deliveryAreas.length === 0) {
    list.innerHTML = '<div class="item-management-note">Nenhuma √°rea de entrega cadastrada. Os clientes n√£o conseguir√£o finalizar o pedido sem uma taxa.</div>';
    return;
  }
  
  ((DATA.restaurant.deliveryAreas || [])).forEach((area, index) => {
    const div = document.createElement('div');
    div.classList.add('delivery-area-row');
    div.innerHTML = `
      <input type="text" value="${area.name}" placeholder="Nome da √Årea (ex: Bairro X)" class="area-name-input" 
             onchange="updateDeliveryAreaProp('${area.id}', 'name', this.value)">
      <input type="number" value="${area.fee}" step="0.01" placeholder="Taxa (R$)" class="area-fee-input" 
             onchange="updateDeliveryAreaProp('${area.id}', 'fee', parseFloat(this.value))">
      <button type="button" class="pill" style="background:#dc3545; color:white; padding:4px 8px;" onclick="removeDeliveryArea('${area.id}')">Remover</button>
    `;
    list.appendChild(div);
  });

  // Atualiza o seletor de checkout
  renderCheckoutDeliveryAreas();
}

function addDeliveryArea() {
  if (!isAdmin) return;
  const newArea = {
    id: Date.now().toString(),
    name: "Nova √Årea",
    fee: 0.00
  };
  DATA.restaurant.deliveryAreas.push(newArea);
  renderDeliveryAreas();
}

function removeDeliveryArea(areaId) {
  if (!isAdmin || !confirm("Tem certeza que deseja remover esta √°rea de entrega?")) return;
  DATA.restaurant.deliveryAreas = ((DATA.restaurant.deliveryAreas || [])).filter(a => a.id !== areaId);
  renderDeliveryAreas();
}

function updateDeliveryAreaProp(areaId, prop, value) {
  const area = DATA.restaurant.deliveryAreas.find(a => a.id === areaId);
  if (area) {
    area[prop] = value;
    // O saveMenuData ser√° chamado no saveStoreSettings
  }
}

// --- Checkout Modal ---

function openCheckoutModal(){
    if (cart.length === 0) {
        alert("Seu carrinho est√° vazio!");
        return;
    }
    if (!currentUser) {
        alert("Por favor, fa√ßa login ou cadastre-se para finalizar o pedido.");
        openAuthModal();
        return;
    }

    // Preenche os campos do usu√°rio
    document.querySelector("#checkoutName").value = currentUser.name;
    document.querySelector("#checkoutPhone").value = currentUser.phone || '';
    
    renderCheckoutCartSummary();
    renderCheckoutDeliveryAreas();
    renderCheckoutSavedAddresses();
    
    // Tenta preencher o endere√ßo com o primeiro salvo se houver
    if (currentUser.savedAddresses && currentUser.savedAddresses.length > 0) {
      document.querySelector("#checkoutAddress").value = currentUser.savedAddresses[0];
      document.querySelector("#checkoutSavedAddresses").value = currentUser.savedAddresses[0];
    } else {
      document.querySelector("#checkoutAddress").value = '';
    }
    
    // Recalcula o total (inicialmente com 0 de taxa)
    updateCheckoutTotal(0, "N/A");

    document.querySelector("#checkoutModal").classList.add('open');
}

function closeCheckoutModal(){
    document.querySelector("#checkoutModal").classList.remove('open');
    document.querySelector("#checkoutForm").reset();
}

function renderCheckoutCartSummary() {
    const summary = document.querySelector("#checkoutCartSummary");
    summary.innerHTML = '';
    
    ((cart || [])).forEach(item => {
        const div = document.createElement('div');
        div.style.cssText = 'font-size:13px; margin-bottom: 4px; border-bottom: 1px dotted #eee; padding-bottom: 4px;';
        div.innerHTML = `
            <div style="display:flex; justify-content:space-between;">
                <span>${item.qty}x ${item.name}</span>
                <span>${formatBRL(item.totalPrice)}</span>
            </div>
        `;
        // Adicionais
        if(item.addons && item.addons.length > 0){
             ((item.addons || [])).forEach(group => {
                ((group.selected || [])).forEach(addon => {
                    const originalItem = getItem(item.itemId);
                    const originalGroup = originalItem.addonGroups.find(g => g.id === addon.groupId);
                    
                    // Adiciona verifica√ß√£o de seguran√ßa para evitar erro se o grupo n√£o for encontrado
                    if (!originalGroup) return; 
                    
                    const originalAddon = originalGroup ? originalGroup.addons.find(a => a.id === addon.addonId) : null;
                    
                    if (originalAddon && addon.qty > 0) {
                        const addonLine = document.createElement('div');
                        addonLine.classList.add('small');
                        addonLine.style.cssText = 'color:var(--muted); margin-left: 15px;';
                        addonLine.textContent = `+ ${addon.qty}x ${originalAddon.name}`;
                        div.appendChild(addonLine);
                    }
                });
            });
        }
        summary.appendChild(div);
    });
}

function renderCheckoutDeliveryAreas() {
    const select = document.querySelector("#deliveryAreaSelect");
    select.innerHTML = '<option value="" disabled selected>Selecione sua √°rea...</option>';
    
    ((DATA.restaurant.deliveryAreas || [])).forEach(area => {
        const opt = document.createElement('option');
        opt.value = area.id;
        opt.dataset.fee = area.fee;
        opt.textContent = `${area.name} (${formatBRL(area.fee)})`;
        select.appendChild(opt);
    });
}

function renderCheckoutSavedAddresses() {
  const select = document.querySelector("#checkoutSavedAddresses");
  select.innerHTML = '<option value="" disabled selected>Selecione um endere√ßo salvo...</option>';

  if (currentUser && currentUser.savedAddresses && currentUser.savedAddresses.length > 0) {
    document.querySelector("#checkoutSavedAddressesGroup").style.display = 'block';
    ((currentUser.savedAddresses || [])).forEach(address => {
      const opt = document.createElement('option');
      opt.value = address;
      opt.textContent = address;
      select.appendChild(opt);
    });
  } else {
    document.querySelector("#checkoutSavedAddressesGroup").style.display = 'none';
  }
}


function updateCheckoutTotal(deliveryFee, areaName) {
    const subtotal = cart.reduce((sum, item) => sum + item.totalPrice, 0);
    const total = subtotal + deliveryFee;
    
    document.querySelector("#checkoutSubtotal").textContent = formatBRL(subtotal);
    document.querySelector("#checkoutDeliveryFee").textContent = formatBRL(deliveryFee);
    document.querySelector("#checkoutAreaName").textContent = areaName;
    document.querySelector("#checkoutTotal").textContent = formatBRL(total);
    document.querySelector("#checkoutSubmit").removeAttribute('disabled');
}


// --- Confirmation Modal ---

function showConfirmationModal(order) {
  const summary = document.querySelector("#confirmationSummaryContent");
  summary.innerHTML = '';
  
  // Resumo dos itens
  ((order.items || [])).forEach(item => {
    const div = document.createElement('div');
    div.style.cssText = 'font-size:13px; margin-bottom: 4px;';
    div.innerHTML = `
      <div style="display:flex; justify-content:space-between;">
          <span style="font-weight:600;">${item.qty}x ${item.name}</span>
          <span>${formatBRL(item.totalPrice)}</span>
      </div>
      ${item.addons && item.addons.length > 0 ? `
        <div class="small" style="color:var(--muted); margin-left: 10px;">
          + ${((item.addons || [])).map(a => `${a.qty}x ${a.name}`).join(', ')}
        </div>
      ` : ''}
    `;
    summary.appendChild(div);
  });

  // Totais
  summary.innerHTML += `
      <div style="border-top:1px solid #eee; margin-top: 8px; padding-top: 8px;">
          <div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:4px;">
            <span>Subtotal:</span>
            <span>${formatBRL(order.subtotal)}</span>
          </div>
          <div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:4px;">
            <span>Taxa de Entrega (${order.deliveryAreaName}):</span>
            <span>${formatBRL(order.deliveryFee)}</span>
          </div>
          <div style="display:flex; justify-content:space-between; font-size:16px; font-weight:800; color:var(--primary);">
            <span>TOTAL GERAL:</span>
            <span>${formatBRL(order.total)}</span>
          </div>
      </div>
  `;
  
  document.querySelector("#orderNumberDisplay").textContent = `#${order.id.substring(0, 7).toUpperCase()}`;
  document.querySelector("#confirmationModal").classList.add('open');
}

function closeConfirmationModal(){
    document.querySelector("#confirmationModal").classList.remove('open');
}


// =========================================================================
// === LISTENERS ===
// =========================================================================

function initListeners(){
  // --- Modals de Checkout/Adicionais ---
  document.querySelector("#modalCancel").addEventListener("click", closeModal);
  document.querySelector("#modalConfirm").addEventListener("click", () => {
      if (!document.querySelector("#modalConfirm").disabled) {
          addItemToCart(modalState.item, modalState.qty, modalState.addons);
      }
  });
  
  document.querySelector("#itemQtyControls").addEventListener("click", (e) => {
      if(e.target.dataset.action){
          handleQtyChange(e.target.dataset.action);
      }
  });
  
  document.querySelector("#btnCheckout").addEventListener("click", openCheckoutModal);
  document.querySelector("#checkoutCancel").addEventListener("click", closeCheckoutModal);
  document.querySelector("#checkoutForm").addEventListener("submit", finalizeOrder);
  
  // L√≥gica para mostrar o campo de troco
  document.querySelectorAll('input[name="paymentMethod"]').forEach(input => {
    input.addEventListener('change', (e) => {
        if (e.target.value === 'cash') {
            document.querySelector("#cashChangeGroup").style.display = 'block';
        } else {
            document.querySelector("#cashChangeGroup").style.display = 'none';
            document.querySelector("#cashChange").value = ''; // Limpa o valor do troco
        }
    });
  });

  // L√≥gica para atualizar o total ao selecionar a √°rea de entrega
  document.querySelector("#deliveryAreaSelect").addEventListener('change', (e) => {
    const selectedOption = e.target.options[e.target.selectedIndex];
    if (selectedOption && selectedOption.dataset.fee) {
        const fee = parseFloat(selectedOption.dataset.fee);
        const name = selectedOption.textContent.split('(')[0].trim();
        updateCheckoutTotal(fee, name);
    }
  });
  
  // L√≥gica para preencher o endere√ßo no checkout com o salvo
  document.querySelector("#checkoutSavedAddresses").addEventListener('change', (e) => {
    document.querySelector("#checkoutAddress").value = e.target.value;
  });

  // --- Modals de Admin ---
  document.querySelector("#btnAdminPanel").addEventListener("click", () => openAdminModal('orders'));
  document.querySelector("#tabOrders").addEventListener("click", () => showAdminTab('orders'));
  document.querySelector("#tabSales").addEventListener("click", () => showAdminTab('sales'));
  document.querySelector("#tabCustomers").addEventListener("click", () => showAdminTab('customers'));
  document.querySelector("#tabSettings").addEventListener("click", () => showAdminTab('settings'));
  document.querySelector("#tabPDV").addEventListener("click", () => showAdminTab('pdv'));
  document.querySelector("#closeAdminModal").addEventListener("click", closeAdminModal);
  document.querySelector("#btnReset").addEventListener("click", resetDemo);

  // Formul√°rio de Configura√ß√µes da Loja
  document.querySelector("#storeSettingsForm").addEventListener("submit", saveStoreSettings);
  document.querySelector("#btnAddDeliveryArea").addEventListener("click", addDeliveryArea);

  // Preview do logo
  document.querySelector("#restaurantLogoFile").addEventListener("change", (e) => {
    if (e.target.files && e.target.files[0]) {
      const reader = new FileReader();
      reader.onload = (r) => {
        document.querySelector("#currentLogoPreview").src = r.target.result;
      };
      reader.readAsDataURL(e.target.files[0]);
    }
  });
  
  // --- Modals de Item CRUD ---
  document.querySelector("#itemDetailsForm").addEventListener("submit", saveItemDetails);
  document.querySelector("#itemDetailsCancel").addEventListener("click", closeItemDetailsModal);
  
  // --- Modals de Imagem ---
  document.querySelector("#imageEditForm").addEventListener("submit", saveImageEdit);
  document.querySelector("#imageEditCancel").addEventListener("click", closeImageEditModal);
  document.querySelector("#itemImgFile").addEventListener("change", (e) => {
    if (e.target.files && e.target.files[0]) {
      const reader = new FileReader();
      reader.onload = (r) => {
        document.querySelector("#currentImagePreview").src = r.target.result;
      };
      reader.readAsDataURL(e.target.files[0]);
    }
  });
  
  // --- Modals de Adicionais ---
  document.querySelector("#addonManagementCancel").addEventListener("click", closeAddonManagementModal);
  document.querySelector("#addonManagementSubmit").addEventListener("click", saveAddonManagement);
  document.querySelector("#btnAddAddonGroup").addEventListener("click", addAddonGroup);

  // --- Bot√µes de Export/Import ---
  document.querySelector("#btnExport").addEventListener("click", () => {
    const json = JSON.stringify(DATA, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'cardapio_export.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });
  
  document.querySelector("#btnImport").addEventListener("click", () => {
    document.querySelector("#fileImport").click();
  });
  
  document.querySelector("#fileImport").addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (file && confirm("Importar o arquivo JSON ir√° substituir TODO o card√°pio e configura√ß√µes atuais. Continuar?")) {
      const reader = new FileReader();
      reader.onload = async (event) => {
        try {
          const importedData = JSON.parse(event.target.result);
          DATA = importedData;
          await saveMenuData(); // Salva os dados importados no Firebase
          renderAll();
          alert("Card√°pio importado e salvo no Firebase com sucesso!");
        } catch (err) {
          alert("Erro ao processar o arquivo JSON. Verifique o formato.");
          console.error(err);
        }
      };
      reader.readAsText(file);
    }
    // Limpa o input file para permitir importar o mesmo arquivo novamente
    e.target.value = null; 
  });


  // --- Bot√µes de Autentica√ß√£o/Perfil ---
  document.querySelector("#userBadge").addEventListener("click", () => {
      if(currentUser){
          openProfileModal();
      } else {
          openAuthModal();
      }
  });
  document.querySelector("#tabLogin").addEventListener("click", showLoginForm);
  document.querySelector("#tabRegister").addEventListener("click", showRegisterForm);
  document.querySelector("#loginCancel").addEventListener("click", closeAuthModal);
  document.querySelector("#registerCancel").addEventListener("click", closeAuthModal);
  document.querySelector("#loginSubmit").addEventListener("click", doLogin);
  document.querySelector("#registerSubmit").addEventListener("click", doRegister);
  document.querySelector("#logoutBtn").addEventListener("click", () => {
      currentUser = null;
      isAdmin = false;
      closeProfileModal();
      updateUserBadge();
      toggleAdminUI();
      renderCategories(); // Adicionado para atualizar a visibilidade dos bot√µes de admin na categoria
      renderItems();
  });
  document.querySelector("#closeProfile").addEventListener("click", closeProfileModal);
  
  // Adicionar endere√ßo do usu√°rio
  document.querySelector("#btnAddUserAddress").addEventListener("click", () => {
    if (!currentUser) return;
    const newAddress = document.querySelector("#newAddressInput").value.trim();
    if (newAddress) {
      if (!currentUser.savedAddresses) currentUser.savedAddresses = [];
      currentUser.savedAddresses.push(newAddress);
      const userToUpdate = users.find(u => u.id === currentUser.id);
      if (userToUpdate) {
        userToUpdate.savedAddresses = currentUser.savedAddresses;
        saveUsers();
        renderProfileAddresses();
        document.querySelector("#newAddressInput").value = '';
        alert("Endere√ßo salvo!");
      }
    }
  });


  // --- Footer/Carrinho Mobile ---
  document.querySelector("#btnViewCart").addEventListener("click", () => {
    const cartPanel = document.querySelector("#cartPanel");
    const isActive = window.getComputedStyle(cartPanel).display === 'block';

    if (isActive) {
      cartPanel.style.display = 'none';
    } else {
      cartPanel.style.display = 'block';
    }
  });



  // --- Fechar modais ao clicar no overlay ---
  document.querySelector("#modal").addEventListener("click", (e) => { if(e.target.id === "modal"){ closeModal(); } });
  document.querySelector("#itemDetailsModal").addEventListener("click", (e) => { if(e.target.id === "itemDetailsModal"){ closeItemDetailsModal(); } });
  document.querySelector("#addonManagementModal").addEventListener("click", (e) => { if(e.target.id === "addonManagementModal"){ closeAddonManagementModal(); } });
  document.querySelector("#imageEditModal").addEventListener("click", (e) => { if(e.target.id === "imageEditModal"){ closeImageEditModal(); } });
  document.querySelector("#authModal").addEventListener("click", (e) => { if(e.target.id === "authModal"){ closeAuthModal(); } });
  document.querySelector("#profileModal").addEventListener("click", (e) => { if(e.target.id === "profileModal"){ closeProfileModal(); } });
  document.querySelector("#checkoutModal").addEventListener("click", (e) => { if(e.target.id === "checkoutModal"){ closeCheckoutModal(); } });
  document.querySelector("#adminModal").addEventListener("click", (e) => { if(e.target.id === "adminModal"){ closeAdminModal(); } });
  document.querySelector("#confirmationModal").addEventListener("click", (e) => { if(e.target.id === "confirmationModal"){ closeConfirmationModal(); } });
  document.querySelector("#closeConfirmationModal").addEventListener("click", closeConfirmationModal);
}

// === INICIALIZA√á√ÉO FINAL ===

document.addEventListener("DOMContentLoaded", () => {
  users = loadUsers(); // Carrega usu√°rios locais (para a demo de login)
  fetchMenuData(); // üëà Come√ßa buscando dados do Firebase
  initListeners();
});

// =========================================================================
// === EXPOSI√á√ÉO GLOBAL DE FUN√á√ïES (CORRE√á√ÉO DE ONCLICK/ONCHANGE) ===
// Fun√ß√µes chamadas a partir de HTML gerado dinamicamente precisam estar no escopo global (window)
// =========================================================================
window.updateOrderStatus = updateOrderStatus;
window.removeUserAddress = removeUserAddress;
window.addAddonGroup = addAddonGroup;
window.removeAddonGroup = removeAddonGroup;
window.addAddonItem = addAddonItem;
window.removeAddonItem = removeAddonItem;
window.updateAddonGroupProp = updateAddonGroupProp;
window.updateAddonItemProp = updateAddonItemProp;
window.removeDeliveryArea = removeDeliveryArea;
window.editCategory = editCategory;
window.removeCategory = removeCategory;




// ======= PDV (Mesas) ‚Äî Inserido automaticamente =======

/**
 * Renderiza as mesas no painel PDV (#pdvTablesGrid).
 * Usa DATA.restaurant.tables ‚Äî mantido em Firestore via saveMenuData().
 */
document.addEventListener("DOMContentLoaded", () => {
    const grid = document.querySelector("#pdvTablesGrid");
    if (!grid) return;

    grid.addEventListener("click", (e) => {
        const button = e.target.closest("button[data-table-id]");
        if (!button) return;

        const tableId = button.dataset.tableId;
        const action = button.dataset.action;

        if (action === "show-details") {
            openTableDetailsModal(tableId);
        } else if (action === "open-comanda") {
            openPDVOrderModal(tableId);
        }
    });
});

function renderPDVTables(){
    const grid = document.querySelector("#pdvTablesGrid");
    if(!grid) return;
    grid.innerHTML = '';

    const tables = (DATA && DATA.restaurant && DATA.restaurant.tables) ? DATA.restaurant.tables : [];

    tables.forEach(table => {
        const div = document.createElement('div');
        // Novo status: 'livre' (padr√£o), 'ocupada' (tem orderId), 'fechada' (status final, n√£o usado aqui)
        const isOccupied = !!table.orderId;
        const status = isOccupied ? 'ocupada' : 'livre';
        
        let bg = '#f1f1f1';
        let color = '#555';
        if(status === 'livre') {
            bg = '#e6ffe6'; // Verde claro
            color = '#28a745';
        }
        if(status === 'ocupada') {
            bg = '#fff3cd'; // Amarelo claro
            color = '#ffc107';
        }
        
        div.style.cssText = `background:${bg};border-radius:10px;padding:16px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,0.05);border:1px solid #eee;`;
        
        let html = `<strong style="display:block;margin-bottom:6px">${table.name || 'Mesa'}</strong><small style="color:${color}">Status: ${status.toUpperCase()}</small>`;
        
        if(isOccupied){
            html += `<button class=\"btn\" style=\"margin-top:10px; padding: 8px 12px; font-size: 14px; background: var(--primary);\" data-action=\"show-details\" data-table-id=\"${table.id}\">Pedidos</button>`;
        } else {
            html += `<button class=\"btn\" style=\"margin-top:10px; padding: 8px 12px; font-size: 14px; background: #007bff;\" data-action=\"open-comanda\" data-table-id=\"${table.id}\">Abrir Comanda</button>`;
        }
        
        div.innerHTML = html;
        grid.appendChild(div);
    });

    // bot√£o adicionar mesa (admin)
    if(isAdmin){
        const btn = document.createElement('button');
        btn.className = 'btn';
        btn.style.cssText = 'background:#28a745;color:#fff;width:100%;margin-top:8px;padding:12px;border-radius:8px;';
        btn.textContent = '+ Adicionar Nova Mesa';
        btn.addEventListener('click', async () => {
            const name = prompt('Nome da nova mesa:', 'Mesa ' + ((tables && tables.length) ? (tables.length + 1) : 1));
            if(!name) return;
            const newTable = { id: Date.now().toString(), name: name, status: 'livre', pedidos: [] };
            if(!DATA.restaurant) DATA.restaurant = {};
            if(!Array.isArray(DATA.restaurant.tables)) DATA.restaurant.tables = [];
            DATA.restaurant.tables.push(newTable);
            await saveMenuData();
            renderPDVTables();
            alert('Mesa adicionada: ' + name);
        });
        grid.appendChild(btn);
    }
}

/**
 * Abre o modal de pedido para a mesa selecionada.
 * Se admin clicar em um item, usa addItemToCart que j√° suporta PDV quando pdvCartState.tableId est√° setado.
 */
function openPDVOrderModal(tableId, existingOrderId = null){
    const table = (DATA.restaurant.tables || []).find(t => t.id === tableId);
    if(!table) return;
    
    // Se a mesa j√° tem um pedido, abre o modal de detalhes, n√£o o de novo pedido, a menos que seja para adicionar itens
    if(table.orderId && !existingOrderId){
        openTableDetailsModal(tableId);
        return;
    }
    
    pdvCartState = { tableId: table.id, items: [], existingOrderId: existingOrderId };
    document.querySelector("#pdvOrderTitle").textContent = 'Pedido ‚Äî ' + (table.name || 'Mesa');
    document.querySelector("#pdvItemsList").innerHTML = '';
    document.querySelector("#pdvCartList").innerHTML = '';
    document.querySelector("#pdvSubtotal").textContent = "R$ 0,00";
    
    // Se for para adicionar itens, carrega o pedido existente no carrinho
    if(existingOrderId){
        const existingOrder = orders.find(o => o.id === existingOrderId);
        if(existingOrder){
            // Copia os itens existentes para o carrinho PDV para que o usu√°rio possa ver o que j√° foi pedido
            // NOTA: Estes itens n√£o ser√£o enviados novamente, apenas os novos ser√£o adicionados ao array pdvCartState.items
            // A l√≥gica de merge ser√° feita no finalizePDVOrder
            pdvCartState.existingItems = existingOrder.items;
            document.querySelector("#pdvOrderTitle").textContent = 'Adicionar Itens ‚Äî ' + (table.name || 'Mesa');
        }
    } else {
        pdvCartState.existingItems = [];
    }

    // Render items - ao clicar abre o modal de adicionais (openModal)
    (DATA.items || []).forEach(item => {
        const btn = document.createElement('button');
        btn.className = 'pill';
        btn.style.cssText = 'display:block;width:100%;text-align:left;margin-bottom:6px;';
        btn.textContent = `${item.name} ‚Äî ${formatBRL(item.price)}`;
        btn.addEventListener('click', () => {
            // No modo PDV, ao clicar no item, abre o modal de adicionais
            // O modal de adicionais precisa saber que est√° no modo PDV
            openModal(item, true); // O segundo argumento 'true' indica modo PDV
        });
        document.querySelector("#pdvItemsList").appendChild(btn);
    });

    // mostra modal
    document.querySelector("#pdvOrderModal").classList.add('open');
    // adapta estilo caso modal seja usado em vers√£o sem class open handling
    if(window.getComputedStyle(document.querySelector("#pdvOrderModal")).display === 'none'){
        document.querySelector("#pdvOrderModal").style.display = 'flex';
    }
    renderPDVCart();
}

/**
 * Renderiza o carrinho local do PDV com base em pdvCartState.items
 */
function renderPDVCart(){
    const list = document.querySelector("#pdvCartList");
    if(!list) return;
    list.innerHTML = '';
    let subtotal = 0;

    const items = (pdvCartState && pdvCartState.items) ? pdvCartState.items : [];

    items.forEach((it, idx) => {
        subtotal += it.totalPrice;
        const row = document.createElement('div');
        row.style.cssText = 'border-bottom:1px solid #eee;padding:8px 0;';
        row.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;"><div><strong>${it.qty}x ${it.name}</strong><div class="small" style="color:var(--muted)">${formatBRL(it.price)} cada</div></div><div style="text-align:right"><div style="font-weight:700">${formatBRL(it.totalPrice)}</div><button class="pill" style="margin-top:6px;background:#fbe6e6;color:#dc3545;" data-idx="${idx}">Remover</button></div></div>`;
        list.appendChild(row);
    });

    document.querySelector("#pdvSubtotal").textContent = formatBRL(subtotal);

    // remover item do pdvCart
    list.querySelectorAll('button[data-idx]').forEach(b=>{
        b.addEventListener('click', (e)=>{
            const idx = parseInt(e.target.dataset.idx, 10);
            if(!isNaN(idx)){
                pdvCartState.items.splice(idx,1);
                renderPDVCart();
            }
        });
    });
}

/**
 * Fecha modal PDV e limpa estado de pdvCartState.tableId (mant√©m itens at√© finalizar)
 */
function closePDVOrderModal(){
    document.querySelector("#pdvOrderModal").classList.remove('open');
    if(window.getComputedStyle(document.querySelector("#pdvOrderModal")).display !== 'none'){
        document.querySelector("#pdvOrderModal").style.display = 'none';
    }
    pdvCartState.existingOrderId = null; // Limpa o estado de adi√ß√£o de itens
}


// === PDV Checkout: abre resumo antes de enviar para cozinha ===
function formatLinePrice(qty, name, price) {
  return `<div style="display:flex; justify-content:space-between; align-items:flex-start; gap:8px;">
            <div style="flex:1;"><strong>${qty}x</strong> ${name}</div>
            <div style="min-width:90px; text-align:right;">${formatBRL(price)}</div>
          </div>`;
}

function openPDVCheckoutModal() {
  if (!pdvCartState || !pdvCartState.tableId || (pdvCartState.items || []).length === 0) {
    alert("Nenhum item no pedido da mesa.");
    return;
  }

  // Preenche a mesa e t√≠tulo
  document.querySelector("#pdvCheckoutTable").value = pdvCartState.tableId;
  document.querySelector("#pdvCheckoutTitle").textContent = "Mesa " + pdvCartState.tableId;

  // Limpa campo cliente
  document.querySelector("#pdvCheckoutClient").value = "";

  // Renderiza os itens
  const summaryEl = document.querySelector("#pdvCheckoutSummary");
  summaryEl.innerHTML = "";

  let subtotal = 0;
  (pdvCartState.items || []).forEach(item => {
    subtotal += item.totalPrice;

    const wrapper = document.createElement("div");
    wrapper.style.cssText = "border-bottom:1px solid #eee; padding:6px 0;";

    // linha principal com qty, nome e pre√ßo do item
    wrapper.innerHTML = formatLinePrice(item.qty, item.name, item.totalPrice);

    // adicionais detalhados
    if (item.addons && item.addons.length > 0) {
      item.addons.forEach(group => {
        (group.selected || []).forEach(addon => {
          if (addon.qty > 0) {
            const originalItem = getItem(item.itemId);
            const originalGroup = originalItem?.addonGroups?.find(g => g.id === group.groupId);
            const addonDef = originalGroup?.addons?.find(a => a.id === addon.addonId);
            const addonName = addonDef ? addonDef.name : "Adicional";
            const addonPrice = addonDef ? addonDef.price : 0;
            const line = document.createElement("div");
            line.classList.add("small");
            line.style.cssText = "margin-left:10px; color:var(--muted);";
            line.innerHTML = `+ ${addon.qty}x ${addonName} ${addonPrice > 0 ? '(' + formatBRL(addonPrice) + ')' : ''}`;
            wrapper.appendChild(line);
          }
        });
      });
    }

    summaryEl.appendChild(wrapper);
  });

  document.querySelector("#pdvCheckoutSubtotal").textContent = formatBRL(subtotal);
  // No PDV assumimos sem taxa; Total = subtotal (mas mantemos campo)
  document.querySelector("#pdvCheckoutTotal").textContent = formatBRL(subtotal);

  // Abre modal
  document.querySelector("#pdvCheckoutModal").classList.add("open");
}

// Bot√µes do modal de checkout PDV
document.addEventListener("DOMContentLoaded", () => {
  const cancelBtn = document.querySelector("#pdvCheckoutCancel");
  if (cancelBtn) {
    cancelBtn.addEventListener("click", () => {
      document.querySelector("#pdvCheckoutModal").classList.remove("open");
    });
  }

  const confirmBtn = document.querySelector("#pdvCheckoutConfirm");
  if (confirmBtn) {
    confirmBtn.addEventListener("click", async () => {
      // L√™ o nome do cliente (opcional) e chama finalizePDVOrder
      const clientName = document.querySelector("#pdvCheckoutClient").value.trim();
      document.querySelector("#pdvCheckoutModal").classList.remove("open");
      await finalizePDVOrder(clientName);
    });
  }

  // Substitui o evento do bot√£o PDV no modal principal para abrir o checkout
  const pdvBtn = document.querySelector("#pdvFinalizeBtn");
  if (pdvBtn) {
    pdvBtn.removeEventListener("click", openPDVCheckoutModal);
    pdvBtn.addEventListener("click", openPDVCheckoutModal);
  }
});


// ==== Drawer de Pedidos ====
(function(){
  const root = document;
  function $(sel){ return root.querySelector(sel); }
  // Guard: if elements not yet present, retry
  function openOrdersDrawerHandler(){
    if (!currentUser) { openAuthModal(); return; }
    renderOrdersDrawer();
    document.getElementById('ordersDrawer').classList.add('open');
  }
  function closeOrdersDrawerHandler(){
    document.getElementById('ordersDrawer').classList.remove('open');
  }
  // attach when DOM ready
  document.addEventListener('DOMContentLoaded', function(){
    if(document.querySelector("#btnViewOrders")) document.querySelector("#btnViewOrders").addEventListener('click', openOrdersDrawerHandler);
    if(document.querySelector("#closeOrdersDrawer")) document.querySelector("#closeOrdersDrawer").addEventListener('click', closeOrdersDrawerHandler);
  });
  // also attach immediately if possible
  if(document.querySelector("#btnViewOrders")) document.querySelector("#btnViewOrders").addEventListener('click', openOrdersDrawerHandler);
  if(document.querySelector("#closeOrdersDrawer")) document.querySelector("#closeOrdersDrawer").addEventListener('click', closeOrdersDrawerHandler);

  window.renderOrdersDrawer = function() {
    const list = document.getElementById('ordersDrawerList');
    if(!list) return;
    list.innerHTML = '';
    const userOrders = ((orders || [])).filter(o => currentUser && o.userId === currentUser.id);
    if (!userOrders || userOrders.length === 0) {
      list.innerHTML = '<div class="small" style="color:var(--muted);text-align:center;">Nenhum pedido encontrado.</div>';
      return;
    }
    userOrders.forEach(order => {
      const statusInfo = ORDER_STATUSES[order.status] || ORDER_STATUSES.pending;
      const div = document.createElement('div');
      div.className = 'order-item';
      div.style.cssText = 'border:1px solid #eee;border-radius:10px;padding:10px;margin-bottom:8px;box-shadow:0 4px 8px rgba(0,0,0,0.03);';
      div.innerHTML = ''
        + '<div style="display:flex;justify-content:space-between;align-items:center;">'
        + '<strong style="font-size:15px;">Pedido #' + (order.id ? order.id.substring(0,7) : '') + '</strong>'
        + '<span style="font-weight:600;color:' + (statusInfo.color || '#000') + ';">' + (statusInfo.label || '') + '</span>'
        + '</div>'
        + '<div class="small" style="color:var(--muted);margin:4px 0;">' + (new Date(order.createdAt).toLocaleDateString()) + ' ‚Äî Total ' + formatBRL(order.total) + '</div>'
        + '<div style="font-size:13px;color:#444;line-height:1.4;">' + (order.items.map(i => i.qty + 'x ' + i.name).join('<br>')) + '</div>';
      list.appendChild(div);
    });
  };
})();


// ==== Compatibilidade: logout (profile modal + admin) ====
document.addEventListener("DOMContentLoaded", () => {
  function attachLogout(el) {
    if (!el) return;
    el.removeEventListener("click", el._logoutHandler);
    el._logoutHandler = () => {
      if (confirm("Deseja realmente sair da conta?")) {
        if (typeof logoutUser === "function") {
          logoutUser();
        } else {
          // fallback: clear currentUser and reload UI
          currentUser = null;
          isAdmin = false;
          saveUsers();
          renderAll();
          alert("Voc√™ saiu da conta (logout fallback).");
        }
      }
    };
    el.addEventListener("click", el._logoutHandler);
  }

  const els = Array.from(document.querySelectorAll("#logoutBtn, #btnLogout, [data-action='logout']"));
  els.forEach(attachLogout);

  // Observe mutations to catch dynamically added buttons (e.g., modal injected later)
  const obs = new MutationObserver(muts => {
    muts.forEach(m => {
      m.addedNodes && m.addedNodes.forEach(node => {
        if (!(node instanceof HTMLElement)) return;
        const found = node.querySelectorAll && node.querySelectorAll("#logoutBtn, #btnLogout, [data-action='logout']");
        if (found && found.length) found.forEach(attachLogout);
        if (node.matches && (node.matches("#logoutBtn") || node.matches("#btnLogout") || node.matches("[data-action='logout']"))) attachLogout(node);
      });
    });
  });
  obs.observe(document.body, { childList: true, subtree: true });
});


// === FOR√áAR: Carrinho inicia oculto em telas pequenas (mobile) ===
document.addEventListener("DOMContentLoaded", () => {
  const cartPanel = document.getElementById("cartPanel");
  if (cartPanel && window.innerWidth <= 1024) {
    cartPanel.style.display = "none";
  }
});

// === Comanda Avulsa: handler UI e envio ===
document.addEventListener("DOMContentLoaded", () => {
  const btnComanda = document.getElementById("btnComandaAvulsa");
  const comandaModal = document.getElementById("comandaModal");
  const comandaForm = document.getElementById("comandaForm");
  const comandaCancel = document.getElementById("comandaCancel");

  if (btnComanda && comandaModal) {
    btnComanda.addEventListener("click", () => {
      comandaModal.classList.add("open");
      // focus no primeiro campo
      const f = document.getElementById("comandaName");
      if (f) f.focus();
    });
  }

  if (comandaCancel) {
    comandaCancel.addEventListener("click", () => {
      comandaModal.classList.remove("open");
      comandaForm.reset();
    });
  }

  if (comandaForm) {
    comandaForm.addEventListener("submit", async (ev) => {
      ev.preventDefault();
      const name = document.getElementById("comandaName").value.trim();
      const value = parseFloat(document.getElementById("comandaValue").value) || 0;
      const payment = document.getElementById("comandaPayment").value;
      const cpf = document.getElementById("comandaCPF").value.trim();

      if (!name || value <= 0) {
        alert("Preencha o nome do cliente e um valor maior que zero.");
        return;
      }

      // Monta o objeto do pedido semelhante aos pedidos normais
      const newOrder = {
        userId: "comanda_" + Date.now().toString(),
        userName: name,
        userPhone: "",
        address: "",
        deliveryAreaId: "",
        deliveryAreaName: "Comanda Avulsa",
        deliveryFee: 0,
        items: [], // comanda avulsa n√£o tem itens detalhados
        subtotal: value,
        total: value,
        paymentMethod: payment,
        cpfOnReceipt: cpf || null,
        type: "comandaAvulsa",
        status: "pending",
        createdAt: new Date().toISOString()
      };

      try {
        // usa a mesma cole√ß√£o de pedidos em tempo real
        await addDoc(ordersCollectionRef, newOrder);
        // fecha modal e limpa form
        comandaModal.classList.remove("open");
        comandaForm.reset();
        alert("Comanda avulsa criada com sucesso.");
      } catch (err) {
        console.error("Falha ao salvar comanda avulsa:", err);
        alert("Erro ao criar comanda. Verifique a conex√£o.");
      }
    });
  }
});

window.printOrder = function(orderId) {
  const order = orders.find(o => o.id === orderId);
  if (!order) return alert('Pedido n√£o encontrado.');

  // Fun√ß√µes auxiliares (assumindo que j√° existem no escopo global do HTML)
  // formatBRL(value)
  // formatCPFCNPJ(value) - Precisa ser criada ou assumida

  // Dados fict√≠cios ou extra√≠dos do objeto 'order'
  const orderDate = new Date(order.createdAt).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
  const orderTime = new Date(order.createdAt).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
  const deliveryTime = order.deliveryTime || '30min a 1h'; // Assumindo que o tempo de entrega est√° em 'order.deliveryTime' ou um valor padr√£o
  const storeName = order.storeName || 'Acaiteria Creamy Purple'; // Assumindo que o nome da loja est√° em 'order.storeName' ou um valor padr√£o
  const orderNumber = order.orderNumber || order.id.substring(0, 7); // N√∫mero do pedido

  // Informa√ß√µes do Cliente
  const clientName = order.userName || 'N/A';
  const clientCpfCnpj = order.userCpfCnpj ? formatCPFCNPJ(order.userCpfCnpj) : 'N/A'; // Assumindo formatCPFCNPJ existe
  const clientPhone = order.userPhone || 'N/A';
  const clientOrderCount = order.userOrderCount || 'N/A'; // Assumindo que a contagem de pedidos est√° em 'order.userOrderCount'
  const clientAddress = order.address || 'N/A';
  const clientNeighborhood = order.neighborhood || 'N/A'; // Assumindo que o bairro est√° em 'order.neighborhood'

  // Informa√ß√µes de Pagamento
  let paymentMethod = 'N/A';
  if (order.paymentMethod === 'cash') {
    paymentMethod = 'Dinheiro' + (order.changeNeeded > 0 ? ` (Troco: ${formatBRL(order.changeNeeded)})` : '');
  } else if (order.paymentMethod === 'credit') {
    paymentMethod = 'Cart√£o de Cr√©dito';
  } else if (order.paymentMethod === 'debit') {
    paymentMethod = 'Cart√£o de D√©bito';
  } else if (order.paymentMethod === 'pix') {
    paymentMethod = 'PIX';
  }

  // Valores
  const subtotal = order.subtotal || order.total - (order.deliveryFee || 0); // Assumindo que subtotal existe ou pode ser calculado
  const deliveryFee = order.deliveryFee || 0;
  const total = order.total || 0;

  // Gera√ß√£o da lista de itens
  const itemsList = (order.items || []).map(item => {
    let itemHtml = `<div class="footer-line"><span>${item.qty}x ${item.name}</span><span>${formatBRL(item.price)}</span></div>`;
    if (item.addons && item.addons.length > 0) {
      item.addons.forEach(a => {
        itemHtml += `<div class="item-addon"> &nbsp; &nbsp; + ${a.qty}x ${a.name}</div>`;
      });
    }
    return itemHtml;
  }).join('');

  const printContent = `
    <html>
      <head>
        <title>Comanda - Pedido #${orderNumber}</title>
        <style>
          @page { size: 58mm auto; margin: 5mm; }
          body { font-family: monospace; font-size: 10px; line-height: 1.2; white-space: pre; }
          .center { text-align: center; }
          .right { text-align: right; }
          .line { border-top: 1px dashed #000; margin: 5px 0; }
          .bold { font-weight: bold; }
          .item-line { margin-left: 5px; }
          .footer-line { display: flex; justify-content: space-between; }
          .item-addon { margin-left: 10px; }
        </style>
      </head>
      <body>
===============================================
               COMANDA - PEDIDO
===============================================
<div class="center">${orderDate} ${orderTime}</div>
<div class="center">Entrega prevista: ${deliveryTime}</div>
<div class="center">${storeName}</div>
<div class="center bold">===============================================</div>
<div class="center bold">                Pedido:</div>
<div class="line"></div>
<div class="bold">Itens:</div>
<div class="items-list">${itemsList}</div>
<div class="line"></div>
<div class="bold">Cliente</div>

Nome: ${clientName}
CPF/CNPJ: ${clientCpfCnpj}
Telefone: ${clientPhone}
Quantidade de pedidos: ${clientOrderCount}
Endere√ßo: ${clientAddress}
Bairro: ${clientNeighborhood}
<div class="line"></div>
<div class="bold">Pagamento</div>

Forma de Pagamento: ${paymentMethod}
<div class="line"></div>
<div class="footer-line"><span>Subtotal:</span><span>${formatBRL(subtotal)}</span></div>
<div class="footer-line"><span>Taxa de entrega:</span><span>${formatBRL(deliveryFee)}</span></div>
<div class="footer-line"><span>Total:</span><span>${formatBRL(total)}</span></div>
<div class="line"></div>
      </body>
    </html>
  `;

  const win = window.open('', 'PRINT', 'height=600,width=400');
  win.document.write(printContent);
  win.document.close();
  win.focus();
  win.print();
}

</script>

<!-- PDV Checkout Modal: confirma antes de enviar para cozinha -->
<div class="modal" id="pdvCheckoutModal">
  <div class="card" role="dialog" aria-modal="true" style="max-width:600px;">
    <h3>Confirmar Pedido da Mesa <span id="pdvCheckoutTitle" style="float:right; color:var(--primary); font-weight:800;"></span></h3>

    <div class="form-group">
      <label for="pdvCheckoutTable">Mesa</label>
      <input type="text" id="pdvCheckoutTable" readonly>
    </div>

    <div class="form-group">
      <label for="pdvCheckoutClient">Nome do Cliente (opcional)</label>
      <input type="text" id="pdvCheckoutClient" placeholder="Ex: Jo√£o, Ana, etc.">
    </div>

    <h4>Itens do Pedido</h4>
    <div id="pdvCheckoutSummary" style="max-height:300px; overflow:auto; border:1px solid #eee; border-radius:8px; padding:8px;"></div>

    <div style="margin-top:10px; display:flex; justify-content:space-between; font-weight:600;">
      <span>Subtotal:</span>
      <span id="pdvCheckoutSubtotal" style="color:var(--primary);">R$ 0,00</span>
    </div>

    <div style="margin-top:6px; display:flex; justify-content:space-between; font-weight:600;">
      <span>Total Geral:</span>
      <span id="pdvCheckoutTotal" style="color:var(--primary);">R$ 0,00</span>
    </div>

    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:20px;">
      <button class="pill" id="pdvCheckoutCancel">Voltar</button>
      <button class="btn" id="pdvCheckoutConfirm" style="background:#28a745;">Enviar para Cozinha</button>
    </div>
  </div>
</div>


<div class="drawer" id="ordersDrawer">
  <div class="drawer-content">
    <h4>üì¶ Meus Pedidos</h4>
    <div id="ordersDrawerList"></div>
    <button class="btn" id="closeOrdersDrawer" style="margin-top:12px;width:100%;">Fechar</button>
  </div>
</div>


<!-- === BOT√ÉO FECHAR PDV === -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const closeBtn = document.getElementById("closePdvOrderModal");
  const modal = document.getElementById("pdvOrderModal");
  if (closeBtn && modal) {
    closeBtn.addEventListener("click", () => {
      modal.classList.remove("open");
    });
  }
});

/* ===== Relat√≥rio de Vendas Din√¢mico (inserido automaticamente) ===== */
(function(){
  // Utilidades locais
  function parseDate(d){
    try { return new Date(d); } catch(e){ return null; }
  }

  function isDelivered(order){
    return order && order.status === "delivered";
  }

  function withinPeriod(dateObj, period){
    if(!dateObj) return false;
    const now = new Date();
    const start = new Date(now);
    if(period === "day"){
      start.setHours(0,0,0,0);
      return dateObj >= start && dateObj <= now;
    } else if(period === "week"){
      // last 7 days (including today)
      start.setDate(now.getDate() - 6);
      start.setHours(0,0,0,0);
      return dateObj >= start && dateObj <= now;
    } else if(period === "month"){
      // last 30 days (including today)
      start.setDate(now.getDate() - 29);
      start.setHours(0,0,0,0);
      return dateObj >= start && dateObj <= now;
    }
    return false;
  }

  function getFilteredOrders(period){
    const filtered = (orders || []).filter(o => {
      if(!isDelivered(o)) return false;
      const created = parseDate(o.createdAt);
      return withinPeriod(created, period);
    });
    return filtered;
  }

  function calcSummary(filtered){
    const summary = { revenue:0, count:0, avg:0, topArea:"N/A" };
    summary.count = filtered.length;
    summary.revenue = filtered.reduce((s,o)=> s + (parseFloat(o.total) || parseFloat(o.subtotal) || 0), 0);
    summary.avg = summary.count > 0 ? summary.revenue / summary.count : 0;
    // top area
    const areas = {};
    filtered.forEach(o => {
      const area = o.deliveryAreaName || "N/A";
      areas[area] = (areas[area] || 0) + 1;
    });
    const top = Object.entries(areas).sort((a,b)=>b[1]-a[1])[0];
    if(top) summary.topArea = `${top[0]} (${top[1]} pedidos)`;
    return summary;
  }

  function calcTopProducts(filtered, limit=10){
    const counts = {};
    filtered.forEach(o => {
      (o.items || []).forEach(it => {
        const key = it.itemId || it.name;
        counts[key] = counts[key] || { name: it.name || key, qty: 0 };
        counts[key].qty += (parseInt(it.qty) || 0);
      });
    });
    return Object.values(counts).sort((a,b)=>b.qty-a.qty).slice(0,limit);
  }

  function calcPayments(filtered){
    const map = {};
    filtered.forEach(o => {
      const pm = o.paymentMethod || "unknown";
      map[pm] = (map[pm] || 0) + 1;
    });
    const total = filtered.length;
    return Object.entries(map).map(([k,v]) => ({ method:k, count:v, pct: total>0 ? Math.round((v/total)*100) : 0 }))
      .sort((a,b)=>b.count-a.count);
  }

  function calcAreas(filtered){
    const map = {};
    filtered.forEach(o => {
      const area = o.deliveryAreaName || "N/A";
      map[area] = map[area] || { orders:0, total:0 };
      map[area].orders += 1;
      map[area].total += (parseFloat(o.total) || parseFloat(o.subtotal) || 0);
    });
    return Object.entries(map).map(([k,v])=>({ area:k, orders:v.orders, total:v.total })).sort((a,b)=>b.orders-a.orders);
  }

  // Renderers
  function renderSummaryCards(summary){
    document.querySelector("#cardRevenue").textContent = formatBRL(summary.revenue);
    document.querySelector("#cardCount").textContent = summary.count;
    document.querySelector("#cardAvg").textContent = formatBRL(summary.avg);
    document.querySelector("#cardTopArea").textContent = summary.topArea;
  }

  function renderTopProducts(list){
    const tbody = document.querySelector("#tableTopProducts tbody");
    tbody.innerHTML = "";
    if(list.length === 0){
      tbody.innerHTML = '<tr><td colspan="3" style="padding:8px;color:var(--muted)">Nenhum produto encontrado no per√≠odo.</td></tr>';
      return;
    }
    list.forEach((p, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td style="padding:8px;border-bottom:1px solid #f1f1f1">${idx+1}</td>
                      <td style="padding:8px;border-bottom:1px solid #f1f1f1">${p.name}</td>
                      <td style="padding:8px;border-bottom:1px solid #f1f1f1">${p.qty}</td>`;
      tbody.appendChild(tr);
    });
  }

  function renderPayments(list){
    const tbody = document.querySelector("#tablePayments tbody");
    tbody.innerHTML = "";
    if(list.length === 0){
      tbody.innerHTML = '<tr><td colspan="3" style="padding:8px;color:var(--muted)">Nenhuma forma de pagamento encontrada.</td></tr>';
      return;
    }
    list.forEach(p => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td style="padding:8px;border-bottom:1px solid #f1f1f1">${p.method}</td>
                      <td style="padding:8px;border-bottom:1px solid #f1f1f1">${p.count}</td>
                      <td style="padding:8px;border-bottom:1px solid #f1f1f1">${p.pct}%</td>`;
      tbody.appendChild(tr);
    });
  }

  function renderAreas(list){
    const tbody = document.querySelector("#tableAreas tbody");
    tbody.innerHTML = "";
    if(list.length === 0){
      tbody.innerHTML = '<tr><td colspan="3" style="padding:8px;color:var(--muted)">Nenhuma √°rea encontrada.</td></tr>';
      return;
    }
    list.forEach(a => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td style="padding:8px;border-bottom:1px solid #f1f1f1">${a.area}</td>
                      <td style="padding:8px;border-bottom:1px solid #f1f1f1">${a.orders}</td>
                      <td style="padding:8px;border-bottom:1px solid #f1f1f1">${formatBRL(a.total)}</td>`;
      tbody.appendChild(tr);
    });
  }

  // Main update
  function updateSalesReport(period){
    const filtered = getFilteredOrders(period);
    const summary = calcSummary(filtered);
    const topProducts = calcTopProducts(filtered, 10);
    const payments = calcPayments(filtered);
    const areas = calcAreas(filtered);

    renderSummaryCards(summary);
    renderTopProducts(topProducts);
    renderPayments(payments);
    renderAreas(areas);
  }

  // UI bindings
  function initSalesReport(){
    const buttons = Array.from(document.querySelectorAll(".period-btn"));
    buttons.forEach(btn => {
      btn.addEventListener("click", () => {
        buttons.forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        const period = btn.dataset.period || "day";
        updateSalesReport(period);
      });
    });
    // initial render: day
    updateSalesReport("day");

    // Re-render when the admin modal is open and orders update: hook into existing re-render flow
    const origRenderAdminDashboard = window.renderAdminDashboard;
    window.renderAdminDashboard = function(...args){
      try{ if (typeof origRenderAdminDashboard === "function") origRenderAdminDashboard.apply(this,args); }catch(e){}
      // determine active period
      const activeBtn = document.querySelector(".period-btn.active");
      const period = activeBtn ? activeBtn.dataset.period : "day";
      updateSalesReport(period);
    };
  }

  // Wait for DOM and for existing functions to be available
  
function safeInit() {
  if (typeof orders !== "undefined" && typeof formatBRL === "function") {
    initSalesReport();
  } else {
    setTimeout(safeInit, 300);
  }
}
safeInit();

/* ===== Relat√≥rio de Vendas Din√¢mico (inserido automaticamente) ===== */
(function(){
  // Utilidades locais
  function parseDate(d){
    try { return new Date(d); } catch(e){ return null; }
  }

  function isDelivered(order){
    if(!order || !order.status) return false;
    const s = String(order.status).toLowerCase().trim();
    return s === "delivered" || s === "entregue" || s === "entregada";
  }

  function withinPeriod(dateObj, period){
    if(!dateObj) return false;
    const now = new Date();
    const start = new Date(now);
    if(period === "day"){
      start.setHours(0,0,0,0);
      return dateObj >= start && dateObj <= now;
    } else if(period === "week"){
      start.setDate(now.getDate() - 6);
      start.setHours(0,0,0,0);
      return dateObj >= start && dateObj <= now;
    } else if(period === "month"){
      start.setDate(now.getDate() - 29);
      start.setHours(0,0,0,0);
      return dateObj >= start && dateObj <= now;
    }
    return false;
  }

  function getAllOrdersArray(){
    const candidates = [window.orders, window.adminOrders, window.pdvOrders, window.firebaseOrders, window._orders];
    for(const c of candidates){
      if(Array.isArray(c)) return c;
    }
    try{ if(typeof orders !== "undefined" && Array.isArray(orders)) return orders; }catch(e){}
    return [];
  }

  function getFilteredOrders(period){
    const all = getAllOrdersArray();
    const filtered = (all || []).filter(o => {
      if(!isDelivered(o)) return false;
      const created = parseDate(o.createdAt || o.created_at || o.timestamp);
      return withinPeriod(created, period);
    });
    return filtered;
  }

  function calcSummary(filtered){
    const summary = { revenue:0, count:0, avg:0, topArea:"N/A" };
    summary.count = filtered.length;
    summary.revenue = filtered.reduce((s,o)=> s + (parseFloat(o.total) || parseFloat(o.subtotal) || parseFloat(o.totalPrice) || 0), 0);
    summary.avg = summary.count > 0 ? summary.revenue / summary.count : 0;
    const areas = {};
    filtered.forEach(o => {
      const area = o.deliveryAreaName || o.deliveryArea || "N/A";
      areas[area] = (areas[area] || 0) + 1;
    });
    const top = Object.entries(areas).sort((a,b)=>b[1]-a[1])[0];
    if(top) summary.topArea = `${top[0]} (${top[1]} pedidos)`;
    return summary;
  }

  function calcTopProducts(filtered, limit=10){
    const counts = {};
    filtered.forEach(o => {
      (o.items || []).forEach(it => {
        const key = it.itemId || it.id || it.name;
        counts[key] = counts[key] || { name: it.name || it.title || key, qty: 0 };
        counts[key].qty += (parseInt(it.qty) || parseInt(it.quantity) || 0);
      });
    });
    return Object.values(counts).sort((a,b)=>b.qty-a.qty).slice(0,limit);
  }

  function calcPayments(filtered){
    const map = {};
    filtered.forEach(o => {
      const pm = o.paymentMethod || o.payment || "unknown";
      map[pm] = (map[pm] || 0) + 1;
    });
    const total = filtered.length;
    return Object.entries(map).map(([k,v]) => ({ method:k, count:v, pct: total>0 ? Math.round((v/total)*100) : 0 }))
      .sort((a,b)=>b.count-a.count);
  }

  function calcAreas(filtered){
    const map = {};
    filtered.forEach(o => {
      const area = o.deliveryAreaName || o.deliveryArea || "N/A";
      map[area] = map[area] || { orders:0, total:0 };
      map[area].orders += 1;
      map[area].total += (parseFloat(o.total) || parseFloat(o.subtotal) || parseFloat(o.totalPrice) || 0);
    });
    return Object.entries(map).map(([k,v])=>({ area:k, orders:v.orders, total:v.total })).sort((a,b)=>b.orders-a.orders);
  }

  // Renderers using standard DOM (no $ helper)
  function renderSummaryCards(summary){
    const elRev = document.querySelector("#cardRevenue");
    const elCnt = document.querySelector("#cardCount");
    const elAvg = document.querySelector("#cardAvg");
    const elTop = document.querySelector("#cardTopArea");
    if(elRev) elRev.textContent = formatBRL(summary.revenue);
    if(elCnt) elCnt.textContent = summary.count;
    if(elAvg) elAvg.textContent = formatBRL(summary.avg);
    if(elTop) elTop.textContent = summary.topArea;
  }

  function renderTopProducts(list){
    const tbody = document.querySelector("#tableTopProducts tbody");
    if(!tbody) return;
    tbody.innerHTML = "";
    if(list.length === 0){
      tbody.innerHTML = '<tr><td colspan="3" style="padding:8px;color:var(--muted)">Nenhum produto encontrado no per√≠odo.</td></tr>';
      return;
    }
    list.forEach((p, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td style="padding:8px;border-bottom:1px solid #f1f1f1">${idx+1}</td>
                      <td style="padding:8px;border-bottom:1px solid #f1f1f1">${p.name}</td>
                      <td style="padding:8px;border-bottom:1px solid #f1f1f1">${p.qty}</td>`;
      tbody.appendChild(tr);
    });
  }

  function renderPayments(list){
    const tbody = document.querySelector("#tablePayments tbody");
    if(!tbody) return;
    tbody.innerHTML = "";
    if(list.length === 0){
      tbody.innerHTML = '<tr><td colspan="3" style="padding:8px;color:var(--muted)">Nenhuma forma de pagamento encontrada.</td></tr>';
      return;
    }
    list.forEach(p => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td style="padding:8px;border-bottom:1px solid #f1f1f1">${p.method}</td>
                      <td style="padding:8px;border-bottom:1px solid #f1f1f1">${p.count}</td>
                      <td style="padding:8px;border-bottom:1px solid #f1f1f1">${p.pct}%</td>`;
      tbody.appendChild(tr);
    });
  }

  function renderAreas(list){
    const tbody = document.querySelector("#tableAreas tbody");
    if(!tbody) return;
    tbody.innerHTML = "";
    if(list.length === 0){
      tbody.innerHTML = '<tr><td colspan="3" style="padding:8px;color:var(--muted)">Nenhuma √°rea encontrada.</td></tr>';
      return;
    }
    list.forEach(a => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td style="padding:8px;border-bottom:1px solid #f1f1f1">${a.area}</td>
                      <td style="padding:8px;border-bottom:1px solid #f1f1f1">${a.orders}</td>
                      <td style="padding:8px;border-bottom:1px solid #f1f1f1">${formatBRL(a.total)}</td>`;
      tbody.appendChild(tr);
    });
  }

  // Main update
  function updateSalesReport(period){
    const filtered = getFilteredOrders(period);
    const summary = calcSummary(filtered);
    const topProducts = calcTopProducts(filtered, 10);
    const payments = calcPayments(filtered);
    const areas = calcAreas(filtered);

    renderSummaryCards(summary);
    renderTopProducts(topProducts);
    renderPayments(payments);
    renderAreas(areas);
  }

  // UI bindings
  function initSalesReport(){
    const buttons = Array.from(document.querySelectorAll(".period-btn"));
    buttons.forEach(btn => {
      btn.addEventListener("click", () => {
        buttons.forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        const period = btn.dataset.period || "day";
        updateSalesReport(period);
      });
    });
    // initial render: day
    updateSalesReport("day");

    // Hook into existing admin render flow to update report when orders change
    const origRenderAdminDashboard = window.renderAdminDashboard;
    window.renderAdminDashboard = function(...args){
      try{ if (typeof origRenderAdminDashboard === "function") origRenderAdminDashboard.apply(this,args); }catch(e){}
      const activeBtn = document.querySelector(".period-btn.active");
      const period = activeBtn ? activeBtn.dataset.period : "day";
      updateSalesReport(period);
    };

    // Also listen to Firestore changes by patching setupRealtimeOrdersListener behavior if exists
    if(typeof setupRealtimeOrdersListener === "function"){
      // No-op: it already updates orders and calls renderAdminDashboard in this file.
    }
  }

})(); // Fechamento da segunda IIFE (linha 209)
})(); // Fechamento da primeira IIFE (linha 12)






document.getElementById("tabCustomers").addEventListener("click", () => {
  document.querySelectorAll(".admin-panel").forEach(p => p.classList.add("hidden"));
  document.getElementById("customersPanel").classList.remove("hidden");
  renderCustomers();
});

</script>

</body>
</html>










    <!-- Table Details Modal: Visualiza e gerencia o pedido de uma mesa ocupada -->
    <div class="modal" id="tableDetailsModal">
      <div class="card" role="dialog" aria-modal="true" style="max-width:600px">
        <h3 id="tableDetailsModalTitle">Detalhes da Mesa <span id="tableDetailsTableName" style="color:var(--primary);"></span></h3>
        
        <div class="form-group">
          <label>Cliente:</label>
          <p id="tableDetailsClientName" style="font-weight:600; margin-top:0;"></p>
        </div>

        <div class="form-group">
          <label>Forma de Pagamento:</label>
          <select id="tableDetailsPaymentMethod" class="form-control">
            <option value="cash">Dinheiro</option>
            <option value="credit">Cart√£o de Cr√©dito</option>
            <option value="debit">Cart√£o de D√©bito</option>
            <option value="pix">PIX</option>
          </select>
        </div>
        
        <h4>Itens do Pedido (Comanda)</h4>
        <div id="tableDetailsOrderItems" style="max-height:300px; overflow-y:auto; border:1px solid #eee; border-radius:8px; padding:8px; margin-bottom:16px;">
          <!-- Itens do pedido ser√£o renderizados aqui -->
        </div>
        
        <div style="display:flex; justify-content:space-between; font-weight:600; border-top:1px solid #eee; padding-top:8px;">
          <span>Total Atual:</span>
          <span id="tableDetailsTotal" style="color:var(--primary);">R$ 0,00</span>
        </div>
        
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:20px">
          <button type="button" id="tableDetailsCancel" class="pill">Voltar</button>
          <button type="button" id="tableDetailsAddItems" class="btn" style="background:#007bff;">Enviar Mais Itens</button>
          <button type="button" id="tableDetailsCloseTable" class="btn" style="background:#dc3545;">Fechar Mesa</button>
        </div>
      </div>
    </div>
    <div class="modal" id="itemDetailsModal">
      <div class="card" role="dialog" aria-modal="true" style="max-width:500px">
        <h3 id="itemDetailsModalTitle">Adicionar Novo Item</h3>
        <form id="itemDetailsForm">
          <input type="hidden" id="itemIdDetails" />
          <div class="form-group">
            <label for="itemName">Nome do Item</label>
            <input type="text" id="itemName" required>
          </div>
          <div class="form-group">
            <label for="itemDesc">Descri√ß√£o</label>
            <textarea id="itemDesc" rows="3" required></textarea>
          </div>
          <div class="form-group">
            <label for="itemPrice">Pre√ßo (R$)</label>
            <input type="number" id="itemPrice" step="0.01" required>
          </div>
          <div class="form-group">
            <label for="itemCategory">Categoria</label>
            <select id="itemCategory" required></select>
          </div>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px">
            <button type="button" id="itemDetailsCancel" class="pill">Cancelar</button>
            <button type="submit" class="btn" id="itemDetailsSubmit">Salvar Detalhes</button>
          </div>
        </form>
      </div>
    </div>

    <div class="modal" id="addonManagementModal">
      <div class="card" role="dialog" aria-modal="true" style="max-width:800px">
        <h3 id="addonManagementTitle">Gerenciar Adicionais para <span id="addonItemName" style="color:var(--primary);"></span></h3>
        
        <div id="addonGroupsList"></div>
        
        <div style="margin-top:16px; display:flex; justify-content:space-between; align-items:center;">
          <button type="button" class="btn" id="btnAddAddonGroup" style="background:#28a745;">+ Adicionar Grupo</button>
          <div>
            <button type="button" id="addonManagementCancel" class="pill">Cancelar</button>
            <button type="button" class="btn" id="addonManagementSubmit">Salvar Adicionais</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal" id="imageEditModal">
      <div class="card" role="dialog" aria-modal="true" style="max-width:500px">
        <h3 id="imageEditModalTitle">Editar Imagem para <span id="imageItemName" style="color:var(--primary);"></span></h3>
        <form id="imageEditForm">
          <input type="hidden" id="itemIdImage" />
          
          <div class="form-group">
            <label for="itemImgFile">Escolher Imagem do Item</label>
            <input type="file" id="itemImgFile" accept="image/*">
            <input type="hidden" id="itemImgUrl"> </div>
          <div style="text-align:center; margin-bottom:16px;">
             <img id="currentImagePreview" src="" alt="Pr√©via" style="max-width:100%; height:auto; border-radius:8px; margin-top:10px;">
          </div>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px">
            <button type="button" id="imageEditCancel" class="pill">Cancelar</button>
            <button type="submit" class="btn" id="imageEditSubmit">Salvar Imagem</button>
          </div>
        </form>
      </div>
    </div>




