<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Card√°pio Real ‚Äì Sistema com Autentica√ß√£o e FIREBASE</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let salesChartInstance = null; // Vari√°vel global para a inst√¢ncia do Chart.js

// === FUN√á√ÉO AUXILIAR DE FORMATA√á√ÉO MONET√ÅRIA ===
const formatBRL = v => "R$ " + (v || 0).toFixed(2).replace(".",",");



// Solicita permiss√£o de notifica√ß√£o ao carregar a p√°gina
document.addEventListener("DOMContentLoaded", () => {
    if (typeof Notification !== 'undefined' && Notification.permission !== "granted" && Notification.permission !== "denied") {
        Notification.requestPermission();
    }
    // Carrega configura√ß√£o de cupons inteligentes
    loadSmartCouponConfig();
});

// ==== Fun√ß√µes Auxiliares ====

/* =========================================================================
   === NOVO RECURSO: HIST√ìRICO E FIDELIDADE DO CLIENTE (LOYALTY) ===
   ========================================================================= */

// [NOVOS CRIT√âRIOS]
const POINTS_PER_ORDER = 100; // Pontos por pedido
const MIN_ORDERS_FOR_DISCOUNT = 10; // M√≠nimo de pedidos para 10% OFF
const DISCOUNT_PERCENTAGE = 0.10; // 10% de desconto
const MIN_SUBTOTAL_FOR_DISCOUNT = 50.00; // Valor m√≠nimo do subtotal para aplicar o desconto

/* =========================================================================
   === NOVO RECURSO: CUPOM INTELIGENTE (SMART COUPON RULES) ===
   ========================================================================= */

// [ESTRUTURA DE DADOS CONFIGUR√ÅVEL] - Agora gerenci√°vel pelo Admin
let SMART_COUPON_CONFIG = {
  inactivity: {
    enabled: true,
    days: 60,
    code: 'VOLTE15',
    type: 'percentage',
    value: 0.15,
    description: '15% OFF - Sentimos sua falta!',
    priority: 1,
    minSubtotal: 0,
    validityDays: 30,
    maxUsesPerClient: 1
  },
  area: {
    enabled: true,
    rules: [
      {
        id: 'area-001',
        areaName: 'Vila Velha',
        code: 'FRETEVV',
        type: 'fixed',
        value: 15.00,
        description: 'R$ 15 OFF - Frete subsidiado para Vila Velha',
        priority: 2,
        enabled: true
      }
    ]
  },
  product: {
    enabled: true,
    percentage: 0.20,
    minPurchases: 3,
    priority: 3,
    codeFormat: 'VIP-{PRODUCT}',
    validityDays: 30
  },
  advanced: {
    allowCombineWithManual: false,
    allowCombineWithLoyalty: true,
    notifyInProfile: true,
    trackUsage: true
  }
};

// [HIST√ìRICO DE CUPONS GERADOS]
let SMART_COUPON_HISTORY = [];

// [COMPATIBILIDADE] - Mant√©m constantes antigas para n√£o quebrar c√≥digo existente
const COUPON_INACTIVITY_DAYS = () => SMART_COUPON_CONFIG.inactivity.days;
const INACTIVITY_COUPON = () => SMART_COUPON_CONFIG.inactivity;
const AREA_COUPON_RULES = () => SMART_COUPON_CONFIG.area.rules.filter(r => r.enabled);
const PRODUCT_COUPON_PERCENTAGE = () => SMART_COUPON_CONFIG.product.percentage;
const PRODUCT_COUPON_PRIORITY = () => SMART_COUPON_CONFIG.product.priority;

/**
 * [FUN√á√ÉO NOVA] Define o N√≠vel de Fidelidade com base na pontua√ß√£o.
 * @param {number} points - Pontua√ß√£o total do cliente.
 * @returns {{level: string, color: string}}
 */
function getLoyaltyLevel(points) {
    if (points >= 3000) {
        return { level: 'üíé N√≠vel OURO', color: '#ffc107' }; // Dourado
    } else if (points >= 1000) {
        return { level: 'ü•à N√≠vel PRATA', color: '#adb5bd' }; // Prata
    } else if (points >= 100) {
        return { level: 'ü•â N√≠vel BRONZE', color: '#cd7f32' }; // Bronze
    } else {
        return { level: '‚≠ê Novo Cliente', color: '#007bff' };
    }
}

/**
 * [FUN√á√ÉO NOVA] Calcula as m√©tricas de fidelidade (pontua√ß√£o, n√≠vel, benef√≠cio).
 * @param {Object} clientData - Dados do cliente, **deve** incluir totalOrders.
 * @returns {Object} - Dados de fidelidade.
 */
function calculateLoyaltyMetrics(clientData) {
    const totalOrders = clientData.totalOrders || 0;
    const points = totalOrders * POINTS_PER_ORDER;
    const { level, color } = getLoyaltyLevel(points);
    
    // Benef√≠cio: 10% off autom√°tico ap√≥s 10 pedidos
    const hasDiscountBenefit = totalOrders >= MIN_ORDERS_FOR_DISCOUNT;
    const benefitText = hasDiscountBenefit 
        ? `‚úÖ 10% OFF em pedidos acima de ${formatBRL(MIN_SUBTOTAL_FOR_DISCOUNT)}`
        : `‚ùå Desconto autom√°tico (faltam ${Math.max(0, MIN_ORDERS_FOR_DISCOUNT - totalOrders)} pedidos)`;

    return {
        loyaltyPoints: points,
        loyaltyLevel: level,
        loyaltyLevelColor: color,
        hasDiscountBenefit: hasDiscountBenefit,
        loyaltyBenefitText: benefitText,
    };
}

/**
 * [FUN√á√ÉO NOVA] Adiciona o painel de fidelidade no Perfil do Cliente (Client Profile).
 * @param {Object} metrics - As m√©tricas padr√£o calculadas por calculateClientMetrics.
 */
function renderClientLoyaltyPanel(metrics) {
    const totalOrders = metrics.totalOrders || 0;
    const loyaltyMetrics = calculateLoyaltyMetrics({ totalOrders }); 
    
    const loyaltyPanel = document.getElementById("clientLoyaltyPanel");
    if (!loyaltyPanel) return;

    loyaltyPanel.innerHTML = `
        <h5 style="margin-top: 20px; margin-bottom: 10px; color: var(--primary);">Programa de Fidelidade</h5>
        <div style="background: #f7f7f7; padding: 15px; border-radius: 10px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span>Seu N√≠vel:</span>
                <span style="font-weight: bold; color: ${loyaltyMetrics.loyaltyLevelColor};">${loyaltyMetrics.loyaltyLevel}</span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span>Pontos Acumulados:</span>
                <span style="font-weight: bold;">${loyaltyMetrics.loyaltyPoints} pts</span>
            </div>
            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px dashed #ddd;">
                <span style="font-weight: 600;">Benef√≠cio Atual:</span>
                <p style="margin: 4px 0 0; font-size: 13px; color: ${loyaltyMetrics.hasDiscountBenefit ? '#28a745' : '#dc3545'};">
                    ${loyaltyMetrics.loyaltyBenefitText}
                </p>
            </div>
        </div>
    `;
}

/**
 * [FUN√á√ÉO NOVA] Gera o HTML do badge de fidelidade para o cart√£o do cliente no Admin.
 * @param {Object} clientData - Dados do cliente.
 * @returns {string} - HTML adicional para o card.
 */
function renderLoyaltyBadge(clientData) {
    const metrics = calculateLoyaltyMetrics(clientData);
    
    return `
        <div style="font-size:12px; margin-top: 6px; padding-top: 6px; border-top: 1px dashed #eee;">
            Fidelidade: 
            <span style="font-weight:bold; color: ${metrics.loyaltyLevelColor};">
                ${metrics.loyaltyLevel}
            </span> 
            (${metrics.loyaltyPoints} pts)
        </div>
    `;
}

/**
 * [FUN√á√ÉO NOVA] Calcula o valor do desconto de fidelidade.
 * @param {number} subtotal - O subtotal do pedido antes do desconto.
 * @param {number} totalOrders - O n√∫mero total de pedidos do cliente atual.
 * @returns {{discountValue: number, discountApplied: boolean, reason: string}}
 */
function calculateLoyaltyDiscount(subtotal, totalOrders) {
    if (!totalOrders || totalOrders < MIN_ORDERS_FOR_DISCOUNT) {
        return { discountValue: 0, discountApplied: false, reason: `Faltam ${MIN_ORDERS_FOR_DISCOUNT - (totalOrders || 0)} pedidos para 10% OFF` };
    }

    if (subtotal < MIN_SUBTOTAL_FOR_DISCOUNT) {
         return { discountValue: 0, discountApplied: false, reason: `M√≠nimo de ${formatBRL(MIN_SUBTOTAL_FOR_DISCOUNT)} no subtotal n√£o atingido` };
    }

    const discount = subtotal * DISCOUNT_PERCENTAGE;
    return { 
        discountValue: discount, 
        discountApplied: true,
        reason: `Desconto Fidelidade (10% OFF - N√≠vel: ${getLoyaltyLevel(totalOrders * POINTS_PER_ORDER).level})`
    };
}

function formatCPFCNPJ(value) {
    // Placeholder: Retorna o valor sem formata√ß√£o se a fun√ß√£o real n√£o estiver definida.
    // O usu√°rio deve implementar a formata√ß√£o real se necess√°rio.
    return value || 'N/A';
}

/* =========================================================================
   === NOVAS FUN√á√ïES: CUPOM INTELIGENTE (SMART COUPON LOGIC) ===
   ========================================================================= */

/**
 * [FUN√á√ÉO NOVA] Calcula os dias desde o √∫ltimo pedido do cliente.
 * Assume que a data do √∫ltimo pedido est√° no objeto do cliente (lastOrderTimestamp).
 * @param {Object} clientData - Dados do cliente.
 * @returns {number} Dias de inatividade.
 */
function calculateDaysSinceLastOrder(clientData) {
    const lastOrderTime = clientData.lastOrderTimestamp || clientData.lastOrderDate;
    if (!lastOrderTime) return 999; // Se nunca pediu, considera-se inativo/novo.
    
    const now = Date.now();
    const diffTime = now - lastOrderTime;
    return Math.floor(diffTime / (1000 * 60 * 60 * 24));
}

/**
 * [FUN√á√ÉO NOVA] Encontra o ID do produto que o cliente mais comprou.
 * @param {Array<Object>} clientOrders - Array de pedidos do cliente.
 * @returns {string | null} ID do produto mais comprado ou null.
 */
function findMostFrequentProduct(clientOrders) {
    if (!clientOrders || clientOrders.length === 0) return null;

    const productCounts = {};
    clientOrders.forEach(order => {
        (order.items || []).forEach(item => { // Assume que o pedido tem um array 'items'
            const productId = item.productId || item.name; // Usa ID ou Nome como fallback
            productCounts[productId] = (productCounts[productId] || 0) + (item.qty || item.quantity || 1);
        });
    });

    let topProduct = null;
    let maxCount = 0;
    
    for (const productId in productCounts) {
        if (productCounts[productId] > maxCount) {
            maxCount = productCounts[productId];
            topProduct = productId;
        }
    }
    
    // Assumindo que 'products' √© um array global de produtos com 'id' e 'name'
    const topProductDetails = window.products ? window.products.find(p => p.id === topProduct || p.name === topProduct) : null;

    return topProductDetails || { id: topProduct, name: topProduct };
}

/**
 * [FUN√á√ÉO NOVA] Gera o melhor cupom inteligente para o cliente.
 * Prioriza: Inatividade > √Årea de Entrega > Produto Favorito.
 * @param {Object} clientData - Dados do cliente (incluindo lastOrderTimestamp, address).
 * @param {Array<Object>} clientOrders - Pedidos do cliente.
 * @returns {Object | null} O objeto de cupom a ser sugerido ou null.
 */
function generateSmartCoupons(clientData, clientOrders) {
    const coupons = [];
    const config = SMART_COUPON_CONFIG;
    const daysInactive = calculateDaysSinceLastOrder(clientData);

    // 1. Checa Inatividade (Maior Prioridade)
    if (config.inactivity.enabled && daysInactive >= config.inactivity.days) {
        coupons.push({ 
            ...config.inactivity, 
            target: 'global',
            ruleType: 'inactivity'
        });
    }

    // 2. Checa √Årea de Entrega (M√©dia Prioridade)
    if (config.area.enabled) {
        const clientArea = clientData.address ? (clientData.address.area || clientData.address) : '';
        const areaRule = config.area.rules.find(rule => {
            if (!rule.enabled) return false;
            const areaStr = typeof clientArea === 'string' ? clientArea : '';
            return areaStr.toLowerCase().includes(rule.areaName.toLowerCase());
        });
        if (areaRule) {
            coupons.push({ 
                code: areaRule.code,
                type: areaRule.type,
                value: areaRule.value,
                description: areaRule.description,
                priority: areaRule.priority,
                target: 'global',
                ruleType: 'area',
                areaName: areaRule.areaName
            });
        }
    }
    
    // 3. Checa Produto Favorito (Menor Prioridade)
    if (config.product.enabled && coupons.length === 0) {
        const topProduct = findMostFrequentProduct(clientOrders);
        if (topProduct && topProduct.id) {
            const productCode = config.product.codeFormat.replace('{PRODUCT}', topProduct.id.toString().slice(0, 4).toUpperCase());
            coupons.push({
                code: productCode,
                type: 'product_percentage',
                value: config.product.percentage,
                target: topProduct.id,
                description: `${config.product.percentage * 100}% OFF no seu item favorito: ${topProduct.name}`,
                priority: config.product.priority,
                ruleType: 'product',
                productName: topProduct.name
            });
        }
    }

    // Seleciona o cupom de maior prioridade (menor n√∫mero)
    if (coupons.length > 0) {
        coupons.sort((a, b) => a.priority - b.priority);
        return coupons[0];
    }

    return null;
}

/**
 * [FUN√á√ÉO NOVA] Renderiza a sugest√£o de cupom no Dashboard/Perfil do Cliente.
 * @param {Object | null} smartCoupon - O cupom gerado por generateSmartCoupons.
 */
function renderSmartCouponOffer(smartCoupon) {
    const profilePanel = document.getElementById("clientLoyaltyPanel"); // Reutiliza o painel de fidelidade ou crie um novo.
    if (!profilePanel) return;
    
    const smartCouponHtml = document.createElement('div');
    smartCouponHtml.id = 'smartCouponOffer';
    smartCouponHtml.style.marginTop = '20px';
    smartCouponHtml.style.padding = '15px';
    smartCouponHtml.style.border = '2px solid #ff9800';
    smartCouponHtml.style.borderRadius = '8px';
    smartCouponHtml.style.background = '#fff3e0';
    
    if (smartCoupon) {
        smartCouponHtml.innerHTML = `
            <h5 style="margin-top:0; color:#ff9800;">üéÅ Cupom Inteligente Dispon√≠vel!</h5>
            <p style="font-size: 14px; margin-bottom: 5px;">${smartCoupon.description}</p>
            <div style="font-size: 18px; font-weight: bold; color: #d35400; text-align: center; border: 1px dashed #ffa726; padding: 5px; margin-top: 10px;">
                C√ìDIGO: ${smartCoupon.code}
            </div>
        `;
    } else {
        smartCouponHtml.innerHTML = `
            <h5 style="margin-top:0; color:#4CAF50;">üéâ Sem Cupons Inteligentes no momento.</h5>
            <p style="font-size: 14px; margin: 0;">Volte sempre! Seu hist√≥rico est√° excelente.</p>
        `;
    }
    
    // Adiciona abaixo do painel de Fidelidade/Loyalty
    const existingOffer = document.getElementById('smartCouponOffer');
    if (existingOffer) {
        existingOffer.remove(); // Remove antes de adicionar o novo
    }
    profilePanel.parentNode.insertBefore(smartCouponHtml, profilePanel.nextSibling); 
}

/* =========================================================================
   === FUN√á√ïES DE GERENCIAMENTO: PAINEL DE CONTROLE ===
   ========================================================================= */

/**
 * [FUN√á√ÉO NOVA] Salva a configura√ß√£o de cupons inteligentes no Firebase/localStorage.
 */
async function saveSmartCouponConfig() {
    try {
        if (typeof DATA !== 'undefined' && DATA.restaurant) {
            DATA.restaurant.smartCouponConfig = SMART_COUPON_CONFIG;
            DATA.restaurant.smartCouponHistory = SMART_COUPON_HISTORY;
            if (typeof saveMenuData === 'function') {
                await saveMenuData();
            }
        }
        // Fallback para localStorage
        localStorage.setItem('smartCouponConfig', JSON.stringify(SMART_COUPON_CONFIG));
        localStorage.setItem('smartCouponHistory', JSON.stringify(SMART_COUPON_HISTORY));
        return true;
    } catch (error) {
        console.error('Erro ao salvar configura√ß√£o de cupons:', error);
        return false;
    }
}

/**
 * [FUN√á√ÉO NOVA] Carrega a configura√ß√£o de cupons inteligentes.
 */
function loadSmartCouponConfig() {
    try {
        // Tenta carregar do DATA.restaurant primeiro
        if (typeof DATA !== 'undefined' && DATA.restaurant && DATA.restaurant.smartCouponConfig) {
            SMART_COUPON_CONFIG = DATA.restaurant.smartCouponConfig;
            SMART_COUPON_HISTORY = DATA.restaurant.smartCouponHistory || [];
            return;
        }
        // Fallback para localStorage
        const savedConfig = localStorage.getItem('smartCouponConfig');
        const savedHistory = localStorage.getItem('smartCouponHistory');
        if (savedConfig) {
            SMART_COUPON_CONFIG = JSON.parse(savedConfig);
        }
        if (savedHistory) {
            SMART_COUPON_HISTORY = JSON.parse(savedHistory);
        }
    } catch (error) {
        console.error('Erro ao carregar configura√ß√£o de cupons:', error);
    }
}

/**
 * [FUN√á√ÉO NOVA] Calcula estat√≠sticas dos cupons inteligentes.
 */
function getSmartCouponStats() {
    const stats = {
        totalGenerated: 0,
        totalUsed: 0,
        totalAvailable: 0,
        totalExpired: 0,
        totalDiscountGiven: 0,
        byType: {
            inactivity: { generated: 0, used: 0, discount: 0 },
            area: { generated: 0, used: 0, discount: 0 },
            product: { generated: 0, used: 0, discount: 0 }
        }
    };

    SMART_COUPON_HISTORY.forEach(entry => {
        stats.totalGenerated++;
        
        if (entry.status === 'used') {
            stats.totalUsed++;
            stats.totalDiscountGiven += entry.discountValue || 0;
            if (entry.ruleType && stats.byType[entry.ruleType]) {
                stats.byType[entry.ruleType].used++;
                stats.byType[entry.ruleType].discount += entry.discountValue || 0;
            }
        } else if (entry.status === 'available') {
            stats.totalAvailable++;
        } else if (entry.status === 'expired') {
            stats.totalExpired++;
        }
        
        if (entry.ruleType && stats.byType[entry.ruleType]) {
            stats.byType[entry.ruleType].generated++;
        }
    });

    stats.usageRate = stats.totalGenerated > 0 
        ? ((stats.totalUsed / stats.totalGenerated) * 100).toFixed(1)
        : 0;

    return stats;
}

/**
 * [FUN√á√ÉO NOVA] Conta clientes eleg√≠veis para cada regra.
 */
function getEligibleClientsCount() {
    const counts = {
        inactivity: 0,
        area: {},
        product: 0
    };

    // Precisa de acesso aos dados de clientes e pedidos
    if (typeof window.orders === 'undefined') return counts;

    const clientsMap = {};
    window.orders.forEach(order => {
        if (!order.userId) return;
        if (!clientsMap[order.userId]) {
            clientsMap[order.userId] = {
                id: order.userId,
                name: order.userName,
                address: order.address,
                lastOrderDate: order.createdAt,
                orders: []
            };
        }
        clientsMap[order.userId].orders.push(order);
        if (order.createdAt > clientsMap[order.userId].lastOrderDate) {
            clientsMap[order.userId].lastOrderDate = order.createdAt;
        }
    });

    Object.values(clientsMap).forEach(client => {
        // Inatividade
        const daysInactive = calculateDaysSinceLastOrder({ lastOrderDate: client.lastOrderDate });
        if (SMART_COUPON_CONFIG.inactivity.enabled && daysInactive >= SMART_COUPON_CONFIG.inactivity.days) {
            counts.inactivity++;
        }

        // √Årea
        if (SMART_COUPON_CONFIG.area.enabled) {
            SMART_COUPON_CONFIG.area.rules.forEach(rule => {
                if (!rule.enabled) return;
                const clientArea = client.address || '';
                const areaStr = typeof clientArea === 'string' ? clientArea : '';
                if (areaStr.toLowerCase().includes(rule.areaName.toLowerCase())) {
                    counts.area[rule.areaName] = (counts.area[rule.areaName] || 0) + 1;
                }
            });
        }

        // Produto (simplificado - conta quem tem hist√≥rico)
        if (SMART_COUPON_CONFIG.product.enabled && client.orders.length >= SMART_COUPON_CONFIG.product.minPurchases) {
            counts.product++;
        }
    });

    return counts;
}

/**
 * [FUN√á√ÉO NOVA] Registra o uso de um cupom inteligente.
 */
function logSmartCouponUsage(userId, userName, coupon, discountValue) {
    if (!SMART_COUPON_CONFIG.advanced.trackUsage) return;

    const entry = {
        id: 'sc-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
        userId: userId,
        userName: userName,
        couponCode: coupon.code,
        ruleType: coupon.ruleType || 'unknown',
        generatedAt: Date.now(),
        expiresAt: Date.now() + (30 * 24 * 60 * 60 * 1000), // 30 dias
        status: 'used',
        usedAt: Date.now(),
        discountValue: discountValue
    };

    SMART_COUPON_HISTORY.push(entry);
    saveSmartCouponConfig();
}

/**
 * [FUN√á√ÉO NOVA] Renderiza o painel de controle de cupons inteligentes no Admin.
 */
function renderSmartCouponAdminPanel() {
    const panel = document.getElementById('smartCouponAdminPanel');
    if (!panel) return;

    const stats = getSmartCouponStats();
    const eligibleCounts = getEligibleClientsCount();
    const config = SMART_COUPON_CONFIG;

    panel.innerHTML = `
        <!-- DASHBOARD -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px;">
            <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; text-align: center;">
                <div style="font-size: 24px; font-weight: bold; color: #1976d2;">${stats.totalGenerated}</div>
                <div style="font-size: 12px; color: #666;">Cupons Gerados</div>
            </div>
            <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; text-align: center;">
                <div style="font-size: 24px; font-weight: bold; color: #388e3c;">${stats.totalUsed}</div>
                <div style="font-size: 12px; color: #666;">Cupons Usados</div>
            </div>
            <div style="background: #fff3e0; padding: 15px; border-radius: 8px; text-align: center;">
                <div style="font-size: 24px; font-weight: bold; color: #f57c00;">${stats.usageRate}%</div>
                <div style="font-size: 12px; color: #666;">Taxa de Uso</div>
            </div>
            <div style="background: #f3e5f5; padding: 15px; border-radius: 8px; text-align: center;">
                <div style="font-size: 24px; font-weight: bold; color: #7b1fa2;">${formatBRL(stats.totalDiscountGiven)}</div>
                <div style="font-size: 12px; color: #666;">Total Descontado</div>
            </div>
        </div>

        <!-- REGRAS ATIVAS -->
        <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <h6 style="margin: 0 0 10px 0; color: #333;">‚ö° Regras Ativas</h6>
            
            <!-- Regra de Inatividade -->
            <div style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 10px; border-left: 4px solid ${config.inactivity.enabled ? '#4caf50' : '#ccc'};">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <div>
                        <strong>${config.inactivity.enabled ? '‚úÖ' : '‚ùå'} Inatividade</strong>
                        <span style="color: #666; font-size: 12px; margin-left: 10px;">
                            ${config.inactivity.days} dias ‚Üí ${config.inactivity.code} (${config.inactivity.value * 100}% OFF)
                        </span>
                    </div>
                    <div>
                        <label style="cursor: pointer;">
                            <input type="checkbox" id="toggleInactivity" ${config.inactivity.enabled ? 'checked' : ''} 
                                   onchange="toggleSmartCouponRule('inactivity', this.checked)" />
                            <span style="font-size: 12px; margin-left: 5px;">Ativo</span>
                        </label>
                    </div>
                </div>
                <div style="font-size: 12px; color: #666;">
                    üë• ${eligibleCounts.inactivity} clientes eleg√≠veis
                    <button onclick="editSmartCouponRule('inactivity')" style="margin-left: 10px; padding: 2px 8px; font-size: 11px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer;">‚úèÔ∏è Editar</button>
                </div>
            </div>

            <!-- Regra de √Årea -->
            <div style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 10px; border-left: 4px solid ${config.area.enabled ? '#4caf50' : '#ccc'};">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <div>
                        <strong>${config.area.enabled ? '‚úÖ' : '‚ùå'} √Årea de Entrega</strong>
                    </div>
                    <div>
                        <label style="cursor: pointer;">
                            <input type="checkbox" id="toggleArea" ${config.area.enabled ? 'checked' : ''} 
                                   onchange="toggleSmartCouponRule('area', this.checked)" />
                            <span style="font-size: 12px; margin-left: 5px;">Ativo</span>
                        </label>
                    </div>
                </div>
                <div style="margin-left: 15px;">
                    ${config.area.rules.map(rule => `
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px; padding: 5px; background: #f5f5f5; border-radius: 4px;">
                            ${rule.enabled ? '‚úÖ' : '‚ùå'} <strong>${rule.areaName}</strong>: ${rule.code} (${rule.type === 'fixed' ? formatBRL(rule.value) : rule.value * 100 + '%'} OFF)
                            - üë• ${eligibleCounts.area[rule.areaName] || 0} clientes
                            <button onclick="editAreaRule('${rule.id}')" style="margin-left: 5px; padding: 2px 6px; font-size: 10px; background: #2196f3; color: white; border: none; border-radius: 3px; cursor: pointer;">‚úèÔ∏è</button>
                            <button onclick="deleteAreaRule('${rule.id}')" style="padding: 2px 6px; font-size: 10px; background: #f44336; color: white; border: none; border-radius: 3px; cursor: pointer;">üóëÔ∏è</button>
                        </div>
                    `).join('')}
                    <button onclick="addNewAreaRule()" style="margin-top: 5px; padding: 4px 10px; font-size: 11px; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer;">+ Adicionar √Årea</button>
                </div>
            </div>

            <!-- Regra de Produto -->
            <div style="background: white; padding: 12px; border-radius: 6px; border-left: 4px solid ${config.product.enabled ? '#4caf50' : '#ccc'};">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <div>
                        <strong>${config.product.enabled ? '‚úÖ' : '‚ùå'} Produto Favorito</strong>
                        <span style="color: #666; font-size: 12px; margin-left: 10px;">
                            ${config.product.percentage * 100}% OFF no item mais comprado
                        </span>
                    </div>
                    <div>
                        <label style="cursor: pointer;">
                            <input type="checkbox" id="toggleProduct" ${config.product.enabled ? 'checked' : ''} 
                                   onchange="toggleSmartCouponRule('product', this.checked)" />
                            <span style="font-size: 12px; margin-left: 5px;">Ativo</span>
                        </label>
                    </div>
                </div>
                <div style="font-size: 12px; color: #666;">
                    üë• ${eligibleCounts.product} clientes eleg√≠veis
                    <button onclick="editSmartCouponRule('product')" style="margin-left: 10px; padding: 2px 8px; font-size: 11px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer;">‚úèÔ∏è Editar</button>
                </div>
            </div>
        </div>

        <!-- HIST√ìRICO -->
        <div style="background: #f9f9f9; padding: 15px; border-radius: 8px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h6 style="margin: 0; color: #333;">üìú Hist√≥rico de Cupons</h6>
                <button onclick="exportSmartCouponHistory()" style="padding: 5px 10px; font-size: 11px; background: #607d8b; color: white; border: none; border-radius: 4px; cursor: pointer;">üìä Exportar</button>
            </div>
            <div id="smartCouponHistoryList" style="max-height: 300px; overflow-y: auto;">
                ${renderSmartCouponHistory()}
            </div>
        </div>
    `;
}

/**
 * [FUN√á√ÉO NOVA] Renderiza o hist√≥rico de cupons.
 */
function renderSmartCouponHistory() {
    if (SMART_COUPON_HISTORY.length === 0) {
        return '<div style="text-align: center; color: #999; padding: 20px;">Nenhum cupom gerado ainda</div>';
    }

    const recentHistory = SMART_COUPON_HISTORY.slice(-10).reverse();
    
    return recentHistory.map(entry => {
        const statusColors = {
            used: '#4caf50',
            available: '#ff9800',
            expired: '#9e9e9e'
        };
        const statusLabels = {
            used: '‚úÖ Usado',
            available: '‚è≥ Dispon√≠vel',
            expired: '‚ùå Expirado'
        };
        
        return `
            <div style="background: white; padding: 10px; border-radius: 4px; margin-bottom: 8px; border-left: 3px solid ${statusColors[entry.status] || '#ccc'};">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>${entry.userName || 'Cliente'}</strong>
                        <span style="margin-left: 10px; padding: 2px 6px; background: #e0e0e0; border-radius: 3px; font-size: 11px;">${entry.couponCode}</span>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 11px; color: ${statusColors[entry.status]};">${statusLabels[entry.status]}</div>
                        <div style="font-size: 10px; color: #999;">${new Date(entry.generatedAt).toLocaleDateString('pt-BR')}</div>
                    </div>
                </div>
                ${entry.discountValue ? `<div style="font-size: 11px; color: #666; margin-top: 5px;">Desconto: ${formatBRL(entry.discountValue)}</div>` : ''}
            </div>
        `;
    }).join('');
}

/**
 * [FUN√á√ÉO NOVA] Alterna ativa√ß√£o de uma regra.
 */
function toggleSmartCouponRule(ruleType, enabled) {
    SMART_COUPON_CONFIG[ruleType].enabled = enabled;
    saveSmartCouponConfig();
    renderSmartCouponAdminPanel();
    alert(`Regra "${ruleType}" ${enabled ? 'ativada' : 'desativada'} com sucesso!`);
}

/**
 * [FUN√á√ÉO NOVA] Abre modal para editar regra.
 */
function editSmartCouponRule(ruleType) {
    const config = SMART_COUPON_CONFIG[ruleType];
    
    if (ruleType === 'inactivity') {
        const days = prompt('Dias de inatividade:', config.days);
        const code = prompt('C√≥digo do cupom:', config.code);
        const value = prompt('Percentual de desconto (0-1, ex: 0.15 para 15%):', config.value);
        const description = prompt('Descri√ß√£o:', config.description);
        
        if (days && code && value && description) {
            config.days = parseInt(days);
            config.code = code.toUpperCase();
            config.value = parseFloat(value);
            config.description = description;
            saveSmartCouponConfig();
            renderSmartCouponAdminPanel();
            alert('Regra atualizada com sucesso!');
        }
    } else if (ruleType === 'product') {
        const percentage = prompt('Percentual de desconto (0-1, ex: 0.20 para 20%):', config.percentage);
        const minPurchases = prompt('M√≠nimo de compras do produto:', config.minPurchases);
        
        if (percentage && minPurchases) {
            config.percentage = parseFloat(percentage);
            config.minPurchases = parseInt(minPurchases);
            saveSmartCouponConfig();
            renderSmartCouponAdminPanel();
            alert('Regra atualizada com sucesso!');
        }
    }
}

/**
 * [FUN√á√ÉO NOVA] Adiciona nova regra de √°rea.
 */
function addNewAreaRule() {
    const areaName = prompt('√Årea de entrega:');
    const code = prompt('C√≥digo do cupom:');
    const type = confirm('Desconto fixo? (OK = Sim, Cancelar = Percentual)') ? 'fixed' : 'percentage';
    const value = prompt(type === 'fixed' ? 'Valor fixo (R$):' : 'Percentual (0-1, ex: 0.15):');
    const description = prompt('Descri√ß√£o:');
    
    if (areaName && code && value && description) {
        const newRule = {
            id: 'area-' + Date.now(),
            areaName: areaName,
            code: code.toUpperCase(),
            type: type,
            value: parseFloat(value),
            description: description,
            priority: 2,
            enabled: true
        };
        
        SMART_COUPON_CONFIG.area.rules.push(newRule);
        saveSmartCouponConfig();
        renderSmartCouponAdminPanel();
        alert('√Årea adicionada com sucesso!');
    }
}

/**
 * [FUN√á√ÉO NOVA] Edita regra de √°rea existente.
 */
function editAreaRule(ruleId) {
    const rule = SMART_COUPON_CONFIG.area.rules.find(r => r.id === ruleId);
    if (!rule) return;
    
    const areaName = prompt('√Årea de entrega:', rule.areaName);
    const code = prompt('C√≥digo do cupom:', rule.code);
    const value = prompt(rule.type === 'fixed' ? 'Valor fixo (R$):' : 'Percentual (0-1):', rule.value);
    const description = prompt('Descri√ß√£o:', rule.description);
    
    if (areaName && code && value && description) {
        rule.areaName = areaName;
        rule.code = code.toUpperCase();
        rule.value = parseFloat(value);
        rule.description = description;
        saveSmartCouponConfig();
        renderSmartCouponAdminPanel();
        alert('√Årea atualizada com sucesso!');
    }
}

/**
 * [FUN√á√ÉO NOVA] Remove regra de √°rea.
 */
function deleteAreaRule(ruleId) {
    if (!confirm('Tem certeza que deseja remover esta √°rea?')) return;
    
    SMART_COUPON_CONFIG.area.rules = SMART_COUPON_CONFIG.area.rules.filter(r => r.id !== ruleId);
    saveSmartCouponConfig();
    renderSmartCouponAdminPanel();
    alert('√Årea removida com sucesso!');
}

/**
 * [FUN√á√ÉO NOVA] Exporta hist√≥rico de cupons.
 */
function exportSmartCouponHistory() {
    if (SMART_COUPON_HISTORY.length === 0) {
        alert('Nenhum hist√≥rico para exportar.');
        return;
    }
    
    const csv = [
        ['Cliente', 'Cupom', 'Tipo', 'Status', 'Gerado Em', 'Usado Em', 'Desconto'].join(','),
        ...SMART_COUPON_HISTORY.map(entry => [
            entry.userName || 'N/A',
            entry.couponCode,
            entry.ruleType,
            entry.status,
            new Date(entry.generatedAt).toLocaleDateString('pt-BR'),
            entry.usedAt ? new Date(entry.usedAt).toLocaleDateString('pt-BR') : 'N/A',
            entry.discountValue ? formatBRL(entry.discountValue) : 'N/A'
        ].join(','))
    ].join('\n');
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `cupons-inteligentes-${Date.now()}.csv`;
    a.click();
    URL.revokeObjectURL(url);
}

// ==== Bot√£o Sair do Perfil ====
document.addEventListener("DOMContentLoaded", () => {
  const logoutBtn = document.getElementById("btnLogout");
  if (logoutBtn) {
    logoutBtn.addEventListener("click", () => {
      if (confirm("Deseja realmente sair da conta?")) {
        if (typeof logoutUser === "function") logoutUser();
        else console.warn("Fun√ß√£o logoutUser() n√£o encontrada.");
      }
    });
  }
});



window.printOrder = function(orderId) {
  const order = orders.find(o => o.id === orderId);
  if (!order) return alert('Pedido n√£o encontrado.');

  // Fun√ß√µes auxiliares (assumindo que j√° existem no escopo global do HTML)
  // formatBRL(value)
  // formatCPFCNPJ(value) - Precisa ser criada ou assumida

  // Dados fict√≠cios ou extra√≠dos do objeto 'order'
  const orderDate = new Date(order.createdAt).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
  const orderTime = new Date(order.createdAt).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
  const deliveryTime = order.deliveryTime || '30min a 1h'; // Assumindo que o tempo de entrega est√° em 'order.deliveryTime' ou um valor padr√£o
  const storeName = order.storeName || 'Acaiteria Creamy Purple'; // Assumindo que o nome da loja est√° em 'order.storeName' ou um valor padr√£o
  const orderNumber = order.orderNumber || order.id.substring(0, 7); // N√∫mero do pedido

  // Informa√ß√µes do Cliente
  const clientName = order.userName || 'N/A';
  const clientCpfCnpj = order.userCpfCnpj ? formatCPFCNPJ(order.userCpfCnpj) : 'N/A'; // Assumindo formatCPFCNPJ existe
  const clientPhone = order.userPhone || 'N/A';
  const clientOrderCount = order.userOrderCount || 'N/A'; // Assumindo que a contagem de pedidos est√° em 'order.userOrderCount'
  const clientAddress = order.address || 'N/A';
  const clientNeighborhood = order.neighborhood || 'N/A'; // Assumindo que o bairro est√° em 'order.neighborhood'

  // Informa√ß√µes de Pagamento
  let paymentMethod = 'N/A';
  if (order.paymentMethod === 'cash') {
    paymentMethod = 'Dinheiro' + (order.changeNeeded > 0 ? ` (Troco: ${formatBRL(order.changeNeeded)})` : '');
  } else if (order.paymentMethod === 'credit') {
    paymentMethod = 'Cart√£o de Cr√©dito';
  } else if (order.paymentMethod === 'debit') {
    paymentMethod = 'Cart√£o de D√©bito';
  } else if (order.paymentMethod === 'pix') {
    paymentMethod = 'PIX';
  }

  // Valores
  const subtotal = order.subtotal || order.total - (order.deliveryFee || 0); // Assumindo que subtotal existe ou pode ser calculado
  const deliveryFee = order.deliveryFee || 0;
  const total = order.total || 0;

  // Gera√ß√£o da lista de itens
  const itemsList = (order.items || []).map(item => {
    let itemHtml = `<div class="footer-line"><span>${item.qty}x ${item.name}</span><span>${formatBRL(item.totalPrice / item.qty)}</span></div>`;
    if (item.addons && item.addons.length > 0) {
      item.addons.forEach(a => {
        itemHtml += `<div class="item-addon"> &nbsp; &nbsp; + ${a.qty}x ${a.name}</div>`;
      });
    }
    return itemHtml;
  }).join('');
  
  // Gera√ß√£o da lista de comandas avulsas
  let comandasAvulsasHtml = '';
  let totalComandas = 0;
  if (order.comandasAvulsas && order.comandasAvulsas.length > 0) {
    comandasAvulsasHtml = '<div class="line"></div><div class="bold">Comandas Avulsas:</div>';
    order.comandasAvulsas.forEach(comanda => {
      totalComandas += comanda.totalCalculado || 0;
      let detalhes = '';
      if (comanda.tipo === 'valor') {
        detalhes = `Valor Fixo`;
      } else if (comanda.tipo === 'peso') {
        detalhes = `${comanda.peso}kg x ${formatBRL(comanda.valorKg)}/kg`;
      }
      const pagamentoLabel = {
        'pix': 'PIX',
        'credit': 'Cr√©dito',
        'debit': 'D√©bito',
        'cash': 'Dinheiro'
      }[comanda.pagamento] || comanda.pagamento;
      
      comandasAvulsasHtml += `<div class="footer-line"><span>${comanda.cliente} (${detalhes})</span><span>${formatBRL(comanda.totalCalculado)}</span></div>`;
      comandasAvulsasHtml += `<div class="item-addon">Pagamento: ${pagamentoLabel}${comanda.cpf ? ' | CPF: ' + comanda.cpf : ''}</div>`;
    });
  }
  
  // Total geral incluindo comandas
  const totalGeral = (order.totalGeral !== undefined) ? order.totalGeral : (total + totalComandas);

  const printContent = `
    <html>
      <head>
        <title>Comanda - Pedido #${orderNumber}</title>
        <style>
          @page { size: 58mm auto; margin: 5mm; }
          body { font-family: monospace; font-size: 10px; line-height: 1.2; white-space: pre; }
          .center { text-align: center; }
          .right { text-align: right; }
          .line { border-top: 1px dashed #000; margin: 5px 0; }
          .bold { font-weight: bold; }
          .item-line { margin-left: 5px; }
          .footer-line { display: flex; justify-content: space-between; }
          .item-addon { margin-left: 10px; }
        </style>
      </head>
      <body>
===============================================
               COMANDA - PEDIDO
===============================================
<div class="center">${orderDate} ${orderTime}</div>
<div class="center">Entrega prevista: ${deliveryTime}</div>
<div class="center">${storeName}</div>
<div class="center bold">===============================================</div>
<div class="center bold">                Pedido:</div>
<div class="line"></div>
<div class="bold">Itens:</div>
<div class="items-list">${itemsList}</div>
${comandasAvulsasHtml}
<div class="line"></div>
<div class="bold">Cliente</div>

Nome: ${clientName}
CPF/CNPJ: ${clientCpfCnpj}
Telefone: ${clientPhone}
Quantidade de pedidos: ${clientOrderCount}
Endere√ßo: ${clientAddress}
Bairro: ${clientNeighborhood}
<div class="line"></div>
<div class="bold">Pagamento</div>

Forma de Pagamento: ${paymentMethod}
<div class="line"></div>
<div class="footer-line"><span>Subtotal:</span><span>${formatBRL(subtotal)}</span></div>
<div class="footer-line"><span>Taxa de entrega:</span><span>${formatBRL(deliveryFee)}</span></div>
${totalComandas > 0 ? `<div class="footer-line"><span>Comandas Avulsas:</span><span>${formatBRL(totalComandas)}</span></div>` : ''}
<div class="footer-line"><span>Total:</span><span>${formatBRL(totalGeral)}</span></div>
<div class="line"></div>
      
<!-- ========================================================================= -->
<!-- === MODAL DE HIST√ìRICO DE PEDIDOS (CRM) === -->
<!-- ========================================================================= -->
<div id="orderHistoryModal" class="modal">
  <div class="modal-content" style="max-height: 80vh; overflow-y: auto;">
    <div class="modal-header">
      <h2 id="historyModalTitle">Hist√≥rico de Pedidos</h2>
      <span class="close-button" onclick="closeOrderHistoryModal()">&times;</span>
    </div>
    <div class="modal-body">
      <p id="historyClientInfo" style="margin-bottom: 15px; font-weight: 600;"></p>
      <div id="historyOrdersList">
        <!-- Pedidos ser√£o injetados aqui -->
        <p style="color:#888;">Carregando hist√≥rico...</p>
      </div>
    </div>
  </div>
</div>

</body>
    </html>
  `;

  const win = window.open('', 'PRINT', 'height=600,width=400');
  win.document.write(printContent);
  win.document.close();
  win.focus();
  win.print();
}

</script>
<style>
  :root{
    --primary:#800080;
    --muted:#7d8590;
    --bg:#f5f6f7;
    --card:#ffffff;
    --radius:12px;
    font-family:Inter, "Helvetica Neue", Arial, sans-serif;
    color:#222;
  }
  *{box-sizing:border-box}
  /* Ajuste de padding padr√£o */
  body{margin:0;background:var(--bg);padding:18px;display:flex;justify-content:center}
  .app{width:100%;max-width:1200px}
  header.banner{
    background:linear-gradient(90deg,var(--primary),#ff6b6b);
    color:#fff;border-radius:12px;padding:18px;display:flex;align-items:center;gap:16px;margin-bottom:14px;
  }
  header.banner img.logo{width:72px;height:72px;border-radius:50%;object-fit:cover;background:#fff;}
  header .meta h1{margin:0;font-size:20px}
  header .meta p{margin:6px 0 0;color:rgba(255,255,255,0.95);font-size:13px}
  .controls{display:flex;gap:12px;align-items:center;margin-bottom:10px;flex-wrap:wrap}
  .search{flex:1;display:flex;align-items:center;background:#fff;padding:8px;border-radius:10px}
  .search input{border:0;outline:0;width:100%;font-size:15px}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:14px}
  
  /* --- IN√çCIO: AJUSTES DE RESPONSIVIDADE (MOBILE) --- */

  /* Estilos para o novo Dashboard de Motoboys */
  .motoboy-dashboard-container {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    flex-wrap: wrap;
  }
  .dashboard-card {
    flex: 1;
    min-width: 150px;
    background: var(--card);
    padding: 15px;
    border-radius: var(--radius);
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    text-align: center;
  }
  .dashboard-card .value {
    font-size: 24px;
    font-weight: bold;
    color: var(--primary);
    margin-bottom: 5px;
  }
  .dashboard-card .label {
    font-size: 12px;
    color: var(--muted);
    text-transform: uppercase;
  }
  
  /* Esconde o user-badge que est√° no footer em telas grandes (desktop) */
  .user-badge.only-mobile {
      display: none;
  }

  /* Ajuste para telas menores que 1024px (tablets e celular) */
  @media (max-width:1024px){ 
    .grid{grid-template-columns:1fr; } 
    
    /* Torna o painel do carrinho responsivo e centralizado */
    .cart-panel{
      position:fixed;
      bottom:90px; /* 90px de dist√¢ncia do rodap√© fixo */
      width:min(90%, 320px); 
      left: 50%; 
      transform: translateX(-50%);
      right: auto; 
      z-index:60;
    }

    /* Esconde o status do rodap√© para dar espa√ßo aos bot√µes */
    #footerStatus {
        display: none; 
    }

    /* Mostra o user-badge do footer em mobile, ao lado do bot√£o do carrinho */
    .user-badge.only-mobile {
        display: flex; /* Agora vis√≠vel em mobile */
        margin-right: 10px; /* Adiciona um pequeno espa√ßamento do bot√£o ao lado */
    }

    /* Reduz o tamanho do bot√£o no footer para caber melhor */
    .footer-content-wrapper .btn {
      padding: 8px 10px;
      font-size: 14px;
    }
  }

  /* Ajuste para telas muito pequenas (celulares estreitos) */
  @media (max-width:600px){
    body{padding: 10px;} 
    header.banner{padding: 12px;} 
    header.banner img.logo{width: 60px; height: 60px;} 
    .controls{gap: 8px;} 
  }

  /* Ajuste para o rodap√© fixo */
  .footer-fixed{
      position:fixed;
      left:0;
      right:0;
      bottom:0;
      background:#fff;
      border-top:1px solid #eee;
      padding:10px; 
      display:flex;
      justify-content:center;
      z-index:90;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.05); 
  }
  
  /* Novo wrapper para alinhar o conte√∫do do rodap√© com o max-width do app */
  .footer-content-wrapper {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      max-width: 1200px;
      padding: 0 8px; 
  }
  /* --- FIM: AJUSTES DE RESPONSIVIDADE (MOBILE) --- */

  .side{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.06)}
  main {
      overflow-y: auto;
      min-height: 0; 
  }
  .items{
      display:flex;
      flex-direction:column;
      gap:6px;
      padding-bottom: 30px; 
  }
  .categories{display:flex;gap:8px;overflow-x:auto;padding-bottom:10px; /* Espa√ßo para a barra de rolagem */}.categories::-webkit-scrollbar{height:4px;}.categories::-webkit-scrollbar-thumb{background:var(--primary);border-radius:2px;}.categories button{flex-shrink:0;display:inline-block;text-align:center;padding:6px 12px;border-radius:20px;border:1px solid #ddd;background:#f5f5f5;margin-bottom:0;cursor:pointer;font-size:14px;transition:background 0.2s, border-color 0.2s;}
  
  .categories button.active{background:var(--primary);color:#fff;border-color:var(--primary);font-weight:700}.item{display:flex;gap:12px;align-items:flex-start;background:var(--card);padding:12px;border-radius:12px;box-shadow:0 6px 14px rgba(0,0,0,0.04)}
  .item img{width:110px;height:90px;object-fit:cover;border-radius:10px}
  .item .info h3{margin:0;display:flex;justify-content:space-between;align-items:center;gap:12px}
  .item .info p{margin:6px 0 10px;color:var(--muted)}
  .actions{display:flex;flex-direction:column;gap:8px;align-items:flex-end}
  .btn{background:var(--primary);color:#fff;padding:8px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
  .pill{background:#fff;padding:6px 10px;border-radius:10px;border:1px solid #eee;cursor:pointer}
  .qty{display:flex;gap:6px;align-items:center;background:#fff;padding:6px;border-radius:8px}
  .qty button{border:0;background:transparent;font-size:18px;cursor:pointer}
  .modal{position:fixed;left:0;top:0;right:0;bottom:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:80;padding:12px}
  .modal.open{display:flex}
  .modal .card{background:#fff;border-radius:12px;padding:16px;width:100%;max-width:1000px;max-height:85vh;overflow:auto}
  .addon-group{border:1px solid #f1f1f1;padding:12px;border-radius:8px;margin-bottom:12px}
  .addon-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .addon-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-top:1px solid #fbfbfb}
  
  /* === ESTILOS PARA TIMELINE DO PEDIDO === */
  #timelineList li {
    position: relative;
    padding-left: 35px;
    padding-bottom: 20px;
    border-left: 2px solid #e0e0e0;
  }
  #timelineList li:last-child {
    border-left: 2px solid transparent;
    padding-bottom: 0;
  }
  #timelineList li::before {
    content: '';
    position: absolute;
    left: -6px;
    top: 0;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #ccc;
  }
  #timelineList li.completed::before {
    background: #4CAF50;
  }
  #timelineList li.current::before {
    background: var(--primary);
    width: 14px;
    height: 14px;
    left: -8px;
    box-shadow: 0 0 0 4px rgba(128, 0, 128, 0.2);
  }
  #timelineList li .timeline-title {
    font-weight: 700;
    font-size: 14px;
    margin-bottom: 4px;
  }
  #timelineList li .timeline-time {
    font-size: 12px;
    color: var(--muted);
  }
  .addon-controls{display:flex;gap:8px;align-items:center}
  .addon-controls button{background:#fff;border:1px solid #eee;border-radius:6px;padding:6px 10px;cursor:pointer}
  .addon-controls .count{min-width:28px;text-align:center;display:inline-block}
  .cart-panel{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.08)}
  .admin-bar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
  .meta-addon-info{font-size:12px;color:var(--muted);margin-top:4px}
  .hidden{display:none}
  .auth-tabs{display:flex;gap:8px;margin-bottom:16px}
  .auth-tabs button{flex:1;padding:10px;border:0;background:#f5f5f5;border-radius:8px;cursor:pointer;font-weight:600}
  .auth-tabs button.active{background:var(--primary);color:#fff}
  .admin-tabs{display:flex;gap:8px;margin-bottom:16px;border-bottom:1px solid #eee;padding-bottom:8px;overflow-x:auto;}.admin-tabs::-webkit-scrollbar{height:4px;}.admin-tabs::-webkit-scrollbar-thumb{background:var(--primary);border-radius:2px;}
  .admin-tabs button{flex-shrink:0;padding:10px 15px;border:0;background:#f5f5f5;border-radius:8px;cursor:pointer;font-weight:600;}
  .admin-tabs button.active{background:var(--primary);color:#fff;}
  .admin-panel{padding-top:10px;}
  
  /* CORRE√á√ÉO DO GR√ÅFICO: Define altura para o cont√™iner */
  #salesPanel { 
      height: 400px; 
      padding-bottom: 20px; 
  } 
  #salesChart { 
      width: 100%; 
      height: 100%; 
  }

  .form-group{margin-bottom:14px}
  .form-group label{display:block;margin-bottom:6px;font-weight:600;font-size:14px}
  .form-group input, .form-group select, .form-group textarea{width:100%;padding:10px;border:1px solid #e1e1e1;border-radius:8px;font-size:14px}
  .user-badge{background:#fff;padding:6px 12px;border-radius:20px;display:flex;align-items:center;gap:8px;cursor:pointer}
  .user-badge:hover{background:#f9f9f9}
  .item-management-note { background: #fff7e6; padding: 10px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid #ff9800; }
  .addon-group-settings { margin-bottom: 15px; padding: 10px; border: 1px solid #e9ecef; border-radius: 6px; background: #f8f9fa; }
  .addon-item-row { display: flex; gap: 8px; align-items: center; margin-bottom: 6px; }
  .addon-item-row input { flex: 1; }
  .delivery-area-row { display: flex; gap: 10px; align-items: center; margin-bottom: 8px; padding: 8px; border: 1px solid #eee; border-radius: 6px; }
  .delivery-area-row input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
  .delivery-area-row .area-name-input { flex: 2; }
  .delivery-area-row .area-fee-input { flex: 1; max-width: 100px; }

  /* --- CORRE√á√ÉO DE Z-INDEX PARA MODAL DE ADICIONAIS --- */
  #modal { z-index: 200 !important; }


/* === NOVO LAYOUT DE CARDS PARA CLIENTE === */
.menu-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 14px;
  width: 100%;
}

.menu-card {
  padding:12px;
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  overflow: hidden;
  text-align: center;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.menu-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 20px rgba(0,0,0,0.1);
}
.menu-card-img {
  width: 100%;
  height: 140px;
  object-fit: cover;
}
.menu-card-body {
  padding: 10px;
}
.menu-card-title {
  font-size: 15px;
  margin: 6px 0 4px;
  color: #333;
}
.menu-card-price {
  font-weight: 700;
  color: var(--primary);
  margin-bottom: 8px;
}
.menu-card-btn {
  width: 100%;
  background: var(--primary);
  color: #fff;
  border: none;
  border-radius: 10px;
  padding: 8px 12px;
  font-weight: 600;
  cursor: pointer;
}
.menu-card-btn:hover {
  opacity: 0.9;
}


/* === Drawer de Pedidos === */
.drawer {
  position: fixed;
  left: 0;
  right: 0;
  bottom: -100%;
  background: var(--card);
  border-top-left-radius: 16px;
  border-top-right-radius: 16px;
  box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
  padding: 18px;
  transition: bottom 0.35s ease;
  z-index: 250;
  max-height: 80vh;
  overflow-y: auto;
}
.drawer.open { bottom: 0; }

.drawer h4 {
  color: var(--primary);
  margin-top: 0;
  margin-bottom: 12px;
}






/* === Bot√£o Pedidos igual ao Entrar === */
#btnViewOrders {
  background-color: inherit !important; /* cor do rodap√© */
  color: #000 !important;               /* texto preto */
  border: none !important;
  border-radius: 8px;
  padding: 8px 12px;
  font-weight: 600;
}
#btnViewOrders:hover {
  opacity: 0.9;
}


/* === CORRE√á√ÉO DE LAYOUT ADMIN (CATEGORIAS E ITENS) === */

/* For√ßa o conte√∫do principal a respeitar o limite da tela */
.app {
  max-width: 100%;
  overflow-x: hidden;
}

/* Mant√©m o grid alinhado no mobile */
@media (max-width: 1024px) {
  .grid {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  main, .side {
    width: 100% !important;
    max-width: 100%;
  }

  /* Corrige as categorias para n√£o estourarem a largura */
  .categories {
    display: flex;
    flex-wrap: nowrap;
    overflow-x: auto;
    padding: 8px 0;
    margin: 0;
  }
  .categories > div,
  .categories > button {
    flex-shrink: 0;
    max-width: 90%;
  }

  /* Corrige os bot√µes de categoria do admin */
  .categories div {
    flex: 0 0 auto;
    display: flex;
    align-items: center;
    gap: 6px;
    margin-right: 6px;
  }

  /* Ajusta itens do card√°pio */
  .item {
    flex-direction: column;
    align-items: flex-start;
    width: 100%;
  }
  .item img {
    width: 100%;
    height: auto;
    border-radius: 10px;
  }
  .item .info {
    width: 100%;
  }

  /* Ajusta modais para caber na tela */
  .modal .card {
    width: 95% !important;
    max-width: 95% !important;
  }
}

/* Corrige o grid em telas grandes */
@media (min-width: 1025px) {
  .categories {
    flex-wrap: wrap;
    justify-content: flex-start;
  }
  .categories div {
    display: flex;
    align-items: center;
    gap: 6px;
    margin: 4px;
  }
}

</style>
</head>
<body>
  <div class="app" id="app">
    <header class="banner">
      <img class="logo" id="logo" src="" alt="Logo">
      <div class="meta">
        <h1 id="name">Creamy Purple</h1>
        <p id="addr">R ALCIDES RODRIGUES PONTES ‚Ä¢ <span id="status">Aberto at√© as 23:00</span></p>
      </div>
      <div style="margin-left:auto;text-align:right">
      </div>
      </header>

    <div class="controls">
      <div class="search"><input id="q" placeholder="Buscar no card√°pio ‚Äî ex: calabresa, bacon..." /></div>
      <div id="adminControls" class="hidden">
        <button class="pill" id="btnAdminPanel">Painel Admin</button>
        <button class="pill" id="btnExport">Exportar JSON</button>
        <button class="pill" id="btnImport">Importar JSON</button>
        <button class="pill" id="logoutBtn">Sair</button>
        <input id="fileImport" type="file" accept=".json" style="display:none" />
      </div>
      <div style="margin-left:auto" class="admin-bar" id="adminBar">
        <button class="pill" id="btnReset" style="background:#dc3545; color:white;">Reset demo (Firebase)</button>
      </div>
    </div>

    <div class="grid">
      <main>
        <div class="categories" id="cats">
  <button class="active">Todas</button>
  <button>Pizzas Salgadas</button>
  <button>Pizzas Doces</button>
  <button>Esfihas</button>
  <button>Bebidas</button>
  <button>Sobremesas</button>
  <button>Combos Especiais</button>
  <button>Promo√ß√µes do Dia</button>
  <button>Lanches</button>
  <button>Sucos Naturais</button>
</div>
        <div id="items" class="items"></div>
      </main>
        <div class="cart-panel" id="cartPanel">
          <h3>Meu Carrinho</h3>
          <div id="cartList"></div>
          <div class="cart-summary">
            <div class="summary-row">
              <span>Subtotal</span>
              <span id="subtotal">R$ 0,00</span>
            </div>
            <div class="summary-row">
              <span>Taxa de Entrega</span>
              <span id="deliveryFee">R$ 0,00</span>
            </div>
            <div class="summary-row" id="loyaltyDiscountRow" style="display:none; color:#28a745;">
              <span>Desconto Fidelidade</span>
              <span id="loyaltyDiscountValue">- R$ 0,00</span>
            </div>
            <div class="summary-row total">
              <span>Total</span>
              <span id="total">R$ 0,00</span>
            </div>
          </div>
          <button class="btn" id="btnCheckout" disabled>Finalizar Pedido</button>
        </div>
      </aside>

        <div class="modal" id="adminModal">
          <div class="card" role="dialog" aria-modal="true" style="max-width:2000px">
            <h3>Painel de Administra√ß√£o</h3>
            <div class="admin-tabs">
              <button id="tabOrders" class="active">Pedidos em Tempo Real</button>
              <button id="tabSales">Relat√≥rio de Vendas</button>
              <button id="tabCustomers">Controle de Clientes</button>
              <button id="tabSettings">Configura√ß√µes da Loja</button>
              <button id="tabPDV">PDV (Mesas)</button>
              <button id="tabMotoboys">Motoboy</button>
              <button id="btnComandaAvulsa" class="pill" style="background:#ffe6b3; color:#663300; font-weight:700; margin-left:6px;">Comanda Avulsa</button>
              <button id="closeAdminModal" style="text-align:right;margin-top:16px">Fechar</button>
            </div>

            <div id="adminContent">
              
<div id="ordersPanel" class="admin-panel">
  <h4>Pedidos em Tempo Real</h4>

  <style>
    #kanbanWrapper {
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:12px;
      overflow-x: auto; /* Permite rolagem horizontal em telas grandes se necess√°rio */
      padding-bottom: 10px; /* Espa√ßo para a barra de rolagem */
    }
    @media (max-width: 768px) {
      #kanbanWrapper {
        grid-template-columns: repeat(4, 250px); /* Mant√©m 4 colunas, mas com largura fixa para rolagem */
        grid-auto-flow: column; /* Garante que as colunas fiquem lado a lado */
      }
    }
    .kanban-column {background:#f5f5f5;padding:10px;border-radius:12px;min-height:300px;max-height:70vh;overflow-y:auto;}
    .kanban-title {font-weight:700;color:#fff;padding:8px;border-radius:8px;text-align:center;margin-bottom:8px;}
    .order-card {background:#fff;border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,0.1);padding:10px;margin-bottom:10px;}
    .order-card-header{display:flex;justify-content:space-between;font-weight:700;}
    .order-card-items{font-size:13px;margin-top:6px;border-left:3px solid #eee;padding-left:6px;}
  </style>

  <div id="kanbanWrapper">
    <div class="kanban-column" id="col_pending"><div class="kanban-title" style="background:#ff9800">üüß Em An√°lise</div></div>
    <div class="kanban-column" id="col_in_production"><div class="kanban-title" style="background:#17a2b8">üü® Em Produ√ß√£o</div></div>
    <div class="kanban-column" id="col_ready_for_delivery"><div class="kanban-title" style="background:#03A9F4">üü¶ Pronto para Entregar</div></div>
    <div class="kanban-column" id="col_delivered"><div class="kanban-title" style="background:#4CAF50">‚úîÔ∏è Conclu√≠dos</div></div>
  </div>
</div>
</div>
              
<div id="salesPanel" class="admin-panel hidden">
  <h4>Relat√≥rio de Vendas</h4>

  <!-- Filtro de Per√≠odo -->
  <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px;">
    <div style="font-weight:700;">Per√≠odo:</div>
    <div id="periodFilters" style="display:flex;gap:8px;margin-left:6px; flex-wrap: wrap;">
      <button class="pill period-btn" data-period="day" onclick="setSalesPeriod('day')">Dia</button>
      <button class="pill period-btn" data-period="week" onclick="setSalesPeriod('week')">Semana</button>
      <button class="pill period-btn" data-period="month" onclick="setSalesPeriod('month')">M√™s</button>
      <button class="pill period-btn active" data-period="total" onclick="setSalesPeriod('total')">Total</button>
      
      <!-- Seletor de Per√≠odo Personalizado -->
      <div style="display:flex; gap: 4px; align-items: center; margin-left: 10px;">
        <input type="date" id="startDate" style="padding: 6px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px;">
        <span style="color: var(--muted);">at√©</span>
        <input type="date" id="endDate" style="padding: 6px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px;">
        <button id="btnFilterCustom" class="pill period-btn" data-period="custom" onclick="setSalesPeriod('custom')" style="background: #007bff; color: white;">Personalizado</button>
      </div>
    </div>
    <div style="margin-left:auto;font-size:13px;color:var(--muted)">Apenas pedidos com status <strong>entregue</strong> s√£o considerados.</div>
  </div>

	  <!-- Gr√°fico de Picos de Hor√°rio -->
	  <div class="side" style="padding:12px; margin-bottom: 14px;">
	    <h5 style="margin:0 0 8px">üìà Picos de Pedidos por Hora</h5>
	    <div style="height: 300px;">
	      <canvas id="peakHoursChart"></canvas>
	    </div>
	  </div>
	
	  <!-- Cards Resumo -->
	  <div id="salesSummaryCards" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:14px">
    <div class="side" style="padding:12px;text-align:left">
      <div style="font-size:13px;color:var(--muted)">Faturamento Total</div>
      <div id="cardRevenue" style="font-weight:800;font-size:20px;margin-top:6px">R$ 0,00</div>
    </div>
    <div class="side" style="padding:12px;text-align:left">
      <div style="font-size:13px;color:var(--muted)">Quantidade de Vendas</div>
      <div id="cardCount" style="font-weight:800;font-size:20px;margin-top:6px">0</div>
    </div>
    <div class="side" style="padding:12px;text-align:left">
      <div style="font-size:13px;color:var(--muted)">Ticket M√©dio</div>
      <div id="cardAvg" style="font-weight:800;font-size:20px;margin-top:6px">R$ 0,00</div>
    </div>
    <div class="side" style="padding:12px;text-align:left">
      <div style="font-size:13px;color:var(--muted)">√Årea com Mais Pedidos</div>
      <div id="cardTopArea" style="font-weight:800;font-size:16px;margin-top:6px">N/A</div>
    </div>
  </div>

  <!-- Tabelas -->
  <div style="display:grid;grid-template-columns:1fr;gap:12px">
    <div class="side" style="padding:12px">
      <h5 style="margin:0 0 8px">Top 10 Produtos Mais Vendidos</h5>
      <div style="overflow:auto">
        <table id="tableTopProducts" style="width:100%;border-collapse:collapse">
          <thead>
            <tr style="text-align:left;color:var(--muted);font-size:13px">
              <th style="padding:8px;border-bottom:1px solid #eee">Posi√ß√£o</th>
              <th style="padding:8px;border-bottom:1px solid #eee">Produto</th>
              <th style="padding:8px;border-bottom:1px solid #eee">Quantidade</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
	      </div>
	    </div>
	
	    <!-- NOVO: Tabela Top Clientes -->
	    <div class="side" style="padding:12px">
	      <h5 style="margin:0 0 8px">üèÜ Top Clientes</h5>
	      <div style="overflow:auto">
	        <table id="tableTopCustomers" style="width:100%;border-collapse:collapse">
	          <thead>
	            <tr style="text-align:left;color:var(--muted);font-size:13px">
	              <th style="padding:8px;border-bottom:1px solid #eee">#</th>
	              <th style="padding:8px;border-bottom:1px solid #eee">Nome</th>
	              <th style="padding:8px;border-bottom:1px solid #eee">Pedidos</th>
	              <th style="padding:8px;border-bottom:1px solid #eee">Total Gasto</th>
	              <th style="padding:8px;border-bottom:1px solid #eee">Ticket M√©dio</th>
	            </tr>
	          </thead>
	          <tbody></tbody>
	        </table>
	      </div>
	    </div>
	
	    <div class="side" style="padding:12px">
	      <h5 style="margin:0 0 8px">Formas de Pagamento</h5>
      <div style="overflow:auto">
        <table id="tablePayments" style="width:100%;border-collapse:collapse">
          <thead>
            <tr style="text-align:left;color:var(--muted);font-size:13px">
              <th style="padding:8px;border-bottom:1px solid #eee">M√©todo</th>
              <th style="padding:8px;border-bottom:1px solid #eee">Quantidade</th>
              <th style="padding:8px;border-bottom:1px solid #eee">Total (R$)</th>
              <th style="padding:8px;border-bottom:1px solid #eee">%</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- NOVO: Tabela Relat√≥rio de Motoboys -->
	    <div class="side" style="padding:12px">
	      <h5 style="margin:0 0 8px">üõµ Relat√≥rio de Motoboys</h5>
	      <div style="overflow:auto">
	        <table id="tableMotoboyReport" style="width:100%;border-collapse:collapse">
	          <thead>
	            <tr style="text-align:left;color:var(--muted);font-size:13px">
	              <th style="padding:8px;border-bottom:1px solid #eee">Motoboy</th>
	              <th style="padding:8px;border-bottom:1px solid #eee">Entregas</th>
	              <th style="padding:8px;border-bottom:1px solid #eee">Total Entregue (R$)</th>
	              <th style="padding:8px;border-bottom:1px solid #eee">M√©dia por Entrega (R$)</th>
	            </tr>
	          </thead>
	          <tbody></tbody>
	        </table>
	      </div>
	    </div>
	
	    <div class="side" style="padding:12px">
	      <h5 style="margin:0 0 8px">Performance por √Årea de Entrega</h5>
      <div style="overflow:auto">
        <table id="tableAreas" style="width:100%;border-collapse:collapse">
          <thead>
            <tr style="text-align:left;color:var(--muted);font-size:13px">
              <th style="padding:8px;border-bottom:1px solid #eee">√Årea</th>
              <th style="padding:8px;border-bottom:1px solid #eee">Pedidos</th>
              <th style="padding:8px;border-bottom:1px solid #eee">Total (R$)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>
<div id="customersPanel" class="admin-panel hidden">
<h4>Controle de Clientes</h4>
	                
	                <!-- Controles de Busca e Ordena√ß√£o (CRM) -->
	                <div style="display:flex; gap:10px; margin-bottom:15px; flex-wrap:wrap;">
	                    <input type="text" id="customerSearchInput" placeholder="Buscar por nome ou telefone..." 
	                           style="flex:1; padding:8px; border:1px solid #ccc; border-radius:8px;"
	                           oninput="filterAndSortCustomers()">
	                    
	                    <select id="customerSortSelect" 
	                            style="padding:8px; border:1px solid #ccc; border-radius:8px;"
	                            onchange="filterAndSortCustomers()">
	                        <option value="totalOrdersDesc">Pedidos (Mais)</option>
	                        <option value="totalOrdersAsc">Pedidos (Menos)</option>
	                        <option value="totalSpentDesc">Gasto (Maior)</option>
	                        <option value="totalSpentAsc">Gasto (Menor)</option>
	                        <option value="lastOrderDateDesc">Mais Recentes</option>
	                        <option value="lastOrderDateAsc">Mais Antigos</option>
	                        <option value="activityScoreDesc">Mais Ativos</option>
	                    </select>
	                </div>
	                
	                <div id="customersList"></div>
              </div>
              <div id="settingsPanel" class="admin-panel hidden">
                <h4>Configura√ß√µes da Loja</h4>
                <form id="storeSettingsForm">
                  <div class="form-group">
                    <label for="restaurantName">Nome da Loja</label>
                    <input type="text" id="restaurantName" required>
                  </div>
                  <div class="form-group">
                    <label for="restaurantAddress">Endere√ßo</label>
                    <input type="text" id="restaurantAddress" required>
                  </div>
                  <div class="form-group" id="savedAddressesGroup" style="display:none;">
                    <label for="savedAddresses">Endere√ßos Salvos</label>
                    <select id="savedAddresses" class="form-control">
                      <option value="">Selecionar um endere√ßo salvo...</option>
                      <option value="Casa">Casa (Rua Exemplo, 123, Cidade)</option>
                      <option value="Trabalho">Trabalho (Av. Principal, 456, Cidade)</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label for="restaurantStatus">Status (Hor√°rio de Funcionamento)</label>
                    <input type="text" id="restaurantStatus" placeholder="Ex: Aberto at√© as 23:00" required>
                  </div>
                  
                  <!-- NOVO: Tempo de Preparo Din√¢mico -->
                  <div class="form-group">
                    <label for="preparationTime">‚è±Ô∏è Tempo M√©dio de Preparo (minutos)</label>
                    <input type="number" id="preparationTime" min="5" max="120" placeholder="Ex: 30" required>
                    <small style="color: var(--muted); font-size: 12px;">Tempo estimado para preparar os pedidos (entre 5 e 120 minutos)</small>
                  </div>
                  
                  <div class="form-group">
                    <label for="restaurantLogoFile">Logo da Loja (Escolha Arquivo)</label>
                    <input type="file" id="restaurantLogoFile" accept="image/*">
                    <div style="margin-top:10px;"><img id="currentLogoPreview" src="" alt="Pr√©via do Logo" style="max-width:100px; height:auto; border-radius:8px;"></div>
                    <input type="hidden" id="restaurantLogoUrl"> </div>
                  <h5 style="margin-top:20px;">Taxas de Entrega por √Årea</h5>
                  
                  <div class="form-group">
                    <label>
                      <input type="checkbox" id="useRadiusDelivery"> Calcular taxa automaticamente por raio (km)
                    </label>
                  </div>
                  
                  <div class="form-group">
                    <label for="deliveryBaseFee">Taxa base de entrega (R$)</label>
                    <input type="number" id="deliveryBaseFee" step="0.01" min="0" value="0">
                  </div>
                  
                  <div class="form-group">
                    <label for="deliveryFeePerKm">Valor por km adicional (R$/km)</label>
                    <input type="number" id="deliveryFeePerKm" step="0.01" min="0" value="0">
                  </div>
                  
                  <input type="hidden" id="restaurantLat" value="0">
                  <input type="hidden" id="restaurantLng" value="0">
                  
                  <div id="deliveryAreasList">
                    </div>
                  <button type="button" class="pill" id="btnAddDeliveryArea" style="background:#e6ffe6; color:#28a745; margin-bottom:10px;">+ Adicionar √Årea de Entrega</button>
                  
                  <h5 style="margin-top:20px;">Gerenciar Cupons de Desconto</h5>
                  <div id="couponsList" style="margin-bottom:10px;">
                    </div>
                  <button type="button" class="pill" id="btnAddCoupon" style="background:#e6ffe6; color:#28a745; margin-bottom:10px;">+ Criar Novo Cupom</button>
                  
                  <!-- NOVA SE√á√ÉO: CUPONS INTELIGENTES -->
                  <div style="border-top: 2px solid #e0e0e0; margin: 30px 0; padding-top: 20px;">
                    <h5 style="margin-bottom:15px; color:#ff9800;">üß† Cupons Inteligentes (IA Leve)</h5>
                    <div id="smartCouponAdminPanel">
                      <!-- Painel ser√° renderizado aqui -->
                    </div>
                  </div>
                  <!-- FIM CUPONS INTELIGENTES -->
                  
                  <div style="text-align:right;margin-top:16px">
                    <button type="submit" class="btn">Salvar Configura√ß√µes</button>
                  </div>
                </form>
              </div>
              
              <div id="motoboysPanel" class="admin-panel hidden">
    <!-- Novo Dashboard de Motoboys -->
    <div class="motoboy-dashboard-container" id="motoboyDashboard">
      <!-- Cards do dashboard ser√£o injetados aqui pelo JS -->
    </div>
                <h4>Painel de Motoboys</h4>
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
                  <div style="font-weight:700;">Motoboys Cadastrados</div>
                  <div>
                    <button id="btnOpenMotoboyModal" class="pill" style="background:#e6ffe6; color:#28a745;">+ Cadastrar Motoboy</button>
                  </div>
                </div>
                <div id="motoboysList" class="menu-grid"></div>
              </div>

              <div id="pdvPanel" class="admin-panel hidden">
                <h4>PDV ‚Äî Gest√£o de Mesas</h4>
                <div id="pdvTablesGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px;"></div>
              </div>
            </div>
          </div>
        </div>

      </main>

    </div>

    <div class="modal" id="itemDetailsModal">
      <div class="card" role="dialog" aria-modal="true" style="max-width:500px">
        <h3 id="itemDetailsModalTitle">Adicionar Novo Item</h3>
        <form id="itemDetailsForm">
          <input type="hidden" id="itemIdDetails" />
          <div class="form-group">
            <label for="itemName">Nome do Item</label>
            <input type="text" id="itemName" required>
          </div>
          <div class="form-group">
            <label for="itemDesc">Descri√ß√£o</label>
            <textarea id="itemDesc" rows="3" required></textarea>
          </div>
          <div class="form-group">
            <label for="itemPrice">Pre√ßo (R$)</label>
            <input type="number" id="itemPrice" step="0.01" required>
          </div>
          <div class="form-group">
            <label for="itemCategory">Categoria</label>
            <select id="itemCategory" required></select>
          </div>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px">
            <button type="button" id="itemDetailsCancel" class="pill">Cancelar</button>
            <button type="submit" class="btn" id="itemDetailsSubmit">Salvar Detalhes</button>
          </div>
        </form>
      </div>
    </div>

    <div class="modal" id="addonManagementModal">
      <div class="card" role="dialog" aria-modal="true" style="max-width:800px">
        <h3 id="addonManagementTitle">Gerenciar Adicionais para <span id="addonItemName" style="color:var(--primary);"></span></h3>
        
        <div id="addonGroupsList"></div>
        
        <div style="margin-top:16px; display:flex; justify-content:space-between; align-items:center;">
          <button type="button" class="btn" id="btnAddAddonGroup" style="background:#28a745;">+ Adicionar Grupo</button>
          <div>
            <button type="button" id="addonManagementCancel" class="pill">Cancelar</button>
            <button type="button" class="btn" id="addonManagementSubmit">Salvar Adicionais</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal" id="imageEditModal">
      <div class="card" role="dialog" aria-modal="true" style="max-width:500px">
        <h3 id="imageEditModalTitle">Editar Imagem para <span id="imageItemName" style="color:var(--primary);"></span></h3>
        <form id="imageEditForm">
          <input type="hidden" id="itemIdImage" />
          
          <div class="form-group">
            <label for="itemImgFile">Escolher Imagem do Item</label>
            <input type="file" id="itemImgFile" accept="image/*">
            <input type="hidden" id="itemImgUrl"> </div>
          <div style="text-align:center; margin-bottom:16px;">
             <img id="currentImagePreview" src="" alt="Pr√©via" style="max-width:100%; height:auto; border-radius:8px; margin-top:10px;">
          </div>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px">
            <button type="button" id="imageEditCancel" class="pill">Cancelar</button>
            <button type="submit" class="btn" id="imageEditSubmit">Salvar Imagem</button>
          </div>
        </form>
      </div>
    </div>


    <div class="modal" id="modal">
      <div class="card" role="dialog" aria-modal="true">
        <h3 id="modalTitle">Adicionais</h3>
        <div style="display:flex;gap:12px;align-items:center;margin-bottom:8px">
          <div><strong id="modalItemName"></strong></div>
          <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
            <div class="small">Quantidade do item:</div>
            <div class="qty" id="itemQtyControls">
              <button data-action="decrement-qty">-</button>
              <span id="modalItemQty">1</span>
              <button data-action="increment-qty">+</button>
            </div>
          </div>
        </div>
        <div id="modalAddons"></div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
          <div class="small">Total do item: <strong id="modalTotal">R$ 0,00</strong></div>
          <div>
            <button id="modalCancel" class="pill">Cancelar</button>
            <button id="modalConfirm" class="btn">Adicionar ao carrinho</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal" id="authModal">
      <div class="card" role="dialog" aria-modal="true" style="max-width:420px">
        <h3 id="authTitle">Entrar / Cadastrar</h3>
        <div class="auth-tabs">
          <button id="tabLogin" class="active">Entrar</button>
          <button id="tabRegister">Cadastrar</button>
        </div>
        
        <div id="loginForm">
          <div class="form-group">
            <label>Email ou usu√°rio</label>
            <input type="text" id="loginUser" placeholder="seu@email.com">
          </div>
          <div class="form-group">
            <label>Senha</label>
            <input type="password" id="loginPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
          </div>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px">
            <button id="loginCancel" class="pill">Cancelar</button>
            <button id="loginSubmit" class="btn">Entrar</button>
          </div>
        </div>

        <div id="registerForm" class="hidden">
          <div class="form-group">
            <label>Nome completo</label>
            <input type="text" id="regName" placeholder="Jo√£o Silva">
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="regEmail" placeholder="seu@email.com">
          </div>
          <div class="form-group">
            <label>Telefone</label>
            <input type="tel" id="regPhone" placeholder="(11) 99999-9999">
          </div>
          <div class="form-group">
            <label>Senha</label>
            <input type="password" id="regPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
          </div>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px">
            <button id="registerCancel" class="pill">Cancelar</button>
            <button id="registerSubmit" class="btn">Cadastrar</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal" id="profileModal">
      <div class="card" role="dialog" aria-modal="true" style="max-width:600px">
        <h3>Meu Perfil</h3>
        <div style="background:#f9f9f9;padding:12px;border-radius:8px;margin-bottom:16px">
          <div style="display:flex;justify-content:space-between;margin-bottom:8px">
            <strong id="profileName"></strong>
            <button class="pill" id="logoutBtn">Sair</button>
          </div>
          <div class="small" id="profileEmail"></div>
          <div class="small" id="profilePhone"></div>

          <!-- Card de Status do Cliente -->
          <div id="clientStatusCard" style="
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            background: #fff;
            border: 1px solid #eee;
            text-align: center;
          ">
            <div style="font-size: 12px; color: var(--muted);">Seu Status Atual</div>
            <div id="clientStatusText" style="font-weight: 700; font-size: 16px; color: var(--primary); margin-top: 5px;">
              Carregando...
            </div>
          </div>
          <!-- Fim Card de Status do Cliente -->
          
          <!-- Badge de Tempo M√©dio de Entrega -->
          <div id="averageDeliveryTimeCard" style="
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            background: #fff;
            border: 1px solid #eee;
            text-align: center;
            display: none; /* Escondido por padr√£o, s√≥ aparece se houver dados */
          ">
            <div style="font-size: 12px; color: var(--muted);">üõµ Tempo m√©dio de entrega</div>
            <div id="averageDeliveryTimeText" style="font-weight: 700; font-size: 16px; color: #03A9F4; margin-top: 5px;">
              --min
            </div>
          </div>
          <!-- Fim Badge de Tempo M√©dio de Entrega -->

          <h4 style="margin-top:20px;">Meus Endere√ßos Salvos</h4>
          <div id="savedUserAddressesList">
            </div>
          <div class="form-group" style="margin-top:15px;">
            <label for="newAddressInput">Adicionar Novo Endere√ßo</label>
            <input type="text" id="newAddressInput" placeholder="Ex: Rua Exemplo, 123 - Bairro - Cidade" />
          </div>
          <button type="button" class="btn" id="btnAddUserAddress" style="background:#28a745; margin-bottom:15px;">Salvar Endere√ßo</button>

          <hr/>
        </div>
        
      <!-- Painel de "Meu Consumo" -->
          <div id="clientLoyaltyPanel">
          </div>      <h4 style="margin-top:20px;">üìä Meu Consumo</h4>
        <div id="myConsumptionPanel" style="
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
          gap: 10px;
          margin-bottom: 20px;
        ">
          <!-- Cards de m√©tricas ser√£o injetados aqui -->
          <div class="side" style="padding:10px; text-align:center;">
            <div style="font-size:12px;color:var(--muted)">Total Gasto</div>
            <div id="totalSpent" style="font-weight:800;font-size:16px;margin-top:4px">R$ 0,00</div>
          </div>
          <div class="side" style="padding:10px; text-align:center;">
            <div style="font-size:12px;color:var(--muted)">Ticket M√©dio</div>
            <div id="averageTicket" style="font-weight:800;font-size:16px;margin-top:4px">R$ 0,00</div>
          </div>
          <div class="side" style="padding:10px; text-align:center;">
            <div style="font-size:12px;color:var(--muted)">Pedidos</div>
            <div id="totalOrders" style="font-weight:800;font-size:16px;margin-top:4px">0</div>
          </div>
          <div class="side" style="padding:10px; text-align:center; grid-column: 1 / -1;">
            <div style="font-size:12px;color:var(--muted)">Produto Mais Pedido</div>
            <div id="mostOrderedProduct" style="font-weight:800;font-size:16px;margin-top:4px">N/A</div>
          </div>
          <div class="side" style="padding:10px; text-align:center; grid-column: 1 / -1;">
            <div style="font-size:12px;color:var(--muted)">Pagamento Preferido</div>
            <div id="preferredPaymentMethod" style="font-weight:800;font-size:16px;margin-top:4px">N/A</div>
          </div>
        </div>
        <!-- Fim Painel Meu Consumo -->

        <!-- Favoritos do Cliente -->
        <h4 style="margin-top:20px;">‚ù§Ô∏è Meus Favoritos</h4>
        <div id="favoriteProductsList" style="margin-bottom: 20px;">
          <!-- Produtos favoritos ser√£o injetados aqui -->
          <div class="small" style="color:var(--muted)">Nenhum favorito ainda. Fa√ßa mais pedidos!</div>
        </div>
        <!-- Fim Favoritos do Cliente -->
        
        <!-- Cupons Dispon√≠veis -->
        <h4 style="margin-top:20px;">üéÅ Seus Cupons Dispon√≠veis</h4>
        <div id="availableCouponsList" style="margin-bottom: 20px;">
          <!-- Cupons ser√£o injetados aqui -->
          <div class="small" style="color:var(--muted)">Nenhum cupom dispon√≠vel no momento.</div>
        </div>
        <!-- Fim Cupons Dispon√≠veis -->
        
        <h4>Meus Pedidos</h4>
        <div id="profileOrders"></div>
        
        <div style="text-align:right;margin-top:16px">
          <button id="closeProfile" class="btn">Fechar</button>
        </div>
      </div>
    </div>

    
    <div class="modal" id="pdvOrderModal">
      <div class="card" role="dialog" aria-modal="true" style="max-width:900px">
        <button id="closePdvOrderModal" class="pill" style="position:absolute; top:10px; right:10px; background:#eee; border:none; border-radius:8px; padding:8px 10px; cursor:pointer;">‚ùå</button>
<h3 id="pdvOrderTitle">Pedido ‚Äî Mesa</h3>
        <div style="display:flex;gap:12px;align-items:flex-start">
          <div style="flex:1; max-width:480px;">
            <h4>Itens do Card√°pio</h4>
            <div id="pdvItemsList" style="max-height:420px; overflow:auto;"></div>
          </div>
          <div style="width:360px;background:#fafafa;padding:12px;border-radius:8px;">
            <h4>Pedido da Mesa</h4>
            <div id="pdvCartList" style="max-height:360px; overflow:auto;"></div>
            <div style="margin-top:10px;display:flex;justify-content:space-between;align-items:center">
              <div>
                <div class="small">Subtotal</div>
                <div id="pdvSubtotal" style="font-weight:800">R$ 0,00</div>
              </div>
              <div>
                <button id="pdvFinalizeBtn" class="btn" style="background:#28a745">Enviar para Cozinha e Fechar Mesa</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    
    
    
<!-- Modal Cadastro Motoboy -->
<div class="modal" id="motoboyModal">
  <div class="card" role="dialog" aria-modal="true" style="max-width:420px">
    <h3>Cadastrar Motoboy</h3>
    <form id="motoboyForm">
      <div class="form-group">
        <label for="motoboyName">Nome</label>
        <input type="text" id="motoboyName" required>
      </div>
      <div class="form-group">
        <label for="motoboyPhone">N√∫mero de WhatsApp</label>
        <input type="tel" id="motoboyPhone" required placeholder="(11) 9XXXX-XXXX">
      </div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px;">
        <button type="button" class="pill" onclick="document.getElementById('motoboyModal').classList.remove('open')">Cancelar</button>
        <button type="submit" class="btn">Salvar Motoboy</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Perfil do Motoboy -->
<div class="modal" id="motoboyProfileModal">
  <div class="card" role="dialog" aria-modal="true" style="max-width:700px;max-height:85vh;overflow-y:auto;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
      <h3 id="motoboyProfileName" style="margin:0;">Perfil do Motoboy</h3>
      <button type="button" class="pill" onclick="closeMotoboyProfile()" style="font-size:20px;padding:4px 10px;">&times;</button>
    </div>
    
    <!-- Estat√≠sticas Principais -->
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin-bottom:20px;">
      <div class="dashboard-card">
        <div class="value" id="profileTotalEntregas">0</div>
        <div class="label">Entregas Totais</div>
      </div>
      <div class="dashboard-card">
        <div class="value" id="profileMediaEntrega">R$ 0,00</div>
        <div class="label">M√©dia por Entrega</div>
      </div>
      <div class="dashboard-card">
        <div class="value" id="profileTempoMedio">0 min</div>
        <div class="label">Tempo M√©dio</div>
      </div>
      <div class="dashboard-card">
        <div class="value" id="profileEntregasHoje">0</div>
        <div class="label">Entregues Hoje</div>
      </div>
    </div>

    <!-- Gr√°fico de Entregas por Per√≠odo -->
    <div style="background:#f9f9f9;padding:15px;border-radius:10px;margin-bottom:20px;">
      <h4 style="margin:0 0 15px 0;font-size:14px;color:var(--muted);">ENTREGAS POR PER√çODO (√öltimos 7 dias)</h4>
      <canvas id="motoboyDeliveriesChart" style="max-height:200px;"></canvas>
    </div>

    <!-- √Åreas de Entrega -->
    <div style="background:#f9f9f9;padding:15px;border-radius:10px;">
      <h4 style="margin:0 0 15px 0;font-size:14px;color:var(--muted);">√ÅREAS QUE MAIS ENTREGA</h4>
      <div id="profileTopAreas" style="display:flex;flex-direction:column;gap:8px;">
        <!-- √Åreas ser√£o injetadas aqui -->
      </div>
    </div>

    <div style="display:flex;justify-content:flex-end;margin-top:20px;">
      <button type="button" class="btn" onclick="closeMotoboyProfile()">Fechar</button>
    </div>
  </div>
</div>

<!-- Modal de Escolha Comanda -->
<div class="modal" id="comandaChoiceModal">
  <div class="card" role="dialog" aria-modal="true" style="max-width:400px; text-align:center;">
    <h3>Escolha o Tipo de Comanda</h3>
    <p style="color:var(--muted); margin-bottom: 20px;">Selecione o tipo de comanda avulsa que deseja abrir.</p>

    <div style="display:flex; flex-direction:column; gap:15px;">
      <button class="btn" id="btnComandaValor" style="background:var(--primary); padding: 15px;">
        üßæ Comanda-Valor (Valor Fixo)
      </button>
      <button class="btn" id="btnComandaPeso" style="background:#28a745; padding: 15px;">
        ‚öñÔ∏è Comanda-Peso (Peso x Valor/Kg)
      </button>
    </div>

    <button class="pill" style="margin-top:20px;" onclick="document.getElementById('comandaChoiceModal').classList.remove('open')">Cancelar</button>
  </div>
</div>

<!-- Modal Comanda Avulsa (Por Peso) -->
<div class="modal" id="comandaPesoModal">
  <div class="card" role="dialog" aria-modal="true" style="max-width:400px;">
    <h3>‚öñÔ∏è Comanda Avulsa por Peso</h3>
    <form id="comandaPesoForm">
      <div class="form-group">
        <label for="comandaPesoName">Nome do Cliente</label>
        <input type="text" id="comandaPesoName" required placeholder="Ex: Jo√£o da Silva">
      </div>

      <div class="form-group">
        <label for="comandaPesoWeight">Peso (kg)</label>
        <input type="number" id="comandaPesoWeight" step="0.001" min="0.001" required placeholder="Ex: 0.500">
      </div>

      <div class="form-group">
        <label for="comandaPesoValuePerKg">Valor por kg (R$)</label>
        <input type="number" id="comandaPesoValuePerKg" step="0.01" min="0.01" required placeholder="Ex: 59.90">
      </div>

      <div class="form-group">
        <label for="comandaPesoTotal">Total (R$)</label>
        <input type="text" id="comandaPesoTotal" readonly style="font-weight:bold; color:var(--primary);">
      </div>

      <div class="form-group">
        <label for="comandaPesoPayment">Forma de Pagamento</label>
        <select id="comandaPesoPayment" required>
          <option value="pix">PIX</option>
          <option value="credit">Cart√£o de Cr√©dito</option>
          <option value="debit">Cart√£o de D√©bito</option>
          <option value="cash">Dinheiro</option>
        </select>
      </div>

      <div class="form-group">
        <label for="comandaPesoCPF">CPF na Nota (opcional)</label>
        <input type="text" id="comandaPesoCPF" placeholder="000.000.000-00">
      </div>

      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:20px;">
        <button type="button" class="pill" id="comandaPesoCancel">Cancelar</button>
        <button type="submit" class="btn" style="background:#28a745;">Salvar Comanda por Peso</button>
      </div>
    </form>
  </div>
</div>

<div class="modal" id="comandaModal">
      <div class="card" role="dialog" aria-modal="true" style="max-width:520px; position:relative;">
        <h3 style="margin:0 0 10px;">Criar Comanda Avulsa</h3>
        <form id="comandaForm" style="display:flex;flex-direction:column;gap:10px;">
          <div class="form-group">
            <label for="comandaName">Nome do Cliente</label>
            <input type="text" id="comandaName" required placeholder="Ex: Jo√£o Silva">
          </div>
          <div class="form-group">
            <label for="comandaValue">Valor a ser cobrado (R$)</label>
            <input type="number" id="comandaValue" step="0.01" required placeholder="Ex: 25.00">
          </div>
          <div class="form-group">
            <label for="comandaPayment">Forma de Pagamento</label>
            <select id="comandaPayment" required>
              <option value="pix">Pix</option>
              <option value="credit">Cart√£o de Cr√©dito</option>
              <option value="debit">Cart√£o de D√©bito</option>
              <option value="cash">Dinheiro</option>
            </select>
          </div>
          <div class="form-group">
            <label for="comandaCPF">CPF na nota (opcional)</label>
            <input type="text" id="comandaCPF" placeholder="000.000.000-00">
          </div>
          <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:6px;">
            <button type="button" id="comandaCancel" class="pill">Cancelar</button>
            <button type="submit" id="comandaSave" class="btn">Salvar Comanda</button>
          </div>
        </form>
      </div>
    </div>
    
<div class="modal" id="checkoutModal">
      <div class="card" role="dialog" aria-modal="true" style="max-width:600px">
        <h3>Finalizar Pedido</h3>
        
        <form id="checkoutForm"> 
            <div id="checkoutContent">
              <h4>Seus Dados</h4>
              <div class="form-group">
                <label for="checkoutName">Nome Completo</label>
                <input type="text" id="checkoutName" placeholder="Seu nome" required>
              </div>
              <div class="form-group">
                <label for="checkoutAddress">Endere√ßo de Entrega</label>
                <input type="text" id="checkoutAddress" placeholder="Rua, n√∫mero, bairro, complemento" required>
    <div class="form-group" id="checkoutSavedAddressesGroup" style="display:none; margin-top: 10px;">
      <label for="checkoutSavedAddresses">Ou selecione um endere√ßo salvo:</label>
      <select id="checkoutSavedAddresses" class="form-control">
        <option value="" disabled selected>Selecione um endere√ßo salvo...</option>
      </select>
    </div>
              <div class="form-group">
                <label for="checkoutCPF">CPF na nota (opcional)</label>
                <input type="text" id="checkoutCPF" placeholder="000.000.000-00">
              </div>

              </div>
              <div class="form-group">
                <label for="checkoutPhone">Telefone</label>
                <input type="tel" id="checkoutPhone" placeholder="(XX) XXXXX-XXXX" required>
              </div>
              
              <div class="form-group">
                  <label for="deliveryAreaSelect">√Årea de Entrega (Para c√°lculo da taxa)</label>
                  <select id="deliveryAreaSelect" required>
                      <option value="" disabled selected>Selecione sua √°rea...</option>
                      </select>
              </div>
              <h4>Forma de Pagamento</h4>
              <div class="form-group">
                <label>Escolha uma op√ß√£o:</label>
                <div>
                  <input type="radio" id="paymentCredit" name="paymentMethod" value="credit" checked>
                  <label for="paymentCredit">Cart√£o de Cr√©dito</label>
                </div>
                <div>
                  <input type="radio" id="paymentDebit" name="paymentMethod" value="debit">
                  <label for="paymentDebit">Cart√£o de D√©bito</label>
                </div>
                <div>
                  <input type="radio" id="paymentCash" name="paymentMethod" value="cash">
                  <label for="paymentCash">Dinheiro</label>
                </div>
              </div>
              <div class="form-group" id="cashChangeGroup" style="display:none;">
                <label for="cashChange">Precisa de troco para quanto?</label>
                <input type="number" id="cashChange" placeholder="Ex: 50.00">
              </div>

              <h4>Resumo do Pedido</h4>
              <div id="checkoutCartSummary"></div>
              
              <div class="form-group" style="margin-top:12px;">
                <label for="checkoutCoupon">Cupom de Desconto</label>
                <div style="display:flex;gap:8px;">
                  <input type="text" id="checkoutCoupon" placeholder="Digite o c√≥digo do cupom" style="flex:1;text-transform:uppercase;">
                  <button type="button" id="applyCouponBtn" class="pill" style="background:#28a745;color:#fff;">Aplicar</button>
                </div>
                <div id="couponMessage" style="font-size:12px;margin-top:4px;"></div>
              </div>
              
              <div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:4px;border-top:1px solid #eee;padding-top:8px;margin-top:8px;">
                <span>Subtotal:</span>
                <span id="checkoutSubtotal">R$ 0,00</span>
              </div>
              <div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:4px;" id="checkoutDiscountRow" data-visible="false">
                <span>Desconto (<span id="checkoutCouponCode"></span>):</span>
                <span id="checkoutDiscount" style="color:#28a745;">- R$ 0,00</span>
              </div>
              <div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:8px;">
                <span>Taxa de Entrega (<span id="checkoutAreaName">N/A</span>):</span>
                <span id="checkoutDeliveryFee">R$ 0,00</span>
              </div>
              <div style="margin-top:10px;display:flex;justify-content:space-between;align-items:center">
                <div>
                  <div class="small">Total Geral</div>
                  <div id="checkoutTotal" style="font-weight:800; color:var(--primary);">R$ 0,00</div>
                </div>
              </div>

            </div>
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px">
              <button type="button" id="checkoutCancel" class="pill">Cancelar</button>
              <button type="submit" id="checkoutSubmit" class="btn" disabled>Confirmar Pedido</button>
            </div>
        </form>
        </div>
    </div>

    <div class="modal" id="confirmationModal">
      <div class="card" role="dialog" aria-modal="true" style="max-width:500px; text-align:center;">
        <h3 style="color:#28a745; margin-bottom: 0;">üéâ Pedido Confirmado!</h3>
        <h1 id="orderNumberDisplay" style="color:var(--primary); margin: 10px 0 20px; font-size: 32px;">#XXXXXXX</h1>

        <h4>Resumo do Pedido</h4>
        <div id="confirmationSummaryContent" style="text-align:left; border:1px solid #eee; padding: 12px; border-radius:8px;">
          </div>
        
        <p style="margin-top:20px; color:var(--muted); font-size:14px;">
            Acompanhe o status do pedido no Painel do Administrador (se for admin) ou no seu Perfil.
        </p>

        <div style="text-align:right;margin-top:16px">
          <button id="closeConfirmationModal" class="btn">Voltar ao Card√°pio</button>
        </div>
      </div>
    </div>

    <!-- ========================================================================= -->
    <!-- === MODAL DE LINHA DO TEMPO DO PEDIDO === -->
    <!-- ========================================================================= -->
    <div class="modal" id="orderTimelineModal">
      <div class="modal-content" style="max-width: 500px; max-height: 80vh; overflow-y: auto;">
        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
          <h2 id="timelineModalTitle" style="margin: 0;">üìú Hist√≥rico do Pedido</h2>
          <span class="close-button" onclick="closeOrderTimelineModal()" style="cursor: pointer; font-size: 24px; color: #999;">&times;</span>
        </div>
        <div class="modal-body">
          <p id="timelineOrderInfo" style="margin-bottom: 15px; font-weight: 600; color: var(--primary);"></p>
          <ul id="timelineList" style="list-style: none; padding: 0; margin: 0;">
            <!-- Timeline ser√° injetada aqui -->
          </ul>
        </div>
      </div>
    </div>

    <div class="modal" id="couponModal">
      <div class="card" role="dialog" aria-modal="true" style="max-width:500px">
        <h3 id="couponModalTitle">Criar Novo Cupom</h3>
        <form id="couponForm">
          <input type="hidden" id="couponIdEdit" />
          <div class="form-group">
            <label for="couponCode">C√≥digo do Cupom</label>
            <input type="text" id="couponCode" placeholder="Ex: DESCONTO10" required style="text-transform:uppercase;">
          </div>
          <div class="form-group">
            <label for="couponType">Tipo de Desconto</label>
            <select id="couponType" required>
              <option value="percent">Percentual (%)</option>
              <option value="fixed">Valor Fixo (R$)</option>
            </select>
          </div>
          <div class="form-group">
            <label for="couponValue">Valor</label>
            <input type="number" id="couponValue" step="0.01" min="0" placeholder="Ex: 10" required>
          </div>
          <div class="form-group">
            <label for="couponMinSubtotal">Valor M√≠nimo do Pedido (R$)</label>
            <input type="number" id="couponMinSubtotal" step="0.01" min="0" placeholder="Ex: 30.00" required>
          </div>
          <div class="form-group">
            <label for="couponExpiresAt">Data de Expira√ß√£o</label>
            <input type="date" id="couponExpiresAt" required>
          </div>
          <div class="form-group">
            <label for="couponMaxUses">Limite Total de Usos</label>
            <input type="number" id="couponMaxUses" min="1" placeholder="Ex: 100" required>
          </div>
          <div class="form-group">
            <label style="display:flex;align-items:center;gap:8px;">
              <input type="checkbox" id="couponActive">
              <span>Cupom Ativo</span>
            </label>
          </div>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px">
            <button type="button" id="couponCancel" class="pill">Cancelar</button>
            <button type="submit" class="btn" id="couponSubmit">Salvar Cupom</button>
          </div>
        </form>
      </div>
    </div>

    <div class="footer-fixed">
      <div class="footer-content-wrapper" style="justify-content: space-around;">
        <div class="user-badge only-mobile" id="userBadge">
          <span id="userIcon">üë§</span>
          <span id="userName">Entrar</span>
        </div>

        <span id="footerStatus">Fa√ßa login para fazer pedidos</span>
        <button class="btn" id="btnViewOrders">üßæ Pedidos</button>    <button class="btn" id="btnViewCart">Ver Carrinho (<span id="cartCount">0</span>)</button>
      </div>
    </div>

  </div>

<script type="module">

// === FUN√á√ÉO PARA LISTAR CLIENTES COM PEDIDOS (FIREBASE) ===

async function renderCustomers() {
  const container = document.getElementById("customersList");
  container.innerHTML = `<p style="color:#888;">Carregando clientes...</p>`;

  try {
    let orders = [];
    const snapshot = await getDocs(ordersCollectionRef);
    orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

    if (orders.length === 0) {
      container.innerHTML = `<p style="color:#777;">Nenhum cliente com pedidos encontrados.</p>`;
      return;
    }

    const clientsMap = {};
    for (const o of orders) {
      if (!o.userId || !o.userPhone) continue;
      const nome = (o.userName || "").toLowerCase();
      if (nome.includes("mesa") || nome.includes("comanda")) continue;

      if (!clientsMap[o.userId]) {
        clientsMap[o.userId] = {
          id: o.userId,
          name: o.userName || "Cliente sem nome",
          email: o.userEmail || "",
          phone: o.userPhone || "",
          address: o.address || "Endere√ßo n√£o informado",
          totalOrders: 1,
          totalSpent: o.total || 0,
          lastOrderDate: new Date(o.createdAt).getTime(),
          firstOrderDate: new Date(o.createdAt).getTime(), // Novo campo para o primeiro pedido
        };
      } else {
        clientsMap[o.userId].totalOrders++;
        clientsMap[o.userId].totalSpent += o.total || 0;
        const currentOrderDate = new Date(o.createdAt).getTime();
        if (currentOrderDate > clientsMap[o.userId].lastOrderDate) {
            clientsMap[o.userId].lastOrderDate = currentOrderDate;
        }
        if (currentOrderDate < clientsMap[o.userId].firstOrderDate) {
            clientsMap[o.userId].firstOrderDate = currentOrderDate;
        }
      }
    }

    // Adiciona o activityScore (ex: totalOrders * 1000 + (lastOrderDate / 100000000000))
	    // Isso prioriza pedidos e usa a data como desempate.
	    Object.values(clientsMap).forEach(client => {
	        const daysSinceLastOrder = (Date.now() - client.lastOrderDate) / (1000 * 60 * 60 * 24);
	        // Uma pontua√ß√£o simples: mais pedidos e menos dias desde o √∫ltimo pedido = mais ativo
	        client.activityScore = client.totalOrders / (daysSinceLastOrder + 1);
	        
	        // === C√°lculo do Indicador de Frequ√™ncia ===
	        const daysBetweenOrders = (client.lastOrderDate - client.firstOrderDate) / (1000 * 60 * 60 * 24);
	        client.frequency = daysBetweenOrders / client.totalOrders; // M√©dia de dias entre pedidos
	    });
	    
	    // === Detec√ß√£o de Poss√≠veis Duplicados (Simples) ===
	    const clientsArray = Object.values(clientsMap);
	    clientsArray.forEach(clientA => {
	        clientA.isPossibleDuplicate = false;
	        const phoneA = clientA.phone.replace(/\D/g, '');
	        const nameA = clientA.name.toLowerCase().trim();
	        
	        for (const clientB of clientsArray) {
	            if (clientA.id === clientB.id) continue;
	            
	            const phoneB = clientB.phone.replace(/\D/g, '');
	            const nameB = clientB.name.toLowerCase().trim();
	            
	            // Compara√ß√£o de telefone: se o telefone for o mesmo, mas o ID for diferente (o que n√£o deveria acontecer, mas pode indicar um erro de dados)
	            // Ou se o telefone for parecido (ex: um com 9 d√≠gitos e outro com 10, mas o final √© o mesmo)
	            const isPhoneMatch = phoneA === phoneB || (phoneA.length > 5 && phoneB.length > 5 && (phoneA.includes(phoneB) || phoneB.includes(phoneA)));
	            
	            // Compara√ß√£o de nome: se os nomes forem muito parecidos (ex: usando uma m√©trica simples de substring ou dist√¢ncia)
	            // Aqui, vamos usar uma compara√ß√£o simples de que um nome √© substring do outro (ex: "Jo√£o Silva" e "Jo√£o")
	            const isNameSimilar = nameA.includes(nameB) || nameB.includes(nameA);
	            
	            if (isPhoneMatch && isNameSimilar) {
	                clientA.isPossibleDuplicate = true;
	                break;
	            }
	        }
	    });

    // Vari√°vel global para armazenar a lista de clientes para filtragem/ordena√ß√£o
    window.allCustomers = Object.values(clientsMap);
    
    // Chama a fun√ß√£o de filtro e ordena√ß√£o inicial
    filterAndSortCustomers();
    
    return; // A renderiza√ß√£o ser√° feita por filterAndSortCustomers()
    
  } catch (err) {
    console.error("Erro ao carregar clientes:", err);
    container.innerHTML = `<p style="color:red;">Erro ao carregar clientes do Firebase.</p>`;
  }
}
window.renderCustomers = renderCustomers;

// =========================================================================
// === FUN√á√ïES DE FILTRO E ORDENA√á√ÉO DE CLIENTES (CRM) ===
// =========================================================================

// Vari√°vel global para armazenar a lista de clientes (populada em renderCustomers)
// window.allCustomers

// Fun√ß√£o auxiliar para gerar tags autom√°ticas (VIP, Fiel, Inativo)
// Fun√ß√£o auxiliar para formatar a frequ√™ncia de pedidos
function formatFrequency(frequencyDays) {
    if (frequencyDays === 0) return '1 pedido/dia (Novo)';
    if (frequencyDays <= 7) return `${(7 / frequencyDays).toFixed(1)} pedidos/semana`;
    if (frequencyDays <= 30) return `${(30 / frequencyDays).toFixed(1)} pedidos/m√™s`;
    if (frequencyDays > 30 && frequencyDays <= 90) return 'Cliente Recorrente';
    return 'Cliente Espor√°dico';
}

function generateCustomerTags(client) {
    const tags = [];
    const daysInactivity = 60;
    const msInDay = 1000 * 60 * 60 * 24;
    const daysSinceLastOrder = (Date.now() - client.lastOrderDate) / msInDay;

    // VIP ‚Üí total gasto > R$ 500
    if (client.totalSpent > 500) {
        tags.push({ name: 'VIP', color: '#ffc107' }); // Amarelo/Dourado
    }

    // Fiel ‚Üí mais de 20 pedidos
    if (client.totalOrders > 20) {
        tags.push({ name: 'Fiel', color: '#28a745' }); // Verde
    }

    // Inativo ‚Üí sem pedidos h√° mais de 60 dias
    if (daysSinceLastOrder > daysInactivity) {
        tags.push({ name: 'Inativo', color: '#dc3545' }); // Vermelho
    }
    
    return tags;
}

function filterAndSortCustomers() {
    const container = document.getElementById("customersList");
    if (!window.allCustomers) {
        container.innerHTML = `<p style="color:#888;">Nenhum dado de cliente carregado.</p>`;
        return;
    }

    let filteredCustomers = [...window.allCustomers];
    const searchTerm = document.getElementById("customerSearchInput").value.toLowerCase().trim();
    const sortKey = document.getElementById("customerSortSelect").value;

    // 1. Filtragem
    if (searchTerm) {
        filteredCustomers = filteredCustomers.filter(u => 
            u.name.toLowerCase().includes(searchTerm) || 
            u.phone.replace(/\D/g,'').includes(searchTerm.replace(/\D/g,''))
        );
    }

    // 2. Ordena√ß√£o
    filteredCustomers.sort((a, b) => {
        switch (sortKey) {
            case 'totalOrdersDesc':
                return b.totalOrders - a.totalOrders;
            case 'totalOrdersAsc':
                return a.totalOrders - b.totalOrders;
            case 'totalSpentDesc':
                return b.totalSpent - a.totalSpent;
            case 'totalSpentAsc':
                return a.totalSpent - b.totalSpent;
            case 'lastOrderDateDesc':
                return b.lastOrderDate - a.lastOrderDate; // Mais recente (maior timestamp)
            case 'lastOrderDateAsc':
                return a.lastOrderDate - b.lastOrderDate; // Mais antigo (menor timestamp)
            case 'activityScoreDesc':
                return b.activityScore - a.activityScore;
            default:
                return 0;
        }
    });

    // 3. Renderiza√ß√£o
    if (filteredCustomers.length === 0) {
        container.innerHTML = `<p style="color:#777;">Nenhum cliente encontrado com os crit√©rios de busca/filtro.</p>`;
        return;
    }

    const html = filteredCustomers.map(u => {
        const lastOrderDate = u.lastOrderDate ? new Date(u.lastOrderDate).toLocaleDateString('pt-BR') : 'N/A';
        const totalSpent = formatBRL(u.totalSpent);
        
        // =========================================================
        // [NOVO] CHAMADA DE INJE√á√ÉO PARA STATUS DE CUPOM INTELIGENTE NO ADMIN
        // =========================================================
        const clientOrders = (orders || []).filter(o => o.userId === u.id); // Busca pedidos
        const adminSmartCoupon = generateSmartCoupons(u, clientOrders);
        
        const smartCouponStatus = adminSmartCoupon 
            ? `<div style="font-size:12px; color:#dc3545; font-weight:bold;">üèÜ Cupom: ${adminSmartCoupon.code}</div>`
            : `<div style="font-size:12px; color:#28a745;">Cupom: Nenhum</div>`;
        // =========================================================
        
        // Gera√ß√£o das tags
	        // Gera√ß√£o das tags
	        const tags = generateCustomerTags(u);
	        
	        // Adiciona a tag de Duplicado, se aplic√°vel
	        if (u.isPossibleDuplicate) {
	            tags.push({ name: 'Poss√≠vel duplicado', color: '#ff4500' }); // Laranja/Vermelho para aviso
	        }
	        
	        const tagsHtml = tags.map(tag => `
            <span style="
                background-color: ${tag.color}; 
                color: white; 
                padding: 2px 8px; 
                border-radius: 10px; 
                font-size: 10px; 
                font-weight: bold; 
                margin-right: 5px;
            ">${tag.name}</span>
        `).join('');
        
	        return `
	            <div style="
	                background:#fff;
	                padding:14px 16px;
	                border-radius:12px;
	                margin-bottom:10px;
	                box-shadow:0 3px 10px rgba(0,0,0,0.05);
	                display:flex;
	                justify-content:space-between;
	                align-items:center;
	                flex-wrap:wrap;
	            ">
	                <div style="flex:1; min-width:200px;">
	                    <div style="font-weight:bold; font-size:16px;">${u.name}</div>
	                    <div style="font-size:12px; color:#666;">${u.phone}</div>
	                </div>
	                <div style="text-align:right; min-width:150px;">
	                    <div style="font-size:12px; color:#666;">Frequ√™ncia: 
	                        <span style="font-weight:bold; color: ${u.frequency <= 7 ? '#28a745' : u.frequency <= 30 ? '#ffc107' : '#dc3545'};">
	                            ${formatFrequency(u.frequency)}
	                        </span>
	                    </div>
	                    <div style="font-size:12px; color:#666;">√öltimo pedido: ${lastOrderDate}</div>
	                </div>
	                <div style="min-width:100px; text-align:right;">
	                    <div style="font-weight:bold;">${totalSpent}</div>
	                    <div style="font-size:12px; color:#666;">${u.totalOrders} pedidos</div>
	                </div>
<div style="margin-top:10px; width:100%;">
		                    ${tagsHtml}
		                    ${renderLoyaltyBadge(u)}
		                    ${smartCouponStatus}
	                    <button onclick="showOrderHistory('${u.id}', '${u.name}')" style="
                        background-color: var(--primary);
                        color: white;
                        border: none;
                        padding: 5px 10px;
                        border-radius: 5px;
                        cursor: pointer;
                        font-size: 12px;
                        margin-left: 10px;
                    ">Ver Hist√≥rico</button>
                    <button onclick="window.open('https://wa.me/55${u.phone ? u.phone.replace(/\\D/g, '') : ''}', '_blank')" style="
                        background-color: #25D366;
                        color: white;
                        border: none;
                        padding: 5px 10px;
                        border-radius: 5px;
                        cursor: pointer;
                        font-size: 12px;
                        margin-left: 5px;
                        display: inline-flex;
                        align-items: center;
                        gap: 5px;
                    " title="Entrar em contato via WhatsApp">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="white" xmlns="http://www.w3.org/2000/svg">
                            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                        </svg>
                        WhatsApp
                    </button>
	                </div>
		            </div>
        `;
	    }).join("");
	
	    container.innerHTML = html;
	}
	
	window.filterAndSortCustomers = filterAndSortCustomers;

// =========================================================================
// === FUN√á√ïES DO MODAL DE HIST√ìRICO DE PEDIDOS (CRM) ===
// =========================================================================

// Fun√ß√£o auxiliar para formatar o status do pedido
function formatOrderStatus(status) {
    const statusMap = {
        'pending': 'Pendente',
        'preparing': 'Em Prepara√ß√£o',
        'ready': 'Pronto para Entrega',
        'delivering': 'Em Entrega',
        'delivered': 'Entregue',
        'canceled': 'Cancelado'
    };
    const statusColor = {
        'pending': '#ffc107', // Amarelo
        'preparing': '#17a2b8', // Azul claro
        'ready': '#28a745', // Verde
        'delivering': '#007bff', // Azul
        'delivered': '#6c757d', // Cinza
        'canceled': '#dc3545' // Vermelho
    };
    const text = statusMap[status] || status;
    const color = statusColor[status] || '#000';
    return `<span style="color: ${color}; font-weight: 600;">${text}</span>`;
}

// Fun√ß√£o para abrir o modal e carregar o hist√≥rico
async function showOrderHistoryModal(userId, userName) {
    const modal = document.getElementById("orderHistoryModal");
    const listContainer = document.getElementById("historyOrdersList");
    const infoContainer = document.getElementById("historyClientInfo");
    
    infoContainer.textContent = `Cliente: ${userName} (ID: ${userId})`;
    listContainer.innerHTML = `<p style="color:#888;">Carregando pedidos de ${userName}...</p>`;
    modal.classList.add('open');

    try {
        // A vari√°vel 'orders' j√° deve estar populada pela fun√ß√£o renderCustomers
        // ou por uma fun√ß√£o de inicializa√ß√£o do sistema.
        // Se 'orders' n√£o estiver no escopo global, esta parte precisar√° ser ajustada
        // para buscar no Firestore, mas a regra √© "apenas ler os pedidos j√° existentes".
        // Assumindo que 'orders' √© uma vari√°vel global com todos os pedidos.
        const clientOrders = orders
            .filter(o => o.userId === userId)
            .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)); // Mais recentes primeiro

        if (clientOrders.length === 0) {
            listContainer.innerHTML = `<p style="color:#777;">Nenhum pedido encontrado para este cliente.</p>`;
            return;
        }

        const ordersHtml = clientOrders.map(order => {
            const orderDate = new Date(order.createdAt).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
            const orderTime = new Date(order.createdAt).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            const orderNumber = order.orderNumber || order.id.substring(0, 7).toUpperCase();
            const total = order.total || 0;
            const statusHtml = formatOrderStatus(order.status);
            const paymentMethod = order.paymentMethod || 'N√£o Informado';
            const address = order.address || 'Endere√ßo n√£o informado';

            return `
                <div style="
                    background:#f9f9f9;
                    padding:12px;
                    border-radius:8px;
                    margin-bottom:10px;
                    border-left: 4px solid var(--primary);
                ">
                    <div style="display:flex; justify-content:space-between; font-weight:bold; margin-bottom:5px;">
                        <span>Pedido #${orderNumber}</span>
                        <span>${formatBRL(total)}</span>
                    </div>
                    <small style="color:#555;">ID: ${order.id}</small><br>
                    <small style="color:#555;">Data: ${orderDate} √†s ${orderTime}</small><br>
                    <small style="color:#555;">Status: ${statusHtml}</small><br>
                    <small style="color:#555;">Pagamento: ${paymentMethod}</small><br>
                    <small style="color:#555;">Endere√ßo: ${address}</small>
                </div>
            `;
        }).join('');

        listContainer.innerHTML = ordersHtml;

    } catch (err) {
        console.error("Erro ao carregar hist√≥rico de pedidos:", err);
        listContainer.innerHTML = `<p style="color:red;">Erro ao carregar hist√≥rico. Verifique o console.</p>`;
    }
}

// Fun√ß√£o para fechar o modal
function closeOrderHistoryModal() {
    document.getElementById("orderHistoryModal").classList.remove('open');
}

// Fun√ß√£o wrapper para compatibilidade (corrige o erro de refer√™ncia)
function showOrderHistory(userId, userName) {
    showOrderHistoryModal(userId, userName);
}

window.showOrderHistory = showOrderHistory;
window.showOrderHistoryModal = showOrderHistoryModal;
window.closeOrderHistoryModal = closeOrderHistoryModal;

// =========================================================================
// === FUN√á√ïES DO MODAL DE LINHA DO TEMPO DO PEDIDO ===
// =========================================================================

/**
 * Abre o modal de timeline do pedido e exibe o hist√≥rico de status.
 * @param {string} orderId - ID do pedido
 */
function showOrderTimeline(orderId) {
    const order = orders.find(o => o.id === orderId);
    if (!order) {
        alert('Pedido n√£o encontrado.');
        return;
    }

    const modal = document.getElementById('orderTimelineModal');
    const infoContainer = document.getElementById('timelineOrderInfo');
    const listContainer = document.getElementById('timelineList');

    // Define informa√ß√µes do pedido
    const orderNumber = order.orderNumber || order.id.substring(0, 7).toUpperCase();
    infoContainer.textContent = `Pedido #${orderNumber} - ${order.userName || 'Cliente'}`;

    // Mapeamento de status para timeline
    const statusTimeline = [
        { key: 'pending', label: 'üì• Pedido Recebido', icon: 'üì•' },
        { key: 'in_production', label: 'üç≥ Entrou em Produ√ß√£o', icon: 'üç≥' },
        { key: 'ready_for_delivery', label: '‚úÖ Ficou Pronto', icon: '‚úÖ' },
        { key: 'out_for_delivery', label: 'üöö Saiu para Entrega', icon: 'üöö' },
        { key: 'delivered', label: '‚úîÔ∏è Entregue', icon: '‚úîÔ∏è' }
    ];

    // Normaliza o status atual do pedido
    const currentStatus = order.status || 'pending';
    
    // Mapeamento de status antigos para novos
    const statusMap = {
        'pending': 'pending',
        'accepted': 'in_production',
        'in_production': 'in_production',
        'ready': 'ready_for_delivery',
        'ready_for_delivery': 'ready_for_delivery',
        'delivering': 'out_for_delivery',
        'out_for_delivery': 'out_for_delivery',
        'delivered': 'delivered'
    };

    const normalizedStatus = statusMap[currentStatus] || currentStatus;

    // Encontra o √≠ndice do status atual na timeline
    const currentIndex = statusTimeline.findIndex(s => s.key === normalizedStatus);

    // Gera o HTML da timeline
    const timelineHtml = statusTimeline.map((step, index) => {
        let className = '';
        let timeInfo = '';

        if (index < currentIndex) {
            className = 'completed';
            timeInfo = '<div class="timeline-time">Conclu√≠do</div>';
        } else if (index === currentIndex) {
            className = 'current';
            const orderDate = new Date(order.createdAt);
            const formattedDate = orderDate.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
            const formattedTime = orderDate.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            timeInfo = `<div class="timeline-time">Atual - ${formattedDate} √†s ${formattedTime}</div>`;
        } else {
            timeInfo = '<div class="timeline-time">Pendente</div>';
        }

        return `
            <li class="${className}">
                <div class="timeline-title">${step.label}</div>
                ${timeInfo}
            </li>
        `;
    }).join('');

    listContainer.innerHTML = timelineHtml;
    modal.classList.add('open');
}

/**
 * Fecha o modal de timeline do pedido.
 */
function closeOrderTimelineModal() {
    document.getElementById('orderTimelineModal').classList.remove('open');
}

window.showOrderTimeline = showOrderTimeline;
window.closeOrderTimelineModal = closeOrderTimelineModal;



// =========================================================================
// === CONFIGURA√á√ÉO DO FIREBASE (CHAVES INSERIDAS PELO G√äMINI) ===
// =========================================================================
const firebaseConfig = {
    apiKey: "AIzaSyBYxYq65hf2zwBTKrwuFAg5AmS5iM88aLU", 
    authDomain: "luk123-b1986.firebaseapp.com", 
    projectId: "luk123-b1986", 
    storageBucket: "luk123-b1986.firebasestorage.app", 
    messagingSenderId: "55447377903", 
    appId: "1:55447377903:web:e9cbbcdba3a4ed5dc4081a"
};
// =========================================================================

// === INICIALIZA√á√ÉO DO FIREBASE E SDKs NECESS√ÅRIOS ===
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-app.js";
import { 
    getFirestore, collection, doc, getDoc, setDoc, updateDoc, 
    addDoc, query, orderBy, onSnapshot, deleteDoc, getDocs 
} from "https://www.gstatic.com/firebasejs/9.1.0/firebase-firestore.js";


const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
// Documento √∫nico para o card√°pio e configura√ß√µes da loja
const menuDocRef = doc(db, "config", "cardapioData"); 
// Cole√ß√£o para pedidos, permitindo queries e tempo real
const ordersCollectionRef = collection(db, "orders"); 
// Cole√ß√£o para usu√°rios (opcional, mantendo o local storage para a demo)
const usersCollectionRef = collection(db, "users");

// Vari√°veis globais
let DATA = null; 
let orders = [];
let motoboys = []; 
let users = []; 

const CART_KEY = "cardapio_cart_v1";
const ORDERS_KEY = "cardapio_orders_v1";

const ORDER_STATUSES = {
  pending: { label: 'Pendente', color: '#ffc107' },
  preparing: { label: 'Em Preparo', color: '#17a2b8' },
  ready: { label: 'Pronto para Entrega', color: '#28a745' },
  delivered: { label: 'Entregue', color: '#6c757d' },
  cancelled: { label: 'Cancelado', color: '#dc3545' }
};

const ADMIN_CREDENTIALS = {
  user: "admin",
  pass: "admin123"
};

let activeCat = null;
let cart = loadCart();
let modalState = null;
let pdvCartState = { tableId: null, items: [] }; // PDV temporary cart (admin use)

let itemState = null;
let addonManagerState = null;
let currentUser = null;
let isAdmin = false;
let salesChartInstance = null;
let lastPendingCount = 0; // Para notifica√ß√£o


const $ = sel => document.querySelector(sel);


// Fun√ß√µes de Storage (Mantidas para Carrinho e Login SIMPLIFICADO de Cliente)
function loadCart(){ try{ return JSON.parse(localStorage.getItem(CART_KEY)) || []; }catch(e){ return []; } }
function saveCart(){ localStorage.setItem(CART_KEY, JSON.stringify(cart)); }
function loadUsers(){ try{ return JSON.parse(localStorage.getItem("cardapio_users_v1")) || []; }catch(e){ return []; } }
function saveUsers(){ localStorage.setItem("cardapio_users_v1", JSON.stringify(users)); }

// =========================================================================
// === FUN√á√ïES DE PERSIST√äNCIA (FIREBASE) ===
// =========================================================================

/**
 * Carrega o card√°pio do Firestore (config/cardapioData).
 */
async function fetchMenuData() {
    try {
        // 1. Carrega o Card√°pio
        const menuSnap = await getDoc(menuDocRef);
        if (menuSnap.exists()) {
            DATA = menuSnap.data();
            
            // Garante que os novos campos de entrega por raio existam
            if (DATA.restaurant.useRadiusDelivery === undefined) {
                DATA.restaurant.useRadiusDelivery = false;
            }
            if (DATA.restaurant.deliveryBaseFee === undefined) {
                DATA.restaurant.deliveryBaseFee = 0;
            }
            if (DATA.restaurant.deliveryFeePerKm === undefined) {
                DATA.restaurant.deliveryFeePerKm = 0;
            }
            if (DATA.restaurant.restaurantLat === undefined) {
                DATA.restaurant.restaurantLat = 0;
            }
            if (DATA.restaurant.restaurantLng === undefined) {
                DATA.restaurant.restaurantLng = 0;
            }
            // NOVO: Garante que o campo de tempo de preparo exista
            if (DATA.restaurant.preparationTime === undefined) {
                DATA.restaurant.preparationTime = 30;
            }
            
            console.log("Card√°pio carregado do Firebase.");
        } else {
            console.warn("Nenhum dado de card√°pio encontrado no Firebase. Usando Demo e salvando.");
            DATA = loadDemoData();
            // Salva a demo no Firebase para come√ßar a persist√™ncia
            await setDoc(menuDocRef, DATA);
        }

        // Inicializa a primeira categoria ativa
        if (DATA.categories.length > 0) {
            activeCat = DATA.categories[0].id;
        }

        renderAll();
        // Come√ßa a monitorar pedidos em tempo real imediatamente (ou ap√≥s login)
        setupRealtimeOrdersListener(); 

        return true;
    } catch (e) {
        console.error("Erro ao carregar card√°pio do Firebase:", e);
        alert("Erro ao conectar com o banco de dados. Carregando dados de demonstra√ß√£o local.");
        DATA = loadDemoData();
        renderAll();
        return false;
    }
}


/**
 * Salva o card√°pio (DATA) de volta para o Firestore.
 */
async function saveMenuData() {
    if (!isAdmin) {
        alert("Acesso negado. Apenas administradores podem salvar.");
        return false;
    }
    try {
        await setDoc(menuDocRef, DATA);
        console.log("Dados do card√°pio salvos no Firebase com sucesso!");
        return true;
    } catch (e) {
        console.error("Erro ao salvar card√°pio no Firebase:", e);
        alert("Falha ao salvar. Verifique as regras de seguran√ßa do seu Firebase.");
        return false;
    }
}

/**
 * Mant√©m o array 'orders' atualizado em tempo real e notifica o admin.
 */
function setupRealtimeOrdersListener() {
    // Busca todos os pedidos, ordenados pelo mais recente
    const q = query(ordersCollectionRef, orderBy("createdAt", "desc"));

    // onSnapshot: mant√©m a conex√£o aberta para updates em tempo real
    onSnapshot(q, (snapshot) => {
        const newOrders = ((snapshot.docs || [])).map(doc => ({ id: doc.id, ...doc.data() }));
        
        // Verifica se h√° novos pedidos pendentes APENAS se for Admin
        if (isAdmin) {
            const currentPending = ((newOrders || [])).filter(o => o.status === "pending").length;
            if (currentPending > lastPendingCount) {
                // Novo pedido detectado
                const newPendingOrders = ((newOrders || [])).filter(o => o.status === "pending");
                const latestNewOrder = newPendingOrders[0]; // O primeiro √© o mais recente, pois a query √© decrescente

                // 1. Notifica√ß√£o Sonora
                const audio = new Audio('https://www.soundjay.com/misc/bell-ringing-05.mp3'); // Som de sino de mesa 
                audio.play().catch(e => console.error("Erro ao tocar √°udio:", e));
                // 2. Janela visual dentro da p√°gina
                const popup = document.createElement("div");
                popup.innerHTML = `
                  <div style="
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    background: #fff;
                    border-radius: 12px;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.25);
                    padding: 16px 20px;
                    z-index: 9999;
                    display: flex;
                    align-items: center;
                    gap: 12px;
                    font-family: Arial, sans-serif;
                    border-left: 6px solid #28a745;
                    animation: fadeIn 0.4s ease;
                  ">
                    <img src="https://cdn-icons-png.flaticon.com/512/2331/2331970.png" 
                         style="width:42px;height:42px;border-radius:50%;object-fit:cover;">
                    <div>
                      <div style="font-weight:700;font-size:15px;color:#222;">üõí Novo Pedido Recebido!</div>
                      <div style="font-size:13px;color:#555;">
                        Pedido #${latestNewOrder.id.substring(0,7)} ‚Äî Total ${formatBRL(latestNewOrder.total)}
                      </div>
                    </div>
                  </div>
                `;
                document.body.appendChild(popup);
                setTimeout(() => popup.remove(), 8000);


                // 2. Notifica√ß√£o Visual (API de Notifica√ß√£o do Navegador)
                if (Notification.permission === "granted") {
                    new Notification("Novo Pedido Recebido!", {
                        body: `Pedido #${latestNewOrder.id.substring(0, 7)} - Total: ${formatBRL(latestNewOrder.total)}`,
                        icon: 'https://i.imgur.com/2Jt9r0X.png'
                    });
                }
            }
            lastPendingCount = currentPending;
        }

        orders = newOrders;
        
        // Atualiza as visualiza√ß√µes se estiverem abertas
        if (document.querySelector("#adminModal").classList.contains('open')) {
            renderAdminOrders();
            renderAdminDashboard();
        }
        if (document.querySelector("#profileModal").classList.contains('open')) {
            renderProfileOrders();
        }
    }, (error) => {
        console.error("Erro no listener de pedidos:", error);
    });
}
// === MOTOBOYS FUNCTIONS (single clean block) ===

/**
 * Atualiza o status do motoboy no Firestore.
 * @param {string} motoboyId ID do motoboy.
 * @param {string} newStatus Novo status ("disponivel", "ocupado", "offline").
 */
async function updateMotoboyStatus(motoboyId, newStatus) {
  if (!isAdmin) return;
  try {
    const motoboyDocRef = doc(db, "motoboys", motoboyId);
    await updateDoc(motoboyDocRef, { status: newStatus });
    
    // Atualiza o array local para re-renderizar
    const motoboyIndex = motoboys.findIndex(m => m.id === motoboyId);
    if (motoboyIndex !== -1) {
        motoboys[motoboyIndex].status = newStatus;
    }
    renderMotoboys();
  } catch (e) {
    console.error("Erro ao atualizar status do motoboy:", e);
    alert("Falha ao atualizar status do motoboy.");
  }
}

window.updateMotoboyStatus = updateMotoboyStatus;
async function fetchMotoboys() {
  const motoboysCollectionRef = collection(db, "motoboys");
  try {
    const snap = await getDocs(motoboysCollectionRef);
    motoboys = snap.docs.map(d => ({ id: d.id, status: "offline", entregasHoje: 0, ...d.data() })); // Adiciona status e entregasHoje como padr√£o
    renderMotoboys();
  } catch (e) {
    console.error("Erro ao carregar motoboys:", e);
  }
}

window.fetchMotoboys = fetchMotoboys;

function renderMotoboys() {
  const statusMap = {
    "disponivel": { label: "Dispon√≠vel", color: "#28a745" }, // Verde
    "ocupado": { label: "Ocupado / Em Entrega", color: "#ffc107" }, // Amarelo
    "offline": { label: "Offline", color: "#dc3545" } // Vermelho
  };
  const container = document.getElementById("motoboysList");
  if(!container) return;
  if(!motoboys || motoboys.length === 0){
    container.innerHTML = '<div class="small" style="color:var(--muted);">Nenhum motoboy cadastrado.</div>';
    return;
  }
  container.innerHTML = motoboys.map(m => {
    const currentStatus = m.status || "offline";
    const statusInfo = statusMap[currentStatus] || statusMap["offline"];
    const deliveredCount = m.entregasHoje || 0;
    const phoneDigits = (m.phone || '').replace(/\D/g, '');
    return `
      <div class='menu-card' style='text-align:left;display:flex;flex-direction:column;'>
        <div class='menu-card-body' style='display:flex;flex-direction:column;justify-content:space-between;height:100%;'><div>
            <div>
              <div class='menu-card-title'>${m.name}</div>
              <div style='font-size:13px;color:var(--muted);margin-top:6px;'>üìû ${m.phone || '‚Äî'}</div>
              <div style="font-size:13px;margin-top:6px;font-weight:bold;color:${statusInfo.color};">
                <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${statusInfo.color};margin-right:5px;"></span>
                ${statusInfo.label}
              </div>
              <div style="font-size:13px;color:var(--muted);margin-top:6px;">üìû ${m.phone || "‚Äî"}</div>
              <div style="font-size:13px;color:var(--muted);margin-top:6px;">üßæ Entregues Hoje: <strong>${deliveredCount}</strong></div>
            </div>
            <div style='display:flex;flex-direction:column;gap:8px;margin-top:10px;'>
              <select onchange="updateMotoboyStatus('${m.id}', this.value)" style="padding: 8px; border-radius: 8px; border: 1px solid #ccc; background: #f9f9f9; font-size: 14px;">
                <option value="disponivel" ${currentStatus === "disponivel" ? "selected" : ""}>üü¢ Dispon√≠vel</option>
                <option value="ocupado" ${currentStatus === "ocupado" ? "selected" : ""}>üü° Ocupado / Em Entrega</option>
                <option value="offline" ${currentStatus === "offline" ? "selected" : ""}>üî¥ Offline</option>
              </select>
              <button onclick="openMotoboyProfile('${m.id}')" class="menu-card-btn" style="background:var(--primary);color:#fff;border:none;cursor:pointer;padding:8px 12px;border-radius:10px;font-weight:600;">üìà Ver Perfil</button>
              <a href="https://wa.me/${phoneDigits}" target="_blank" class="menu-card-btn" style="background:#25D366;color:#fff;text-decoration:none;text-align:center;padding:8px 12px;border-radius:10px;">üí¨ WhatsApp</a>
            </div>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

window.renderMotoboys = renderMotoboys;

// Abre modal de cadastro
document.getElementById('btnOpenMotoboyModal')?.addEventListener('click', () => {
  document.getElementById('motoboyModal').classList.add('open');
});

// Cadastro do motoboy
document.getElementById('motoboyForm')?.addEventListener('submit', async (e) => {
  e.preventDefault();
  const name = document.getElementById('motoboyName').value.trim();
  const phone = document.getElementById('motoboyPhone').value.trim();
  if(!name){ alert('Informe o nome do motoboy'); return; }
  try {
    await addDoc(motoboysCollectionRef, { name, phone, createdAt: Date.now(), status: "offline", entregasHoje: 0 });
    document.getElementById('motoboyForm').reset();
    document.getElementById('motoboyModal').classList.remove('open');
    await fetchMotoboys();
    alert('Motoboy cadastrado com sucesso!');
  } catch (err) {
    console.error('Erro ao salvar motoboy:', err);
    alert('Falha ao salvar motoboy.');
  }
});

// Atualiza o v√≠nculo motoboy <-> pedido
window._updateOrderMotoboy = async function(orderId, motoboyId){
  try {
    const orderDocRef = doc(db, "orders", orderId);
    let motoboyName = "";
    
    // 1. L√≥gica de Atribui√ß√£o/Desatribui√ß√£o
    if(!motoboyId){
      // Desatribuir
      await updateDoc(orderDocRef, { motoboyId: "", motoboyName: "" });
    } else {
      // Atribuir
      const m = motoboys.find(x => x.id === motoboyId);
      motoboyName = m ? m.name : "";
      
      // Atualiza o pedido com motoboyId e motoboyName
      await updateDoc(orderDocRef, { motoboyId: motoboyId, motoboyName: motoboyName });
      
      // 2. Atualiza o contador de entregas do motoboy (entregasHoje)
      const motoboyDocRef = doc(db, "motoboys", motoboyId);
      await updateDoc(motoboyDocRef, { 
        entregasHoje: increment(1) 
      });
      
      // 3. Atualiza o array local do motoboy para re-renderizar
      const motoboyIndex = motoboys.findIndex(x => x.id === motoboyId);
      if (motoboyIndex !== -1) {
          motoboys[motoboyIndex].entregasHoje = (motoboys[motoboyIndex].entregasHoje || 0) + 1;
      }
      renderMotoboys(); // Re-renderiza a lista de motoboys para mostrar o novo contador
    }
    
    // Atualiza√ß√£o local do array 'orders' para evitar re-render global
    const orderIndex = orders.findIndex(o => o.id === orderId);
    if (orderIndex !== -1) {
        orders[orderIndex].motoboyId = motoboyId;
        orders[orderIndex].motoboyName = motoboyName;
    }
    
    // loadOrders() removido para evitar re-render global e colapso dos cards
  } catch (e) {
    console.error('Erro ao vincular motoboy:', e);
    alert('Falha ao salvar o motoboy no pedido.');
  }
};

// Re-renderiza motoboys sempre que pedidos mudam (j√° que a contagem depende de orders[])
fetchMotoboys();
// === END MOTOBOYS ===

/**
 * Calcula e renderiza o dashboard de motoboys.
 */
function renderMotoboyDashboard() {
    // 1. Motoboys Dispon√≠veis
    const motoboysDisponiveis = (motoboys || []).filter(m => m.status === 'disponivel').length;

    // 2. Entregas em Andamento (Pedidos atribu√≠dos a motoboy, mas n√£o entregues)
    const entregasEmAndamento = (orders || []).filter(o => 
        o.motoboyId && o.motoboyId !== "" && o.status !== 'delivered' && o.status !== 'cancelled'
    ).length;

    // 3. Tempo M√©dio de Entrega Hoje
    const hoje = new Date().toLocaleDateString();
    let totalTempoEntrega = 0;
    let entregasHojeCount = 0;

    (orders || []).forEach(o => {
        if (o.status === 'delivered' && o.createdAt && o.deliveredAt) {
            const dataCriacao = new Date(o.createdAt);
            const dataEntrega = new Date(o.deliveredAt);
            
            // Verifica se a entrega foi hoje (compara√ß√£o simples de data)
            if (dataEntrega.toLocaleDateString() === hoje) {
                const tempoEntregaMs = dataEntrega.getTime() - dataCriacao.getTime();
                totalTempoEntrega += tempoEntregaMs;
                entregasHojeCount++;
            }
        }
    });

    let tempoMedioMinutos = 0;
    if (entregasHojeCount > 0) {
        tempoMedioMinutos = Math.round((totalTempoEntrega / entregasHojeCount) / 60000); // Converte ms para minutos
    }
    
    const tempoMedioFormatado = tempoMedioMinutos > 0 ? `${tempoMedioMinutos} min` : 'N/A';

    // === NOVAS M√âTRICAS ADICIONADAS ===
    
    // 4. Entregas por Hora (√∫ltimas 24h)
    const agora = Date.now();
    const ultimas24h = agora - (24 * 60 * 60 * 1000);
    const entregasUltimas24h = (orders || []).filter(o => 
        o.status === 'delivered' && o.deliveredAt && o.deliveredAt >= ultimas24h
    ).length;
    const entregasPorHora = entregasUltimas24h > 0 ? (entregasUltimas24h / 24).toFixed(1) : '0';

    // 5. Ticket M√©dio por Motoboy (considerando entregas com motoboy atribu√≠do)
    let totalValorEntregas = 0;
    let totalEntregasComMotoboy = 0;
    (orders || []).forEach(o => {
        if (o.motoboyId && o.motoboyId !== "" && o.status === 'delivered') {
            totalValorEntregas += (o.total || 0);
            totalEntregasComMotoboy++;
        }
    });
    const ticketMedio = totalEntregasComMotoboy > 0 ? (totalValorEntregas / totalEntregasComMotoboy) : 0;
    const ticketMedioFormatado = ticketMedio > 0 ? formatBRL(ticketMedio) : 'R$ 0,00';

    // 6. Atraso M√©dio (diferen√ßa entre tempo estimado e tempo real)
    // Assumindo tempo estimado padr√£o de 45 minutos
    const tempoEstimadoMinutos = 45;
    let totalAtraso = 0;
    let entregasComAtraso = 0;
    (orders || []).forEach(o => {
        if (o.status === 'delivered' && o.createdAt && o.deliveredAt) {
            const dataCriacao = new Date(o.createdAt);
            const dataEntrega = new Date(o.deliveredAt);
            const tempoRealMinutos = (dataEntrega.getTime() - dataCriacao.getTime()) / 60000;
            const atraso = tempoRealMinutos - tempoEstimadoMinutos;
            if (atraso > 0) {
                totalAtraso += atraso;
                entregasComAtraso++;
            }
        }
    });
    const atrasoMedio = entregasComAtraso > 0 ? Math.round(totalAtraso / entregasComAtraso) : 0;
    const atrasoMedioFormatado = atrasoMedio > 0 ? `+${atrasoMedio} min` : '0 min';

    // 7. % de Entregas no Prazo
    let entregasNoPrazo = 0;
    let totalEntregasAvaliadas = 0;
    (orders || []).forEach(o => {
        if (o.status === 'delivered' && o.createdAt && o.deliveredAt) {
            const dataCriacao = new Date(o.createdAt);
            const dataEntrega = new Date(o.deliveredAt);
            const tempoRealMinutos = (dataEntrega.getTime() - dataCriacao.getTime()) / 60000;
            totalEntregasAvaliadas++;
            if (tempoRealMinutos <= tempoEstimadoMinutos) {
                entregasNoPrazo++;
            }
        }
    });
    const percentualNoPrazo = totalEntregasAvaliadas > 0 ? Math.round((entregasNoPrazo / totalEntregasAvaliadas) * 100) : 0;

    // Renderiza no HTML
    const container = document.getElementById("motoboyDashboard");
    if (!container) return;

    container.innerHTML = `
        <div class="dashboard-card">
            <div class="value">${motoboysDisponiveis}</div>
            <div class="label">Motoboys Dispon√≠veis</div>
        </div>
        <div class="dashboard-card">
            <div class="value">${entregasEmAndamento}</div>
            <div class="label">Entregas em Andamento</div>
        </div>
        <div class="dashboard-card">
            <div class="value">${tempoMedioFormatado}</div>
            <div class="label">Tempo M√©dio de Entrega Hoje</div>
        </div>
        <div class="dashboard-card">
            <div class="value">${entregasPorHora}</div>
            <div class="label">Entregas por Hora (24h)</div>
        </div>
        <div class="dashboard-card">
            <div class="value">${ticketMedioFormatado}</div>
            <div class="label">Ticket M√©dio por Motoboy</div>
        </div>
        <div class="dashboard-card">
            <div class="value">${atrasoMedioFormatado}</div>
            <div class="label">Atraso M√©dio</div>
        </div>
        <div class="dashboard-card">
            <div class="value">${percentualNoPrazo}%</div>
            <div class="label">Entregas no Prazo</div>
        </div>
    `;
}

window.renderMotoboyDashboard = renderMotoboyDashboard;

// === FUN√á√ïES DO MODAL DE PERFIL DO MOTOBOY ===

let motoboyChartInstance = null; // Inst√¢ncia do gr√°fico para evitar duplica√ß√£o

/**
 * Abre o modal de perfil do motoboy com todas as estat√≠sticas
 * @param {string} motoboyId - ID do motoboy
 */
window.openMotoboyProfile = function(motoboyId) {
  const motoboy = motoboys.find(m => m.id === motoboyId);
  if (!motoboy) {
    alert('Motoboy n√£o encontrado.');
    return;
  }

  // Filtra pedidos deste motoboy
  const motoboyOrders = (orders || []).filter(o => o.motoboyId === motoboyId);
  const deliveredOrders = motoboyOrders.filter(o => o.status === 'delivered');

  // 1. Entregas Totais
  const totalEntregas = deliveredOrders.length;

  // 2. M√©dia por Entrega
  let totalValor = 0;
  deliveredOrders.forEach(o => {
    totalValor += (o.total || 0);
  });
  const mediaEntrega = totalEntregas > 0 ? (totalValor / totalEntregas) : 0;

  // 3. Tempo M√©dio
  let totalTempo = 0;
  let countTempo = 0;
  deliveredOrders.forEach(o => {
    if (o.createdAt && o.deliveredAt) {
      const tempo = (o.deliveredAt - o.createdAt) / 60000; // minutos
      totalTempo += tempo;
      countTempo++;
    }
  });
  const tempoMedio = countTempo > 0 ? Math.round(totalTempo / countTempo) : 0;

  // 4. Entregues Hoje
  const hoje = new Date().toLocaleDateString();
  const entregasHoje = deliveredOrders.filter(o => {
    if (o.deliveredAt) {
      const dataEntrega = new Date(o.deliveredAt);
      return dataEntrega.toLocaleDateString() === hoje;
    }
    return false;
  }).length;

  // 5. √Åreas que mais entrega
  const areaStats = {};
  deliveredOrders.forEach(o => {
    const area = o.neighborhood || o.address || 'N√£o informado';
    if (!areaStats[area]) {
      areaStats[area] = 0;
    }
    areaStats[area]++;
  });
  const topAreas = Object.entries(areaStats)
    .sort(([, a], [, b]) => b - a)
    .slice(0, 5);

  // 6. Entregas por dia (√∫ltimos 7 dias)
  const ultimos7Dias = [];
  const entregasPorDia = [];
  for (let i = 6; i >= 0; i--) {
    const data = new Date();
    data.setDate(data.getDate() - i);
    const dataStr = data.toLocaleDateString();
    ultimos7Dias.push(data.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }));
    
    const count = deliveredOrders.filter(o => {
      if (o.deliveredAt) {
        const dataEntrega = new Date(o.deliveredAt);
        return dataEntrega.toLocaleDateString() === dataStr;
      }
      return false;
    }).length;
    entregasPorDia.push(count);
  }

  // Atualiza o modal
  document.getElementById('motoboyProfileName').textContent = `Perfil: ${motoboy.name}`;
  document.getElementById('profileTotalEntregas').textContent = totalEntregas;
  document.getElementById('profileMediaEntrega').textContent = formatBRL(mediaEntrega);
  document.getElementById('profileTempoMedio').textContent = `${tempoMedio} min`;
  document.getElementById('profileEntregasHoje').textContent = entregasHoje;

  // Renderiza √°reas
  const areasContainer = document.getElementById('profileTopAreas');
  if (topAreas.length === 0) {
    areasContainer.innerHTML = '<div style="color:var(--muted);font-size:13px;">Nenhuma entrega registrada ainda.</div>';
  } else {
    areasContainer.innerHTML = topAreas.map(([area, count]) => {
      const percentual = totalEntregas > 0 ? Math.round((count / totalEntregas) * 100) : 0;
      return `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:8px;background:#fff;border-radius:8px;">
          <div style="flex:1;">
            <div style="font-weight:600;font-size:14px;">${area}</div>
            <div style="font-size:12px;color:var(--muted);">${count} entregas</div>
          </div>
          <div style="font-weight:700;color:var(--primary);font-size:16px;">${percentual}%</div>
        </div>
      `;
    }).join('');
  }

  // Renderiza gr√°fico
  const ctx = document.getElementById('motoboyDeliveriesChart');
  if (ctx) {
    // Destr√≥i inst√¢ncia anterior se existir
    if (motoboyChartInstance) {
      motoboyChartInstance.destroy();
    }
    
    motoboyChartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ultimos7Dias,
        datasets: [{
          label: 'Entregas',
          data: entregasPorDia,
          backgroundColor: 'rgba(128, 0, 128, 0.6)',
          borderColor: 'rgba(128, 0, 128, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              stepSize: 1
            }
          }
        },
        plugins: {
          legend: {
            display: false
          }
        }
      }
    });
  }

  // Abre o modal
  document.getElementById('motoboyProfileModal').classList.add('open');
};

/**
 * Fecha o modal de perfil do motoboy
 */
window.closeMotoboyProfile = function() {
  document.getElementById('motoboyProfileModal').classList.remove('open');
  // Destr√≥i o gr√°fico ao fechar
  if (motoboyChartInstance) {
    motoboyChartInstance.destroy();
    motoboyChartInstance = null;
  }
};

// === FIM DAS FUN√á√ïES DO MODAL DE PERFIL ===

/**
 * Atualiza o status de um pedido no Firestore.
 * AGORA EXPOSTA GLOBALMENTE para uso no onchange do HTML
 */
async function updateOrderStatus(orderId, newStatus) {
  if (!isAdmin) return;
  
  try {
    const orderDocRef = doc(db, "orders", orderId);
    await updateDoc(orderDocRef, { status: newStatus });
    
    // L√≥gica para remover do localStorage 'pendingOrders' se o status mudar
    if (newStatus !== 'pending') {
        let pendingOrders = JSON.parse(localStorage.getItem('pendingOrders')) || [];
        pendingOrders = pendingOrders.filter(id => id !== orderId);
        localStorage.setItem('pendingOrders', JSON.stringify(pendingOrders));
    }
    
    // O onSnapshot se encarregar√° de re-renderizar a lista automaticamente
  } catch (e) {
      console.error("Erro ao atualizar status no Firebase:", e);
      alert("Falha ao atualizar o status do pedido.");
  }
}

// =========================================================================
// === FUN√á√ïES DE AUTENTICA√á√ÉO E ADMIN (SIMPLIFICADAS E ADAPTADAS) ===
// =========================================================================

function doLogin(){
    const user = document.querySelector("#loginUser").value.trim();
    const pass = document.querySelector("#loginPass").value;
    
    if(!user || !pass){ alert("Preencha todos os campos"); return; }
    
    // Simula√ß√£o de Login de Admin
    if(user === ADMIN_CREDENTIALS.user && pass === ADMIN_CREDENTIALS.pass){ 
        currentUser = { id: "admin", name: "Administrador", email: "admin@sistema.com", isAdmin: true, savedAddresses: [] };
        isAdmin = true;
        closeAuthModal();
        updateUserBadge();
        toggleAdminUI();
        renderCategories();
        renderItems();
        // setupRealtimeOrdersListener j√° est√° ativo e come√ßa a notificar
        alert("Bem-vindo, Admin! Painel em Tempo Real (via Firebase) ativado. üéâ");
        return;
    }

    // SIMULA√á√ÉO DE LOGIN DE CLIENTE (usa array local 'users')
    const foundUser = users.find(u => (u.email === user || u.email === user) && u.password === pass);
    if(foundUser){
        currentUser = { id: foundUser.id, name: foundUser.name, email: foundUser.email, phone: foundUser.phone, isAdmin: false, savedAddresses: foundUser.savedAddresses || [] };
        isAdmin = false;
        closeAuthModal();
        updateUserBadge();
        toggleAdminUI();
        renderCategories();
        renderItems();
        alert(`Bem-vindo de volta, ${foundUser.name.split(" ")[0]}! (Conta Simples) üòä`);
        return;
    }
    
    alert("Credenciais inv√°lidas. Para Admin use: admin/admin123");
}

function doRegister(){
    const name = document.querySelector("#regName").value.trim();
    const email = document.querySelector("#regEmail").value.trim();
    const phone = document.querySelector("#regPhone").value.trim();
    const pass = document.querySelector("#regPass").value;
    
    if(!name || !email || !pass){ alert("Preencha nome, email e senha"); return; }
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if(!emailRegex.test(email)){ alert("Email inv√°lido"); return; }
    if(pass.length < 4){ alert("Senha deve ter pelo menos 4 caracteres"); return; }
    if(users.find(u => u.email === email)){ alert("Email j√° cadastrado"); return; }
    
    const newUser = { id: Date.now().toString(), name, email, phone, password: pass, createdAt: new Date().toISOString(), savedAddresses: [] };
    
    users.push(newUser);
    saveUsers(); // Salva no localStorage (para a demo)
    
    currentUser = { id: newUser.id, name: newUser.name, email: newUser.email, phone: newUser.phone, isAdmin: false, savedAddresses: [] };
    closeAuthModal();
    updateUserBadge();
    alert(`Cadastro realizado! Bem-vindo, ${name.split(" ")[0]}! üéâ`);
}


// =========================================================================
// === FUN√á√ÉO DE PEDIDO (AGORA PERSISTENTE FIREBASE) ===
// =========================================================================


async function finalizeOrder(e) {
  e.preventDefault();
  
  if (!currentUser) {
      alert("Voc√™ precisa estar logado para fazer o pedido.");
      return;
  }
  
  // Vari√°veis para armazenar informa√ß√µes de entrega
  let deliveryFee = 0;
  let deliveryAreaName = "";
  let deliveryAreaId = "";
  let deliveryDistanceKm = null;
  
  // Verifica se o modo autom√°tico por raio est√° ativado
  if (DATA.restaurant.useRadiusDelivery && window.autoDeliveryFee) {
    // Usa valores calculados automaticamente
    deliveryFee = window.autoDeliveryFee;
    deliveryAreaName = window.autoDeliveryDistanceKm.toFixed(1) + " km";
    deliveryAreaId = "radius_auto";
    deliveryDistanceKm = window.autoDeliveryDistanceKm;
  } else {
    // Usa o sistema tradicional de √°reas de entrega
    const selectedOption = document.querySelector("#deliveryAreaSelect").options[document.querySelector("#deliveryAreaSelect").selectedIndex];
    if (!selectedOption || selectedOption.value === "") {
        alert("Por favor, selecione sua √Årea de Entrega para calcular a taxa.");
        return;
    }
    deliveryFee = parseFloat(selectedOption.dataset.fee);
    deliveryAreaName = selectedOption.textContent.split('(')[0].trim();
    deliveryAreaId = selectedOption.value;
  }
  const subtotal = cart.reduce((sum, item) => sum + item.totalPrice, 0);
  
  let discount = 0;
  let couponCode = null;
  
  if (appliedCoupon) {
    if (appliedCoupon.type === 'percent') {
      discount = subtotal * (appliedCoupon.value / 100);
    } else {
      discount = appliedCoupon.value;
    }
    
    if (discount > subtotal) {
      discount = subtotal;
    }
    
    couponCode = appliedCoupon.code;
  }
  
  const total = subtotal - discount + deliveryFee;
  
  const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
  let changeNeeded = 0;

  if (paymentMethod === 'cash') {
    changeNeeded = parseFloat(document.querySelector("#cashChange").value) || 0;
    if (changeNeeded > 0 && changeNeeded < total) {
      alert("O valor do troco deve ser maior ou igual ao total do pedido.");
      return;
    }
  }

  // NOVO: Calcula ETA de preparo baseado na configura√ß√£o
  const preparationTime = DATA.restaurant.preparationTime || 30;
  const estimatedReadyTime = new Date(Date.now() + preparationTime * 60 * 1000);
  
  const newOrder = {
    userId: currentUser.id,
    userName: document.querySelector("#checkoutName").value.trim(),
    userPhone: document.querySelector("#checkoutPhone").value.trim(),
    address: document.querySelector("#checkoutAddress").value.trim(),
    deliveryAreaId: deliveryAreaId,
    deliveryAreaName: deliveryAreaName,
    deliveryFee: deliveryFee,
    deliveryDistanceKm: deliveryDistanceKm || null,
    preparationTime: preparationTime,
    estimatedReadyTime: estimatedReadyTime.toISOString(),
    items: ((cart || [])).map(item => ({
        itemId: item.itemId,
        name: item.name,
        qty: item.qty,
        totalPrice: item.totalPrice,
        addons: item.addons.flatMap(group => {
            const originalItem = getItem(item.itemId);
            if (!originalItem || !originalItem.addonGroups) return [];

            const originalGroup = originalItem.addonGroups.find(g => g.id === group.groupId);
            if (!originalGroup) return [];

            return group.selected
                .filter(a => a.qty > 0)
                .map(a => {
                    const addonDef = originalGroup.addons.find(x => x.id === a.addonId);
                    return {
                        groupName: originalGroup.name,
                        name: addonDef ? addonDef.name : 'Adicional',
                        qty: a.qty,
                        price: addonDef ? addonDef.price : 0
                    };
                });
        })
    })),
    subtotal: subtotal,
    discount: discount,
    couponCode: couponCode,
    total: total,
    paymentMethod: paymentMethod,
    changeNeeded: changeNeeded,
    status: 'pending',
    createdAt: new Date().toISOString()
  };
  
  try {
      const docRef = await addDoc(ordersCollectionRef, newOrder);
      
      // Incrementa o contador de uso do cupom
      if (appliedCoupon) {
        // Verifica se √© cupom inteligente
        if (appliedCoupon.isSmart) {
          // Registra uso do cupom inteligente
          const discountValue = appliedCoupon.type === 'percentage' 
            ? newOrder.subtotal * appliedCoupon.value 
            : appliedCoupon.value;
          logSmartCouponUsage(
            currentUser.id, 
            currentUser.name || currentUser.email, 
            appliedCoupon, 
            discountValue
          );
        } else {
          // Cupom manual
          const coupon = DATA.restaurant.coupons.find(c => c.id === appliedCoupon.id);
          if (coupon) {
            coupon.usedCount = (coupon.usedCount || 0) + 1;
            await saveMenuData();
          }
        }
      }
      
      cart = [];
      saveCart();
      appliedCoupon = null; // Limpa o cupom aplicado
      closeCheckoutModal();
      renderCart();
      showConfirmationModal({ ...newOrder, id: docRef.id });
  } catch (e) {
      console.error("Falha ao salvar pedido no Firebase:", e);
      alert("Falha ao finalizar pedido. Verifique sua conex√£o ou as regras do Firebase.");
  }
}


// =========================================================================
// === FUN√á√ïES DE DEMONSTRA√á√ÉO E MANUTEN√á√ÉO (Adaptadas para Firebase) ===
// =========================================================================
function loadDemoData(){
    return {
        restaurant:{
            name:"Creamy Purple (FIREBASE TEST)",
            tables: [],
            address:"Rua Fict√≠cia, 61",
            status:"Aberto at√© as 23:00",
            logo:blankSVG(),
            deliveryAreas: [
                { id: 'area1', name: 'Centro da Cidade', fee: 5.00 },
                { id: 'area2', name: 'Regi√£o Oeste', fee: 8.00 }
            ],
            coupons: [],
            useRadiusDelivery: false,
            deliveryBaseFee: 0,
            deliveryFeePerKm: 0,
            restaurantLat: 0,
            restaurantLng: 0
        },
        categories:[
            {id:"lanc", title:"LAN√áAMENTOS"},
            {id:"trad", title:"Lanches Tradicionais"}
        ],
        items:[
            { 
                id:"cmb1", 
                category:"lanc", 
                name:"Combo Real-Time", 
                desc:"Este item est√° salvo no Firebase!", 
                price:57.00, 
                img:blankSVG(), 
                addonGroups:[
                    { 
                        id: 'g1', 
                        name: 'Escolha o P√£o', 
                        max: 1, 
                        free: 0, 
                        required: true, 
                        addons: [
                            { id: 'a1', name: 'P√£o Brioche', price: 0.00 },
                            { id: 'a2', name: 'P√£o Australiano', price: 2.50 }
                        ]
                    },
                    { 
                        id: 'g2', 
                        name: 'Adicionar Molho', 
                        max: 3, 
                        free: 1, 
                        required: false, 
                        addons: [
                            { id: 'a3', name: 'Maionese da Casa', price: 1.00 },
                            { id: 'a4', name: 'Molho Barbecue', price: 1.00 },
                            { id: 'a5', name: 'Molho Picante', price: 1.50 }
                        ]
                    }
                ] 
            },
            { 
                id:"xcal", 
                category:"trad", 
                name:"X-Salada Firestore", 
                desc:"Este card√°pio √© persistente.", 
                price:24.00, 
                img:blankSVG(), 
                addonGroups:[] 
            }
        ]
    };
}

// Altera a fun√ß√£o resetDemo para salvar a demo no Firebase
async function resetDemo(){
    if(confirm("Restaurar demo? Perder√° altera√ß√µes salvas no Firebase e reescrever√° o card√°pio no banco.")){
        DATA = loadDemoData();
        cart=[];
        saveCart();
        await saveMenuData(); // Salva a demo no Firebase
        renderAll();
    }
}



function notifyNewOrder() {
    if (Notification.permission === "granted") {
        new Notification("üõçÔ∏è Novo Pedido Recebido!", { 
            body: "Um novo pedido pendente chegou ao painel.",
            icon: "https://cdn-icons-png.flaticon.com/512/2331/2331970.png"
        });
    }
}

// =========================================================================
// === FUN√á√ïES AUXILIARES (L√ìGICA INALTERADA) ===
// =========================================================================
function blankSVG(){
    return "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(`<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'400\' height=\'400\'><rect fill=\'#fff\' width=\'100%\' height=\'100%\'/><text x=\'50%\' y=\'50%\' dominant-baseline=\'middle\' text-anchor=\'middle\' font-size=\'28\' fill=\'#ff3b3b\' font-family=\'Arial\'>Logo</text></svg>`);
}

function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file);
    });
}

function renderAll(){
    document.querySelector("#name").textContent = DATA.restaurant.name;
    document.querySelector("#addr").textContent = DATA.restaurant.address + " ‚Ä¢ " + DATA.restaurant.status;
    document.querySelector("#logo").src = DATA.restaurant.logo || blankSVG();
    renderCategories();
    renderItems();
    renderCart();
    updateUserBadge();
    renderPDVTables();
    toggleAdminUI();
}

function updateUserBadge(){
    if(currentUser){
        // userBadge agora est√° apenas no footer e √© sempre o mesmo elemento
        document.querySelector("#userIcon").textContent = currentUser.isAdmin ? "‚öôÔ∏è" : "üë§";
        document.querySelector("#userName").textContent = currentUser.name.split(" ")[0];
        document.querySelector("#footerStatus").textContent = currentUser.isAdmin ? "Modo Administrador ativo" : `Logado como ${currentUser.name.split(" ")[0]}`;
    } else {
        document.querySelector("#userIcon").textContent = "üë§";
        document.querySelector("#userName").textContent = "Entrar";
        document.querySelector("#footerStatus").textContent = "Fa√ßa login para fazer pedidos";
    }
}

function toggleAdminUI() {
    const adminControls = document.querySelector("#adminControls");
    const adminBar = document.querySelector("#adminBar");
    if (isAdmin) {
        adminControls.classList.remove("hidden");
        document.querySelector("#btnReset").classList.remove("hidden"); // Mostrar o bot√£o reset que salva no Firebase
    } else {
        adminControls.classList.add("hidden");
        document.querySelector("#btnReset").classList.add("hidden");
    }
}

function openAuthModal(){
    document.querySelector("#authModal").classList.add("open");
    showLoginForm();
}

function closeAuthModal(){
    document.querySelector("#authModal").classList.remove("open");
    clearAuthForms();
}

function showLoginForm(){
    document.querySelector("#tabLogin").classList.add("active");
    document.querySelector("#tabRegister").classList.remove("active");
    document.querySelector("#loginForm").classList.remove("hidden");
    document.querySelector("#registerForm").classList.add("hidden");
}

function showRegisterForm(){
    document.querySelector("#tabRegister").classList.add("active");
    document.querySelector("#tabLogin").classList.remove("active");
    document.querySelector("#registerForm").classList.remove("hidden");
    document.querySelector("#loginForm").classList.add("hidden");
}

function clearAuthForms(){
    document.querySelector("#loginUser").value = "";
    document.querySelector("#loginPass").value = "";
    document.querySelector("#regName").value = "";
    document.querySelector("#regEmail").value = "";
    document.querySelector("#regPhone").value = "";
    document.querySelector("#regPass").value = "";
}

function openProfileModal(){
    if(!currentUser || currentUser.isAdmin){ 
        // Admin usa o Painel Admin
        openAdminModal('settings');
        return;
    }
    document.querySelector("#profileName").textContent = currentUser.name;
    document.querySelector("#profileEmail").textContent = currentUser.email;
    document.querySelector("#profilePhone").textContent = currentUser.phone;
    renderProfileAddresses();
    renderProfileOrders();
    document.querySelector("#profileModal").classList.add("open");
}

function closeProfileModal(){
    document.querySelector("#profileModal").classList.remove("open");
}

function renderProfileAddresses() {
  const list = document.querySelector("#savedUserAddressesList");
  list.innerHTML = '';
  if (!currentUser || !currentUser.savedAddresses || currentUser.savedAddresses.length === 0) {
    list.innerHTML = '<div class="small" style="color:var(--muted)">Nenhum endere√ßo salvo.</div>';
    return;
  }
  
  ((currentUser.savedAddresses || [])).forEach((address, index) => {
    const div = document.createElement('div');
    div.classList.add('delivery-area-row');
    div.style.padding = '6px';
    div.innerHTML = `
      <div style="flex:1;">${address}</div>
      <button type="button" class="pill" style="background:#dc3545; color:white; padding:4px 8px;" onclick="removeUserAddress(${index})">Remover</button>
    `;
    list.appendChild(div);
  });
}

function removeUserAddress(index) {
  if (currentUser && currentUser.savedAddresses) {
    currentUser.savedAddresses.splice(index, 1);
    const userToUpdate = users.find(u => u.id === currentUser.id);
    if (userToUpdate) {
        userToUpdate.savedAddresses = currentUser.savedAddresses;
        saveUsers();
        renderProfileAddresses();
        alert("Endere√ßo removido.");
    }
  }
}

/**
 * Retorna o status do cliente baseado na quantidade de pedidos.
 * @param {number} orderCount - N√∫mero total de pedidos do cliente.
 * @returns {{text: string, color: string}}
 */
/**
 * Calcula as m√©tricas de consumo e favoritos do cliente.
 * @param {Array} userOrders - Lista de pedidos do cliente.
 * @returns {Object} - M√©tricas calculadas.
 */
function calculateClientMetrics(userOrders) {
    const metrics = {
        totalSpent: 0,
        totalOrders: userOrders.length,
        averageTicket: 0,
        mostOrderedProduct: 'N/A',
        preferredPaymentMethod: 'N/A',
        favoriteProducts: []
    };

    if (userOrders.length === 0) {
        return metrics;
    }

    let totalSum = 0;
    const productCounts = {};
    const paymentCounts = {};
    let totalDeliveryTime = 0;
    let deliveredOrdersCount = 0;

    userOrders.forEach(order => {
        // 1. Total Gasto
        totalSum += order.total || 0;

        // 2. Contagem de Produtos e Forma de Pagamento
        (order.items || []).forEach(item => {
            const itemName = item.name;
            productCounts[itemName] = (productCounts[itemName] || 0) + (item.qty || 1);
        });

        const paymentMethod = order.paymentMethod || 'N√£o Informado';
        paymentCounts[paymentMethod] = (paymentCounts[paymentMethod] || 0) + 1;
        
        // 3. C√°lculo do Tempo M√©dio de Entrega (Apenas para pedidos 'delivered')
        if (order.status === 'delivered' && order.createdAt && order.deliveredAt) {
            const timeCreated = new Date(order.createdAt).getTime();
            const timeDelivered = new Date(order.deliveredAt).getTime();
            const deliveryDurationMinutes = (timeDelivered - timeCreated) / (1000 * 60); // Diferen√ßa em minutos
            
            if (deliveryDurationMinutes > 0) {
                totalDeliveryTime += deliveryDurationMinutes;
                deliveredOrdersCount++;
            }
        }
    });

    metrics.totalSpent = totalSum;
    
    // 4. Tempo M√©dio de Entrega
    metrics.averageDeliveryTime = deliveredOrdersCount > 0 
        ? Math.round(totalDeliveryTime / deliveredOrdersCount) 
        : null;
    
    // 3. Ticket M√©dio
    metrics.averageTicket = totalSum / userOrders.length;

    // 4. Produto Mais Pedido
    let maxProductCount = 0;
    let mostOrderedProduct = 'N/A';
    for (const product in productCounts) {
        if (productCounts[product] > maxProductCount) {
            maxProductCount = productCounts[product];
            mostOrderedProduct = product;
        }
    }
    metrics.mostOrderedProduct = mostOrderedProduct;

    // 5. Forma de Pagamento Preferida
    let maxPaymentCount = 0;
    let preferredPaymentMethod = 'N/A';
    for (const method in paymentCounts) {
        if (paymentCounts[method] > maxPaymentCount) {
            maxPaymentCount = paymentCounts[method];
            preferredPaymentMethod = method;
        }
    }
    metrics.preferredPaymentMethod = preferredPaymentMethod;

    // 6. Produtos Favoritos (Top 5)
    metrics.favoriteProducts = Object.entries(productCounts)
        .sort(([, countA], [, countB]) => countB - countA)
        .slice(0, 5)
        .map(([name, count]) => ({ name, count }));

    return metrics;
}

function getClientStatus(orderCount) {
    if (orderCount === 0) {
        return { text: '‚≠ê Novo Cliente', color: '#007bff' }; // Azul
    } else if (orderCount >= 1 && orderCount <= 5) {
        return { text: '‚≠ê‚≠ê Cliente Recorrente', color: '#ffc107' }; // Amarelo
    } else {
        return { text: '‚≠ê‚≠ê‚≠ê Cliente VIP', color: '#dc3545' }; // Vermelho (VIP)
    }
}

function renderProfileOrders() {
  const list = document.querySelector("#profileOrders");
  list.innerHTML = '';
  
  const userOrders = ((orders || [])).filter(o => o.userId === currentUser.id);
  
  // 1. Calcula as m√©tricas e atualiza o Card de Status do Cliente
    const metrics = calculateClientMetrics(userOrders); // [Linha Existente]
    
    // =========================================================
    // [NOVO] CHAMADA DE INJE√á√ÉO PARA PAINEL DE FIDELIDADE
    // =========================================================
    renderClientLoyaltyPanel(metrics); 
    // =========================================================
    
    // =========================================================
    // [NOVO] CHAMADA DE INJE√á√ÉO PARA CUPOM INTELIGENTE
    // √â essencial garantir que 'currentUser' e 'userOrders' estejam dispon√≠veis.
    // =========================================================
    const smartCoupon = generateSmartCoupons(currentUser, userOrders);
    renderSmartCouponOffer(smartCoupon);
    // =========================================================
    
    const status = getClientStatus(metrics.totalOrders);
  const statusElement = document.querySelector("#clientStatusText");
  if (statusElement) {
      statusElement.textContent = status.text;
      statusElement.style.color = status.color;
  }
  
  // 2. Preenche o Painel Meu Consumo
  document.querySelector("#totalSpent").textContent = formatBRL(metrics.totalSpent);
  document.querySelector("#averageTicket").textContent = formatBRL(metrics.averageTicket);
  document.querySelector("#totalOrders").textContent = metrics.totalOrders;
  document.querySelector("#mostOrderedProduct").textContent = metrics.mostOrderedProduct;
  document.querySelector("#preferredPaymentMethod").textContent = metrics.preferredPaymentMethod;
  
  // 3. Preenche o Badge de Tempo M√©dio de Entrega
  const deliveryTimeCard = document.querySelector("#averageDeliveryTimeCard");
  const deliveryTimeText = document.querySelector("#averageDeliveryTimeText");
  if (metrics.averageDeliveryTime !== null) {
      deliveryTimeText.textContent = `${metrics.averageDeliveryTime} min`;
      deliveryTimeCard.style.display = 'block';
  } else {
      deliveryTimeCard.style.display = 'none';
  }
  
  // 4. Preenche Meus Favoritos
  const favoritesList = document.querySelector("#favoriteProductsList");
  if (metrics.favoriteProducts.length > 0) {
      favoritesList.innerHTML = metrics.favoriteProducts.map(fav => `
          <div style="display:flex; justify-content:space-between; padding: 6px 0; border-bottom: 1px dashed #eee;">
              <span style="font-weight: 600;">${fav.name}</span>
              <span class="pill" style="background: var(--primary); color: white; padding: 2px 8px;">${fav.count} pedidos</span>
          </div>
      `).join('');
  } else {
      favoritesList.innerHTML = '<div class="small" style="color:var(--muted)">Nenhum favorito ainda. Fa√ßa mais pedidos!</div>';
  }
  
  // 5. Preenche Cupons Dispon√≠veis
  const couponsList = document.querySelector("#availableCouponsList");
  const allCoupons = DATA.restaurant.coupons || [];
  const validCoupons = allCoupons.filter(coupon => {
      // Verifica se o cupom est√° ativo
      if (!coupon.active) return false;
      
      // Verifica a data de expira√ß√£o
      const today = new Date().toISOString().split('T')[0];
      if (coupon.expiresAt < today) return false;
      
      // Verifica o limite de uso
      if (coupon.usedCount >= coupon.maxUses) return false;
      
      return true;
  });
  
  if (validCoupons.length > 0) {
      couponsList.innerHTML = validCoupons.map(coupon => {
          const typeLabel = coupon.type === 'percent' ? '%' : 'R$';
          return `
              <div style="
                  border: 1px solid #ffc107; 
                  border-radius: 8px; 
                  padding: 10px; 
                  margin-bottom: 8px; 
                  background: #fffbe6;
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
              ">
                  <div>
                      <strong style="color: #ffc107; font-size: 16px;">${coupon.code}</strong>
                      <div class="small" style="color:var(--muted); margin-top: 4px;">
                          Desconto de ${coupon.value}${typeLabel} | M√≠nimo: ${formatBRL(coupon.minSubtotal)}
                      </div>
                  </div>
                  <span class="pill" style="background: #ffc107; color: #333; font-weight: 700;">
                      V√°lido
                  </span>
              </div>
          `;
      }).join('');
  } else {
      couponsList.innerHTML = '<div class="small" style="color:var(--muted)">Nenhum cupom dispon√≠vel no momento.</div>';
  }

  if (userOrders.length === 0) {
    list.innerHTML = '<div class="small" style="color:var(--muted)">Nenhum pedido realizado.</div>';
    return;
  }
  
  ((userOrders || [])).forEach(order => {
    const statusInfo = ORDER_STATUSES[order.status] || ORDER_STATUSES.pending;
    
    const div = document.createElement('div');
    div.style.cssText = 'border: 1px solid #eee; border-radius: 8px; padding: 12px; margin-bottom: 10px;';
    div.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <strong style="font-size:16px;">Pedido #${order.id.substring(0, 7)}</strong>
            <span style="font-weight:600; color:${statusInfo.color};">${statusInfo.label}</span>
        </div>
        <div class="small" style="color:var(--muted); margin: 4px 0;">Total: ${formatBRL(order.total)} ‚Ä¢ Em: ${new Date(order.createdAt).toLocaleDateString()}</div>
        <div style="font-size:12px; margin-top: 8px;">
            <button onclick="showOrderTimeline('${order.id}')" style="
                background-color: var(--primary);
                color: white;
                border: none;
                padding: 5px 10px;
                border-radius: 5px;
                cursor: pointer;
                font-size: 12px;
                margin-top: 5px;
            ">üìú Ver hist√≥rico detalhado</button>
        </div>
    `;
    list.appendChild(div);
  });
}

function getItem(id){
    return DATA.items.find(i => i.id === id);
}

function getCategory(id){
    return DATA.categories.find(c => c.id === id);
}

function editCategory(id) {
    const cat = DATA.categories.find(c => c.id === id);
    if (!cat) return;
    const newTitle = prompt(`Novo nome para \"${cat.title}\":`, cat.title);
    if (newTitle && newTitle !== cat.title) {
        cat.title = newTitle;
        saveMenuData();
        renderCategories();
    }
}

async function removeCategory(id) {
    if (confirm("Ao remover a categoria, todos os itens associados a ela ser√£o perdidos. Tem certeza?")) {
        DATA.categories = ((DATA.categories || [])).filter(c => c.id !== id);
        DATA.items = ((DATA.items || [])).filter(i => i.category !== id);
        activeCat = DATA.categories.length > 0 ? DATA.categories[0].id : null;
        await saveMenuData();
        renderCategories();
        renderItems();
    }
}

function renderCategories(){
    const catsEl = document.querySelector("#cats");
    catsEl.innerHTML = '';
    
    ((DATA.categories || [])).forEach(cat => {
        const btn = document.createElement('button');
        btn.textContent = cat.title;
        btn.dataset.id = cat.id;
        if(cat.id === activeCat) btn.classList.add('active');
        btn.addEventListener("click", () => { activeCat = cat.id; renderCategories(); renderItems(); });

        if (isAdmin) {
          // Se for admin, envolve o bot√£o da categoria e os bot√µes de edi√ß√£o/exclus√£o em um container flex√≠vel
          const container = document.createElement("div");
          container.style.display = 'flex'; container.style.alignItems = 'center'; container.style.gap = '4px'; 
          // O bot√£o da categoria precisa ser estilizado como p√≠lula e ter margem zero
          btn.style.margin = '0'; 
          container.appendChild(btn);
          
          // Bot√£o de Edi√ß√£o
          const editBtn = document.createElement("button");
          editBtn.textContent = '‚úèÔ∏è'; editBtn.classList.add('pill'); 
          editBtn.style.cssText = 'padding: 6px 8px; font-size: 14px; margin: 0;';
          editBtn.addEventListener('click', (e) => { e.stopPropagation(); editCategory(cat.id); }); 
          container.appendChild(editBtn);
          
          // Bot√£o de Exclus√£o
          const removeBtn = document.createElement("button");
          removeBtn.textContent = '‚ùå'; removeBtn.classList.add('pill'); 
          removeBtn.style.cssText = 'padding: 6px 8px; font-size: 14px; margin: 0;';
          removeBtn.addEventListener('click', (e) => { e.stopPropagation(); removeCategory(cat.id); }); 
          container.appendChild(removeBtn);
          
          // Adiciona o container (que tem a categoria e os bot√µes de admin)
          catsEl.appendChild(container);
        } else {
          // Se n√£o for admin, apenas adiciona o bot√£o da categoria (que j√° est√° estilizado como p√≠lula pelo CSS)
          catsEl.appendChild(btn);
        }
    });
    
    if (isAdmin) {
        // Bot√£o para adicionar nova categoria (Admin) - Implementa√ß√£o simplificada
        const btnAdd = document.createElement('button');
        btnAdd.textContent = '+ Adicionar Categoria';
        btnAdd.style.cssText = 'background:#e6ffe6; color:#28a745; font-weight:700; border: 1px dashed #28a745; margin-top: 10px;';
        btnAdd.addEventListener('click', () => {
            const title = prompt("Qual o nome da nova categoria?");
            if(title){
                const newCat = { id: title.toLowerCase().replace(/\s/g, '_'), title };
                if(DATA.categories.find(c => c.id === newCat.id)){ 
                    alert("Uma categoria com nome similar j√° existe. Tente outro nome."); 
                    return;
                } 
                DATA.categories.push(newCat);
                saveMenuData();
                activeCat = newCat.id;
                renderCategories();
                renderItems();
            }
        });
        catsEl.appendChild(btnAdd);
    }
}


function renderItems(){
    const itemsEl = document.querySelector("#items");
    itemsEl.innerHTML = '';
    
      const allItems = ((DATA.items || [])).filter(i => i.category === activeCat);
    const items = isAdmin ? allItems : allItems.filter(i => !i.isPaused);
    
    // === ADMIN: layout antigo ===
    if (isAdmin) {
      const btnNew = document.createElement('button');
      btnNew.classList.add('btn');
      btnNew.style.cssText = 'background:#28a745; margin-bottom: 12px;';
      btnNew.textContent = '+ Adicionar Novo Item';
      btnNew.addEventListener('click', () => openItemDetailsModal());
      itemsEl.appendChild(btnNew);

      if(items.length === 0){
          itemsEl.innerHTML += '<div class="small" style="color:var(--muted); text-align:center;">Nenhum item nesta categoria.</div>';
          return;
      }

      ((items || [])).forEach(item => {
          const itemEl = document.createElement('div');
          itemEl.classList.add('item');
          itemEl.innerHTML = `
              <img src="${item.img || blankSVG()}" alt="${item.name}">
              <div class="info" style="flex:1;">
                  <h3>
                      <span>${item.name}</span>
                      <span style="color:var(--primary); font-weight:800">${formatBRL(item.price)}</span>
                  </h3>
                  <p>${item.desc}</p>
                  <div class="actions">
                      <div style="display:flex;gap:8px;">
                          <button class="pill" data-id="${item.id}" data-action="manage-addons">Adicionais</button>
                          <button class="pill" data-id="${item.id}" data-action="edit-image">Imagem</button>
                          <button class="pill" data-id="${item.id}" data-action="edit-item">Editar</button>
                        <button class=\"pill\" data-id=\"${item.id}\" data-action=\"delete-item\" style=\"background:#dc3545; color:white;\">Deletar</button>\n<button class=\"pill\" data-id=\"${item.id}\" data-action=\"toggle-pause\" style=\"background:${item.isPaused ? '#28a745' : '#ffc107'}; color:white;\">${item.isPaused ? 'Reativar' : 'Pausar'}</button>
                      <button class=\"btn\" data-id=\"${item.id}\" data-action=\"add-to-cart\">${item.addonGroups.length > 0 ? 'Ver Op√ß√µes' : 'Adicionar'}</button>
                  </div>
              </div>
          `;
          itemsEl.appendChild(itemEl);
      });

      itemsEl.querySelectorAll('[data-action]').forEach(btn => {
          btn.addEventListener('click', (e) => handleItemAction(e.target.dataset.action, e.target.dataset.id));
      });
      return;
    }

    // === CLIENTE: layout tipo iFood ===
    if (items.length === 0) {
        itemsEl.innerHTML = '<div class="small" style="color:var(--muted); text-align:center;">Nenhum item nesta categoria.</div>';
        return;
    }

    const grid = document.createElement('div');
    grid.classList.add('menu-grid');
    items.forEach(item => {
        const card = document.createElement('div');
        card.classList.add('menu-card');
        card.innerHTML = `
            <img src="${item.img || blankSVG()}" alt="${item.name}" class="menu-card-img">
            <div class="menu-card-body">
                <h3 class="menu-card-title">${item.name}</h3>
                <p class="menu-card-price">${formatBRL(item.price)}</p>
                <button class="btn menu-card-btn" data-id="${item.id}" data-action="add-to-cart">Comprar</button>
            </div>
        `;
        grid.appendChild(card);
    });
    itemsEl.appendChild(grid);

    itemsEl.querySelectorAll('[data-action=\"add-to-cart\"]').forEach(btn => {
        btn.addEventListener('click', (e) => handleItemAction('add-to-cart', e.target.dataset.id));
    });
}

function handleItemAction(action, itemId){
    const item = getItem(itemId);
    if (!item) return;
    
    switch(action){
        case 'add-to-cart':
            if (item.addonGroups.length > 0) {
                openModal(item);
            } else {
                addItemToCart(item, 1, []);
            }
            break;
        case 'edit-item':
            openItemDetailsModal(item);
            break;
        case 'edit-image':
            openImageEditModal(item);
            break;
        case 'manage-addons':
            openAddonManagementModal(item);
            break;
        case 'toggle-pause':
                const itemToToggle = getItem(itemId);
                if (itemToToggle) {
                    itemToToggle.isPaused = !itemToToggle.isPaused;
                    saveMenuData();
                    renderItems();
                }
                break;
            case 'delete-item':
            if(confirm(`Tem certeza que deseja deletar o item "${item.name}"?`)){
                DATA.items = ((DATA.items || [])).filter(i => i.id !== itemId);
                saveMenuData();
                renderItems();
            }
            break;
    }
}


function addItemToCart(item, qty, addons){
    // Se estiver no modo PDV, adiciona ao carrinho PDV
    if(isPdvMode && pdvCartState && pdvCartState.tableId){
        const cartItem = {
            itemId: item.id,
            name: item.name,
            price: item.price,
            qty: qty,
            addons: addons,
            totalPrice: 0
        };
        let totalAddons = 0;
        ((addons || [])).forEach(group => { ((group.selected || [])).forEach(addon => { const originalGroup = item.addonGroups.find(g => g.id === group.groupId); const originalAddon = originalGroup ? originalGroup.addons.find(a => a.id === addon.addonId) : null; totalAddons += (originalAddon ? originalAddon.price : 0) * addon.qty; }); });
        cartItem.totalPrice = (item.price + totalAddons) * qty;
        pdvCartState.items.push(cartItem);
        renderPDVCart();
        closeModal();
        return;
    }

    const cartItem = {
        itemId: item.id,
        name: item.name,
        price: item.price,
        qty: qty,
        addons: addons,
        totalPrice: 0 // Ser√° calculado abaixo
    };
    
    let totalAddons = 0;
    
    ((addons || [])).forEach(group => {
        ((group.selected || [])).forEach(addon => {
            const originalGroup = item.addonGroups.find(g => g.id === group.groupId);
            const originalAddon = originalGroup ? originalGroup.addons.find(a => a.id === addon.addonId) : null;
            totalAddons += (originalAddon ? originalAddon.price : 0) * addon.qty;
        });
    });
    
    cartItem.totalPrice = (item.price + totalAddons) * qty;
    
    cart.push(cartItem);
    saveCart();
    renderCart();
    closeModal();
    
    // Se estiver em mobile (<1024px), mostra o carrinho
    if(window.innerWidth <= 1024){
        document.querySelector("#cartPanel").style.display = 'block'; 
        // Em um app real, aqui o JS faria a transi√ß√£o do carrinho
    }
}

function renderCart(){
    const list = document.querySelector("#cartList");
    list.innerHTML = '';
    
    let subtotal = 0;
    
    if(cart.length === 0){
        list.innerHTML = '<div class="small" style="color:var(--muted); text-align:center;">Seu carrinho est√° vazio.</div>';
        document.querySelector("#btnCheckout").setAttribute('disabled', 'true');
        document.querySelector("#btnViewCart").classList.remove('active');
        document.querySelector("#btnViewCart").textContent = `Ver Carrinho (0)`;
    } else {
        document.querySelector("#btnCheckout").removeAttribute('disabled');
        document.querySelector("#btnViewCart").classList.add('active');
    }
    
    ((cart || [])).forEach((item, index) => {
        subtotal += item.totalPrice;
        
        const itemEl = document.createElement('div');
        itemEl.style.cssText = 'border-bottom: 1px solid #eee; padding: 8px 0;';
        
        const mainLine = document.createElement('div');
        mainLine.style.cssText = 'display:flex; justify-content:space-between; align-items:center;';
        mainLine.innerHTML = `
            <div>
                <strong style="font-size:14px;">${item.name}</strong> 
                <span class="small" style="color:var(--muted)">(${formatBRL(item.totalPrice / item.qty)} cada)</span>
            </div>
            <div style="font-weight:700;">${formatBRL(item.totalPrice)}</div>
        `;
        itemEl.appendChild(mainLine);
        
        // Quantidade e A√ß√µes
        const qtyActions = document.createElement('div');
        qtyActions.style.cssText = 'display:flex; justify-content:space-between; align-items:center; margin-top:4px;';
        qtyActions.innerHTML = `
            <div class="small" style="color:var(--muted);">Qtd: ${item.qty}</div>
            <button class="pill" data-index="${index}" data-action="remove-item" style="padding: 4px 8px; background:#fbe6e6; color:#dc3545;">Remover</button>
        `;
        itemEl.appendChild(qtyActions);
        
        // Adicionais
        if(item.addons && item.addons.length > 0){
            ((item.addons || [])).forEach(group => {
                ((group.selected || [])).forEach(addon => {
                    // Obt√©m os dados originais do item para o nome
                    const originalItem = getItem(item.itemId);
                    const originalGroup = originalItem.addonGroups.find(g => g.id === group.groupId);
                    const originalAddon = originalGroup ? originalGroup.addons.find(a => a.id === addon.addonId) : null;
                    
                    if (originalAddon && addon.qty > 0) {
                        const addonLine = document.createElement('div');
                        addonLine.classList.add('small');
                        addonLine.style.cssText = 'color:var(--muted); margin-left: 10px; border-top: 1px dotted #f5f5f5; padding-top: 2px;';
                        addonLine.textContent = `+ ${addon.qty}x ${originalAddon.name} ${originalAddon.price > 0 ? '(' + formatBRL(originalAddon.price) + ')' : ''}`;
                        itemEl.appendChild(addonLine);
                    }
                });
            });
        }
        
        list.appendChild(itemEl);
    });
    
    document.querySelector("#subtotal").textContent = formatBRL(subtotal);
    document.querySelector("#btnViewCart").textContent = `Ver Carrinho (${cart.length})`;

    // =========================================================
    // [NOVO] C√ÅLCULO DE DESCONTO DE FIDELIDADE
    // =========================================================
    // Assumindo que o total de pedidos do usu√°rio logado (currentUser) √© conhecido ou buscado
    const userTotalOrders = currentUser ? (currentUser.totalOrders || 0) : 0; 
    const loyaltyDiscount = calculateLoyaltyDiscount(subtotal, userTotalOrders);
    
    const discountRow = document.getElementById("loyaltyDiscountRow");
    const discountValueSpan = document.getElementById("loyaltyDiscountValue");

    let totalDiscount = 0;
    if (loyaltyDiscount.discountApplied) {
        totalDiscount = loyaltyDiscount.discountValue;
        discountValueSpan.textContent = `- ${formatBRL(totalDiscount)}`;
        discountRow.style.display = 'flex';
    } else {
        discountRow.style.display = 'none';
    }
    // =========================================================

    // CALCULAR O TOTAL FINAL COM O NOVO DESCONTO
    const deliveryFee = parseFloat(document.getElementById("deliveryFee").textContent.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
    const finalTotal = subtotal + deliveryFee - totalDiscount;

    // Atualiza os valores na tela
    document.getElementById("total").textContent = formatBRL(finalTotal);

    list.querySelectorAll('[data-action="remove-item"]').forEach(btn => {
        btn.addEventListener('click', (e) => removeItemFromCart(e.target.dataset.index));
    });
}

function removeItemFromCart(index){
    cart.splice(index, 1);
    saveCart();
    renderCart();
    
    // Se o carrinho estiver vazio em mobile, esconde o painel do carrinho
    if(cart.length === 0 && window.innerWidth <= 1024){
        document.querySelector("#cartPanel").style.display = 'none';
    }
}


let isPdvMode = false; // Vari√°vel global para rastrear o modo PDV

function openModal(item, isPdv = false){
    isPdvMode = isPdv;
    modalState = { item: item, qty: 1, addons: generateAddonState(item.addonGroups) };
    
    document.querySelector("#modalTitle").textContent = "Personalizar " + item.name;
    document.querySelector("#modalItemName").textContent = item.name;
    document.querySelector("#modalItemQty").textContent = modalState.qty;
    
    renderModalAddons();
    calculateModalTotal();
    
    document.querySelector("#modal").classList.add('open');
}

function closeModal(){
    document.querySelector("#modal").classList.remove('open');
    modalState = null;
}

function generateAddonState(groups){
    return ((groups || [])).map(group => ({
        groupId: group.id,
        selected: ((group.addons || [])).map(addon => ({ addonId: addon.id, qty: 0 }))
    }));
}

function renderModalAddons(){
    const addonsEl = document.querySelector("#modalAddons");
    addonsEl.innerHTML = '';
    
    ((modalState.item.addonGroups || [])).forEach(group => {
        const groupState = modalState.addons.find(g => g.groupId === group.id);
        const currentCount = groupState.selected.reduce((sum, addon) => sum + addon.qty, 0);
        
        const groupEl = document.createElement('div');
        groupEl.classList.add('addon-group');
        groupEl.innerHTML = `
            <div class="addon-header">
                <strong style="font-size:15px;">${group.name}</strong>
                <div class="small" style="color:var(--muted);">${group.required ? '(Obrigat√≥rio)' : `(Max ${group.max}, ${group.free > 0 ? group.free + ' gr√°tis' : 'todos pagos'})`}</div>
            </div>
        `;
        
        ((group.addons || [])).forEach(addon => {
            const addonState = groupState.selected.find(a => a.addonId === addon.id);
            const addonEl = document.createElement('div');
            addonEl.classList.add('addon-row');
            
            addonEl.innerHTML = `
                <div>
                    ${addon.name} 
                    ${addon.price > 0 ? `<span style="font-weight:600; color:var(--primary);"> (+${formatBRL(addon.price)})</span>` : ''}
                </div>
                <div class="addon-controls">
                    <button data-group="${group.id}" data-addon="${addon.id}" data-action="decrement" ${addonState.qty === 0 ? 'disabled' : ''}>-</button>
                    <span class="count">${addonState.qty}</span>
                    <button data-group="${group.id}" data-addon="${addon.id}" data-action="increment" ${currentCount >= group.max && addonState.qty === 0 ? 'disabled' : ''}>+</button>
                </div>
            `;
            groupEl.appendChild(addonEl);
        });
        
        addonsEl.appendChild(groupEl);
    });
    
    addonsEl.querySelectorAll('.addon-controls button').forEach(btn => {
        btn.addEventListener('click', (e) => handleAddonChange(
            e.target.dataset.group, 
            e.target.dataset.addon, 
            e.target.dataset.action
        ));
    });
}

function handleAddonChange(groupId, addonId, action){
    const group = modalState.item.addonGroups.find(g => g.id === groupId);
    const groupState = modalState.addons.find(g => g.groupId === groupId);
    const addonState = groupState.selected.find(a => a.addonId === addonId);
    
    let currentCount = groupState.selected.reduce((sum, addon) => sum + addon.qty, 0);
    
    if(action === 'increment'){
        if(currentCount < group.max){
            addonState.qty += 1;
        }
    } else if(action === 'decrement'){
        if(addonState.qty > 0){
            addonState.qty -= 1;
        }
    }
    
    renderModalAddons();
    calculateModalTotal();
}

function calculateModalTotal(){
    let basePrice = modalState.item.price;
    let totalAddonsPrice = 0;
    
    ((modalState.addons || [])).forEach(groupState => {
        const originalGroup = modalState.item.addonGroups.find(g => g.id === groupState.groupId);
        let currentCount = 0;
        
        ((groupState.selected || [])).forEach(addonState => {
            currentCount += addonState.qty;
            const originalAddon = originalGroup.addons.find(a => a.id === addonState.addonId);
            
            // L√≥gica de gr√°tis
            let paidQty = addonState.qty;
            if(originalGroup.free > 0){
                const groupTotal = groupState.selected.reduce((sum, a) => sum + a.qty, 0);
                const freeToApply = Math.min(groupTotal, originalGroup.free);
                
                // Distribui o "gr√°tis" de forma simples (pode ser ajustado)
                // A forma mais simples √© aplicar o free at√© o limite e depois cobrar.
                // Aqui, vou manter a l√≥gica de que o pre√ßo do adicional √© cobrado *sempre* se for > 0, 
                // e o "gr√°tis" √© apenas um indicador de limite/info para o usu√°rio.
                // Para uma l√≥gica de desconto real, o JS seria mais complexo. 
                // Mantenho a implementa√ß√£o mais simples (todos os adicionais pagos contam para o total)
                
                // Assumindo que o `free` √© apenas um limite visual ou simplificado:
                totalAddonsPrice += (originalAddon.price * addonState.qty);
            } else {
                 totalAddonsPrice += (originalAddon.price * addonState.qty);
            }
        });
    });
    
    let itemTotal = (basePrice + totalAddonsPrice) * modalState.qty;
    document.querySelector("#modalTotal").textContent = formatBRL(itemTotal);
    
    // Valida√ß√£o de grupos obrigat√≥rios
    let canConfirm = true;
    ((modalState.item.addonGroups || [])).forEach(group => {
        if(group.required){
            const groupState = modalState.addons.find(g => g.groupId === group.id);
            const currentCount = groupState.selected.reduce((sum, addon) => sum + addon.qty, 0);
            if(currentCount === 0){
                canConfirm = false;
            }
        }
    });
    
    if(canConfirm){
        document.querySelector("#modalConfirm").removeAttribute('disabled');
        document.querySelector("#modalConfirm").textContent = `Adicionar ${formatBRL(itemTotal)}`;
    } else {
        document.querySelector("#modalConfirm").setAttribute('disabled', 'true');
        document.querySelector("#modalConfirm").textContent = `Faltam op√ß√µes obrigat√≥rias`;
    }
}

function handleQtyChange(action){
    if(action === 'increment-qty'){
        modalState.qty += 1;
    } else if(action === 'decrement-qty'){
        if(modalState.qty > 1) modalState.qty -= 1;
    }
    document.querySelector("#modalItemQty").textContent = modalState.qty;
    calculateModalTotal();
}



// ---------------- PDV (Ponto de Venda) ----------------


function openPDVForTable(tableId){
    // initialize pdvCartState from existing order if present
    pdvCartState.tableId = tableId;
    pdvCartState.items = [];
    const table = DATA.tables.find(t => t.id === tableId);
    document.querySelector("#pdvOrderTitle").textContent = `Pedido ‚Äî ${table ? table.name : tableId}`;
    renderPDVItems();
    renderPDVCart();
    document.querySelector("#pdvOrderModal").classList.add('open');
}

function renderPDVItems(){
    const list = document.querySelector("#pdvItemsList");
    list.innerHTML = '';
    // reuse DATA.items rendering (simple list of buttons to add)
    ((DATA.items || [])).forEach(item => {
        const row = document.createElement('div');
        row.style.cssText = 'display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid #f5f5f5;';
        row.innerHTML = `<div><strong>${item.name}</strong><div class="small" style="color:var(--muted)">${formatBRL(item.totalPrice / item.qty)}</div></div>`;
        const btns = document.createElement('div');
        btns.style.display = 'flex'; btns.style.gap = '6px'; 
        const addBtn = document.createElement('button');
        addBtn.className = 'btn';
        addBtn.textContent = item.addonGroups.length > 0 ? 'Ver Op√ß√µes' : 'Adicionar';
        addBtn.addEventListener('click', () => {
            if(item.addonGroups.length > 0){
                // open modal but when confirmed it should add to PDV (pdvCartState). We'll open modal and on confirm it will call addItemToCart (which respects pdvCartState)
                openModal(item);
            } else {
                addItemToCart(item, 1, []);
            }
        });
        btns.appendChild(addBtn);
        row.appendChild(btns);
        list.appendChild(row);
    });
}



// finalize PDV order: save to Firestore and update DATA.tables
async function finalizePDVOrder(clientName = "") {
  const isAddingItems = !!pdvCartState.existingOrderId;
  const existingOrderId = pdvCartState.existingOrderId;
  try {
    if (!isAdmin) {
      alert("Apenas administradores podem finalizar pedidos de mesa.");
      return;
    }

    // Se n√£o est√° adicionando itens, e n√£o tem itens no carrinho, n√£o faz nada.
    if (!isAddingItems && (!pdvCartState || !pdvCartState.tableId || (pdvCartState.items || []).length === 0)) {
        alert("Nenhum item no pedido da mesa.");
        return;
    }

    const newItemsSubtotal = (pdvCartState.items || []).reduce((sum, item) => sum + item.totalPrice, 0);

    let orderToSave = {};
    let docRef;

    if(isAddingItems){
      const existingOrder = orders.find(o => o.id === existingOrderId);
      if(!existingOrder){
        alert("Erro: Pedido existente n√£o encontrado para adicionar itens.");
        return;
      }

      // 1. Merge dos itens: Novos itens + Itens existentes
      const newItems = (pdvCartState.items || []).map(item => {
        const originalItem = getItem(item.itemId);
        return {
          itemId: item.itemId,
          name: item.name,
          qty: item.qty,
          totalPrice: item.totalPrice,
          addons: (item.addons || []).flatMap(group => {
            if (!originalItem || !originalItem.addonGroups) return [];
            const originalGroup = originalItem.addonGroups.find(g => g.id === group.groupId);
            if (!originalGroup) return [];

            return group.selected
              .filter(a => a.qty > 0)
              .map(a => {
                const addonDef = originalItem.addons.find(x => x.id === a.addonId);
                return {
                  groupName: originalGroup.name,
                  name: addonDef ? addonDef.name : "Adicional",
                  qty: a.qty,
                  price: addonDef ? addonDef.price : 0
                };
              });
          })
        };
      });
      
      const allItems = [...existingOrder.items, ...newItems];
      const newSubtotal = allItems.reduce((sum, item) => sum + item.totalPrice, 0);

      orderToSave = {
        items: allItems,
        subtotal: newSubtotal,
        total: newSubtotal, // No PDV, total = subtotal
        updatedAt: new Date().toISOString(),
        // Mant√©m o status como 'pending'
      };

      // 2. Atualiza o pedido existente no Firestore
      const orderDocRef = doc(ordersCollectionRef, existingOrderId);
      await updateDoc(orderDocRef, orderToSave);
      docRef = orderDocRef; // Para a mensagem de sucesso
      
    } else {
      // Cria√ß√£o de um NOVO pedido (Comportamento original)
      const subtotal = newItemsSubtotal;
      orderToSave = {
        userId: "pdv_" + pdvCartState.tableId,
        userName: clientName || "Mesa " + pdvCartState.tableId,
        address: "Atendimento no local (PDV)",
        deliveryAreaId: null,
        deliveryAreaName: "PDV",
        deliveryFee: 0,
        items: (pdvCartState.items || []).map(item => {
          const originalItem = getItem(item.itemId);

          return {
            itemId: item.itemId,
            name: item.name,
            qty: item.qty,
            totalPrice: item.totalPrice,
            addons: (item.addons || []).flatMap(group => {
              if (!originalItem || !originalItem.addonGroups) return [];
              const originalGroup = originalItem.addonGroups.find(g => g.id === group.groupId);
              if (!originalGroup) return [];

              return group.selected
                .filter(a => a.qty > 0)
                .map(a => {
                  const addonDef = originalGroup.addons.find(x => x.id === a.addonId);
                  return {
                    groupName: originalGroup.name,
                    name: addonDef ? addonDef.name : "Adicional",
                    qty: a.qty,
                    price: addonDef ? addonDef.price : 0
                  };
                });
            })
          };
        }),
        subtotal: subtotal,
        total: subtotal,
        paymentMethod: "pdv",
        changeNeeded: 0,
        status: "pending",
        createdAt: new Date().toISOString(),
        pdvTable: pdvCartState.tableId
      };

      docRef = await addDoc(ordersCollectionRef, orderToSave);

      // 3. Atualiza o status da mesa para 'ocupada' e associa o orderId
      const table = (DATA.restaurant.tables || []).find(t => t.id === pdvCartState.tableId);
      if(table){
        table.orderId = docRef.id;
        await saveMenuData();
        renderPDVTables(); // Renderiza novamente para mudar a cor da mesa
      }
    }

    pdvCartState.items = [];
    pdvCartState.existingOrderId = null; // Limpa o estado
    renderPDVCart();
    closePDVOrderModal();

    alert(`Pedido da Mesa ${pdvCartState.tableId} ${isAddingItems ? 'atualizado' : 'enviado'} para a cozinha com sucesso!`);

    pdvCartState.items = [];
    renderPDVCart();
    closePDVOrderModal();

    alert(`Pedido da Mesa ${pdvCartState.tableId} enviado para a cozinha com sucesso!`);

  } catch (e) {
    console.error("Erro ao finalizar pedido PDV:", e);
    alert("Falha ao enviar pedido da mesa. Verifique o console ou sua conex√£o com o Firebase.");
  }
}

async function closeTableAccount(tableId){
    const table = (DATA.restaurant.tables || []).find(t => t.id === tableId);
    if(!table || !table.orderId){ alert('Mesa n√£o possui pedido associado.'); return; }
    
    // Encontra o pedido no array global 'orders'
    const order = orders.find(o => o.id === table.orderId);
    if(!order){
        alert('Pedido n√£o encontrado nos pedidos (pode levar um momento para sincronizar).');
        return;
    }
    
    // Calcula o total incluindo comandas avulsas
    let totalComandas = 0;
    if (table.comandasAvulsas && table.comandasAvulsas.length > 0) {
        totalComandas = table.comandasAvulsas.reduce((sum, c) => sum + (c.totalCalculado || 0), 0);
    }
    
    const totalGeral = (order.total || 0) + totalComandas;
    
    // 1. Confirma√ß√£o e Fechamento
    let resumo = `Resumo do pedido (#${order.id.substring(0,7)})\\n`;
    resumo += `Itens do card√°pio: ${formatBRL(order.total || 0)}\\n`;
    if (totalComandas > 0) {
        resumo += `Comandas avulsas: ${formatBRL(totalComandas)}\\n`;
    }
    resumo += `Total: ${formatBRL(totalGeral)}\\nConfirma pagamento e fechamento da mesa?`;
    
    if(confirm(resumo)){
        
        // 2. Marca o pedido como "delivered" (entregue/finalizado) no Firestore
        // e salva as comandas avulsas junto com o pedido
        try {
            const orderDocRef = doc(ordersCollectionRef, order.id);
            await updateDoc(orderDocRef, { 
                status: 'delivered', 
                closedAt: new Date().toISOString(),
                comandasAvulsas: table.comandasAvulsas || [],
                totalComandas: totalComandas,
                totalGeral: totalGeral
            });
        } catch(e){
            console.error("Erro ao atualizar status do pedido no Firestore:", e);
            alert("Erro ao finalizar pedido no sistema. Verifique o console.");
            return;
        }
        
        // 3. Libera a mesa (limpa orderId, status e comandas avulsas)
        table.orderId = null;
        table.comandasAvulsas = []; // Limpa as comandas avulsas ao fechar a mesa
        // table.status = 'livre'; // O status agora √© determinado pela presen√ßa de orderId
        await saveMenuData();
        
        // 4. Feedback e Renderiza√ß√£o
        alert('Conta fechada. Mesa liberada.');
        renderPDVTables();
        closeTableDetailsModal();
    }
}

// ------------------------------------------------------

// === COMANDAS AVULSAS ===

// Vari√°vel global para armazenar a mesa atual ao abrir modal de comanda
let currentComandaTableId = null;

/**
 * Abre o modal de escolha do tipo de comanda (valor ou peso)
 */
function openComandaChoiceModal(tableId) {
    currentComandaTableId = tableId;
    document.querySelector("#comandaChoiceModal").classList.add('open');
    // Garante que o modal de escolha esteja acima do modal de detalhes da mesa
    document.querySelector("#comandaChoiceModal").style.zIndex = 1000;
}

/**
 * Abre o modal de comanda por valor
 */
function openComandaValorModal() {
    document.querySelector("#comandaChoiceModal").classList.remove('open');
    document.querySelector("#comandaModal").classList.add('open');
    document.querySelector("#comandaModal").style.zIndex = 1001; // Acima do modal de escolha e detalhes
    // Limpa o formul√°rio
    document.querySelector("#comandaForm").reset();
}

/**
 * Abre o modal de comanda por peso
 */
function openComandaPesoModal() {
    document.querySelector("#comandaChoiceModal").classList.remove('open');
    document.querySelector("#comandaPesoModal").classList.add('open');
    document.querySelector("#comandaPesoModal").style.zIndex = 1001; // Acima do modal de escolha e detalhes
    // Limpa o formul√°rio
    document.querySelector("#comandaPesoForm").reset();
    document.querySelector("#comandaPesoTotal").value = '';
}

/**
 * Calcula automaticamente o total da comanda por peso
 */
function calculatePesoTotal() {
    const peso = parseFloat(document.querySelector("#comandaPesoWeight").value) || 0;
    const valorKg = parseFloat(document.querySelector("#comandaPesoValuePerKg").value) || 0;
    const total = peso * valorKg;
    document.querySelector("#comandaPesoTotal").value = formatBRL(total);
}

/**
 * Salva uma comanda avulsa por valor
 */
async function saveComandaValor(e) {
    e.preventDefault();
    
    if (!isAdmin) {
        alert("Apenas administradores podem criar comandas avulsas.");
        return;
    }
    
    if (!currentComandaTableId) {
        alert("Erro: Mesa n√£o identificada.");
        return;
    }
    
    const table = (DATA.restaurant.tables || []).find(t => t.id === currentComandaTableId);
    if (!table) {
        alert("Erro: Mesa n√£o encontrada.");
        return;
    }
    
    // Coleta dados do formul√°rio
    const cliente = document.querySelector("#comandaName").value.trim();
    const valorFixo = parseFloat(document.querySelector("#comandaValue").value) || 0;
    const pagamento = document.querySelector("#comandaPayment").value;
    const cpf = document.querySelector("#comandaCPF").value.trim();
    
    if (!cliente || valorFixo <= 0) {
        alert("Preencha o nome do cliente e o valor.");
        return;
    }
    
    // Cria a comanda
    const comanda = {
        id: Date.now().toString(),
        tipo: "valor",
        cliente: cliente,
        cpf: cpf || null,
        pagamento: pagamento,
        valorFixo: valorFixo,
        totalCalculado: valorFixo,
        criadoEm: new Date().toISOString()
    };
    
    // Inicializa o array de comandas se n√£o existir
    if (!table.comandasAvulsas) {
        table.comandasAvulsas = [];
    }
    
    // Adiciona a comanda √† mesa
    table.comandasAvulsas.push(comanda);
    
    // Salva no Firebase
    try {
        await saveMenuData();
        alert(`Comanda por valor adicionada: ${cliente} - ${formatBRL(valorFixo)}`);
    closeComandaModals();
    document.querySelector("#comandaForm").reset();
    
    // Atualiza o modal de detalhes se estiver aberto
    if (currentTableId === currentComandaTableId) {
        updateTableDetailsComandas();
    }
    } catch (e) {
        console.error("Erro ao salvar comanda:", e);
        alert("Falha ao salvar comanda. Verifique o console.");
    }
}

/**
 * Salva uma comanda avulsa por peso
 */
async function saveComandaPeso(e) {
    e.preventDefault();
    
    if (!isAdmin) {
        alert("Apenas administradores podem criar comandas avulsas.");
        return;
    }
    
    if (!currentComandaTableId) {
        alert("Erro: Mesa n√£o identificada.");
        return;
    }
    
    const table = (DATA.restaurant.tables || []).find(t => t.id === currentComandaTableId);
    if (!table) {
        alert("Erro: Mesa n√£o encontrada.");
        return;
    }
    
    // Coleta dados do formul√°rio
    const cliente = document.querySelector("#comandaPesoName").value.trim();
    const peso = parseFloat(document.querySelector("#comandaPesoWeight").value) || 0;
    const valorKg = parseFloat(document.querySelector("#comandaPesoValuePerKg").value) || 0;
    const pagamento = document.querySelector("#comandaPesoPayment").value;
    const cpf = document.querySelector("#comandaPesoCPF").value.trim();
    
    if (!cliente || peso <= 0 || valorKg <= 0) {
        alert("Preencha todos os campos obrigat√≥rios.");
        return;
    }
    
    const total = peso * valorKg;
    
    // Cria a comanda
    const comanda = {
        id: Date.now().toString(),
        tipo: "peso",
        cliente: cliente,
        cpf: cpf || null,
        pagamento: pagamento,
        peso: peso,
        valorKg: valorKg,
        totalCalculado: total,
        criadoEm: new Date().toISOString()
    };
    
    // Inicializa o array de comandas se n√£o existir
    if (!table.comandasAvulsas) {
        table.comandasAvulsas = [];
    }
    
    // Adiciona a comanda √† mesa
    table.comandasAvulsas.push(comanda);
    
    // Salva no Firebase
    try {
        await saveMenuData();
        alert(`Comanda por peso adicionada: ${cliente} - ${peso}kg x ${formatBRL(valorKg)}/kg = ${formatBRL(total)}`);
    closeComandaModals();
    document.querySelector("#comandaPesoForm").reset();
    
    // Atualiza o modal de detalhes se estiver aberto
    if (currentTableId === currentComandaTableId) {
        updateTableDetailsComandas();
    }
    } catch (e) {
        console.error("Erro ao salvar comanda:", e);
        alert("Falha ao salvar comanda. Verifique o console.");
    }
}

/**
 * Atualiza a exibi√ß√£o das comandas avulsas no modal de detalhes da mesa
 */
function updateTableDetailsComandas() {
    if (!currentTableId) return;
    
    const table = (DATA.restaurant.tables || []).find(t => t.id === currentTableId);
    if (!table) return;
    
    const comandasList = document.querySelector("#tableDetailsComandasAvulsas");
    if (!comandasList) return;
    
    comandasList.innerHTML = '';
    
    const comandas = table.comandasAvulsas || [];
    
    if (comandas.length === 0) {
        comandasList.innerHTML = '<div class="small" style="color:var(--muted);">Nenhuma comanda avulsa nesta mesa.</div>';
        return;
    }
    
    comandas.forEach((comanda, index) => {
        const div = document.createElement('div');
        div.style.cssText = 'font-size:14px; margin-bottom: 8px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; background: #f9f9f9;';
        
        let detalhes = '';
        if (comanda.tipo === 'valor') {
            detalhes = `<strong>Valor Fixo:</strong> ${formatBRL(comanda.valorFixo)}`;
        } else if (comanda.tipo === 'peso') {
            detalhes = `<strong>Peso:</strong> ${comanda.peso}kg x ${formatBRL(comanda.valorKg)}/kg`;
        }
        
        const pagamentoLabel = {
            'pix': 'PIX',
            'credit': 'Cr√©dito',
            'debit': 'D√©bito',
            'cash': 'Dinheiro'
        }[comanda.pagamento] || comanda.pagamento;
        
        div.innerHTML = `
            <div style="display:flex; justify-content:space-between; margin-bottom: 4px;">
                <span style="font-weight:600;">üìã ${comanda.cliente}</span>
                <span style="font-weight:700; color:var(--primary);">${formatBRL(comanda.totalCalculado)}</span>
            </div>
            <div class="small" style="color:var(--muted); margin-bottom: 4px;">
                ${detalhes}
            </div>
            <div class="small" style="color:var(--muted);">
                <strong>Pagamento:</strong> ${pagamentoLabel}
                ${comanda.cpf ? ` | <strong>CPF:</strong> ${comanda.cpf}` : ''}
            </div>
            <button class="pill" style="margin-top:6px; background:#fbe6e6; color:#dc3545; font-size:12px; padding:4px 8px;" onclick="removeComanda('${currentTableId}', ${index})">Remover</button>
        `;
        
        comandasList.appendChild(div);
    });
    
    // Atualiza o total da mesa incluindo comandas
    updateTableDetailsTotal();
}

/**
 * Atualiza o total da mesa incluindo itens do card√°pio e comandas avulsas
 */
function updateTableDetailsTotal() {
    if (!currentTableId) return;
    
    const table = (DATA.restaurant.tables || []).find(t => t.id === currentTableId);
    if (!table || !table.orderId) return;
    
    const order = orders.find(o => o.id === table.orderId);
    if (!order) return;
    
    // Total dos itens do card√°pio
    let totalItens = order.total || 0;
    
    // Total das comandas avulsas
    let totalComandas = 0;
    if (table.comandasAvulsas && table.comandasAvulsas.length > 0) {
        totalComandas = table.comandasAvulsas.reduce((sum, c) => sum + (c.totalCalculado || 0), 0);
    }
    
    const totalGeral = totalItens + totalComandas;
    
    document.querySelector("#tableDetailsTotal").textContent = formatBRL(totalGeral);
}

/**
 * Remove uma comanda avulsa da mesa
 */
window.removeComanda = async function(tableId, comandaIndex) {
    if (!isAdmin) {
        alert("Apenas administradores podem remover comandas.");
        return;
    }
    
    const table = (DATA.restaurant.tables || []).find(t => t.id === tableId);
    if (!table || !table.comandasAvulsas) return;
    
    if (!confirm("Deseja realmente remover esta comanda?")) return;
    
    table.comandasAvulsas.splice(comandaIndex, 1);
    
    try {
        await saveMenuData();
        alert("Comanda removida com sucesso.");
        
        if (currentTableId === tableId) {
            updateTableDetailsComandas();
        }
    } catch (e) {
        console.error("Erro ao remover comanda:", e);
        alert("Falha ao remover comanda. Verifique o console.");
    }
};

// Event Listeners para os modais de comanda
document.addEventListener("DOMContentLoaded", () => {
    // Bot√µes de escolha do tipo de comanda
    const btnComandaValor = document.querySelector("#btnComandaValor");
    if (btnComandaValor) {
        btnComandaValor.addEventListener("click", openComandaValorModal);
    }
    
    const btnComandaPeso = document.querySelector("#btnComandaPeso");
    if (btnComandaPeso) {
        btnComandaPeso.addEventListener("click", openComandaPesoModal);
    }
    
    // Formul√°rio de comanda por valor
    const comandaForm = document.querySelector("#comandaForm");
    if (comandaForm) {
        comandaForm.addEventListener("submit", saveComandaValor);
    }
    
    const comandaCancel = document.querySelector("#comandaCancel");
    if (comandaCancel) {
        comandaCancel.addEventListener("click", closeComandaModals);
    }
    
    // Formul√°rio de comanda por peso
    const comandaPesoForm = document.querySelector("#comandaPesoForm");
    if (comandaPesoForm) {
        comandaPesoForm.addEventListener("submit", saveComandaPeso);
    }
    
    const comandaPesoCancel = document.querySelector("#comandaPesoCancel");
    if (comandaPesoCancel) {
        comandaPesoCancel.addEventListener("click", closeComandaModals);
    }
    
    // C√°lculo autom√°tico do total por peso
    const pesoWeight = document.querySelector("#comandaPesoWeight");
    const pesoValuePerKg = document.querySelector("#comandaPesoValuePerKg");
    
    if (pesoWeight) {
        pesoWeight.addEventListener("input", calculatePesoTotal);
    }
    
    if (pesoValuePerKg) {
        pesoValuePerKg.addEventListener("input", calculatePesoTotal);
    }
});

// ------------------------------------------------------

// === Table Details Modal (Gerenciamento de Mesa Ocupada) ===

let currentTableId = null;

function openTableDetailsModal(tableId){
    const table = (DATA.restaurant.tables || []).find(t => t.id === tableId);
    if(!table) return;
    
    currentTableId = tableId;
    const order = table.orderId ? orders.find(o => o.id === table.orderId) : null;
    
    document.querySelector("#tableDetailsTableName").textContent = table.name || 'Mesa ' + table.id.substring(0,4);
    
    // Oculta/Exibe se√ß√µes baseadas na exist√™ncia de um pedido (orderId)
    const hasOrder = !!order;
    document.querySelector("#tableDetailsClientName").textContent = hasOrder ? (order.userName || 'N/A') : 'N/A';
    document.querySelector("#tableDetailsPaymentMethod").value = hasOrder ? (order.paymentMethod || 'cash') : 'cash';
    
    const itemsList = document.querySelector("#tableDetailsOrderItems");
    itemsList.innerHTML = '';
    
    if(hasOrder){
        // Renderiza itens do card√°pio
        (order.items || []).forEach(item => {
            const div = document.createElement('div');
            div.style.cssText = 'font-size:14px; margin-bottom: 8px; padding-bottom: 4px; border-bottom: 1px dashed #eee;';
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between;">
                    <span style="font-weight:600;">${item.qty}x ${item.name}</span>
                    <span>${formatBRL(item.totalPrice)}</span>
                </div>
                ${item.addons && item.addons.length > 0 ? `
                    <div class="small" style="color:var(--muted); margin-left: 10px; font-size:12px;">
                        + ${((item.addons || [])).map(a => `${a.qty}x ${a.name}`).join(', ')}
                    </div>
                ` : ''}
            `;
            itemsList.appendChild(div);
        });
        
        // Exibe bot√µes de itens e fechamento
        document.querySelector("#tableDetailsAddItems").style.display = 'inline-block';
        document.querySelector("#tableDetailsCloseTable").style.display = 'inline-block';
        document.querySelector("#tableDetailsAddItems").textContent = 'Enviar Mais Itens';
        document.querySelector("#tableDetailsCloseTable").textContent = 'Fechar Mesa';
        document.querySelector("#tableDetailsTotal").textContent = formatBRL(order.total); // Total inicial dos itens
        
    } else {
        itemsList.innerHTML = '<div class="small" style="color:var(--muted);">Nenhum item de card√°pio adicionado.</div>';
        // Se n√£o tem orderId, o bot√£o "Adicionar Itens" deve aparecer para criar o primeiro pedido
        document.querySelector("#tableDetailsAddItems").style.display = 'inline-block';
        document.querySelector("#tableDetailsAddItems").textContent = 'Adicionar Itens';
        document.querySelector("#tableDetailsCloseTable").style.display = 'none'; // N√£o pode fechar se n√£o tem pedido
        document.querySelector("#tableDetailsTotal").textContent = formatBRL(0);
    }
    
    // Renderiza comandas avulsas (sempre vis√≠vel)
    updateTableDetailsComandas();

    document.querySelector("#tableDetailsModal").classList.add('open');
}

function closeTableDetailsModal(){
    const paymentMethodElement = document.querySelector("#tableDetailsPaymentMethod");
    const paymentMethod = paymentMethodElement ? paymentMethodElement.value : null;
    if(currentTableId){
        const table = (DATA.restaurant.tables || []).find(t => t.id === currentTableId);
        if(table && table.orderId){
            const order = orders.find(o => o.id === table.orderId);
            if(order && order.paymentMethod !== paymentMethod){
                order.paymentMethod = paymentMethod;
                // Atualiza o pedido no Firebase (assumindo que existe uma fun√ß√£o para isso)
                // updateOrderInFirebase(order); 
                // Como n√£o tenho acesso ao Firebase, vou apenas atualizar o objeto localmente.
                // Em um ambiente real, a linha acima seria descomentada.
                console.log('Forma de pagamento da mesa ' + currentTableId + ' atualizada para: ' + paymentMethod);
            }
        }
    }
    document.querySelector("#tableDetailsModal").classList.remove('open');
    currentTableId = null;
}

// Listeners para o novo modal
document.addEventListener("DOMContentLoaded", () => {
    const modal = document.querySelector("#tableDetailsModal");
    if(!modal) return;

    document.querySelector("#tableDetailsCancel").addEventListener("click", closeTableDetailsModal);
    
    document.querySelector("#tableDetailsAddItems").addEventListener("click", () => {
        if(!currentTableId) return;
        const table = (DATA.restaurant.tables || []).find(t => t.id === currentTableId);
        if(!table) return;

        const tableIdToOpen = currentTableId;
        const orderIdToOpen = table.orderId || null; // Pode ser null se for o primeiro item

        closeTableDetailsModal();
        
        // Abre o modal PDV no modo de adi√ß√£o de itens (ou cria√ß√£o de novo pedido)
        openPDVOrderModal(tableIdToOpen, orderIdToOpen);
    });
    
    document.querySelector("#tableDetailsCloseTable").addEventListener("click", () => {
        if(!currentTableId) return;
        closeTableAccount(currentTableId);
    });
    
    document.querySelector("#tableDetailsAddComanda").addEventListener("click", () => {
        if(!currentTableId) return;
        openComandaChoiceModal(currentTableId);
    });
});

// ------------------------------------------------------


// === ADMIN MODALS ===

// --- Item Details Modal (CRUD item) ---

function openItemDetailsModal(item = null){
    itemState = item ? { ...item } : { id: Date.now().toString(), category: activeCat || DATA.categories[0].id, name: '', desc: '', price: 0.00, img: blankSVG(), addonGroups: [] };
    
    document.querySelector("#itemDetailsModalTitle").textContent = item ? "Editar Item: " + item.name : "Adicionar Novo Item";
    document.querySelector("#itemIdDetails").value = itemState.id;
    document.querySelector("#itemName").value = itemState.name;
    document.querySelector("#itemDesc").value = itemState.desc;
    document.querySelector("#itemPrice").value = itemState.price;
    
    // Preencher categorias
    const catSelect = document.querySelector("#itemCategory");
    catSelect.innerHTML = '';
    ((DATA.categories || [])).forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat.id;
        opt.textContent = cat.title;
        if(cat.id === itemState.category) opt.selected = true;
        catSelect.appendChild(opt);
    });
    
    document.querySelector("#itemDetailsModal").classList.add('open');
}

function closeItemDetailsModal(){
    document.querySelector("#itemDetailsModal").classList.remove('open');
    itemState = null;
    document.querySelector("#itemDetailsForm").reset();
}

function saveItemDetails(e){
    e.preventDefault();
    if (!isAdmin) return;
    
    const isNew = !DATA.items.find(i => i.id === itemState.id);
    
    itemState.name = document.querySelector("#itemName").value;
    itemState.desc = document.querySelector("#itemDesc").value;
    itemState.price = parseFloat(document.querySelector("#itemPrice").value) || 0;
    itemState.category = document.querySelector("#itemCategory").value;
    
    if(isNew){
        DATA.items.push(itemState);
    } else {
        // Encontra o √≠ndice e substitui
        const index = DATA.items.findIndex(i => i.id === itemState.id);
        if(index !== -1){
            // Mant√©m os grupos de adicionais e imagem existentes se n√£o estiverem sendo editados em outra modal
            DATA.items[index] = { ...DATA.items[index], ...itemState };
        }
    }
    
    saveMenuData();
    renderItems();
    closeItemDetailsModal();
}

// --- Image Edit Modal ---

function openImageEditModal(item){
  itemState = item;
  document.querySelector("#imageEditModalTitle").textContent = "Editar Imagem para: ";
  document.querySelector("#imageItemName").textContent = item.name;
  document.querySelector("#itemIdImage").value = item.id;
  document.querySelector("#currentImagePreview").src = item.img || blankSVG();
  document.querySelector("#itemImgUrl").value = item.img || "";
  
  document.querySelector("#imageEditModal").classList.add('open');
}

function closeImageEditModal(){
  document.querySelector("#imageEditModal").classList.remove('open');
  itemState = null;
  document.querySelector("#imageEditForm").reset();
}

async function saveImageEdit(e){
  e.preventDefault();
  if (!isAdmin) return;
  
  const fileInput = document.querySelector("#itemImgFile");
  let newImgUrl = itemState.img || blankSVG();

  if (fileInput.files.length > 0) {
      try {
          // Converte a imagem para Base64 para salvar no banco de dados
          newImgUrl = await fileToBase64(fileInput.files[0]);
      } catch (error) {
          alert("Erro ao ler o arquivo de imagem.");
          return;
      }
  }
  
  const index = DATA.items.findIndex(i => i.id === itemState.id);
  if(index !== -1){
      DATA.items[index].img = newImgUrl;
      saveMenuData();
      renderItems();
      // Atualiza a pr√©via da imagem se o modal for reaberto
  }
  
  closeImageEditModal();
}

// --- Addon Management Modal ---

function openAddonManagementModal(item){
    addonManagerState = item;
    document.querySelector("#addonManagementTitle").textContent = "Gerenciar Adicionais para ";
    document.querySelector("#addonItemName").textContent = item.name;
    
    renderAddonGroups();
    
    document.querySelector("#addonManagementModal").classList.add('open');
}

function closeAddonManagementModal(){
    document.querySelector("#addonManagementModal").classList.remove('open');
    addonManagerState = null;
}

function renderAddonGroups(){
    const list = document.querySelector("#addonGroupsList");
    list.innerHTML = '';
    
    if (!addonManagerState || addonManagerState.addonGroups.length === 0) {
        list.innerHTML = '<div class="item-management-note">Este item ainda n√£o possui grupos de adicionais. Clique em "+ Adicionar Grupo".</div>';
    }
    
    ((addonManagerState.addonGroups || [])).forEach((group, groupIndex) => {
        const groupEl = document.createElement('div');
        groupEl.classList.add('addon-group-settings');
        groupEl.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 8px;">
                <input type="text" value="${group.name}" placeholder="Nome do Grupo (ex: Escolha o Molho)" 
                       onchange="updateAddonGroupProp('${group.id}', 'name', this.value)" style="flex:1; margin-right: 10px; font-weight: 600;">
                <button type="button" class="pill" style="background:#dc3545; color:white; padding:4px 8px;" onclick="removeAddonGroup('${group.id}')">Remover Grupo</button>
            </div>
            
            <div class="meta-addon-info">
                <strong>Configura√ß√µes:</strong>
                <label style="margin-right:15px;">Max: <input type="number" value="${group.max}" min="1" style="width:50px; padding:4px; display:inline;" 
                       onchange="updateAddonGroupProp('${group.id}', 'max', parseInt(this.value))"></label>
                <label style="margin-right:15px;">Gr√°tis: <input type="number" value="${group.free}" min="0" style="width:50px; padding:4px; display:inline;" 
                       onchange="updateAddonGroupProp('${group.id}', 'free', parseInt(this.value))"></label>
                <label>Obrigat√≥rio: <input type="checkbox" ${group.required ? 'checked' : ''} 
                       onchange="updateAddonGroupProp('${group.id}', 'required', this.checked)"></label>
            </div>
            
            <h5 style="margin-top:15px; margin-bottom: 8px;">Itens do Grupo:</h5>
            <div id="addonItemsList-${group.id}">
                ${((group.addons || [])).map(addon => `
                    <div class="addon-item-row">
                        <input type="text" value="${addon.name}" placeholder="Nome do Adicional" onchange="updateAddonItemProp('${group.id}', '${addon.id}', 'name', this.value)">
                        <input type="number" value="${addon.price}" step="0.01" placeholder="Pre√ßo" style="max-width:80px;" onchange="updateAddonItemProp('${group.id}', '${addon.id}', 'price', parseFloat(this.value))">
                        <button type="button" class="pill" style="background:#dc3545; color:white; padding:4px 8px;" onclick="removeAddonItem('${group.id}', '${addon.id}')">X</button>
                    </div>
                `).join('')}
            </div>
            <button type="button" class="pill" style="background:#e6ffe6; color:#28a745; margin-top:10px; border: 1px dashed #28a745;" onclick="addAddonItem('${group.id}')">+ Adicionar Op√ß√£o</button>
        `;
        list.appendChild(groupEl);
    });
}

function addAddonGroup() {
    if (!addonManagerState) return;
    const newGroup = {
        id: Date.now().toString(),
        name: "Novo Grupo de Adicionais",
        max: 1,
        free: 0,
        required: false,
        addons: [
            { id: Date.now().toString() + 'a', name: 'Op√ß√£o Padr√£o', price: 0.00 }
        ]
    };
    addonManagerState.addonGroups.push(newGroup);
    renderAddonGroups();
}

function removeAddonGroup(groupId) {
    if (!addonManagerState || !confirm("Tem certeza que deseja remover este grupo de adicionais?")) return;
    addonManagerState.addonGroups = ((addonManagerState.addonGroups || [])).filter(g => g.id !== groupId);
    renderAddonGroups();
}

function updateAddonGroupProp(groupId, prop, value) {
    const group = addonManagerState.addonGroups.find(g => g.id === groupId);
    if (group) {
        group[prop] = value;
        // N√£o precisa re-renderizar, mas √© bom para garantir o estado
        // renderAddonGroups(); 
    }
}

function addAddonItem(groupId) {
    const group = addonManagerState.addonGroups.find(g => g.id === groupId);
    if (group) {
        group.addons.push({ id: Date.now().toString(), name: 'Nova Op√ß√£o', price: 0.00 });
        renderAddonGroups();
    }
}

function removeAddonItem(groupId, addonId) {
    const group = addonManagerState.addonGroups.find(g => g.id === groupId);
    if (group && confirm("Tem certeza que deseja remover este adicional?")) {
        group.addons = ((group.addons || [])).filter(a => a.id !== addonId);
        renderAddonGroups();
    }
}

function updateAddonItemProp(groupId, addonId, prop, value) {
    const group = addonManagerState.addonGroups.find(g => g.id === groupId);
    const addon = group ? group.addons.find(a => a.id === addonId) : null;
    if (addon) {
        addon[prop] = value;
        // renderAddonGroups(); // N√£o precisa re-renderizar
    }
}

function saveAddonManagement(){
    if (!isAdmin || !addonManagerState) return;
    
    // Encontra o item no array principal e atualiza os grupos de adicionais
    const index = DATA.items.findIndex(i => i.id === addonManagerState.id);
    if(index !== -1){
        DATA.items[index].addonGroups = addonManagerState.addonGroups;
        saveMenuData();
        renderItems();
    }
    closeAddonManagementModal();
}

// --- Admin Panel Modal ---

function openAdminModal(tabId = 'orders'){
    if (!isAdmin) return;
    
    // Renderiza a tab correta
    showAdminTab(tabId);
    
    // Se for settings, carrega os dados atuais
    if (tabId === 'settings') {
        loadStoreSettings();
        renderDeliveryAreas();
    }
    
    document.querySelector("#adminModal").classList.add('open');
}

function closeAdminModal(){
    document.querySelector("#adminModal").classList.remove('open');
}

function showAdminTab(tabId) {
  // Oculta todos os pain√©is
  document.querySelectorAll('.admin-panel').forEach(p => p.classList.add('hidden'));
  
  // Mostra o painel correspondente
  const panel = document.getElementById(tabId + 'Panel');
  if (panel) {
    panel.classList.remove('hidden');
  } else {
    console.warn('Painel n√£o encontrado:', tabId);
    return;
  }

  // Atualiza bot√£o ativo
  document.querySelectorAll('.admin-tabs button').forEach(btn => btn.classList.remove('active'));
  const tabButton = document.getElementById('tab' + tabId.charAt(0).toUpperCase() + tabId.slice(1));
  if (tabButton) tabButton.classList.add('active');

  // L√≥gica de renderiza√ß√£o
  if (tabId === 'menu') {
    renderAdminMenu();
  } else if (tabId === 'orders') {
    renderAdminOrders();
  } else if (tabId === 'sales') {
    renderAdminDashboard();
  } else if (tabId === 'customers') {
    renderAdminCustomers();
  } else if (tabId === 'settings') {
    renderAdminSettings();
  } else if (tabId === 'pdv') {
    // üî• Aqui garantimos renderiza√ß√£o segura
    if (typeof renderPDVTables === 'function') {
      renderPDVTables();
    }
  }
}





const ORDER_STATUSES_LIST = [
  { id: 'pending', label: 'Em An√°lise', color: '#ff9800' },
  { id: 'in_production', label: 'Em Produ√ß√£o', color: '#17a2b8' }, // Novo status
  { id: 'ready_for_delivery', label: 'Pronto para Entregar', color: '#03A9F4' }, // Novo status
  { id: 'delivered', label: 'Conclu√≠do', color: '#4CAF50' }, // Status final
  { id: 'cancelled', label: 'Cancelar Pedido', color: '#F44336' } // Op√ß√£o de cancelamento
];

// Mapeamento de status antigos para novos (para compatibilidade e l√≥gica)
// 'accepted' ser√° tratado como 'in_production'
const STATUS_MAP = {
    'accepted': 'in_production',
    'preparing': 'in_production', // Mapeia 'preparing' para 'in_production'
    'ready': 'ready_for_delivery', // Mapeia 'ready' para 'ready_for_delivery'
    'delivered': 'delivered',
    'pending': 'pending',
    'in_production': 'in_production',
    'ready_for_delivery': 'ready_for_delivery',
    'cancelled': 'cancelled'
};

window.openStatusSelector = function(button, orderId) {
  // Remove qualquer seletor de status aberto
  document.querySelectorAll('.status-selector').forEach(s => s.remove());

  const selector = document.createElement('div');
  selector.className = 'status-selector';
  selector.style.position = 'absolute';
  selector.style.top = '100%';
  selector.style.left = '0';
  selector.style.zIndex = '10';
  selector.style.background = '#fff';
  selector.style.border = '1px solid #ccc';
  selector.style.borderRadius = '5px';
  selector.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
  selector.style.minWidth = '180px'; // Aumentado para caber os novos labels
  selector.style.padding = '5px 0';

  // Filtra apenas os status que o usu√°rio pode selecionar (Em Produ√ß√£o, Pronto para Entregar, Conclu√≠do, Cancelar)
  const selectableStatuses = ORDER_STATUSES_LIST.filter(s => s.id !== 'pending');

  selectableStatuses.forEach(status => {
    const item = document.createElement('div');
    item.textContent = status.label;
    item.style.padding = '8px 12px';
    item.style.cursor = 'pointer';
    item.style.color = status.color;
    item.style.fontWeight = 'bold';
    item.onmouseover = () => item.style.background = '#f0f0f0';
    item.onmouseout = () => item.style.background = 'none';
    item.onclick = (e) => {
      e.stopPropagation();
      handleStatusUpdate(orderId, status.id);
      selector.remove();
    };
    selector.appendChild(item);
  });

  button.parentNode.appendChild(selector);

  // Fecha o seletor se clicar fora
  function closeSelector(e) {
    if (!selector.contains(e.target) && e.target !== button) {
      selector.remove();
      document.removeEventListener('click', closeSelector);
    }
  }
  document.addEventListener('click', closeSelector);
}

window.openMotoboySelector = function(orderId, currentMotoboyId) {
  // Remove qualquer seletor de motoboy aberto
  document.querySelectorAll('.motoboy-selector').forEach(s => s.remove());

  const orderCard = document.querySelector(`.order-card[data-order-id="${orderId}"]`);
  if (!orderCard) return;

  const selector = document.createElement('div');
  selector.className = 'motoboy-selector';
  selector.style.position = 'absolute';
  selector.style.top = '100%';
  selector.style.left = '0';
  selector.style.zIndex = '10';
  selector.style.background = '#fff';
  selector.style.border = '1px solid #ccc';
  selector.style.borderRadius = '5px';
  selector.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
  selector.style.minWidth = '180px';
  selector.style.padding = '5px 0';

  // Op√ß√£o para desvincular
  const unassignItem = document.createElement('div');
  unassignItem.textContent = '‚ùå Desvincular Motoboy';
  unassignItem.style.padding = '8px 12px';
  unassignItem.style.cursor = 'pointer';
  unassignItem.style.color = '#dc3545';
  unassignItem.onmouseover = () => unassignItem.style.background = '#fbe6e6';
  unassignItem.onmouseout = () => unassignItem.style.background = 'none';
  unassignItem.onclick = (e) => {
    e.stopPropagation();
    window._updateOrderMotoboy(orderId, null);
    selector.remove();
  };
  selector.appendChild(unassignItem);

  // Lista de motoboys
  (motoboys || []).forEach(motoboy => {
    const item = document.createElement('div');
    const isCurrent = motoboy.id === currentMotoboyId;
    item.textContent = (isCurrent ? '‚úÖ ' : '') + motoboy.name;
    item.style.padding = '8px 12px';
    item.style.cursor = 'pointer';
    item.style.fontWeight = isCurrent ? 'bold' : 'normal';
    item.onmouseover = () => item.style.background = '#f0f0f0';
    item.onmouseout = () => item.style.background = 'none';
    item.onclick = (e) => {
      e.stopPropagation();
      window._updateOrderMotoboy(orderId, motoboy.id);
      selector.remove();
    };
    selector.appendChild(item);
  });

  // Adiciona o seletor ao bot√£o que foi clicado
  const button = event.target.closest('button');
  if (button) {
    button.parentNode.appendChild(selector);
  } else {
    // Fallback: adiciona ao card
    orderCard.querySelector('.order-btns').appendChild(selector);
  }

  // Fecha o seletor se clicar fora
  function closeSelector(e) {
    if (!selector.contains(e.target) && e.target !== button) {
      selector.remove();
      document.removeEventListener('click', closeSelector);
    }
  }
  document.addEventListener('click', closeSelector);
}

window.handleStatusUpdate = function(orderId, newStatus) {
  // Encontra o pedido no array global 'orders'
  const orderIndex = orders.findIndex(o => o.id === orderId);
  if (orderIndex === -1) {
    alert('Pedido n√£o encontrado.');
    return;
  }

  // 1. Chama a fun√ß√£o global para atualizar o status no Firebase
  window.updateOrderStatus(orderId, newStatus)
    .then(() => {
      // 2. Atualiza o status no array local para re-renderiza√ß√£o
      orders[orderIndex].status = newStatus;
      // 3. Re-renderiza o quadro Kanban para mover o card
      renderAdminOrders();
    })
    .catch(error => {
      console.error("Erro ao atualizar status:", error);
      alert("Falha ao atualizar o status do pedido.");
    });
}

function renderAdminOrders(){
  const colPending = document.getElementById("col_pending");
  const colInProduction = document.getElementById("col_in_production"); // Novo ID
  const colReadyForDelivery = document.getElementById("col_ready_for_delivery"); // Novo ID
  const colDelivered = document.getElementById("col_delivered");

  colPending.innerHTML = `<div class='kanban-title' style='background:#ff9800'>üüß Pendentes</div>`;
  colInProduction.innerHTML = `<div class='kanban-title' style='background:#17a2b8'>üü® Em Produ√ß√£o</div>`;
  colReadyForDelivery.innerHTML = `<div class='kanban-title' style='background:#03A9F4'>üü¶ Pronto para Entregar</div>`;
  colDelivered.innerHTML = `<div class='kanban-title' style='background:#4CAF50'>‚úîÔ∏è Conclu√≠dos</div>`;

  (orders || []).forEach(order => {
    // Normaliza o status para os novos IDs, tratando 'accepted' como 'in_production'
    const normalizedStatus = STATUS_MAP[order.status] || order.status;

    const div=document.createElement("div");
    div.className="order-card";
    div.style.cursor="pointer";

    let itemsHTML = (order.items || []).map(item => {
        let itemStr = `<b>${item.qty}x ${item.name}</b> (${formatBRL(item.totalPrice / item.qty)})`;
        if (item.addons && item.addons.length > 0) {
            itemStr += item.addons.map(a => `<br>+ ${a.qty}x ${a.name}`).join('');
        }
        return itemStr;
    }).join('<br>');
    let paymentDisplay = order.paymentMethod;
    if (order.paymentMethod === 'Dinheiro' && order.change) {
        paymentDisplay += ` (Troco: ${formatBRL(order.change)})`;
    } else if (order.paymentMethod === 'D√©bito') {
        paymentDisplay = 'D√©bito';
    } else if (order.paymentMethod === 'Cr√©dito') {
        paymentDisplay = 'Cr√©dito';
    } else if (order.paymentMethod === 'PIX') {
        paymentDisplay = 'PIX';
    }
    
    let totalDisplay = formatBRL(order.total);
    
    let discountInfo = '';
    if (order.discount && order.discount > 0) {
      discountInfo = `<b>Desconto (${order.couponCode}):</b> <span style="color:#28a745;">- ${formatBRL(order.discount)}</span><br>`;
    }
    
    // NOVO: Exibe o tempo de preparo e ETA
    let preparationInfo = '';
    if (order.preparationTime && order.estimatedReadyTime) {
      const readyTime = new Date(order.estimatedReadyTime);
      const formattedTime = readyTime.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
      const now = new Date();
      const minutesRemaining = Math.max(0, Math.floor((readyTime - now) / 60000));
      
      preparationInfo = `
        <div style="background: #fff7e6; padding: 8px; border-radius: 6px; margin: 8px 0; border-left: 3px solid #ff9800;">
          <b style="color: #ff9800;">‚è±Ô∏è Tempo de Preparo:</b> ${order.preparationTime} min<br>
          <span style="font-size: 12px; color: #663300;">Pronto √†s: ${formattedTime} (${minutesRemaining > 0 ? `faltam ${minutesRemaining} min` : 'j√° deveria estar pronto'})</span>
        </div>
      `;
    }

    let detailsHTML = `
      <div class='order-details' style='margin-top:8px;font-size:13px;color:#444;'>
        <b>Cliente:</b> ${order.userName || "N/A"}<br>
        <b>Endere√ßo:</b> ${order.address || "N/A"}<br>
        <b>√Årea de Entrega:</b> ${order.neighborhood || "N/A"}<br>
        ${discountInfo}
        <b>Total:</b> R$ ${totalDisplay}<br>
        ${preparationInfo}
        <hr style="border: 0; border-top: 1px dashed #ccc; margin: 5px 0;">
        ${itemsHTML}
        <hr style="border: 0; border-top: 1px dashed #ccc; margin: 5px 0;">
        <div class='order-btns' style='display:flex; gap: 5px; flex-wrap: wrap; position: relative;'>
          <!-- Bot√£o 'Atualizar Status' -->
          <button style='background:#ff9800;color:#fff; padding: 5px 8px; border: none; border-radius: 5px; cursor: pointer; position: relative;' onclick='event.stopPropagation(); openStatusSelector(this, "${order.id}")'>Atualizar Status</button>
          <div class="motoboy-select-wrapper" style="display: inline-block; margin-right: 5px;">
              <select class="pill motoboy-select" onclick="event.stopPropagation()" onchange="event.stopPropagation(); window._updateOrderMotoboy && window._updateOrderMotoboy('${order.id}', this.value)" style="padding: 5px 8px; border: 1px solid #03a9f4; border-radius: 5px; cursor: pointer; background: #fff; color: #03a9f4;">
                <option value="">Motoboy: ‚Äî Selecionar ‚Äî</option>
                ${ (motoboys||[]).map(m => `<option value="${m.id}" ${order.motoboyId === m.id ? 'selected' : ''}>${m.name}</option>`).join('')}
              </select>
            </div>
          <button style='background:#4caf50;color:#fff; padding: 5px 8px; border: none; border-radius: 5px; cursor: pointer;' onclick='event.stopPropagation(); printOrder("${order.id}")'>üñ®Ô∏è Imprimir</button>
          <button style='background:#9c27b0;color:#fff; padding: 5px 8px; border: none; border-radius: 5px; cursor: pointer;' onclick='event.stopPropagation(); showOrderTimeline("${order.id}")'>üìú Hist√≥rico</button>
        </div>
      </div>`;

    div.innerHTML=`<div class='order-card-header'>
        <span>Pedido #${order.id.substring(0,7)}</span>
        <span>R$ ${formatBRL(order.total)}</span>
      </div>
      ${detailsHTML}
    `;

    

    if(normalizedStatus==="pending") colPending.appendChild(div);
    else if(normalizedStatus==="in_production" || order.status==="accepted") colInProduction.appendChild(div);
    else if(normalizedStatus==="ready_for_delivery") colReadyForDelivery.appendChild(div);
    else if(normalizedStatus==="delivered") colDelivered.appendChild(div);
    // Pedidos cancelados n√£o s√£o exibidos no Kanban
  });
}




window.filterOrdersByPeriod = function(orders, period) {
  const now = new Date();
  let startDate;

  switch (period) {
    case 'day':
      startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      break;
    case 'week':
      // Come√ßa no domingo (0)
      const dayOfWeek = now.getDay();
      startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - dayOfWeek);
      startDate.setHours(0, 0, 0, 0);
      break;
    case 'month':
      startDate = new Date(now.getFullYear(), now.getMonth(), 1);
      break;
    case 'custom':
      const startInput = document.getElementById('startDate');
      const endInput = document.getElementById('endDate');
      
      if (!startInput.value || !endInput.value) {
        alert('Por favor, selecione as datas de in√≠cio e fim para o filtro personalizado.');
        return []; // Retorna lista vazia se as datas n√£o estiverem preenchidas
      }
      
      // Converte as strings de data para objetos Date
      const customStart = new Date(startInput.value + 'T00:00:00');
      const customEnd = new Date(endInput.value + 'T23:59:59'); // Inclui o dia final
      
      return orders.filter(order => {
        const orderDate = new Date(order.createdAt);
        return orderDate >= customStart && orderDate <= customEnd;
      });
    case 'total':
    default:
      // N√£o filtra, retorna todos os pedidos
      return orders;
  }

  return orders.filter(order => {
    const orderDate = new Date(order.createdAt);
    return orderDate >= startDate;
  });
}

window.calculateDailySales = function() {
  const salesByDay = {}; // { 'YYYY-MM-DD': total }
  
  // Filtra apenas pedidos entregues
  const deliveredOrders = ((orders || [])).filter(o => o.status === 'delivered');
  
  ((deliveredOrders || [])).forEach(order => {
    // O createdAt √© um timestamp do Firebase, convertemos para objeto Date
    const date = new Date(order.createdAt);
    // Formata a data para o formato 'YYYY-MM-DD'
    const dateKey = date.toISOString().split('T')[0];
    
    // O total do pedido j√° inclui subtotal e taxa de entrega
    const total = order.total || 0; 
    
    salesByDay[dateKey] = (salesByDay[dateKey] || 0) + total;
  });
  
  // Prepara os dados para o Chart.js (√∫ltimos 7 dias)
  const chartData = { labels: [], data: [] };
  const today = new Date();
  
  for (let i = 6; i >= 0; i--) {
    const date = new Date(today);
    date.setDate(today.getDate() - i);
    const dateKey = date.toISOString().split('T')[0];
    
    // R√≥tulo: Dia da Semana (DD/MM)
    const dayOfWeek = date.toLocaleDateString('pt-BR', { weekday: 'short' });
    const dayMonth = date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
    const label = `${dayOfWeek} (${dayMonth})`;
    
    const sales = salesByDay[dateKey] || 0;
    
    chartData.labels.push(label);
    chartData.data.push(sales);
  }
  
  return chartData;
}

window.renderSalesMetrics = function() {
  // 1. Filtra pedidos entregues
  const allDeliveredOrders = ((orders || [])).filter(o => o.status === 'delivered');
  
  // Filtra os pedidos pelo per√≠odo selecionado
  const filteredOrders = filterOrdersByPeriod(allDeliveredOrders, currentSalesPeriod);
  
  // Calcula m√©tricas com base nos pedidos filtrados
  const totalSales = filteredOrders.reduce((sum, order) => sum + (order.total || 0), 0);
  const totalCount = filteredOrders.length;
  const avgTicket = totalCount > 0 ? totalSales / totalCount : 0;

  // 2. Calcula Top Produtos
  const productSales = {};
  filteredOrders.forEach(order => {
    (order.items || []).forEach(item => {
      const name = item.name;
      productSales[name] = (productSales[name] || 0) + item.qty;
    });
  });
  const topProducts = Object.entries(productSales)
    .sort(([, a], [, b]) => b - a)
    .slice(0, 10);

  // 3. Calcula Formas de Pagamento
  const paymentCounts = {};
  filteredOrders.forEach(order => {
    const method = order.paymentMethod || 'Outro';
    paymentCounts[method] = (paymentCounts[method] || 0) + 1;
  });
  const totalPayments = Object.values(paymentCounts).reduce((sum, count) => sum + count, 0);
  const paymentStats = Object.entries(paymentCounts).map(([method, count]) => ({
    method,
    count,
    percentage: totalPayments > 0 ? (count / totalPayments) * 100 : 0
  }));

  // 4. Calcula Performance por √Årea de Entrega
  const areaStats = {};
  filteredOrders.forEach(order => {
    const area = order.deliveryAreaName || 'Retirada/Local';
    areaStats[area] = areaStats[area] || { count: 0, total: 0 };
    areaStats[area].count += 1;
    areaStats[area].total += (order.total || 0);
  });
  const topArea = Object.entries(areaStats).sort(([, a], [, b]) => b.count - a.count)[0];

  // NOVO: 4.6. Calcula Relat√≥rio de Motoboys
  const motoboyStats = {};
  filteredOrders.forEach(order => {
    if (order.motoboyId && order.motoboyName) {
      const id = order.motoboyId;
      const name = order.motoboyName;
      const total = order.total || 0;

      if (!motoboyStats[id]) {
        motoboyStats[id] = { name: name, count: 0, total: 0 };
      }
      motoboyStats[id].count += 1;
      motoboyStats[id].total += total;
    }
  });

  const motoboyReport = Object.values(motoboyStats)
    .map(m => ({ ...m, avg: m.count > 0 ? m.total / m.count : 0 }))
    .sort((a, b) => b.count - a.count); // Ordena por total de entregas

  // NOVO: 4.5. Calcula Top Clientes
  const customerStats = {};
  filteredOrders.forEach(order => {
    const customerId = order.userId || 'cliente_anonimo';
    const customerName = order.userName || 'Cliente An√¥nimo';
    if (!customerStats[customerId]) {
      customerStats[customerId] = { name: customerName, count: 0, total: 0 };
    }
    customerStats[customerId].count += 1;
    customerStats[customerId].total += (order.total || 0);
  });

  const topCustomers = Object.values(customerStats)
    .map(c => ({ ...c, avg: c.count > 0 ? c.total / c.count : 0 }))
    .sort((a, b) => b.total - a.total)
    .slice(0, 10);

  // 5. Renderiza Cards
  const cardCount = document.getElementById('cardCount');
  if (cardCount) cardCount.textContent = totalCount;
  const cardAvg = document.getElementById('cardAvg');
  if (cardAvg) cardAvg.textContent = formatBRL(avgTicket);
  const cardRevenue = document.getElementById('cardRevenue');
  if (cardRevenue) cardRevenue.textContent = formatBRL(totalSales); // Total de Vendas (Corrigido o ID)
  const cardTopArea = document.getElementById('cardTopArea');
  if (cardTopArea) cardTopArea.textContent = topArea ? topArea[0] : 'N/A';

  // NOVO: 5.6. Renderiza Tabela Relat√≥rio de Motoboys
  const tableMotoboyReportBody = document.querySelector('#tableMotoboyReport tbody');
  if (tableMotoboyReportBody) {
    tableMotoboyReportBody.innerHTML = '';
    if (motoboyReport.length === 0) {
        tableMotoboyReportBody.innerHTML = '<tr><td colspan="4" style="padding:8px;color:var(--muted);text-align:center;">Nenhum motoboy com entregas no per√≠odo.</td></tr>';
    } else {
        motoboyReport.forEach(motoboy => {
            tableMotoboyReportBody.innerHTML += `
              <tr>
                <td style="padding:8px;border-bottom:1px solid #eee">${motoboy.name}</td>
                <td style="padding:8px;border-bottom:1px solid #eee">${motoboy.count}</td>
                <td style="padding:8px;border-bottom:1px solid #eee">${formatBRL(motoboy.total)}</td>
                <td style="padding:8px;border-bottom:1px solid #eee">${formatBRL(motoboy.avg)}</td>
              </tr>
            `;
        });
    }
  }

  // NOVO: 5.5. Renderiza Tabela Top Clientes
  const tableTopCustomersBody = document.querySelector('#tableTopCustomers tbody');
  if (tableTopCustomersBody) {
    tableTopCustomersBody.innerHTML = '';
    if (topCustomers.length === 0) {
        tableTopCustomersBody.innerHTML = '<tr><td colspan="5" style="padding:8px;color:var(--muted);text-align:center;">Nenhum cliente encontrado no per√≠odo.</td></tr>';
    } else {
        topCustomers.forEach((customer, index) => {
            tableTopCustomersBody.innerHTML += `
              <tr>
                <td style="padding:8px;border-bottom:1px solid #eee">${index + 1}</td>
                <td style="padding:8px;border-bottom:1px solid #eee">${customer.name}</td>
                <td style="padding:8px;border-bottom:1px solid #eee">${customer.count}</td>
                <td style="padding:8px;border-bottom:1px solid #eee">${formatBRL(customer.total)}</td>
                <td style="padding:8px;border-bottom:1px solid #eee">${formatBRL(customer.avg)}</td>
              </tr>
            `;
        });
    }
  }
  
  // Garante que o bot√£o ativo est√° com o estilo correto ap√≥s a renderiza√ß√£o
  document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
  const activeBtn = document.querySelector(`#periodFilters button[data-period="${currentSalesPeriod}"]`);
  if (activeBtn) {
    activeBtn.classList.add('active');
  }

  // 6. Renderiza Tabela Top Produtos
  const tableTopProductsBody = document.querySelector('#tableTopProducts tbody');
  if (!tableTopProductsBody) return;
  tableTopProductsBody.innerHTML = '';
  topProducts.forEach(([name, qty], index) => {
    tableTopProductsBody.innerHTML += `
      <tr>
        <td style="padding:8px;border-bottom:1px solid #eee">${index + 1}</td>
        <td style="padding:8px;border-bottom:1px solid #eee">${name}</td>
        <td style="padding:8px;border-bottom:1px solid #eee">${qty}</td>
      </tr>
    `;
  });

  // 7. Renderiza Tabela Formas de Pagamento
  const tablePaymentsBody = document.querySelector('#tablePayments tbody');
  if (!tablePaymentsBody) return;
  tablePaymentsBody.innerHTML = '';
  paymentStats.forEach(stat => {
    tablePaymentsBody.innerHTML += `
      <tr>
        <td style="padding:8px;border-bottom:1px solid #eee">${stat.method}</td>
        <td style="padding:8px;border-bottom:1px solid #eee">${stat.count}</td>
        <td style="padding:8px;border-bottom:1px solid #eee">${stat.percentage.toFixed(1)}%</td>
      </tr>
    `;
  });

  // 8. Renderiza Tabela Performance por √Årea
  const tableAreasBody = document.querySelector('#tableAreas tbody');
  if (!tableAreasBody) return;
  tableAreasBody.innerHTML = '';
  Object.entries(areaStats).forEach(([area, stats]) => {
    tableAreasBody.innerHTML += `
      <tr>
        <td style="padding:8px;border-bottom:1px solid #eee">${area}</td>
        <td style="padding:8px;border-bottom:1px solid #eee">${stats.count}</td>
        <td style="padding:8px;border-bottom:1px solid #eee">${formatBRL(stats.total)}</td>
      </tr>
    `;
  });

  // NOVO: 9. Calcula e Renderiza Gr√°fico de Picos de Hor√°rio
  const peakHoursData = calculatePeakHours(filteredOrders);
  renderPeakHoursChart(peakHoursData);
}

/**
 * Calcula a quantidade de pedidos por hora do dia.
 * @param {Array} orders - Lista de pedidos filtrados.
 * @returns {Object} - { labels: Array, data: Array }
 */
function calculatePeakHours(orders) {
    const hourlyCounts = new Array(24).fill(0); // 0 a 23 horas

    orders.forEach(order => {
        const date = new Date(order.createdAt);
        const hour = date.getHours();
        if (hour >= 0 && hour <= 23) {
            hourlyCounts[hour]++;
        }
    });

    const labels = hourlyCounts.map((_, index) => `${index}h`);
    
    return { labels: labels, data: hourlyCounts };
}

let peakHoursChartInstance = null;

/**
 * Renderiza o gr√°fico de picos de hor√°rio.
 * @param {Object} data - Dados do gr√°fico.
 */
function renderPeakHoursChart(data) {
    const chartCanvas = document.getElementById('peakHoursChart');
    if (!chartCanvas) return;

    const ctx = chartCanvas.getContext('2d');
    if (!ctx) return;

    if (peakHoursChartInstance) {
        // Atualiza os dados do gr√°fico existente
        peakHoursChartInstance.data.labels = data.labels;
        peakHoursChartInstance.data.datasets[0].data = data.data;
        peakHoursChartInstance.update();
    } else {
        // Cria um novo gr√°fico
        peakHoursChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'Quantidade de Pedidos',
                    data: data.data,
                    backgroundColor: 'rgba(255, 99, 132, 0.6)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Pedidos'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Hora do Dia'
                        }
                    }
                }
            }
        });
    }
}

let currentSalesPeriod = 'total'; // Vari√°vel global para o per√≠odo de vendas

window.setSalesPeriod = function(period) {
  // L√≥gica de valida√ß√£o para o filtro 'custom'
  if (period === 'custom') {
    const startInput = document.getElementById('startDate');
    const endInput = document.getElementById('endDate');
    
    if (!startInput.value || !endInput.value) {
      alert('Por favor, selecione as datas de in√≠cio e fim para o filtro personalizado.');
      // N√£o muda o per√≠odo atual se a valida√ß√£o falhar
      return; 
    }
  }
  
  currentSalesPeriod = period;
  
  // Remove a classe 'active' de todos os bot√µes
  document.querySelectorAll('.period-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  // Adiciona a classe 'active' ao bot√£o clicado
  const activeBtn = document.querySelector(`#periodFilters button[data-period="${period}"]`);
  if (activeBtn) {
    activeBtn.classList.add('active');
  }
  
  // Recalcula e renderiza o dashboard com o novo per√≠odo
  renderAdminDashboard();
}

window.renderAdminDashboard = function() {
  // O gr√°fico de vendas di√°rias (calculateDailySales) √© mantido para os √∫ltimos 7 dias,
  // mas as m√©tricas (renderSalesMetrics) ser√£o filtradas pelo per√≠odo.
  const { labels, data } = calculateDailySales();
  
  renderSalesMetrics(); // Adicionado: Renderiza as m√©tricas e tabelas
  // O gr√°fico de picos de hor√°rio √© renderizado dentro de renderSalesMetrics, que usa os pedidos filtrados.

  if (!salesChartInstance) {
    const chartCanvas = document.getElementById('salesChart');
    if(chartCanvas){
      const ctx = chartCanvas.getContext('2d');
      if (!ctx) return; // Adiciona verifica√ß√£o de seguran√ßa para o contexto
    salesChartInstance = new Chart(ctx, {
      type: 'bar', // Pode ser 'line', 'bar', 'pie', etc.
      data: {
        labels: labels,
        datasets: [{
          label: 'Vendas Di√°rias (R$)',
          data: data,
          backgroundColor: 'rgba(128, 0, 128, 0.6)',
          borderColor: 'rgba(128, 0, 128, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false, // Permite que o gr√°fico preencha o cont√™iner
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
    }
  } else {
    // Atualiza os dados do gr√°fico existente
    salesChartInstance.data.labels = labels;
    salesChartInstance.data.datasets[0].data = data;
    salesChartInstance.update();
  }
}

function renderAdminCustomers() {
  const list = document.querySelector("#customersList");
  list.innerHTML = '';
  
  if (users.length === 0) {
    list.innerHTML = '<div class="item-management-note" style="border-left: 4px solid #17a2b8;">Nenhum cliente encontrado no Firebase.</div>';
    return;
  }
  
  // Cria uma lista simples de clientes (dados locais para a demo)
  ((users || [])).forEach(user => {
    const div = document.createElement('div');
    div.style.cssText = 'border: 1px solid #eee; border-radius: 6px; padding: 10px; margin-bottom: 8px;';
    div.innerHTML = `
      <div style="font-weight: 600;">${user.name}</div>
      <div class="small" style="color:var(--muted);">Email: ${user.email} ‚Ä¢ Tel: ${user.phone || 'N/A'}</div>
    `;
    list.appendChild(div);
  });
}

// --- Fun√ß√µes de Renderiza√ß√£o da Aba de Configura√ß√µes ---
function renderAdminSettings() {
    loadStoreSettings();
    renderDeliveryAreas();
}

// --- Store Settings ---

function loadStoreSettings() {
    document.querySelector("#restaurantName").value = DATA.restaurant.name;
    document.querySelector("#restaurantAddress").value = DATA.restaurant.address;
    document.querySelector("#restaurantStatus").value = DATA.restaurant.status;
    document.querySelector("#currentLogoPreview").src = DATA.restaurant.logo || blankSVG();
    document.querySelector("#restaurantLogoUrl").value = DATA.restaurant.logo || "";
    
    // NOVO: Carregar tempo de preparo
    document.querySelector("#preparationTime").value = DATA.restaurant.preparationTime || 30;
    
    // Carregar configura√ß√µes de entrega por raio
    document.querySelector("#useRadiusDelivery").checked = DATA.restaurant.useRadiusDelivery || false;
    document.querySelector("#deliveryBaseFee").value = DATA.restaurant.deliveryBaseFee || 0;
    document.querySelector("#deliveryFeePerKm").value = DATA.restaurant.deliveryFeePerKm || 0;
    document.querySelector("#restaurantLat").value = DATA.restaurant.restaurantLat || 0;
    document.querySelector("#restaurantLng").value = DATA.restaurant.restaurantLng || 0;
    
    renderCoupons();
    renderSmartCouponAdminPanel(); // Renderiza painel de cupons inteligentes
}

// Fun√ß√£o para geocodificar endere√ßo usando LocationIQ (Mais precisa que Nominatim)
async function geocodeNominatim(address) {
    const LOCATIONIQ_TOKEN = "pk.5397f7129040e1f4b75902dabfe31805";
    const url = `https://us1.locationiq.com/v1/search.php?key=${LOCATIONIQ_TOKEN}&q=${encodeURIComponent(address)}&format=json&limit=1`;

    const response = await fetch(url);

    const data = await response.json();
    
    // LocationIQ retorna um array vazio ou um objeto de erro
    if (!Array.isArray(data) || !data.length) {
        // Verifica se √© um erro de API (ex: limite excedido)
        if (data.error) {
            throw new Error(`Erro na API LocationIQ: ${data.error}`);
        }
        throw new Error("Endere√ßo n√£o encontrado");
    }

    return {
        lat: parseFloat(data[0].lat),
        lng: parseFloat(data[0].lon)
    };
}

// Fun√ß√£o para calcular dist√¢ncia entre dois pontos usando f√≥rmula de Haversine
function calculateDistance(lat1, lng1, lat2, lng2) {
    const R = 6371; // Raio da Terra em km
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLng = (lng2 - lng1) * Math.PI / 180;
    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLng / 2) * Math.sin(dLng / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c; // Dist√¢ncia em km
}

async function saveStoreSettings(e) {
    e.preventDefault();
    if (!isAdmin) return;

    const fileInput = document.querySelector("#restaurantLogoFile");
    let newLogoUrl = DATA.restaurant.logo || blankSVG();

    if (fileInput.files.length > 0) {
        try {
            newLogoUrl = await fileToBase64(fileInput.files[0]);
        } catch (error) {
            alert("Erro ao ler o arquivo de logo.");
            return;
        }
    }

    DATA.restaurant.name = document.querySelector("#restaurantName").value;
    DATA.restaurant.address = document.querySelector("#restaurantAddress").value;
    DATA.restaurant.status = document.querySelector("#restaurantStatus").value;
    DATA.restaurant.logo = newLogoUrl;
    
    // NOVO: Salvar tempo de preparo
    DATA.restaurant.preparationTime = parseInt(document.querySelector("#preparationTime").value || "30");
    
    // Salvar configura√ß√µes de entrega por raio
    DATA.restaurant.useRadiusDelivery = document.querySelector("#useRadiusDelivery").checked;
    DATA.restaurant.deliveryBaseFee = parseFloat(document.querySelector("#deliveryBaseFee").value || "0");
    DATA.restaurant.deliveryFeePerKm = parseFloat(document.querySelector("#deliveryFeePerKm").value || "0");
    
    // Geocodificar endere√ßo da loja se o modo raio estiver ativado
    if (DATA.restaurant.useRadiusDelivery) {
        try {
            const coords = await geocodeNominatim(DATA.restaurant.address);
            DATA.restaurant.restaurantLat = coords.lat;
            DATA.restaurant.restaurantLng = coords.lng;
            document.querySelector("#restaurantLat").value = coords.lat;
            document.querySelector("#restaurantLng").value = coords.lng;
        } catch (error) {
            alert("Erro ao geocodificar o endere√ßo da loja: " + error.message + ". Verifique o endere√ßo e tente novamente.");
            // Se houver erro, retorna para n√£o salvar as configura√ß√µes
            return;
        }
    } else {
        DATA.restaurant.restaurantLat = parseFloat(document.querySelector("#restaurantLat").value || "0");
        DATA.restaurant.restaurantLng = parseFloat(document.querySelector("#restaurantLng").value || "0");
    }
    
    // O deliveryAreas j√° foi atualizado via onchange/onclick

    await saveMenuData();
    renderAll(); // Atualiza a header
    alert("Configura√ß√µes da loja salvas com sucesso!");
    // N√£o fecha o modal para permitir mais edi√ß√µes
}

function renderDeliveryAreas() {
  const list = document.querySelector("#deliveryAreasList");
  list.innerHTML = '';
  
  if (DATA.restaurant.deliveryAreas.length === 0) {
    list.innerHTML = '<div class="item-management-note">Nenhuma √°rea de entrega cadastrada. Os clientes n√£o conseguir√£o finalizar o pedido sem uma taxa.</div>';
    return;
  }
  
  ((DATA.restaurant.deliveryAreas || [])).forEach((area, index) => {
    const div = document.createElement('div');
    div.classList.add('delivery-area-row');
    div.innerHTML = `
      <input type="text" value="${area.name}" placeholder="Nome da √Årea (ex: Bairro X)" class="area-name-input" 
             onchange="updateDeliveryAreaProp('${area.id}', 'name', this.value)">
      <input type="number" value="${area.fee}" step="0.01" placeholder="Taxa (R$)" class="area-fee-input" 
             onchange="updateDeliveryAreaProp('${area.id}', 'fee', parseFloat(this.value))">
      <button type="button" class="pill" style="background:#dc3545; color:white; padding:4px 8px;" onclick="removeDeliveryArea('${area.id}')">Remover</button>
    `;
    list.appendChild(div);
  });

  // Atualiza o seletor de checkout
  renderCheckoutDeliveryAreas();
}

function addDeliveryArea() {
  if (!isAdmin) return;
  const newArea = {
    id: Date.now().toString(),
    name: "Nova √Årea",
    fee: 0.00
  };
  DATA.restaurant.deliveryAreas.push(newArea);
  renderDeliveryAreas();
}

function removeDeliveryArea(areaId) {
  if (!isAdmin || !confirm("Tem certeza que deseja remover esta √°rea de entrega?")) return;
  DATA.restaurant.deliveryAreas = ((DATA.restaurant.deliveryAreas || [])).filter(a => a.id !== areaId);
  renderDeliveryAreas();
}

function updateDeliveryAreaProp(areaId, prop, value) {
  const area = DATA.restaurant.deliveryAreas.find(a => a.id === areaId);
  if (area) {
    area[prop] = value;
    // O saveMenuData ser√° chamado no saveStoreSettings
  }
}

// --- Cupons de Desconto ---

let appliedCoupon = null; // Armazena o cupom aplicado no checkout

function renderCoupons() {
  const list = document.querySelector("#couponsList");
  list.innerHTML = '';
  
  if (!DATA.restaurant.coupons) {
    DATA.restaurant.coupons = [];
  }
  
  if (DATA.restaurant.coupons.length === 0) {
    list.innerHTML = '<div class="item-management-note">Nenhum cupom cadastrado.</div>';
    return;
  }
  
  ((DATA.restaurant.coupons || [])).forEach((coupon) => {
    const div = document.createElement('div');
    div.classList.add('delivery-area-row');
    
    const typeLabel = coupon.type === 'percent' ? '%' : 'R$';
    const statusLabel = coupon.active ? '‚úÖ Ativo' : '‚ùå Inativo';
    const expiryDate = new Date(coupon.expiresAt).toLocaleDateString('pt-BR');
    
    div.innerHTML = `
      <div style="flex:1; padding:8px; background:#f9f9f9; border-radius:6px;">
        <strong>${coupon.code}</strong> - ${coupon.value}${typeLabel} | M√≠n: ${formatBRL(coupon.minSubtotal)}<br>
        <small>Expira: ${expiryDate} | Usos: ${coupon.usedCount || 0}/${coupon.maxUses} | ${statusLabel}</small>
      </div>
      <button type="button" class="pill" style="background:#dc3545; color:white;" 
              onclick="removeCoupon('${coupon.id}')">Excluir</button>
    `;
    list.appendChild(div);
  });
}

function openCouponModal(couponId = null) {
  if (!isAdmin) return;
  
  const modal = document.querySelector("#couponModal");
  const form = document.querySelector("#couponForm");
  form.reset();
  
  if (couponId) {
    const coupon = DATA.restaurant.coupons.find(c => c.id === couponId);
    if (coupon) {
      document.querySelector("#couponModalTitle").textContent = "Editar Cupom";
      document.querySelector("#couponIdEdit").value = coupon.id;
      document.querySelector("#couponCode").value = coupon.code;
      document.querySelector("#couponType").value = coupon.type;
      document.querySelector("#couponValue").value = coupon.value;
      document.querySelector("#couponMinSubtotal").value = coupon.minSubtotal;
      document.querySelector("#couponExpiresAt").value = coupon.expiresAt;
      document.querySelector("#couponMaxUses").value = coupon.maxUses;
      document.querySelector("#couponActive").checked = coupon.active;
    }
  } else {
    document.querySelector("#couponModalTitle").textContent = "Criar Novo Cupom";
    document.querySelector("#couponActive").checked = true;
  }
  
  modal.classList.add('open');
}

function closeCouponModal() {
  document.querySelector("#couponModal").classList.remove('open');
  document.querySelector("#couponForm").reset();
}

async function saveCoupon(e) {
  e.preventDefault();
  if (!isAdmin) return;
  
  const couponId = document.querySelector("#couponIdEdit").value;
  const code = document.querySelector("#couponCode").value.trim().toUpperCase();
  const type = document.querySelector("#couponType").value;
  const value = parseFloat(document.querySelector("#couponValue").value);
  const minSubtotal = parseFloat(document.querySelector("#couponMinSubtotal").value);
  const expiresAt = document.querySelector("#couponExpiresAt").value;
  const maxUses = parseInt(document.querySelector("#couponMaxUses").value);
  const active = document.querySelector("#couponActive").checked;
  
  // Valida√ß√µes
  if (!code) {
    alert("C√≥digo do cupom √© obrigat√≥rio.");
    return;
  }
  
  if (value <= 0) {
    alert("Valor do desconto deve ser maior que zero.");
    return;
  }
  
  if (type === 'percent' && value > 100) {
    alert("Desconto percentual n√£o pode ser maior que 100%.");
    return;
  }
  
  // Verifica duplica√ß√£o de c√≥digo
  const existingCoupon = DATA.restaurant.coupons.find(c => c.code === code && c.id !== couponId);
  if (existingCoupon) {
    alert("J√° existe um cupom com este c√≥digo.");
    return;
  }
  
  if (couponId) {
    // Editar cupom existente
    const coupon = DATA.restaurant.coupons.find(c => c.id === couponId);
    if (coupon) {
      coupon.code = code;
      coupon.type = type;
      coupon.value = value;
      coupon.minSubtotal = minSubtotal;
      coupon.expiresAt = expiresAt;
      coupon.maxUses = maxUses;
      coupon.active = active;
    }
  } else {
    // Criar novo cupom
    const newCoupon = {
      id: Date.now().toString(),
      code: code,
      type: type,
      value: value,
      minSubtotal: minSubtotal,
      expiresAt: expiresAt,
      maxUses: maxUses,
      usedCount: 0,
      active: active
    };
    DATA.restaurant.coupons.push(newCoupon);
  }
  
  await saveMenuData();
  renderCoupons();
  closeCouponModal();
  alert("Cupom salvo com sucesso!");
}

function removeCoupon(couponId) {
  if (!isAdmin || !confirm("Tem certeza que deseja remover este cupom?")) return;
  DATA.restaurant.coupons = ((DATA.restaurant.coupons || [])).filter(c => c.id !== couponId);
  renderCoupons();
}

function applyCoupon() {
  const code = document.querySelector("#checkoutCoupon").value.trim().toUpperCase();
  const messageEl = document.querySelector("#couponMessage");
  
  if (!code) {
    messageEl.textContent = "Digite um c√≥digo de cupom.";
    messageEl.style.color = "#dc3545";
    return;
  }
  
  // =========================================================
  // [NOVO] L√ìGICA DE VALIDA√á√ÉO DE CUPOM INTELIGENTE
  // =========================================================
  // Assume que 'currentUser' e 'orders' s√£o globais
  const userOrders = currentUser ? (window.orders || []).filter(o => o.userId === currentUser.id) : [];
  const smartCoupon = currentUser ? generateSmartCoupons(currentUser, userOrders) : null;
  
  if (smartCoupon && code === smartCoupon.code) {
    // Encontrou um cupom inteligente v√°lido!
    console.log(`Cupom Inteligente '${smartCoupon.code}' aplicado com sucesso!`);
    
    // Cria um objeto de cupom compat√≠vel com a estrutura existente
    appliedCoupon = {
      ...smartCoupon,
      id: 'smart-' + smartCoupon.code,
      code: smartCoupon.code,
      type: smartCoupon.type,
      value: smartCoupon.value,
      minSubtotal: 0, // Cupom inteligente n√£o tem m√≠nimo
      active: true,
      isSmart: true
    };
    
    messageEl.textContent = `‚úÖ ${smartCoupon.description}`;
    messageEl.style.color = "#28a745";
    updateCheckoutTotalWithCoupon();
    return;
  }
  // =========================================================
  
  const coupon = DATA.restaurant.coupons.find(c => c.code === code);
  
  if (!coupon) {
    messageEl.textContent = "‚ùå Cupom inv√°lido.";
    messageEl.style.color = "#dc3545";
    appliedCoupon = null;
    updateCheckoutTotalWithCoupon();
    return;
  }
  
  if (!coupon.active) {
    messageEl.textContent = "‚ùå Cupom inativo.";
    messageEl.style.color = "#dc3545";
    appliedCoupon = null;
    updateCheckoutTotalWithCoupon();
    return;
  }
  
  const today = new Date().toISOString().split('T')[0];
  if (coupon.expiresAt < today) {
    messageEl.textContent = "‚ùå Cupom expirado.";
    messageEl.style.color = "#dc3545";
    appliedCoupon = null;
    updateCheckoutTotalWithCoupon();
    return;
  }
  
  if (coupon.usedCount >= coupon.maxUses) {
    messageEl.textContent = "‚ùå Limite de uso atingido.";
    messageEl.style.color = "#dc3545";
    appliedCoupon = null;
    updateCheckoutTotalWithCoupon();
    return;
  }
  
  const subtotal = cart.reduce((sum, item) => sum + item.totalPrice, 0);
  
  if (subtotal < coupon.minSubtotal) {
    messageEl.textContent = `‚ùå Valor m√≠nimo de ${formatBRL(coupon.minSubtotal)} n√£o atingido.`;
    messageEl.style.color = "#dc3545";
    appliedCoupon = null;
    updateCheckoutTotalWithCoupon();
    return;
  }
  
  // Cupom v√°lido!
  appliedCoupon = coupon;
  messageEl.textContent = `‚úÖ Cupom aplicado com sucesso!`;
  messageEl.style.color = "#28a745";
  updateCheckoutTotalWithCoupon();
}

function updateCheckoutTotalWithCoupon() {
  let deliveryFee = 0;
  let areaName = "N/A";
  
  // Verifica se o modo autom√°tico por raio est√° ativado
  if (DATA.restaurant.useRadiusDelivery && window.autoDeliveryFee) {
    deliveryFee = window.autoDeliveryFee;
    areaName = window.autoDeliveryDistanceKm.toFixed(1) + " km";
  } else {
    const selectedOption = document.querySelector("#deliveryAreaSelect").options[document.querySelector("#deliveryAreaSelect").selectedIndex];
    if (selectedOption && selectedOption.dataset.fee) {
      deliveryFee = parseFloat(selectedOption.dataset.fee);
      areaName = selectedOption.textContent.split('(')[0].trim();
    }
  }
  
  const subtotal = cart.reduce((sum, item) => sum + item.totalPrice, 0);
  let discount = 0;
  
  if (appliedCoupon) {
    if (appliedCoupon.type === 'percent') {
      discount = subtotal * (appliedCoupon.value / 100);
    } else {
      discount = appliedCoupon.value;
    }
    
    // Garante que o desconto n√£o seja maior que o subtotal
    if (discount > subtotal) {
      discount = subtotal;
    }
  }
  
  const total = subtotal - discount + deliveryFee;
  
  document.querySelector("#checkoutSubtotal").textContent = formatBRL(subtotal);
  document.querySelector("#checkoutDeliveryFee").textContent = formatBRL(deliveryFee);
  document.querySelector("#checkoutAreaName").textContent = areaName;
  document.querySelector("#checkoutTotal").textContent = formatBRL(total);
  
  const discountRow = document.querySelector("#checkoutDiscountRow");
  if (appliedCoupon && discount > 0) {
    discountRow.style.display = 'flex';
    discountRow.dataset.visible = 'true';
    document.querySelector("#checkoutCouponCode").textContent = appliedCoupon.code;
    document.querySelector("#checkoutDiscount").textContent = "- " + formatBRL(discount);
  } else {
    discountRow.style.display = 'none';
    discountRow.dataset.visible = 'false';
  }
  
  if (total > 0) {
    document.querySelector("#checkoutSubmit").removeAttribute('disabled');
  }
}

// --- Checkout Modal ---

function openCheckoutModal(){
    if (cart.length === 0) {
        alert("Seu carrinho est√° vazio!");
        return;
    }
    if (!currentUser) {
        alert("Por favor, fa√ßa login ou cadastre-se para finalizar o pedido.");
        openAuthModal();
        return;
    }

    // Preenche os campos do usu√°rio
    document.querySelector("#checkoutName").value = currentUser.name;
    document.querySelector("#checkoutPhone").value = currentUser.phone || '';
    
    renderCheckoutCartSummary();
    renderCheckoutDeliveryAreas();
    renderCheckoutSavedAddresses();
    
    // Oculta ou mostra o seletor de √°rea de entrega baseado no modo
    const deliveryAreaSelect = document.querySelector("#deliveryAreaSelect");
    const deliveryAreaGroup = deliveryAreaSelect.closest('.form-group');
    if (DATA.restaurant.useRadiusDelivery) {
      deliveryAreaGroup.style.display = 'none';
      deliveryAreaSelect.removeAttribute('required');
    } else {
      deliveryAreaGroup.style.display = 'block';
      deliveryAreaSelect.setAttribute('required', 'required');
    }
    
    // Tenta preencher o endere√ßo com o primeiro salvo se houver
    if (currentUser.savedAddresses && currentUser.savedAddresses.length > 0) {
      document.querySelector("#checkoutAddress").value = currentUser.savedAddresses[0];
      document.querySelector("#checkoutSavedAddresses").value = currentUser.savedAddresses[0];
    } else {
      document.querySelector("#checkoutAddress").value = '';
    }
    
    // Limpa valores autom√°ticos anteriores
    window.autoDeliveryFee = null;
    window.autoDeliveryDistanceKm = null;
    
    // Recalcula o total (inicialmente com 0 de taxa)
    updateCheckoutTotal(0, "N/A");

    document.querySelector("#checkoutModal").classList.add('open');
}

function closeCheckoutModal(){
    document.querySelector("#checkoutModal").classList.remove('open');
    document.querySelector("#checkoutForm").reset();
    appliedCoupon = null;
    document.querySelector("#couponMessage").textContent = '';
    document.querySelector("#checkoutDiscountRow").style.display = 'none';
}

function renderCheckoutCartSummary() {
    const summary = document.querySelector("#checkoutCartSummary");
    summary.innerHTML = '';
    
    ((cart || [])).forEach(item => {
        const div = document.createElement('div');
        div.style.cssText = 'font-size:13px; margin-bottom: 4px; border-bottom: 1px dotted #eee; padding-bottom: 4px;';
        div.innerHTML = `
            <div style="display:flex; justify-content:space-between;">
                <span>${item.qty}x ${item.name}</span>
                <span>${formatBRL(item.totalPrice)}</span>
            </div>
        `;
        // Adicionais
        if(item.addons && item.addons.length > 0){
             ((item.addons || [])).forEach(group => {
                ((group.selected || [])).forEach(addon => {
                    const originalItem = getItem(item.itemId);
                    const originalGroup = originalItem.addonGroups.find(g => g.id === addon.groupId);
                    
                    // Adiciona verifica√ß√£o de seguran√ßa para evitar erro se o grupo n√£o for encontrado
                    if (!originalGroup) return; 
                    
                    const originalAddon = originalGroup ? originalGroup.addons.find(a => a.id === addon.addonId) : null;
                    
                    if (originalAddon && addon.qty > 0) {
                        const addonLine = document.createElement('div');
                        addonLine.classList.add('small');
                        addonLine.style.cssText = 'color:var(--muted); margin-left: 15px;';
                        addonLine.textContent = `+ ${addon.qty}x ${originalAddon.name}`;
                        div.appendChild(addonLine);
                    }
                });
            });
        }
        summary.appendChild(div);
    });
}

function renderCheckoutDeliveryAreas() {
    const select = document.querySelector("#deliveryAreaSelect");
    select.innerHTML = '<option value="" disabled selected>Selecione sua √°rea...</option>';
    
    ((DATA.restaurant.deliveryAreas || [])).forEach(area => {
        const opt = document.createElement('option');
        opt.value = area.id;
        opt.dataset.fee = area.fee;
        opt.textContent = `${area.name} (${formatBRL(area.fee)})`;
        select.appendChild(opt);
    });
}

function renderCheckoutSavedAddresses() {
  const select = document.querySelector("#checkoutSavedAddresses");
  select.innerHTML = '<option value="" disabled selected>Selecione um endere√ßo salvo...</option>';

  if (currentUser && currentUser.savedAddresses && currentUser.savedAddresses.length > 0) {
    document.querySelector("#checkoutSavedAddressesGroup").style.display = 'block';
    ((currentUser.savedAddresses || [])).forEach(address => {
      const opt = document.createElement('option');
      opt.value = address;
      opt.textContent = address;
      select.appendChild(opt);
    });
  } else {
    document.querySelector("#checkoutSavedAddressesGroup").style.display = 'none';
  }
}


function updateCheckoutTotal(deliveryFee, areaName) {
    updateCheckoutTotalWithCoupon();
}


// --- Confirmation Modal ---

function showConfirmationModal(order) {
  const summary = document.querySelector("#confirmationSummaryContent");
  summary.innerHTML = '';
  
  // Resumo dos itens
  ((order.items || [])).forEach(item => {
    const div = document.createElement('div');
    div.style.cssText = 'font-size:13px; margin-bottom: 4px;';
    div.innerHTML = `
      <div style="display:flex; justify-content:space-between;">
          <span style="font-weight:600;">${item.qty}x ${item.name}</span>
          <span>${formatBRL(item.totalPrice)}</span>
      </div>
      ${item.addons && item.addons.length > 0 ? `
        <div class="small" style="color:var(--muted); margin-left: 10px;">
          + ${((item.addons || [])).map(a => `${a.qty}x ${a.name}`).join(', ')}
        </div>
      ` : ''}
    `;
    summary.appendChild(div);
  });

  // Totais
  let discountHTML = '';
  if (order.discount && order.discount > 0) {
    discountHTML = `
      <div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:4px; color:#28a745;">
        <span>Desconto (${order.couponCode}):</span>
        <span>- ${formatBRL(order.discount)}</span>
      </div>
    `;
  }
  
  // NOVO: Formata o tempo estimado de preparo
  let preparationHTML = '';
  if (order.preparationTime && order.estimatedReadyTime) {
    const readyTime = new Date(order.estimatedReadyTime);
    const formattedTime = readyTime.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
    preparationHTML = `
      <div style="background: #fff7e6; padding: 12px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid #ff9800;">
        <div style="font-weight: 700; color: #ff9800; margin-bottom: 4px;">‚è±Ô∏è Tempo de Preparo</div>
        <div style="font-size: 14px; color: #663300;">
          Seu pedido ficar√° pronto em aproximadamente <strong>${order.preparationTime} minutos</strong>
        </div>
        <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">
          Previs√£o: ${formattedTime}
        </div>
      </div>
    `;
  }
  
  summary.innerHTML += `
      ${preparationHTML}
      <div style="border-top:1px solid #eee; margin-top: 8px; padding-top: 8px;">
          <div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:4px;">
            <span>Subtotal:</span>
            <span>${formatBRL(order.subtotal)}</span>
          </div>
          ${discountHTML}
          <div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:4px;">
            <span>Taxa de Entrega (${order.deliveryAreaName}):</span>
            <span>${formatBRL(order.deliveryFee)}</span>
          </div>
          <div style="display:flex; justify-content:space-between; font-size:16px; font-weight:800; color:var(--primary);">
            <span>TOTAL GERAL:</span>
            <span>${formatBRL(order.total)}</span>
          </div>
      </div>
  `;
  
  document.querySelector("#orderNumberDisplay").textContent = `#${order.id.substring(0, 7).toUpperCase()}`;
  document.querySelector("#confirmationModal").classList.add('open');
}

function closeConfirmationModal(){
    document.querySelector("#confirmationModal").classList.remove('open');
}


// =========================================================================
// === LISTENERS ===
// =========================================================================

function initListeners(){
  // --- Modals de Checkout/Adicionais ---
  document.querySelector("#modalCancel").addEventListener("click", closeModal);
  document.querySelector("#modalConfirm").addEventListener("click", () => {
      if (!document.querySelector("#modalConfirm").disabled) {
          addItemToCart(modalState.item, modalState.qty, modalState.addons);
      }
  });
  
  document.querySelector("#itemQtyControls").addEventListener("click", (e) => {
      if(e.target.dataset.action){
          handleQtyChange(e.target.dataset.action);
      }
  });
  
  document.querySelector("#btnCheckout").addEventListener("click", openCheckoutModal);
  document.querySelector("#checkoutCancel").addEventListener("click", closeCheckoutModal);
  document.querySelector("#checkoutForm").addEventListener("submit", finalizeOrder);
  
  // L√≥gica para mostrar o campo de troco
  document.querySelectorAll('input[name="paymentMethod"]').forEach(input => {
    input.addEventListener('change', (e) => {
        if (e.target.value === 'cash') {
            document.querySelector("#cashChangeGroup").style.display = 'block';
        } else {
            document.querySelector("#cashChangeGroup").style.display = 'none';
            document.querySelector("#cashChange").value = ''; // Limpa o valor do troco
        }
    });
  });

  // L√≥gica para atualizar o total ao selecionar a √°rea de entrega
  document.querySelector("#deliveryAreaSelect").addEventListener('change', (e) => {
    const selectedOption = e.target.options[e.target.selectedIndex];
    if (selectedOption && selectedOption.dataset.fee) {
        const fee = parseFloat(selectedOption.dataset.fee);
        const name = selectedOption.textContent.split('(')[0].trim();
        updateCheckoutTotal(fee, name);
    }
  });
  
  // L√≥gica para preencher o endere√ßo no checkout com o salvo
  document.querySelector("#checkoutSavedAddresses").addEventListener('change', (e) => {
    document.querySelector("#checkoutAddress").value = e.target.value;
  });
  
  // C√°lculo autom√°tico de taxa por raio ao digitar endere√ßo
  let addressTimeout;
  document.querySelector("#checkoutAddress").addEventListener('input', (e) => {
    clearTimeout(addressTimeout);
    addressTimeout = setTimeout(async () => {
      const address = e.target.value.trim();
      
      // S√≥ calcula se o modo raio estiver ativado e houver endere√ßo
      if (!DATA.restaurant.useRadiusDelivery || !address || address.length < 10) {
        return;
      }
      
      try {
        // Geocodificar endere√ßo do cliente
        const clientCoords = await geocodeNominatim(address);
        
        // Calcular dist√¢ncia
        const distance = calculateDistance(
          DATA.restaurant.restaurantLat,
          DATA.restaurant.restaurantLng,
          clientCoords.lat,
          clientCoords.lng
        );
        
        // Calcular taxa
        const fee = DATA.restaurant.deliveryBaseFee + (distance * DATA.restaurant.deliveryFeePerKm);
        
        // Armazenar valores globais
        window.autoDeliveryFee = fee;
        window.autoDeliveryDistanceKm = distance;
        
        // Atualizar total do checkout
        updateCheckoutTotal(fee, distance.toFixed(1) + " km");
        
      } catch (error) {
        console.warn("Erro ao calcular taxa autom√°tica:", error.message);
        // N√£o mostra alerta para n√£o incomodar o usu√°rio enquanto digita
      }
    }, 1500); // Aguarda 1.5s ap√≥s o usu√°rio parar de digitar
  });

  // --- Modals de Admin ---
  document.querySelector("#btnAdminPanel").addEventListener("click", () => openAdminModal('orders'));
  document.querySelector("#tabOrders").addEventListener("click", () => showAdminTab('orders'));
  document.querySelector("#tabSales").addEventListener("click", () => showAdminTab('sales'));
  document.querySelector("#tabCustomers").addEventListener("click", () => showAdminTab('customers'));
  document.querySelector("#tabSettings").addEventListener("click", () => showAdminTab('settings'));
  document.querySelector("#tabPDV").addEventListener("click", () => showAdminTab('pdv'));
  document.querySelector("#closeAdminModal").addEventListener("click", closeAdminModal);
  document.querySelector("#btnReset").addEventListener("click", resetDemo);

  // Formul√°rio de Configura√ß√µes da Loja
  document.querySelector("#storeSettingsForm").addEventListener("submit", saveStoreSettings);
  document.querySelector("#btnAddDeliveryArea").addEventListener("click", addDeliveryArea);
  
  // Cupons de Desconto
  document.querySelector("#btnAddCoupon").addEventListener("click", openCouponModal);
  document.querySelector("#couponForm").addEventListener("submit", saveCoupon);
  document.querySelector("#couponCancel").addEventListener("click", closeCouponModal);
  document.querySelector("#applyCouponBtn").addEventListener("click", applyCoupon);

  // Preview do logo
  document.querySelector("#restaurantLogoFile").addEventListener("change", (e) => {
    if (e.target.files && e.target.files[0]) {
      const reader = new FileReader();
      reader.onload = (r) => {
        document.querySelector("#currentLogoPreview").src = r.target.result;
      };
      reader.readAsDataURL(e.target.files[0]);
    }
  });
  
  // --- Modals de Item CRUD ---
  document.querySelector("#itemDetailsForm").addEventListener("submit", saveItemDetails);
  document.querySelector("#itemDetailsCancel").addEventListener("click", closeItemDetailsModal);
  
  // --- Modals de Imagem ---
  document.querySelector("#imageEditForm").addEventListener("submit", saveImageEdit);
  document.querySelector("#imageEditCancel").addEventListener("click", closeImageEditModal);
  document.querySelector("#itemImgFile").addEventListener("change", (e) => {
    if (e.target.files && e.target.files[0]) {
      const reader = new FileReader();
      reader.onload = (r) => {
        document.querySelector("#currentImagePreview").src = r.target.result;
      };
      reader.readAsDataURL(e.target.files[0]);
    }
  });
  
  // --- Modals de Adicionais ---
  document.querySelector("#addonManagementCancel").addEventListener("click", closeAddonManagementModal);
  document.querySelector("#addonManagementSubmit").addEventListener("click", saveAddonManagement);
  document.querySelector("#btnAddAddonGroup").addEventListener("click", addAddonGroup);

  // --- Bot√µes de Export/Import ---
  document.querySelector("#btnExport").addEventListener("click", () => {
    const json = JSON.stringify(DATA, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'cardapio_export.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });
  
  document.querySelector("#btnImport").addEventListener("click", () => {
    document.querySelector("#fileImport").click();
  });
  
  document.querySelector("#fileImport").addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (file && confirm("Importar o arquivo JSON ir√° substituir TODO o card√°pio e configura√ß√µes atuais. Continuar?")) {
      const reader = new FileReader();
      reader.onload = async (event) => {
        try {
          const importedData = JSON.parse(event.target.result);
          DATA = importedData;
          await saveMenuData(); // Salva os dados importados no Firebase
          renderAll();
          alert("Card√°pio importado e salvo no Firebase com sucesso!");
        } catch (err) {
          alert("Erro ao processar o arquivo JSON. Verifique o formato.");
          console.error(err);
        }
      };
      reader.readAsText(file);
    }
    // Limpa o input file para permitir importar o mesmo arquivo novamente
    e.target.value = null; 
  });


  // --- Bot√µes de Autentica√ß√£o/Perfil ---
  document.querySelector("#userBadge").addEventListener("click", () => {
      if(currentUser){
          openProfileModal();
      } else {
          openAuthModal();
      }
  });
  document.querySelector("#tabLogin").addEventListener("click", showLoginForm);
  document.querySelector("#tabRegister").addEventListener("click", showRegisterForm);
  document.querySelector("#loginCancel").addEventListener("click", closeAuthModal);
  document.querySelector("#registerCancel").addEventListener("click", closeAuthModal);
  document.querySelector("#loginSubmit").addEventListener("click", doLogin);
  document.querySelector("#registerSubmit").addEventListener("click", doRegister);
  document.querySelector("#logoutBtn").addEventListener("click", () => {
      currentUser = null;
      isAdmin = false;
      closeProfileModal();
      updateUserBadge();
      toggleAdminUI();
      renderCategories(); // Adicionado para atualizar a visibilidade dos bot√µes de admin na categoria
      renderItems();
  });
  document.querySelector("#closeProfile").addEventListener("click", closeProfileModal);
  
  // Adicionar endere√ßo do usu√°rio
  document.querySelector("#btnAddUserAddress").addEventListener("click", () => {
    if (!currentUser) return;
    const newAddress = document.querySelector("#newAddressInput").value.trim();
    if (newAddress) {
      if (!currentUser.savedAddresses) currentUser.savedAddresses = [];
      currentUser.savedAddresses.push(newAddress);
      const userToUpdate = users.find(u => u.id === currentUser.id);
      if (userToUpdate) {
        userToUpdate.savedAddresses = currentUser.savedAddresses;
        saveUsers();
        renderProfileAddresses();
        document.querySelector("#newAddressInput").value = '';
        alert("Endere√ßo salvo!");
      }
    }
  });


  // --- Footer/Carrinho Mobile ---
  document.querySelector("#btnViewCart").addEventListener("click", () => {
    const cartPanel = document.querySelector("#cartPanel");
    const isActive = window.getComputedStyle(cartPanel).display === 'block';

    if (isActive) {
      cartPanel.style.display = 'none';
    } else {
      cartPanel.style.display = 'block';
    }
  });



  // --- Fechar modais ao clicar no overlay ---
  document.querySelector("#modal").addEventListener("click", (e) => { if(e.target.id === "modal"){ closeModal(); } });
  document.querySelector("#itemDetailsModal").addEventListener("click", (e) => { if(e.target.id === "itemDetailsModal"){ closeItemDetailsModal(); } });
  document.querySelector("#addonManagementModal").addEventListener("click", (e) => { if(e.target.id === "addonManagementModal"){ closeAddonManagementModal(); } });
  document.querySelector("#imageEditModal").addEventListener("click", (e) => { if(e.target.id === "imageEditModal"){ closeImageEditModal(); } });
  document.querySelector("#authModal").addEventListener("click", (e) => { if(e.target.id === "authModal"){ closeAuthModal(); } });
  document.querySelector("#profileModal").addEventListener("click", (e) => { if(e.target.id === "profileModal"){ closeProfileModal(); } });
  document.querySelector("#checkoutModal").addEventListener("click", (e) => { if(e.target.id === "checkoutModal"){ closeCheckoutModal(); } });
  document.querySelector("#adminModal").addEventListener("click", (e) => { if(e.target.id === "adminModal"){ closeAdminModal(); } });
  document.querySelector("#confirmationModal").addEventListener("click", (e) => { if(e.target.id === "confirmationModal"){ closeConfirmationModal(); } });
  document.querySelector("#couponModal").addEventListener("click", (e) => { if(e.target.id === "couponModal"){ closeCouponModal(); } });
  document.querySelector("#closeConfirmationModal").addEventListener("click", closeConfirmationModal);
}

// === INICIALIZA√á√ÉO FINAL ===

document.addEventListener("DOMContentLoaded", () => {
  users = loadUsers(); // Carrega usu√°rios locais (para a demo de login)
  fetchMenuData(); // üëà Come√ßa buscando dados do Firebase
  initListeners();
});

// =========================================================================
// === EXPOSI√á√ÉO GLOBAL DE FUN√á√ïES (CORRE√á√ÉO DE ONCLICK/ONCHANGE) ===
// Fun√ß√µes chamadas a partir de HTML gerado dinamicamente precisam estar no escopo global (window)
// =========================================================================
window.updateOrderStatus = updateOrderStatus;
window.removeUserAddress = removeUserAddress;
window.addAddonGroup = addAddonGroup;
window.removeAddonGroup = removeAddonGroup;
window.addAddonItem = addAddonItem;
window.removeAddonItem = removeAddonItem;
window.updateAddonGroupProp = updateAddonGroupProp;
window.updateAddonItemProp = updateAddonItemProp;
window.removeDeliveryArea = removeDeliveryArea;

window.editCategory = editCategory;
window.removeCategory = removeCategory;




// ======= PDV (Mesas) ‚Äî Inserido automaticamente =======

/**
 * Renderiza as mesas no painel PDV (#pdvTablesGrid).
 * Usa DATA.restaurant.tables ‚Äî mantido em Firestore via saveMenuData().
 */
document.addEventListener("DOMContentLoaded", () => {
    const grid = document.querySelector("#pdvTablesGrid");
    if (!grid) return;

    grid.addEventListener("click", (e) => {
        const button = e.target.closest("button[data-table-id]");
        if (!button) return;

        const tableId = button.dataset.tableId;
        const action = button.dataset.action;

        if (action === "show-details") {
            // Se a mesa estiver ocupada, abre o modal de detalhes.
            // Se estiver livre, abre o modal de detalhes para adicionar a primeira comanda avulsa ou item.
            openTableDetailsModal(tableId);
        } else if (action === "open-comanda") {
            // Este bloco n√£o √© mais necess√°rio, pois o show-details cobre ambos os casos
            openPDVOrderModal(tableId);
        }
    });
});

function renderPDVTables(){
    const grid = document.querySelector("#pdvTablesGrid");
    if(!grid) return;
    grid.innerHTML = '';

    const tables = (DATA && DATA.restaurant && DATA.restaurant.tables) ? DATA.restaurant.tables : [];

    tables.forEach(table => {
        const div = document.createElement('div');
        // Novo status: 'livre' (padr√£o), 'ocupada' (tem orderId), 'fechada' (status final, n√£o usado aqui)
        const isOccupied = !!table.orderId;
        const status = isOccupied ? 'ocupada' : 'livre';
        
        let bg = '#f1f1f1';
        let color = '#555';
        if(status === 'livre') {
            bg = '#e6ffe6'; // Verde claro
            color = '#28a745';
        }
        if(status === 'ocupada') {
            bg = '#fff3cd'; // Amarelo claro
            color = '#ffc107';
        }
        
        div.style.cssText = `background:${bg};border-radius:10px;padding:16px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,0.05);border:1px solid #eee;`;
        
        let html = `<strong style="display:block;margin-bottom:6px">${table.name || 'Mesa'}</strong><small style="color:${color}">Status: ${status.toUpperCase()}</small>`;
        
        // Se a mesa estiver ocupada, mostra "Pedidos", sen√£o mostra "Abrir Comanda"
        // O bot√£o "Pedidos" agora abre o modal de detalhes, que permite adicionar itens ou comandas
        html += `<button class=\"btn\" style=\"margin-top:10px; padding: 8px 12px; font-size: 14px; background: var(--primary);\" data-action=\"show-details\" data-table-id=\"${table.id}\">${isOccupied ? 'Pedidos' : 'Abrir Comanda'}</button>`;
        
        div.innerHTML = html;
        grid.appendChild(div);
    });

    // bot√£o adicionar mesa (admin)
    if(isAdmin){
        const btn = document.createElement('button');
        btn.className = 'btn';
        btn.style.cssText = 'background:#28a745;color:#fff;width:100%;margin-top:8px;padding:12px;border-radius:8px;';
        btn.textContent = '+ Adicionar Nova Mesa';
        btn.addEventListener('click', async () => {
            const name = prompt('Nome da nova mesa:', 'Mesa ' + ((tables && tables.length) ? (tables.length + 1) : 1));
            if(!name) return;
            const newTable = { id: Date.now().toString(), name: name, status: 'livre', pedidos: [] };
            if(!DATA.restaurant) DATA.restaurant = {};
            if(!Array.isArray(DATA.restaurant.tables)) DATA.restaurant.tables = [];
            DATA.restaurant.tables.push(newTable);
            await saveMenuData();
            renderPDVTables();
            alert('Mesa adicionada: ' + name);
        });
        grid.appendChild(btn);
    }
}

/**
 * Abre o modal de pedido para a mesa selecionada.
 * Se admin clicar em um item, usa addItemToCart que j√° suporta PDV quando pdvCartState.tableId est√° setado.
 */
function openPDVOrderModal(tableId, existingOrderId = null){
    const table = (DATA.restaurant.tables || []).find(t => t.id === tableId);
    if(!table) return;
    
    // Se a mesa j√° tem um pedido, abre o modal de detalhes, n√£o o de novo pedido, a menos que seja para adicionar itens
        // Se a mesa j√° tem um pedido, abre o modal de detalhes, n√£o o de novo pedido, a menos que seja para adicionar itens
        // A l√≥gica de adicionar itens a um pedido existente ser√° tratada dentro do modal de detalhes.
        if(table.orderId && !existingOrderId){
            openTableDetailsModal(tableId);
            return;
        }
    
    pdvCartState = { tableId: table.id, items: [], existingOrderId: existingOrderId };
    document.querySelector("#pdvOrderTitle").textContent = 'Pedido ‚Äî ' + (table.name || 'Mesa');
    document.querySelector("#pdvItemsList").innerHTML = '';
    document.querySelector("#pdvCartList").innerHTML = '';
    document.querySelector("#pdvSubtotal").textContent = "R$ 0,00";
    
    // Se for para adicionar itens, carrega o pedido existente no carrinho
    if(existingOrderId){
        const existingOrder = orders.find(o => o.id === existingOrderId);
        if(existingOrder){
            // Copia os itens existentes para o carrinho PDV para que o usu√°rio possa ver o que j√° foi pedido
            // NOTA: Estes itens n√£o ser√£o enviados novamente, apenas os novos ser√£o adicionados ao array pdvCartState.items
            // A l√≥gica de merge ser√° feita no finalizePDVOrder
            pdvCartState.existingItems = existingOrder.items;
            document.querySelector("#pdvOrderTitle").textContent = 'Adicionar Itens ‚Äî ' + (table.name || 'Mesa');
        }
    } else {
        pdvCartState.existingItems = [];
    }

    // Render items - ao clicar abre o modal de adicionais (openModal)
    (DATA.items || []).forEach(item => {
        const btn = document.createElement('button');
        btn.className = 'pill';
        btn.style.cssText = 'display:block;width:100%;text-align:left;margin-bottom:6px;';
        btn.textContent = `${item.name} ‚Äî ${formatBRL(item.price)}`;
        btn.addEventListener('click', () => {
            // No modo PDV, ao clicar no item, abre o modal de adicionais
            // O modal de adicionais precisa saber que est√° no modo PDV
            openModal(item, true); // O segundo argumento 'true' indica modo PDV
        });
        document.querySelector("#pdvItemsList").appendChild(btn);
    });

    // mostra modal
    document.querySelector("#pdvOrderModal").classList.add('open');
    // adapta estilo caso modal seja usado em vers√£o sem class open handling
    if(window.getComputedStyle(document.querySelector("#pdvOrderModal")).display === 'none'){
        document.querySelector("#pdvOrderModal").style.display = 'flex';
    }
    renderPDVCart();
}

/**
 * Renderiza o carrinho local do PDV com base em pdvCartState.items
 */
function renderPDVCart(){
    const list = document.querySelector("#pdvCartList");
    if(!list) return;
    list.innerHTML = '';
    let subtotal = 0;

    const items = (pdvCartState && pdvCartState.items) ? pdvCartState.items : [];

    items.forEach((it, idx) => {
        subtotal += it.totalPrice;
        const row = document.createElement('div');
        row.style.cssText = 'border-bottom:1px solid #eee;padding:8px 0;';
        row.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;"><div><strong>${it.qty}x ${it.name}</strong><div class="small" style="color:var(--muted)">${formatBRL(it.price)} cada</div></div><div style="text-align:right"><div style="font-weight:700">${formatBRL(it.totalPrice)}</div><button class="pill" style="margin-top:6px;background:#fbe6e6;color:#dc3545;" data-idx="${idx}">Remover</button></div></div>`;
        list.appendChild(row);
    });

    document.querySelector("#pdvSubtotal").textContent = formatBRL(subtotal);

    // remover item do pdvCart
    list.querySelectorAll('button[data-idx]').forEach(b=>{
        b.addEventListener('click', (e)=>{
            const idx = parseInt(e.target.dataset.idx, 10);
            if(!isNaN(idx)){
                pdvCartState.items.splice(idx,1);
                renderPDVCart();
            }
        });
    });
}

/**
 * Fecha modal PDV e limpa estado de pdvCartState.tableId (mant√©m itens at√© finalizar)
 */
function closePDVOrderModal(){
    document.querySelector("#pdvOrderModal").classList.remove('open');
    if(window.getComputedStyle(document.querySelector("#pdvOrderModal")).display !== 'none'){
        document.querySelector("#pdvOrderModal").style.display = 'none';
    }
    pdvCartState.existingOrderId = null; // Limpa o estado de adi√ß√£o de itens
}

// Fun√ß√£o auxiliar para fechar os modais de comanda e restaurar o z-index
function closeComandaModals() {
    document.querySelector("#comandaChoiceModal").classList.remove('open');
    document.querySelector("#comandaModal").classList.remove('open');
    document.querySelector("#comandaPesoModal").classList.remove('open');
    document.querySelector("#comandaChoiceModal").style.zIndex = '';
    document.querySelector("#comandaModal").style.zIndex = '';
    document.querySelector("#comandaPesoModal").style.zIndex = '';
}

// === PDV Checkout: abre resumo antes de enviar para cozinha ===
function formatLinePrice(qty, name, price) {
  return `<div style="display:flex; justify-content:space-between; align-items:flex-start; gap:8px;">
            <div style="flex:1;"><strong>${qty}x</strong> ${name}</div>
            <div style="min-width:90px; text-align:right;">${formatBRL(price)}</div>
          </div>`;
}

function openPDVCheckoutModal() {
  if (!pdvCartState || !pdvCartState.tableId || (pdvCartState.items || []).length === 0) {
    alert("Nenhum item no pedido da mesa.");
    return;
  }

  // Preenche a mesa e t√≠tulo
  document.querySelector("#pdvCheckoutTable").value = pdvCartState.tableId;
  document.querySelector("#pdvCheckoutTitle").textContent = "Mesa " + pdvCartState.tableId;

  // Limpa campo cliente
  document.querySelector("#pdvCheckoutClient").value = "";

  // Renderiza os itens
  const summaryEl = document.querySelector("#pdvCheckoutSummary");
  summaryEl.innerHTML = "";

  let subtotal = 0;
  (pdvCartState.items || []).forEach(item => {
    subtotal += item.totalPrice;

    const wrapper = document.createElement("div");
    wrapper.style.cssText = "border-bottom:1px solid #eee; padding:6px 0;";

    // linha principal com qty, nome e pre√ßo do item
    wrapper.innerHTML = formatLinePrice(item.qty, item.name, item.totalPrice);

    // adicionais detalhados
    if (item.addons && item.addons.length > 0) {
      item.addons.forEach(group => {
        (group.selected || []).forEach(addon => {
          if (addon.qty > 0) {
            const originalItem = getItem(item.itemId);
            const originalGroup = originalItem?.addonGroups?.find(g => g.id === group.groupId);
            const addonDef = originalGroup?.addons?.find(a => a.id === addon.addonId);
            const addonName = addonDef ? addonDef.name : "Adicional";
            const addonPrice = addonDef ? addonDef.price : 0;
            const line = document.createElement("div");
            line.classList.add("small");
            line.style.cssText = "margin-left:10px; color:var(--muted);";
            line.innerHTML = `+ ${addon.qty}x ${addonName} ${addonPrice > 0 ? '(' + formatBRL(addonPrice) + ')' : ''}`;
            wrapper.appendChild(line);
          }
        });
      });
    }

    summaryEl.appendChild(wrapper);
  });

  document.querySelector("#pdvCheckoutSubtotal").textContent = formatBRL(subtotal);
  // No PDV assumimos sem taxa; Total = subtotal (mas mantemos campo)
  document.querySelector("#pdvCheckoutTotal").textContent = formatBRL(subtotal);

  // Abre modal
  document.querySelector("#pdvCheckoutModal").classList.add("open");
}

// Bot√µes do modal de checkout PDV
document.addEventListener("DOMContentLoaded", () => {
  const cancelBtn = document.querySelector("#pdvCheckoutCancel");
  if (cancelBtn) {
    cancelBtn.addEventListener("click", () => {
      document.querySelector("#pdvCheckoutModal").classList.remove("open");
    });
  }

  const confirmBtn = document.querySelector("#pdvCheckoutConfirm");
  if (confirmBtn) {
    confirmBtn.addEventListener("click", async () => {
      // L√™ o nome do cliente (opcional) e chama finalizePDVOrder
      const clientName = document.querySelector("#pdvCheckoutClient").value.trim();
      document.querySelector("#pdvCheckoutModal").classList.remove("open");
      await finalizePDVOrder(clientName);
    });
  }

  // Substitui o evento do bot√£o PDV no modal principal para abrir o checkout
  const pdvBtn = document.querySelector("#pdvFinalizeBtn");
  if (pdvBtn) {
    pdvBtn.removeEventListener("click", openPDVCheckoutModal);
    pdvBtn.addEventListener("click", openPDVCheckoutModal);
  }
});


// ==== Drawer de Pedidos ====
(function(){
  const root = document;
  function $(sel){ return root.querySelector(sel); }
  // Guard: if elements not yet present, retry
  function openOrdersDrawerHandler(){
    if (!currentUser) { openAuthModal(); return; }
    renderOrdersDrawer();
    document.getElementById('ordersDrawer').classList.add('open');
  }
  function closeOrdersDrawerHandler(){
    document.getElementById('ordersDrawer').classList.remove('open');
  }
  // attach when DOM ready
  document.addEventListener('DOMContentLoaded', function(){
    if(document.querySelector("#btnViewOrders")) document.querySelector("#btnViewOrders").addEventListener('click', openOrdersDrawerHandler);
    if(document.querySelector("#closeOrdersDrawer")) document.querySelector("#closeOrdersDrawer").addEventListener('click', closeOrdersDrawerHandler);
  });
  // also attach immediately if possible
  if(document.querySelector("#btnViewOrders")) document.querySelector("#btnViewOrders").addEventListener('click', openOrdersDrawerHandler);
  if(document.querySelector("#closeOrdersDrawer")) document.querySelector("#closeOrdersDrawer").addEventListener('click', closeOrdersDrawerHandler);

window.reorderItems = async function(orderId) { // Tornando a fun√ß√£o ass√≠ncrona
  const order = orders.find(o => o.id === orderId);
  if (!order) {
    alert('Pedido n√£o encontrado.');
    return;
  }

  // === CORRE√á√ÉO: Garantir que o DATA (card√°pio) esteja carregado ===
  if (!DATA || !DATA.items) {
    alert('Carregando dados do card√°pio. Tente novamente em instantes.');
    // Tenta carregar os dados. A fun√ß√£o fetchMenuData √© ass√≠ncrona.
    if (typeof fetchMenuData === 'function') {
      await fetchMenuData();
    } else {
      console.error('fetchMenuData n√£o est√° definida. N√£o √© poss√≠vel carregar o card√°pio.');
      alert('Erro ao carregar o card√°pio. Verifique o console.');
      return;
    }
  }
  // =================================================================

  let itemsAdded = 0;
  
  order.items.forEach(item => {
    // Tenta encontrar o item original no menu (DATA.items)
    const originalItem = DATA.items.find(i => i.id === item.itemId);
    
    if (originalItem) {
      // A fun√ß√£o addItemToCart espera: item, qty, addons.
      // O par√¢metro `addons` deve ser a estrutura de sele√ß√£o do modal:
      // [ { groupId: '...', selected: [ { addonId: '...', qty: 1 } ] } ]
      
      // O `item.addons` do pedido anterior (item) √© provavelmente uma lista plana de addons selecionados.
      // Vamos tentar reconstruir a estrutura de sele√ß√£o.
      
      const addonsToReorder = [];
      
      // Verifica se o item do pedido tem addons e se o item original tem grupos de addons
      if (Array.isArray(item.addons) && Array.isArray(originalItem.addonGroups)) {
        
        // Itera sobre os grupos de addons do item original (menu)
        originalItem.addonGroups.forEach(group => {
          const selectedAddons = [];
          
          // Itera sobre os addons do pedido anterior para encontrar os que pertencem a este grupo
          item.addons.forEach(addonFromOrder => {
            // Tenta encontrar o addon correspondente no grupo atual do item original
            // A busca √© feita pelo NOME, pois √© a informa√ß√£o mais est√°vel no objeto de pedido.
            const originalAddon = group.addons.find(a => a.name === addonFromOrder.name);
            
            // Se o addon for encontrado no grupo, adiciona √† lista de selecionados
            if (originalAddon) {
              selectedAddons.push({
                addonId: originalAddon.id,
                qty: addonFromOrder.qty // Usa a quantidade do pedido anterior
              });
            }
          });
          
          // Se houver addons selecionados neste grupo, adiciona ao array de reconstru√ß√£o
          if (selectedAddons.length > 0) {
            addonsToReorder.push({
              groupId: group.id,
              selected: selectedAddons
            });
          }
        });
      }
      
      // Passa a estrutura reconstru√≠da para addItemToCart
      addItemToCart(originalItem, item.qty, addonsToReorder);
      itemsAdded++;
    } else {
      console.warn(`Item com ID ${item.itemId} n√£o encontrado no menu atual.`);
    }
  });

  if (itemsAdded > 0) {
    alert(`${itemsAdded} itens do pedido #${order.id.substring(0, 7)} foram adicionados ao seu carrinho!`);
    // Fecha o modal de pedidos
    document.getElementById('ordersDrawer').classList.remove('open');
  } else {
    alert('Nenhum item do pedido p√¥de ser adicionado ao carrinho. Verifique se os itens ainda est√£o dispon√≠veis.');
  }
}

  window.renderOrdersDrawer = function() {
  loadMotoboys(); // Garante que a lista de motoboys est√° carregada antes de renderizar os pedidos
    const list = document.getElementById('ordersDrawerList');
    if(!list) return;
    list.innerHTML = '';
    const userOrders = ((orders || [])).filter(o => currentUser && o.userId === currentUser.id);
    if (!userOrders || userOrders.length === 0) {
      list.innerHTML = '<div class="small" style="color:var(--muted);text-align:center;">Nenhum pedido encontrado.</div>';
      return;
    }
    userOrders.forEach(order => {
      const statusInfo = ORDER_STATUSES[order.status] || ORDER_STATUSES.pending;
      const div = document.createElement('div');
      div.className = 'order-item';
      div.style.cssText = 'border:1px solid #eee;border-radius:10px;padding:10px;margin-bottom:8px;box-shadow:0 4px 8px rgba(0,0,0,0.03);';
      // Gera√ß√£o da lista de itens detalhada
      const itemsListHtml = (order.items || []).map(item => {
        let itemHtml = `<div style="margin-left:10px; margin-top:4px; border-left:2px solid #eee; padding-left:6px;">
          ${item.qty}x ${item.name} (${formatBRL(item.totalPrice / item.qty)} cada)
          ${item.addons && item.addons.length > 0 ? `<div class="small" style="color:var(--muted); margin-left:5px;">+ ${(item.addons || []).map(a => `${a.qty}x ${a.name}`).join(', ')}</div>` : ''}
        </div>`;
        return itemHtml;
      }).join('');

      div.innerHTML = ''
        + '<div style="display:flex;justify-content:space-between;align-items:flex-start;">'
        + '<strong style="font-size:15px;">Pedido #' + (order.id ? order.id.substring(0,7) : '') + '</strong>'
        + '<span style="font-weight:600;color:' + (statusInfo.color || '#000') + '; margin-left: 10px;">' + (statusInfo.label || '') + '</span>'
        + '</div>'
        + '<div class="small" style="color:var(--muted);margin:4px 0;">'
        + 'Data: ' + (new Date(order.createdAt).toLocaleDateString()) + ' ' + (new Date(order.createdAt).toLocaleTimeString()) + '<br>'
        + 'Total: ' + formatBRL(order.total) + '<br>'
        + 'Endere√ßo: ' + (order.address || 'Retirada no Local') + '<br>'
        + 'Pagamento: ' + (order.paymentMethod || 'N/A')
        + '</div>'
        + '<div style="font-size:14px; margin-bottom:10px;">'
        + '<strong>Itens:</strong>'
        + itemsListHtml
        + '</div>'
        + '<div style="text-align:right; margin-top: 10px;">'
        + `<button class="pill" style="background: var(--primary); color: white; padding: 6px 12px; font-size: 13px;" onclick="window.reorderItems('${order.id}')">Pedir Novamente</button>`
        + '</div>';
      list.appendChild(div);
    });
  };
})();


// ==== Compatibilidade: logout (profile modal + admin) ====
document.addEventListener("DOMContentLoaded", () => {
  function attachLogout(el) {
    if (!el) return;
    el.removeEventListener("click", el._logoutHandler);
    el._logoutHandler = () => {
      if (confirm("Deseja realmente sair da conta?")) {
        if (typeof logoutUser === "function") {
          logoutUser();
        } else {
          // fallback: clear currentUser and reload UI
          currentUser = null;
          isAdmin = false;
          saveUsers();
          renderAll();
          alert("Voc√™ saiu da conta (logout fallback).");
        }
      }
    };
    el.addEventListener("click", el._logoutHandler);
  }

  const els = Array.from(document.querySelectorAll("#logoutBtn, #btnLogout, [data-action='logout']"));
  els.forEach(attachLogout);

  // Observe mutations to catch dynamically added buttons (e.g., modal injected later)
  const obs = new MutationObserver(muts => {
    muts.forEach(m => {
      m.addedNodes && m.addedNodes.forEach(node => {
        if (!(node instanceof HTMLElement)) return;
        const found = node.querySelectorAll && node.querySelectorAll("#logoutBtn, #btnLogout, [data-action='logout']");
        if (found && found.length) found.forEach(attachLogout);
        if (node.matches && (node.matches("#logoutBtn") || node.matches("#btnLogout") || node.matches("[data-action='logout']"))) attachLogout(node);
      });
    });
  });
  obs.observe(document.body, { childList: true, subtree: true });
});


// === FOR√áAR: Carrinho inicia oculto em telas pequenas (mobile) ===
document.addEventListener("DOMContentLoaded", () => {
  const cartPanel = document.getElementById("cartPanel");
  if (cartPanel && window.innerWidth <= 1024) {
    cartPanel.style.display = "none";
  }
});

// === Comanda Avulsa: handler UI e envio ===
document.addEventListener("DOMContentLoaded", () => {
  // Elementos existentes
  const btnComandaAvulsa = document.getElementById("btnComandaAvulsa");
  const comandaModal = document.getElementById("comandaModal");
  const comandaForm = document.getElementById("comandaForm");
  const comandaCancel = document.getElementById("comandaCancel");

  // Novos elementos
  const comandaChoiceModal = document.getElementById("comandaChoiceModal");
  const btnComandaValor = document.getElementById("btnComandaValor");
  const btnComandaPeso = document.getElementById("btnComandaPeso");
  const comandaPesoModal = document.getElementById("comandaPesoModal");
  const comandaPesoForm = document.getElementById("comandaPesoForm");
  const comandaPesoCancel = document.getElementById("comandaPesoCancel");
  const comandaPesoWeight = document.getElementById("comandaPesoWeight");
  const comandaPesoValuePerKg = document.getElementById("comandaPesoValuePerKg");
  const comandaPesoTotal = document.getElementById("comandaPesoTotal");

  // 1. Bot√£o principal abre o modal de escolha
  if (btnComandaAvulsa && comandaChoiceModal) {
    btnComandaAvulsa.addEventListener("click", () => {
      comandaChoiceModal.classList.add("open");
    });
  }

  // 2. Bot√£o Comanda-Valor abre o modal existente
  if (btnComandaValor && comandaModal) {
    btnComandaValor.addEventListener("click", () => {
      comandaChoiceModal.classList.remove("open");
      comandaModal.classList.add("open");
      comandaForm.reset();
      // focus no primeiro campo
      const f = document.getElementById("comandaName");
      if (f) f.focus();
    });
  }

  // 3. Bot√£o Comanda-Peso abre o novo modal
  if (btnComandaPeso && comandaPesoModal) {
    btnComandaPeso.addEventListener("click", () => {
      comandaChoiceModal.classList.remove("open");
      comandaPesoModal.classList.add("open");
      comandaPesoForm.reset();
      if(comandaPesoTotal) comandaPesoTotal.value = formatBRL(0);
      // focus no primeiro campo
      const f = document.getElementById("comandaPesoName");
      if (f) f.focus();
    });
  }

  // --- Comanda Avulsa (Valor Fixo) ---
  if (comandaCancel) {
    comandaCancel.addEventListener("click", () => {
      comandaModal.classList.remove("open");
      comandaForm.reset();
    });
  }

  if (comandaForm) {
    comandaForm.addEventListener("submit", async (ev) => {
      ev.preventDefault();
      const name = document.getElementById("comandaName").value.trim();
      // Adicionado replace para garantir que o ponto seja usado como separador decimal
      const value = parseFloat(document.getElementById("comandaValue").value.replace(',', '.')) || 0; 
      const payment = document.getElementById("comandaPayment").value;
      const cpf = document.getElementById("comandaCPF").value.trim();

      if (!name || value <= 0) {
        alert("Preencha o nome do cliente e um valor maior que zero.");
        return;
      }

      // Monta o objeto do pedido semelhante aos pedidos normais
      const newOrder = {
        userId: "comanda_" + Date.now().toString(),
        userName: name,
        userPhone: "",
        address: "",
        deliveryAreaId: "",
        deliveryAreaName: "Comanda Avulsa",
        deliveryFee: 0,
        items: [], // comanda avulsa n√£o tem itens detalhados
        subtotal: value,
        total: value,
        paymentMethod: payment,
        cpfOnReceipt: cpf || null,
        type: "comandaAvulsa",
        status: "pending",
        createdAt: new Date().toISOString()
      };

      try {
        // usa a mesma cole√ß√£o de pedidos em tempo real
        await addDoc(ordersCollectionRef, newOrder);
        // fecha modal e limpa form
        comandaModal.classList.remove("open");
        comandaForm.reset();
        alert("Comanda avulsa criada com sucesso.");
      } catch (err) {
        console.error("Falha ao salvar comanda avulsa:", err);
        alert("Erro ao criar comanda. Verifique a conex√£o.");
      }
    });
  }

  // --- Comanda Avulsa (Por Peso) ---
  // L√≥gica de c√°lculo autom√°tico
  function updateComandaPesoTotal() {
    // Adicionado replace para garantir que o ponto seja usado como separador decimal
    const weight = parseFloat(comandaPesoWeight.value.replace(',', '.')) || 0;
    const valuePerKg = parseFloat(comandaPesoValuePerKg.value.replace(',', '.')) || 0;
    const total = weight * valuePerKg;
    if(comandaPesoTotal) comandaPesoTotal.value = formatBRL(total);
  }

  if (comandaPesoWeight) {
    comandaPesoWeight.addEventListener("input", updateComandaPesoTotal);
  }
  if (comandaPesoValuePerKg) {
    comandaPesoValuePerKg.addEventListener("input", updateComandaPesoTotal);
  }

  // L√≥gica de cancelamento
  if (comandaPesoCancel) {
    comandaPesoCancel.addEventListener("click", () => {
      comandaPesoModal.classList.remove("open");
      comandaPesoForm.reset();
    });
  }

  // L√≥gica de submiss√£o
  if (comandaPesoForm) {
    comandaPesoForm.addEventListener("submit", async (ev) => {
      ev.preventDefault();
      const name = document.getElementById("comandaPesoName").value.trim();
      const weight = parseFloat(comandaPesoWeight.value.replace(',', '.')) || 0;
      const valuePerKg = parseFloat(comandaPesoValuePerKg.value.replace(',', '.')) || 0;
      const total = weight * valuePerKg;
      const payment = document.getElementById("comandaPesoPayment").value;
      const cpf = document.getElementById("comandaPesoCPF").value.trim();

      if (!name || total <= 0) {
        alert("Preencha o nome do cliente, peso e valor/kg corretamente para calcular um total maior que zero.");
        return;
      }

      // Monta o objeto do pedido
      const newOrder = {
        userId: "comanda_peso_" + Date.now().toString(),
        userName: name,
        userPhone: "",
        address: "",
        deliveryAreaId: "",
        deliveryAreaName: "Comanda Avulsa (Peso)",
        deliveryFee: 0,
        items: [{
            name: `Comanda por Peso (${weight.toFixed(3)}kg @ ${formatBRL(valuePerKg)}/kg)`,
            qty: 1,
            price: total,
            totalPrice: total,
            isComandaPeso: true,
            weight: weight,
            valuePerKg: valuePerKg
        }],
        subtotal: total,
        total: total,
        paymentMethod: payment,
        cpfOnReceipt: cpf || null,
        type: "comandaAvulsaPeso",
        status: "pending",
        createdAt: new Date().toISOString()
      };

      try {
        // usa a mesma cole√ß√£o de pedidos em tempo real
        await addDoc(ordersCollectionRef, newOrder);
        // fecha modal e limpa form
        comandaPesoModal.classList.remove("open");
        comandaPesoForm.reset();
        alert("Comanda por peso criada com sucesso.");
      } catch (err) {
        console.error("Falha ao salvar comanda por peso:", err);
        alert("Erro ao criar comanda. Verifique a conex√£o.");
      }
    });
  }
});

window.printOrder = function(orderId) {
  const order = orders.find(o => o.id === orderId);
  if (!order) return alert('Pedido n√£o encontrado.');

  // Fun√ß√µes auxiliares (assumindo que j√° existem no escopo global do HTML)
  // formatBRL(value)
  // formatCPFCNPJ(value) - Precisa ser criada ou assumida

  // Dados fict√≠cios ou extra√≠dos do objeto 'order'
  const orderDate = new Date(order.createdAt).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
  const orderTime = new Date(order.createdAt).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
  const deliveryTime = order.deliveryTime || '30min a 1h'; // Assumindo que o tempo de entrega est√° em 'order.deliveryTime' ou um valor padr√£o
  const storeName = order.storeName || 'Acaiteria Creamy Purple'; // Assumindo que o nome da loja est√° em 'order.storeName' ou um valor padr√£o
  const orderNumber = order.orderNumber || order.id.substring(0, 7); // N√∫mero do pedido

  // Informa√ß√µes do Cliente
  const clientName = order.userName || 'N/A';
  const clientCpfCnpj = order.userCpfCnpj ? formatCPFCNPJ(order.userCpfCnpj) : 'N/A'; // Assumindo formatCPFCNPJ existe
  const clientPhone = order.userPhone || 'N/A';
  const clientOrderCount = order.userOrderCount || 'N/A'; // Assumindo que a contagem de pedidos est√° em 'order.userOrderCount'
  const clientAddress = order.address || 'N/A';
  const clientNeighborhood = order.neighborhood || 'N/A'; // Assumindo que o bairro est√° em 'order.neighborhood'

  // Informa√ß√µes de Pagamento
  let paymentMethod = 'N/A';
  if (order.paymentMethod === 'cash') {
    paymentMethod = 'Dinheiro' + (order.changeNeeded > 0 ? ` (Troco: ${formatBRL(order.changeNeeded)})` : '');
  } else if (order.paymentMethod === 'credit') {
    paymentMethod = 'Cart√£o de Cr√©dito';
  } else if (order.paymentMethod === 'debit') {
    paymentMethod = 'Cart√£o de D√©bito';
  } else if (order.paymentMethod === 'pix') {
    paymentMethod = 'PIX';
  }

  // Valores
  const subtotal = order.subtotal || order.total - (order.deliveryFee || 0); // Assumindo que subtotal existe ou pode ser calculado
  const deliveryFee = order.deliveryFee || 0;
  const total = order.total || 0;

  // Gera√ß√£o da lista de itens
  const itemsList = (order.items || []).map(item => {
    let itemHtml = `<div class="footer-line"><span>${item.qty}x ${item.name}</span><span>${formatBRL(item.totalPrice / item.qty)}</span></div>`;
    if (item.addons && item.addons.length > 0) {
      item.addons.forEach(a => {
        itemHtml += `<div class="item-addon"> &nbsp; &nbsp; + ${a.qty}x ${a.name}</div>`;
      });
    }
    return itemHtml;
  }).join('');
  
  // Gera√ß√£o da lista de comandas avulsas
  let comandasAvulsasHtml = '';
  let totalComandas = 0;
  if (order.comandasAvulsas && order.comandasAvulsas.length > 0) {
    comandasAvulsasHtml = '<div class="line"></div><div class="bold">Comandas Avulsas:</div>';
    order.comandasAvulsas.forEach(comanda => {
      totalComandas += comanda.totalCalculado || 0;
      let detalhes = '';
      if (comanda.tipo === 'valor') {
        detalhes = `Valor Fixo`;
      } else if (comanda.tipo === 'peso') {
        detalhes = `${comanda.peso}kg x ${formatBRL(comanda.valorKg)}/kg`;
      }
      const pagamentoLabel = {
        'pix': 'PIX',
        'credit': 'Cr√©dito',
        'debit': 'D√©bito',
        'cash': 'Dinheiro'
      }[comanda.pagamento] || comanda.pagamento;
      
      comandasAvulsasHtml += `<div class="footer-line"><span>${comanda.cliente} (${detalhes})</span><span>${formatBRL(comanda.totalCalculado)}</span></div>`;
      comandasAvulsasHtml += `<div class="item-addon">Pagamento: ${pagamentoLabel}${comanda.cpf ? ' | CPF: ' + comanda.cpf : ''}</div>`;
    });
  }
  
  // Total geral incluindo comandas
  const totalGeral = (order.totalGeral !== undefined) ? order.totalGeral : (total + totalComandas);

  const printContent = `
    <html>
      <head>
        <title>Comanda - Pedido #${orderNumber}</title>
        <style>
          @page { size: 58mm auto; margin: 5mm; }
          body { font-family: monospace; font-size: 10px; line-height: 1.2; white-space: pre; }
          .center { text-align: center; }
          .right { text-align: right; }
          .line { border-top: 1px dashed #000; margin: 5px 0; }
          .bold { font-weight: bold; }
          .item-line { margin-left: 5px; }
          .footer-line { display: flex; justify-content: space-between; }
          .item-addon { margin-left: 10px; }
        </style>
      </head>
      <body>
===============================================
               COMANDA - PEDIDO
===============================================
<div class="center">${orderDate} ${orderTime}</div>
<div class="center">Entrega prevista: ${deliveryTime}</div>
<div class="center">${storeName}</div>
<div class="center bold">===============================================</div>
<div class="center bold">                Pedido:</div>
<div class="line"></div>
<div class="bold">Itens:</div>
<div class="items-list">${itemsList}</div>
${comandasAvulsasHtml}
<div class="line"></div>
<div class="bold">Cliente</div>

Nome: ${clientName}
CPF/CNPJ: ${clientCpfCnpj}
Telefone: ${clientPhone}
Quantidade de pedidos: ${clientOrderCount}
Endere√ßo: ${clientAddress}
Bairro: ${clientNeighborhood}
<div class="line"></div>
<div class="bold">Pagamento</div>

Forma de Pagamento: ${paymentMethod}
<div class="line"></div>
<div class="footer-line"><span>Subtotal:</span><span>${formatBRL(subtotal)}</span></div>
<div class="footer-line"><span>Taxa de entrega:</span><span>${formatBRL(deliveryFee)}</span></div>
${totalComandas > 0 ? `<div class="footer-line"><span>Comandas Avulsas:</span><span>${formatBRL(totalComandas)}</span></div>` : ''}
<div class="footer-line"><span>Total:</span><span>${formatBRL(totalGeral)}</span></div>
<div class="line"></div>
      
<!-- ========================================================================= -->
<!-- === MODAL DE HIST√ìRICO DE PEDIDOS (CRM) === -->
<!-- ========================================================================= -->
<div id="orderHistoryModal" class="modal">
  <div class="modal-content" style="max-height: 80vh; overflow-y: auto;">
    <div class="modal-header">
      <h2 id="historyModalTitle">Hist√≥rico de Pedidos</h2>
      <span class="close-button" onclick="closeOrderHistoryModal()">&times;</span>
    </div>
    <div class="modal-body">
      <p id="historyClientInfo" style="margin-bottom: 15px; font-weight: 600;"></p>
      <div id="historyOrdersList">
        <!-- Pedidos ser√£o injetados aqui -->
        <p style="color:#888;">Carregando hist√≥rico...</p>
      </div>
    </div>
  </div>
</div>

</body>
    </html>
  `;

  const win = window.open('', 'PRINT', 'height=600,width=400');
  win.document.write(printContent);
  win.document.close();
  win.focus();
  win.print();
}

</script>

<!-- PDV Checkout Modal: confirma antes de enviar para cozinha -->
<div class="modal" id="pdvCheckoutModal">
  <div class="card" role="dialog" aria-modal="true" style="max-width:600px;">
    <h3>Confirmar Pedido da Mesa <span id="pdvCheckoutTitle" style="float:right; color:var(--primary); font-weight:800;"></span></h3>

    <div class="form-group">
      <label for="pdvCheckoutTable">Mesa</label>
      <input type="text" id="pdvCheckoutTable" readonly>
    </div>

    <div class="form-group">
      <label for="pdvCheckoutClient">Nome do Cliente (opcional)</label>
      <input type="text" id="pdvCheckoutClient" placeholder="Ex: Jo√£o, Ana, etc.">
    </div>

    <h4>Itens do Pedido</h4>
    <div id="pdvCheckoutSummary" style="max-height:300px; overflow:auto; border:1px solid #eee; border-radius:8px; padding:8px;"></div>

    <div style="margin-top:10px; display:flex; justify-content:space-between; font-weight:600;">
      <span>Subtotal:</span>
      <span id="pdvCheckoutSubtotal" style="color:var(--primary);">R$ 0,00</span>
    </div>

    <div style="margin-top:6px; display:flex; justify-content:space-between; font-weight:600;">
      <span>Total Geral:</span>
      <span id="pdvCheckoutTotal" style="color:var(--primary);">R$ 0,00</span>
    </div>

    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:20px;">
      <button class="pill" id="pdvCheckoutCancel">Voltar</button>
      <button class="btn" id="pdvCheckoutConfirm" style="background:#28a745;">Enviar para Cozinha</button>
    </div>
  </div>
</div>


<div class="drawer" id="ordersDrawer">
  <div class="drawer-content">
    <h4>üì¶ Meus Pedidos</h4>
    <div id="ordersDrawerList"></div>
    <button class="btn" id="closeOrdersDrawer" style="margin-top:12px;width:100%;">Fechar</button>
  </div>
</div>


<!-- === BOT√ÉO FECHAR PDV === -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const closeBtn = document.getElementById("closePdvOrderModal");
  const modal = document.getElementById("pdvOrderModal");
  if (closeBtn && modal) {
    closeBtn.addEventListener("click", () => {
      modal.classList.remove("open");
    });
  }
});

/* ===== Relat√≥rio de Vendas Din√¢mico (inserido automaticamente) ===== */
(function(){
  // Utilidades locais
  function parseDate(d){
    try { return new Date(d); } catch(e){ return null; }
  }

  function isDelivered(order){
    return order && order.status === "delivered";
  }

  function withinPeriod(dateObj, period){
    if(!dateObj) return false;
    const now = new Date();
    const start = new Date(now);
    if(period === "day"){
      start.setHours(0,0,0,0);
      return dateObj >= start && dateObj <= now;
    } else if(period === "week"){
      // last 7 days (including today)
      start.setDate(now.getDate() - 6);
      start.setHours(0,0,0,0);
      return dateObj >= start && dateObj <= now;
    } else if(period === "month"){
      // last 30 days (including today)
      start.setDate(now.getDate() - 29);
      start.setHours(0,0,0,0);
      return dateObj >= start && dateObj <= now;
    }
    return false;
  }

  function getFilteredOrders(period){
    const filtered = (orders || []).filter(o => {
      if(!isDelivered(o)) return false;
      const created = parseDate(o.createdAt);
      return withinPeriod(created, period);
    });
    return filtered;
  }

  function calcSummary(filtered){
    const summary = { revenue:0, count:0, avg:0, topArea:"N/A" };
    summary.count = filtered.length;
    summary.revenue = filtered.reduce((s,o)=> s + (parseFloat(o.total) || parseFloat(o.subtotal) || 0), 0);
    summary.avg = summary.count > 0 ? summary.revenue / summary.count : 0;
    // top area
    const areas = {};
    filtered.forEach(o => {
      const area = o.deliveryAreaName || "N/A";
      areas[area] = (areas[area] || 0) + 1;
    });
    const top = Object.entries(areas).sort((a,b)=>b[1]-a[1])[0];
    if(top) summary.topArea = `${top[0]} (${top[1]} pedidos)`;
    return summary;
  }

  function calcTopProducts(filtered, limit=10){
    const counts = {};
    filtered.forEach(o => {
      (o.items || []).forEach(it => {
        const key = it.itemId || it.name;
        counts[key] = counts[key] || { name: it.name || key, qty: 0 };
        counts[key].qty += (parseInt(it.qty) || 0);
      });
    });
    return Object.values(counts).sort((a,b)=>b.qty-a.qty).slice(0,limit);
  }

  function calcPaymentsWithTotal(filtered){
    const map = {};
    let grandTotal = 0;

    filtered.forEach(o => {
      const pm = o.paymentMethod || "unknown";
      const orderTotal = parseFloat(o.total) || parseFloat(o.subtotal) || parseFloat(o.totalPrice) || 0;
      
      map[pm] = map[pm] || { count: 0, total: 0 };
      map[pm].count += 1;
      map[pm].total += orderTotal;
      grandTotal += orderTotal;
    });

    return Object.entries(map).map(([k,v]) => ({ 
      method: k, 
      count: v.count, 
      total: v.total, 
      pct: grandTotal > 0 ? ((v.total / grandTotal) * 100).toFixed(2) : 0 
    })).sort((a,b)=>b.total-a.total);
  }

function calcPayments(filtered){
    const map = {};
    filtered.forEach(o => {
      const pm = o.paymentMethod || "unknown";
      map[pm] = (map[pm] || 0) + 1;
    });
    const total = filtered.length;
    return Object.entries(map).map(([k,v]) => ({ method:k, count:v, pct: total>0 ? Math.round((v/total)*100) : 0 }))
      .sort((a,b)=>b.count-a.count);
  }

  function calcAreas(filtered){
    const map = {};
    filtered.forEach(o => {
      const area = o.deliveryAreaName || "N/A";
      map[area] = map[area] || { orders:0, total:0 };
      map[area].orders += 1;
      map[area].total += (parseFloat(o.total) || parseFloat(o.subtotal) || 0);
    });
    return Object.entries(map).map(([k,v])=>({ area:k, orders:v.orders, total:v.total })).sort((a,b)=>b.orders-a.orders);
  }

  // Renderers
  function renderSummaryCards(summary){
    document.querySelector("#cardRevenue").textContent = formatBRL(summary.revenue);
    document.querySelector("#cardCount").textContent = summary.count;
    document.querySelector("#cardAvg").textContent = formatBRL(summary.avg);
    document.querySelector("#cardTopArea").textContent = summary.topArea;
  }

  function renderTopProducts(list){
    const tbody = document.querySelector("#tableTopProducts tbody");
    tbody.innerHTML = "";
    if(list.length === 0){
      tbody.innerHTML = '<tr><td colspan="3" style="padding:8px;color:var(--muted)">Nenhum produto encontrado no per√≠odo.</td></tr>';
      return;
    }
    list.forEach((p, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td style="padding:8px;border-bottom:1px solid #f1f1f1">${idx+1}</td>
                      <td style="padding:8px;border-bottom:1px solid #f1f1f1">${p.name}</td>
                      <td style="padding:8px;border-bottom:1px solid #f1f1f1">${p.qty}</td>`;
      tbody.appendChild(tr);
    });
  }

function renderPayments(list){
	    const tbody = document.querySelector("#tablePayments tbody");
	    tbody.innerHTML = "";
	    if(list.length === 0){
	      tbody.innerHTML = '<tr><td colspan="4" style="padding:8px;color:var(--muted)">Nenhuma forma de pagamento encontrada.</td></tr>';
	      return;
	    }
	    list.forEach(p => {
	      const tr = document.createElement("tr");
	      tr.innerHTML = `<td style="padding:8px;border-bottom:1px solid #f1f1f1">${p.method}</td>
	                      <td style="padding:8px;border-bottom:1px solid #f1f1f1">${p.count}</td>
	                      <td style="padding:8px;border-bottom:1px solid #f1f1f1">${formatBRL(p.total)}</td>
	                      <td style="padding:8px;border-bottom:1px solid #f1f1f1">${p.pct}%</td>`;
	      tbody.appendChild(tr);
	    });
	  }

  function renderAreas(list){
    const tbody = document.querySelector("#tableAreas tbody");
    tbody.innerHTML = "";
    if(list.length === 0){
      tbody.innerHTML = '<tr><td colspan="3" style="padding:8px;color:var(--muted)">Nenhuma √°rea encontrada.</td></tr>';
      return;
    }
    list.forEach(a => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td style="padding:8px;border-bottom:1px solid #f1f1f1">${a.area}</td>
                      <td style="padding:8px;border-bottom:1px solid #f1f1f1">${a.orders}</td>
                      <td style="padding:8px;border-bottom:1px solid #f1f1f1">${formatBRL(a.total)}</td>`;
      tbody.appendChild(tr);
    });
  }

  // Main update
  function updateSalesReport(period){
    const filtered = getFilteredOrders(period);
    const summary = calcSummary(filtered);
    const topProducts = calcTopProducts(filtered, 10);
    const payments = calcPaymentsWithTotal(filtered);
    const areas = calcAreas(filtered);

    renderSummaryCards(summary);
    renderTopProducts(topProducts);
    renderPayments(payments);
    renderAreas(areas);
  }

  // UI bindings
  function initSalesReport(){
    const buttons = Array.from(document.querySelectorAll(".period-btn"));
    buttons.forEach(btn => {
      btn.addEventListener("click", () => {
        buttons.forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        const period = btn.dataset.period || "day";
        updateSalesReport(period);
      });
    });
    // initial render: day
    updateSalesReport("day");

    // Re-render when the admin modal is open and orders update: hook into existing re-render flow
    const origRenderAdminDashboard = window.renderAdminDashboard;
window.renderAdminDashboard = function(...args){
	      try{ if (typeof origRenderAdminDashboard === "function") origRenderAdminDashboard.apply(this,args); }catch(e){}
	      // Chama o novo dashboard de motoboys
	      renderMotoboyDashboard();
      // determine active period
      const activeBtn = document.querySelector(".period-btn.active");
      const period = activeBtn ? activeBtn.dataset.period : "day";
      updateSalesReport(period);
    };
  }

  // Wait for DOM and for existing functions to be available
  
function safeInit() {
  if (typeof orders !== "undefined" && typeof formatBRL === "function") {
    initSalesReport();
  } else {
    setTimeout(safeInit, 300);
  }
}
safeInit();

/* ===== Relat√≥rio de Vendas Din√¢mico (inserido automaticamente) ===== */
(function(){
  // Utilidades locais
  function parseDate(d){
    try { return new Date(d); } catch(e){ return null; }
  }

  function isDelivered(order){
    if(!order || !order.status) return false;
    const s = String(order.status).toLowerCase().trim();
    return s === "delivered" || s === "entregue" || s === "entregada";
  }

  function withinPeriod(dateObj, period){
    if(!dateObj) return false;
    const now = new Date();
    const start = new Date(now);
    if(period === "day"){
      start.setHours(0,0,0,0);
      return dateObj >= start && dateObj <= now;
    } else if(period === "week"){
      start.setDate(now.getDate() - 6);
      start.setHours(0,0,0,0);
      return dateObj >= start && dateObj <= now;
    } else if(period === "month"){
      start.setDate(now.getDate() - 29);
      start.setHours(0,0,0,0);
      return dateObj >= start && dateObj <= now;
    }
    return false;
  }

  function getAllOrdersArray(){
    const candidates = [window.orders, window.adminOrders, window.pdvOrders, window.firebaseOrders, window._orders];
    for(const c of candidates){
      if(Array.isArray(c)) return c;
    }
    try{ if(typeof orders !== "undefined" && Array.isArray(orders)) return orders; }catch(e){}
    return [];
  }

  function getFilteredOrders(period){
    const all = getAllOrdersArray();
    const filtered = (all || []).filter(o => {
      if(!isDelivered(o)) return false;
      const created = parseDate(o.createdAt || o.created_at || o.timestamp);
      return withinPeriod(created, period);
    });
    return filtered;
  }

  function calcSummary(filtered){
    const summary = { revenue:0, count:0, avg:0, topArea:"N/A" };
    summary.count = filtered.length;
    summary.revenue = filtered.reduce((s,o)=> s + (parseFloat(o.total) || parseFloat(o.subtotal) || parseFloat(o.totalPrice) || 0), 0);
    summary.avg = summary.count > 0 ? summary.revenue / summary.count : 0;
    const areas = {};
    filtered.forEach(o => {
      const area = o.deliveryAreaName || o.deliveryArea || "N/A";
      areas[area] = (areas[area] || 0) + 1;
    });
    const top = Object.entries(areas).sort((a,b)=>b[1]-a[1])[0];
    if(top) summary.topArea = `${top[0]} (${top[1]} pedidos)`;
    return summary;
  }

  function calcTopProducts(filtered, limit=10){
    const counts = {};
    filtered.forEach(o => {
      (o.items || []).forEach(it => {
        const key = it.itemId || it.id || it.name;
        counts[key] = counts[key] || { name: it.name || it.title || key, qty: 0 };
        counts[key].qty += (parseInt(it.qty) || parseInt(it.quantity) || 0);
      });
    });
    return Object.values(counts).sort((a,b)=>b.qty-a.qty).slice(0,limit);
  }

  function calcPaymentsWithTotal(filtered){
    const map = {};
    let grandTotal = 0;

    filtered.forEach(o => {
      const pm = o.paymentMethod || "unknown";
      const orderTotal = parseFloat(o.total) || parseFloat(o.subtotal) || parseFloat(o.totalPrice) || 0;
      
      map[pm] = map[pm] || { count: 0, total: 0 };
      map[pm].count += 1;
      map[pm].total += orderTotal;
      grandTotal += orderTotal;
    });

    return Object.entries(map).map(([k,v]) => ({ 
      method: k, 
      count: v.count, 
      total: v.total, 
      pct: grandTotal > 0 ? ((v.total / grandTotal) * 100).toFixed(2) : 0 
    })).sort((a,b)=>b.total-a.total);
  }

function calcPayments(filtered){
    const map = {};
    filtered.forEach(o => {
      const pm = o.paymentMethod || o.payment || "unknown";
      map[pm] = (map[pm] || 0) + 1;
    });
    const total = filtered.length;
    return Object.entries(map).map(([k,v]) => ({ method:k, count:v, pct: total>0 ? Math.round((v/total)*100) : 0 }))
      .sort((a,b)=>b.count-a.count);
  }

  function calcAreas(filtered){
    const map = {};
    filtered.forEach(o => {
      const area = o.deliveryAreaName || o.deliveryArea || "N/A";
      map[area] = map[area] || { orders:0, total:0 };
      map[area].orders += 1;
      map[area].total += (parseFloat(o.total) || parseFloat(o.subtotal) || parseFloat(o.totalPrice) || 0);
    });
    return Object.entries(map).map(([k,v])=>({ area:k, orders:v.orders, total:v.total })).sort((a,b)=>b.orders-a.orders);
  }

  // Renderers using standard DOM (no $ helper)
  function renderSummaryCards(summary){
    const elRev = document.querySelector("#cardRevenue");
    const elCnt = document.querySelector("#cardCount");
    const elAvg = document.querySelector("#cardAvg");
    const elTop = document.querySelector("#cardTopArea");
    if(elRev) elRev.textContent = formatBRL(summary.revenue);
    if(elCnt) elCnt.textContent = summary.count;
    if(elAvg) elAvg.textContent = formatBRL(summary.avg);
    if(elTop) elTop.textContent = summary.topArea;
  }

  function renderTopProducts(list){
    const tbody = document.querySelector("#tableTopProducts tbody");
    if(!tbody) return;
    tbody.innerHTML = "";
    if(list.length === 0){
      tbody.innerHTML = '<tr><td colspan="3" style="padding:8px;color:var(--muted)">Nenhum produto encontrado no per√≠odo.</td></tr>';
      return;
    }
    list.forEach((p, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td style="padding:8px;border-bottom:1px solid #f1f1f1">${idx+1}</td>
                      <td style="padding:8px;border-bottom:1px solid #f1f1f1">${p.name}</td>
                      <td style="padding:8px;border-bottom:1px solid #f1f1f1">${p.qty}</td>`;
      tbody.appendChild(tr);
    });
  }

  function renderPayments(list){
    const tbody = document.querySelector("#tablePayments tbody");
    if(!tbody) return;
    tbody.innerHTML = "";
    if(list.length === 0){
      tbody.innerHTML = '<tr><td colspan="3" style="padding:8px;color:var(--muted)">Nenhuma forma de pagamento encontrada.</td></tr>';
      return;
    }
    list.forEach(p => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td style="padding:8px;border-bottom:1px solid #f1f1f1">${p.method}</td>
                      <td style="padding:8px;border-bottom:1px solid #f1f1f1">${p.count}</td>
                      <td style="padding:8px;border-bottom:1px solid #f1f1f1">${p.pct}%</td>`;
      tbody.appendChild(tr);
    });
  }

  function renderAreas(list){
    const tbody = document.querySelector("#tableAreas tbody");
    if(!tbody) return;
    tbody.innerHTML = "";
    if(list.length === 0){
      tbody.innerHTML = '<tr><td colspan="3" style="padding:8px;color:var(--muted)">Nenhuma √°rea encontrada.</td></tr>';
      return;
    }
    list.forEach(a => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td style="padding:8px;border-bottom:1px solid #f1f1f1">${a.area}</td>
                      <td style="padding:8px;border-bottom:1px solid #f1f1f1">${a.orders}</td>
                      <td style="padding:8px;border-bottom:1px solid #f1f1f1">${formatBRL(a.total)}</td>`;
      tbody.appendChild(tr);
    });
  }

  // Main update
  function updateSalesReport(period){
    const filtered = getFilteredOrders(period);
    const summary = calcSummary(filtered);
    const topProducts = calcTopProducts(filtered, 10);
    const payments = calcPaymentsWithTotal(filtered);
    const areas = calcAreas(filtered);

    renderSummaryCards(summary);
    renderTopProducts(topProducts);
    renderPayments(payments);
    renderAreas(areas);
  }

  // UI bindings
  function initSalesReport(){
    const buttons = Array.from(document.querySelectorAll(".period-btn"));
    buttons.forEach(btn => {
      btn.addEventListener("click", () => {
        buttons.forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        const period = btn.dataset.period || "day";
        updateSalesReport(period);
      });
    });
    // initial render: day
    updateSalesReport("day");

    // Hook into existing admin render flow to update report when orders change
    const origRenderAdminDashboard = window.renderAdminDashboard;
    window.renderAdminDashboard = function(...args){
      try{ if (typeof origRenderAdminDashboard === "function") origRenderAdminDashboard.apply(this,args); }catch(e){}
      const activeBtn = document.querySelector(".period-btn.active");
      const period = activeBtn ? activeBtn.dataset.period : "day";
      updateSalesReport(period);
    };

    // Also listen to Firestore changes by patching setupRealtimeOrdersListener behavior if exists
    if(typeof setupRealtimeOrdersListener === "function"){
      // No-op: it already updates orders and calls renderAdminDashboard in this file.
    }
  }

})(); // Fechamento da segunda IIFE (linha 209)
})(); // Fechamento da primeira IIFE (linha 12)







document.getElementById("tabMotoboys")?.addEventListener("click", () => {
  document.querySelectorAll(".admin-panel").forEach(p => p.classList.add("hidden"));
  document.getElementById("motoboysPanel")?.classList.remove("hidden");
  document.querySelectorAll(".admin-tabs button").forEach(b => b.classList.remove("active"));
  document.getElementById("tabMotoboys")?.classList.add("active");
  renderMotoboys();
  renderMotoboyDashboard();
});
document.getElementById("tabCustomers").addEventListener("click", () => {
  document.querySelectorAll(".admin-panel").forEach(p => p.classList.add("hidden"));
  document.getElementById("customersPanel").classList.remove("hidden");
  renderCustomers();
});

</script>


<!-- ========================================================================= -->
<!-- === MODAL DE HIST√ìRICO DE PEDIDOS (CRM) === -->
<!-- ========================================================================= -->
<div id="orderHistoryModal" class="modal">
  <div class="modal-content" style="max-height: 80vh; overflow-y: auto;">
    <div class="modal-header">
      <h2 id="historyModalTitle">Hist√≥rico de Pedidos</h2>
      <span class="close-button" onclick="closeOrderHistoryModal()">&times;</span>
    </div>
    <div class="modal-body">
      <p id="historyClientInfo" style="margin-bottom: 15px; font-weight: 600;"></p>
      <div id="historyOrdersList">
        <!-- Pedidos ser√£o injetados aqui -->
        <p style="color:#888;">Carregando hist√≥rico...</p>
      </div>
    </div>
  </div>
</div>

</body>
</html>










    <!-- Table Details Modal: Visualiza e gerencia o pedido de uma mesa ocupada -->
    <div class="modal" id="tableDetailsModal">
      <div class="card" role="dialog" aria-modal="true" style="max-width:600px">
        <h3 id="tableDetailsModalTitle">Detalhes da Mesa <span id="tableDetailsTableName" style="color:var(--primary);"></span></h3>
        
        <div class="form-group">
          <label>Cliente:</label>
          <p id="tableDetailsClientName" style="font-weight:600; margin-top:0;"></p>
        </div>

        <div class="form-group">
          <label>Forma de Pagamento:</label>
          <select id="tableDetailsPaymentMethod" class="form-control">
            <option value="cash">Dinheiro</option>
            <option value="credit">Cart√£o de Cr√©dito</option>
            <option value="debit">Cart√£o de D√©bito</option>
            <option value="pix">PIX</option>
          </select>
        </div>
        
        <h4>Itens do Pedido (Comanda)</h4>
        <div id="tableDetailsOrderItems" style="max-height:300px; overflow-y:auto; border:1px solid #eee; border-radius:8px; padding:8px; margin-bottom:16px;">
          <!-- Itens do pedido ser√£o renderizados aqui -->
        </div>
        
        <h4 style="margin-top:16px;">Comandas Avulsas da Mesa</h4>
        <div id="tableDetailsComandasAvulsas" style="max-height:200px; overflow-y:auto; border:1px solid #eee; border-radius:8px; padding:8px; margin-bottom:16px;">
          <!-- Comandas avulsas ser√£o renderizadas aqui -->
        </div>
        
        <div style="display:flex; justify-content:space-between; font-weight:600; border-top:1px solid #eee; padding-top:8px;">
          <span>Total Atual:</span>
          <span id="tableDetailsTotal" style="color:var(--primary);">R$ 0,00</span>
        </div>
        
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:20px">
          <button type="button" id="tableDetailsCancel" class="pill">Voltar</button>
          <button type="button" id="tableDetailsAddComanda" class="btn" style="background:#28a745;">+ Comanda Avulsa</button>
          <button type="button" id="tableDetailsAddItems" class="btn" style="background:#007bff;">Enviar Mais Itens</button>
          <button type="button" id="tableDetailsCloseTable" class="btn" style="background:#dc3545;">Fechar Mesa</button>
        </div>
      </div>
    </div>
    <div class="modal" id="itemDetailsModal">
      <div class="card" role="dialog" aria-modal="true" style="max-width:500px">
        <h3 id="itemDetailsModalTitle">Adicionar Novo Item</h3>
        <form id="itemDetailsForm">
          <input type="hidden" id="itemIdDetails" />
          <div class="form-group">
            <label for="itemName">Nome do Item</label>
            <input type="text" id="itemName" required>
          </div>
          <div class="form-group">
            <label for="itemDesc">Descri√ß√£o</label>
            <textarea id="itemDesc" rows="3" required></textarea>
          </div>
          <div class="form-group">
            <label for="itemPrice">Pre√ßo (R$)</label>
            <input type="number" id="itemPrice" step="0.01" required>
          </div>
          <div class="form-group">
            <label for="itemCategory">Categoria</label>
            <select id="itemCategory" required></select>
          </div>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px">
            <button type="button" id="itemDetailsCancel" class="pill">Cancelar</button>
            <button type="submit" class="btn" id="itemDetailsSubmit">Salvar Detalhes</button>
          </div>
        </form>
      </div>
    </div>

    <div class="modal" id="addonManagementModal">
      <div class="card" role="dialog" aria-modal="true" style="max-width:800px">
        <h3 id="addonManagementTitle">Gerenciar Adicionais para <span id="addonItemName" style="color:var(--primary);"></span></h3>
        
        <div id="addonGroupsList"></div>
        
        <div style="margin-top:16px; display:flex; justify-content:space-between; align-items:center;">
          <button type="button" class="btn" id="btnAddAddonGroup" style="background:#28a745;">+ Adicionar Grupo</button>
          <div>
            <button type="button" id="addonManagementCancel" class="pill">Cancelar</button>
            <button type="button" class="btn" id="addonManagementSubmit">Salvar Adicionais</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal" id="imageEditModal">
      <div class="card" role="dialog" aria-modal="true" style="max-width:500px">
        <h3 id="imageEditModalTitle">Editar Imagem para <span id="imageItemName" style="color:var(--primary);"></span></h3>
        <form id="imageEditForm">
          <input type="hidden" id="itemIdImage" />
          
          <div class="form-group">
            <label for="itemImgFile">Escolher Imagem do Item</label>
            <input type="file" id="itemImgFile" accept="image/*">
            <input type="hidden" id="itemImgUrl"> </div>
          <div style="text-align:center; margin-bottom:16px;">
             <img id="currentImagePreview" src="" alt="Pr√©via" style="max-width:100%; height:auto; border-radius:8px; margin-top:10px;">
          </div>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px">
            <button type="button" id="imageEditCancel" class="pill">Cancelar</button>
            <button type="submit" class="btn" id="imageEditSubmit">Salvar Imagem</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
// IN√çCIO: L√≥gica de Motoboy (Adicionado para corrigir o seletor)
let motoboys = []; 

async function loadMotoboys() {
  const motoboysCollectionRef = collection(db, "motoboys");
  try {
    const snap = await getDocs(motoboysCollectionRef);
    motoboys = snap.docs.map(d => ({ id: d.id, status: "offline", entregasHoje: 0, ...d.data() })); // Adiciona status e entregasHoje como padr√£o
    renderMotoboysList();
  } catch (e) {
    console.error("Erro ao carregar motoboys:", e);
  }
}

function renderMotoboysList() {
  const container = document.getElementById("motoboysList");
  if (!container) return;

  if(!motoboys || motoboys.length === 0){
    container.innerHTML = '<div class="small" style="color:var(--muted);">Nenhum motoboy cadastrado.</div>';
    return;
  }

  container.innerHTML = motoboys.map(m => {
    const deliveredCount = (orders || []).filter(o => o.motoboyId === m.id && o.status === 'delivered').length;
    return `
      <div class="item">
        <div class="info">
          <h3>${m.name}</h3>
          <p>Tel: ${m.phone}</p>
          <p>Entregas conclu√≠das: ${deliveredCount}</p>
        </div>
        <div class="actions">
          <button class="btn btn-danger" onclick="deleteMotoboy('${m.id}')">Excluir</button>
        </div>
      </div>
    `;
  }).join('');
}

window.openMotoboyModal = function(){
  document.getElementById('motoboyModal').classList.add('open');
}

window.deleteMotoboy = async function(motoboyId){
  if(!confirm("Tem certeza que deseja excluir este motoboy?")){
    return;
  }
  try {
    await deleteDoc(doc(db, "motoboys", motoboyId));
    loadMotoboys();
    loadOrders();
  } catch (e) {
    console.error("Erro ao deletar motoboy:", e);
    alert("Falha ao deletar motoboy.");
  }
}

document.getElementById('motoboyForm')?.addEventListener('submit', async (e) => {
  e.preventDefault();
  const name = document.getElementById('motoboyName').value.trim();
  const phone = document.getElementById('motoboyPhone').value.trim();
  if(!name){ alert('Informe o nome do motoboy'); return; }

  try {
    await addDoc(motoboysCollectionRef, { name, phone, createdAt: Date.now(), status: "offline", entregasHoje: 0 });
    document.getElementById('motoboyForm').reset();
    document.getElementById('motoboyModal').classList.remove('open');
    loadMotoboys();
  } catch (err) {
    console.error('Erro ao salvar motoboy:', err);
    alert('Falha ao salvar motoboy.');
  }
});

window._updateOrderMotoboy = async function(orderId, motoboyId){
  try {
    const orderDocRef = doc(db, "orders", orderId);
    let motoboyName = "";
    if(!motoboyId){
      await updateDoc(orderDocRef, { motoboyId: "", motoboyName: "" });
    } else {
      const m = motoboys.find(x => x.id === motoboyId);
      motoboyName = m ? m.name : "";
      await updateDoc(orderDocRef, { motoboyId: motoboyId, motoboyName: motoboyName });
    }
    
    // Atualiza√ß√£o local do array 'orders' para evitar re-render global
    const orderIndex = orders.findIndex(o => o.id === orderId);
    if (orderIndex !== -1) {
        orders[orderIndex].motoboyId = motoboyId;
        orders[orderIndex].motoboyName = motoboyName;
    }
    
    // loadOrders() removido para evitar re-render global e colapso dos cards
  } catch (e) {
    console.error('Erro ao vincular motoboy:', e);
    alert('Falha ao salvar o motoboy no pedido.');
  }
}
// FIM: L√≥gica de Motoboy


</script>
